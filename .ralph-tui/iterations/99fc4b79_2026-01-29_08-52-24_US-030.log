# Iteration 3 Log

## Metadata

- **Task ID**: US-030
- **Task Title**: Responsividade e UX mobile final
- **Description**: As a user, I want the app to feel native on mobile so that I can use it comfortably on my phone.
- **Status**: completed
- **Task Completed**: Yes
- **Promise Detected**: Yes
- **Started At**: 2026-01-29T11:52:24.706Z
- **Ended At**: 2026-01-29T12:03:35.098Z
- **Duration**: 11m 10s
- **Agent**: claude
- **Sandbox Mode**: auto
- **Sandbox Network**: Enabled
--- RAW OUTPUT ---
{"type":"system","subtype":"init","cwd":"/mnt/d/personal/clinica/src","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","tools":["Task","TaskOutput","Bash","Glob","Grep","ExitPlanMode","Read","Edit","Write","NotebookEdit","WebFetch","TodoWrite","WebSearch","TaskStop","AskUserQuestion","Skill","EnterPlanMode","ToolSearch","mcp__plugin_compound-engineering_context7__resolve-library-id","mcp__plugin_compound-engineering_context7__query-docs"],"mcp_servers":[{"name":"plugin:compound-engineering:context7","status":"connected"}],"model":"claude-opus-4-5-20251101","permissionMode":"bypassPermissions","slash_commands":["keybindings-help","ralph-tui-prd","ralph-tui-create-beads-rust","ralph-tui-create-beads","ralph-tui-create-json","compound-engineering:triage","compound-engineering:lfg","compound-engineering:generate_command","compound-engineering:resolve_parallel","compound-engineering:xcode-test","compound-engineering:changelog","compound-engineering:reproduce-bug","compound-engineering:agent-native-audit","compound-engineering:deploy-docs","compound-engineering:create-agent-skill","compound-engineering:plan_review","compound-engineering:feature-video","compound-engineering:resolve_todo_parallel","compound-engineering:test-browser","compound-engineering:release-docs","compound-engineering:report-bug","compound-engineering:deepen-plan","compound-engineering:heal-skill","compound-engineering:resolve_pr_parallel","compound-engineering:workflows:brainstorm","compound-engineering:workflows:work","compound-engineering:workflows:review","compound-engineering:workflows:plan","compound-engineering:workflows:compound","compound-engineering:rclone","compound-engineering:frontend-design","compound-engineering:skill-creator","compound-engineering:git-worktree","compound-engineering:create-agent-skills","compound-engineering:gemini-imagegen","compound-engineering:compound-docs","compound-engineering:brainstorming","compound-engineering:dhh-rails-style","compound-engineering:every-style-editor","compound-engineering:agent-browser","compound-engineering:andrew-kane-gem-writer","compound-engineering:agent-native-architecture","compound-engineering:file-todos","compound-engineering:dspy-ruby","compact","context","cost","init","pr-comments","release-notes","review","security-review"],"apiKeySource":"none","claude_code_version":"2.1.23","output_style":"default","agents":["Bash","general-purpose","statusline-setup","Explore","Plan","compound-engineering:docs:ankane-readme-writer","compound-engineering:review:julik-frontend-races-reviewer","compound-engineering:review:kieran-rails-reviewer","compound-engineering:review:kieran-python-reviewer","compound-engineering:review:kieran-typescript-reviewer","compound-engineering:review:dhh-rails-reviewer","compound-engineering:review:data-migration-expert","compound-engineering:review:agent-native-reviewer","compound-engineering:review:deployment-verification-agent","compound-engineering:review:pattern-recognition-specialist","compound-engineering:review:data-integrity-guardian","compound-engineering:review:performance-oracle","compound-engineering:review:security-sentinel","compound-engineering:review:code-simplicity-reviewer","compound-engineering:review:architecture-strategist","compound-engineering:research:repo-research-analyst","compound-engineering:research:framework-docs-researcher","compound-engineering:research:git-history-analyzer","compound-engineering:research:learnings-researcher","compound-engineering:research:best-practices-researcher","compound-engineering:workflow:lint","compound-engineering:workflow:pr-comment-resolver","compound-engineering:workflow:every-style-editor","compound-engineering:workflow:spec-flow-analyzer","compound-engineering:workflow:bug-reproduction-validator","compound-engineering:design:figma-design-sync","compound-engineering:design:design-iterator","compound-engineering:design:design-implementation-reviewer"],"skills":["keybindings-help","ralph-tui-prd","ralph-tui-create-beads-rust","ralph-tui-create-beads","ralph-tui-create-json","compound-engineering:rclone","compound-engineering:frontend-design","compound-engineering:skill-creator","compound-engineering:git-worktree","compound-engineering:create-agent-skills","compound-engineering:gemini-imagegen","compound-engineering:compound-docs","compound-engineering:brainstorming","compound-engineering:dhh-rails-style","compound-engineering:every-style-editor","compound-engineering:agent-browser","compound-engineering:andrew-kane-gem-writer","compound-engineering:agent-native-architecture","compound-engineering:file-todos","compound-engineering:dspy-ruby"],"plugins":[{"name":"compound-engineering","path":"/root/.claude/plugins/cache/every-marketplace/compound-engineering/2.28.0"}],"uuid":"72a7a650-0fc6-4e44-a30b-63f19a1a91f1"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SnnsKzJa8nzarSMBLANWjQ","type":"message","role":"assistant","content":[{"type":"text","text":"I'll implement the mobile responsiveness and UX improvements for the app. Let me start by exploring the current codebase structure to understand what we're working with."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5932,"cache_read_input_tokens":25703,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5932},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"417098c3-7656-4d44-9401-af2c2799b7d8"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SnnsKzJa8nzarSMBLANWjQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019N5mccVv3hamcLEK4DzYUN","name":"Task","input":{"subagent_type":"Explore","prompt":"Explore this codebase to understand:\n1. The overall project structure (is it React, Vue, Next.js, etc.)\n2. Current component organization\n3. Existing navigation patterns\n4. Current mobile/responsive implementations\n5. CSS/styling approach (Tailwind, CSS modules, styled-components, etc.)\n6. Any existing bottom navigation or FAB components\n7. Current loading/error state patterns\n\nFocus on finding:\n- Main layout components\n- Navigation components\n- Any mobile-specific code\n- UI component library being used (if any)","description":"Explore codebase structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5932,"cache_read_input_tokens":25703,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5932},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"5dad0a56-50fc-463e-937d-ef20fee4e8d9"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Explore this codebase to understand:\n1. The overall project structure (is it React, Vue, Next.js, etc.)\n2. Current component organization\n3. Existing navigation patterns\n4. Current mobile/responsive implementations\n5. CSS/styling approach (Tailwind, CSS modules, styled-components, etc.)\n6. Any existing bottom navigation or FAB components\n7. Current loading/error state patterns\n\nFocus on finding:\n- Main layout components\n- Navigation components\n- Any mobile-specific code\n- UI component library being used (if any)"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"69d4827b-2e49-480c-95e2-a68c8e874c3e"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01P3yL2UDu88c1t2iJUCtFiy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ThdinDk4gUyaEnJ9jA6ov8","name":"Bash","input":{"command":"find /mnt/d/personal/clinica -maxdepth 3 -type f \\( -name \"*.json\" -o -name \"*.config.*\" \\) | grep -E \"(package|tsconfig|vite|webpack)\" | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1443,"cache_read_input_tokens":10127,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1443},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9b578de3-2b16-48fe-afbd-a3c6d06ff07f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ThdinDk4gUyaEnJ9jA6ov8","type":"tool_result","content":"/mnt/d/personal/clinica/src/.next/package.json\n/mnt/d/personal/clinica/src/node_modules/.package-lock.json\n/mnt/d/personal/clinica/src/package-lock.json\n/mnt/d/personal/clinica/src/package.json\n/mnt/d/personal/clinica/src/tsconfig.json","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f282d189-3567-4201-83ee-aa222e37c0fb"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01F53FdJs3rNSVgmLh3RNJCH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RUniiE4Gvx9LCzZveRVvQS","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/package.json"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":279,"cache_read_input_tokens":11570,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":279},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"dec7ae85-ac55-46dc-a86e-2fce056730fe"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01F53FdJs3rNSVgmLh3RNJCH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BohphBjyGhLTEWpsaxA4XY","name":"Bash","input":{"command":"ls -la /mnt/d/personal/clinica/src/ | head -40"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":279,"cache_read_input_tokens":11570,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":279},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b20be11a-3b42-4f72-b864-04b72dea560b"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RUniiE4Gvx9LCzZveRVvQS","type":"tool_result","content":"     1→{\n     2→  \"name\": \"src\",\n     3→  \"version\": \"0.1.0\",\n     4→  \"private\": true,\n     5→  \"scripts\": {\n     6→    \"dev\": \"next dev\",\n     7→    \"build\": \"next build\",\n     8→    \"start\": \"next start\",\n     9→    \"lint\": \"eslint\",\n    10→    \"prisma:generate\": \"prisma generate\",\n    11→    \"prisma:migrate\": \"prisma migrate dev\",\n    12→    \"prisma:studio\": \"prisma studio\",\n    13→    \"prisma:push\": \"prisma db push\",\n    14→    \"prisma:seed\": \"npx tsx prisma/seed.ts\",\n    15→    \"postinstall\": \"prisma generate\"\n    16→  },\n    17→  \"prisma\": {\n    18→    \"seed\": \"npx tsx prisma/seed.ts\"\n    19→  },\n    20→  \"dependencies\": {\n    21→    \"@hookform/resolvers\": \"^5.2.2\",\n    22→    \"bcrypt\": \"^6.0.0\",\n    23→    \"next\": \"16.1.6\",\n    24→    \"next-auth\": \"^5.0.0-beta.30\",\n    25→    \"react\": \"19.2.3\",\n    26→    \"react-dom\": \"19.2.3\",\n    27→    \"react-hook-form\": \"^7.71.1\",\n    28→    \"sonner\": \"^2.0.7\",\n    29→    \"zod\": \"^4.3.6\"\n    30→  },\n    31→  \"devDependencies\": {\n    32→    \"@esbuild/linux-x64\": \"^0.27.2\",\n    33→    \"@prisma/client\": \"^6.19.2\",\n    34→    \"@tailwindcss/postcss\": \"^4\",\n    35→    \"@types/bcrypt\": \"^6.0.0\",\n    36→    \"@types/node\": \"^20\",\n    37→    \"@types/react\": \"^19\",\n    38→    \"@types/react-dom\": \"^19\",\n    39→    \"dotenv\": \"^17.2.3\",\n    40→    \"eslint\": \"^9\",\n    41→    \"eslint-config-next\": \"16.1.6\",\n    42→    \"prisma\": \"^6.19.2\",\n    43→    \"tailwindcss\": \"^4\",\n    44→    \"tsx\": \"^4.21.0\",\n    45→    \"typescript\": \"^5\"\n    46→  }\n    47→}\n    48→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"042a3969-6a31-4899-a0de-1339bbafb471"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BohphBjyGhLTEWpsaxA4XY","type":"tool_result","content":"total 471\ndrwxrwxrwx 1 root root    512 Jan 29 08:49 .\ndrwxrwxrwx 1 root root    512 Jan 28 21:14 ..\n-rwxrwxrwx 1 root root    327 Jan 28 21:36 .env\n-rwxrwxrwx 1 root root    431 Jan 28 21:46 .env.example\n-rwxrwxrwx 1 root root    115 Jan 28 21:46 .env.local\ndrwxrwxrwx 1 root root    512 Jan 29 08:52 .git\n-rwxrwxrwx 1 root root    517 Jan 28 21:36 .gitignore\ndrwxrwxrwx 1 root root    512 Jan 29 08:41 .next\ndrwxrwxrwx 1 root root    512 Jan 29 08:42 .ralph-tui\n-rwxrwxrwx 1 root root   2670 Jan 29 08:49 README.md\n-rwxrwxrwx 1 root root    580 Jan 28 21:29 docker-compose.yml\n-rwxrwxrwx 1 root root    465 Jan 28 21:27 eslint.config.mjs\n-rwxrwxrwx 1 root root    247 Jan 29 07:26 next-env.d.ts\n-rwxrwxrwx 1 root root    133 Jan 28 21:27 next.config.ts\ndrwxrwxrwx 1 root root    512 Jan 29 08:50 node_modules\n-rwxrwxrwx 1 root root 264676 Jan 29 08:50 package-lock.json\n-rwxrwxrwx 1 root root   1173 Jan 29 08:50 package.json\n-rwxrwxrwx 1 root root     94 Jan 28 21:27 postcss.config.mjs\ndrwxrwxrwx 1 root root    512 Jan 29 08:49 prisma\n-rwxrwxrwx 1 root root    392 Jan 28 21:36 prisma.config.ts\ndrwxrwxrwx 1 root root    512 Jan 28 21:27 public\ndrwxrwxrwx 1 root root    512 Jan 28 21:50 src\ndrwxrwxrwx 1 root root    512 Jan 28 21:26 tasks\n-rwxrwxrwx 1 root root    670 Jan 28 21:27 tsconfig.json\n-rwxrwxrwx 1 root root 202036 Jan 29 08:51 tsconfig.tsbuildinfo","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"00b14a83-66a8-45c9-b5e3-ba8db3ffaaac"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CcEqAZZiyPTc62KCQ7LMfe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013rNe22jcXgznabMbSpDBS2","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src -type d -maxdepth 3 | sort"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1736,"cache_read_input_tokens":11849,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"3752fefb-1fb4-42bf-a24e-f3e3a47ef9d0"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013rNe22jcXgznabMbSpDBS2","type":"tool_result","content":"<persisted-output>\nOutput too large (74.9KB). Full output saved to: /root/.claude/projects/-mnt-d-personal-clinica-src/450a69ab-cd7f-4725-ad89-8b0246468634/tool-results/toolu_013rNe22jcXgznabMbSpDBS2.txt\n\nPreview (first 2KB):\n/mnt/d/personal/clinica/src\n/mnt/d/personal/clinica/src/.git\n/mnt/d/personal/clinica/src/.git/branches\n/mnt/d/personal/clinica/src/.git/hooks\n/mnt/d/personal/clinica/src/.git/info\n/mnt/d/personal/clinica/src/.git/logs\n/mnt/d/personal/clinica/src/.git/logs/refs\n/mnt/d/personal/clinica/src/.git/objects\n/mnt/d/personal/clinica/src/.git/objects/00\n/mnt/d/personal/clinica/src/.git/objects/01\n/mnt/d/personal/clinica/src/.git/objects/02\n/mnt/d/personal/clinica/src/.git/objects/03\n/mnt/d/personal/clinica/src/.git/objects/04\n/mnt/d/personal/clinica/src/.git/objects/05\n/mnt/d/personal/clinica/src/.git/objects/06\n/mnt/d/personal/clinica/src/.git/objects/07\n/mnt/d/personal/clinica/src/.git/objects/08\n/mnt/d/personal/clinica/src/.git/objects/0a\n/mnt/d/personal/clinica/src/.git/objects/0b\n/mnt/d/personal/clinica/src/.git/objects/0c\n/mnt/d/personal/clinica/src/.git/objects/0d\n/mnt/d/personal/clinica/src/.git/objects/0e\n/mnt/d/personal/clinica/src/.git/objects/0f\n/mnt/d/personal/clinica/src/.git/objects/10\n/mnt/d/personal/clinica/src/.git/objects/11\n/mnt/d/personal/clinica/src/.git/objects/13\n/mnt/d/personal/clinica/src/.git/objects/14\n/mnt/d/personal/clinica/src/.git/objects/16\n/mnt/d/personal/clinica/src/.git/objects/17\n/mnt/d/personal/clinica/src/.git/objects/18\n/mnt/d/personal/clinica/src/.git/objects/19\n/mnt/d/personal/clinica/src/.git/objects/1a\n/mnt/d/personal/clinica/src/.git/objects/1b\n/mnt/d/personal/clinica/src/.git/objects/1c\n/mnt/d/personal/clinica/src/.git/objects/1d\n/mnt/d/personal/clinica/src/.git/objects/1e\n/mnt/d/personal/clinica/src/.git/objects/1f\n/mnt/d/personal/clinica/src/.git/objects/20\n/mnt/d/personal/clinica/src/.git/objects/21\n/mnt/d/personal/clinica/src/.git/objects/22\n/mnt/d/personal/clinica/src/.git/objects/24\n/mnt/d/personal/clinica/src/.git/objects/25\n/mnt/d/personal/clinica/src/.git/objects/26\n/mnt/d/personal/clinica/src/.git/objects/27\n/mnt/d/personal/clinica/src/.git/objects/28\n/mnt/d/personal/clinica/src/.git/objects/29\n...\n</persisted-output>","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b87d7c23-7d6c-48d3-8b67-333e017d92f6"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01X75KLL54HFCwAu9iAM8Bs1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QyMHVS97Js78YpSWmuxRhK","name":"Bash","input":{"command":"ls -la /mnt/d/personal/clinica/src/src/"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":1129,"cache_read_input_tokens":13585,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1129},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"c5035a09-7466-42ae-96fd-bdb14ebf3ef5"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QyMHVS97Js78YpSWmuxRhK","type":"tool_result","content":"total 0\ndrwxrwxrwx 1 root root 512 Jan 28 21:50 .\ndrwxrwxrwx 1 root root 512 Jan 29 08:49 ..\ndrwxrwxrwx 1 root root 512 Jan 29 07:53 app\ndrwxrwxrwx 1 root root 512 Jan 28 21:30 features\ndrwxrwxrwx 1 root root 512 Jan 28 21:37 generated\ndrwxrwxrwx 1 root root 512 Jan 29 08:37 lib\n-rwxrwxrwx 1 root root 340 Jan 28 21:50 middleware.ts\ndrwxrwxrwx 1 root root 512 Jan 28 21:30 shared\ndrwxrwxrwx 1 root root 512 Jan 28 21:45 types","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"199b9dc5-85f4-4380-a0f6-fffdd74f1275"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q5uJuWWXAgbvobtCHh8cpr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Rd8eQdGaQZZ73AzqhvgaKE","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src/src -type d -maxdepth 2 | sort"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":378,"cache_read_input_tokens":14714,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":378},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9a5fc844-99e3-4b64-a79b-eb5eb8f031a0"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Rd8eQdGaQZZ73AzqhvgaKE","type":"tool_result","content":"/mnt/d/personal/clinica/src/src\n/mnt/d/personal/clinica/src/src/app\n/mnt/d/personal/clinica/src/src/app/admin\n/mnt/d/personal/clinica/src/src/app/agenda\n/mnt/d/personal/clinica/src/src/app/api\n/mnt/d/personal/clinica/src/src/app/cancel\n/mnt/d/personal/clinica/src/src/app/confirm\n/mnt/d/personal/clinica/src/src/app/login\n/mnt/d/personal/clinica/src/src/app/patients\n/mnt/d/personal/clinica/src/src/app/profile\n/mnt/d/personal/clinica/src/src/app/settings\n/mnt/d/personal/clinica/src/src/features\n/mnt/d/personal/clinica/src/src/generated\n/mnt/d/personal/clinica/src/src/generated/prisma\n/mnt/d/personal/clinica/src/src/lib\n/mnt/d/personal/clinica/src/src/lib/api\n/mnt/d/personal/clinica/src/src/lib/appointments\n/mnt/d/personal/clinica/src/src/lib/notifications\n/mnt/d/personal/clinica/src/src/lib/rbac\n/mnt/d/personal/clinica/src/src/shared\n/mnt/d/personal/clinica/src/src/shared/components\n/mnt/d/personal/clinica/src/src/shared/hooks\n/mnt/d/personal/clinica/src/src/shared/lib\n/mnt/d/personal/clinica/src/src/shared/types\n/mnt/d/personal/clinica/src/src/types","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"05a9446b-f22e-4277-b2e6-9f3dd553a196"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TcNaMCJxeGAFKXYj2SA3Ds","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BXdpzNqRmQvTNsQzV2dHWL","name":"Bash","input":{"command":"ls -la /mnt/d/personal/clinica/src/src/app/"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":701,"cache_read_input_tokens":15092,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":701},"output_tokens":7,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"dd0f2951-eb20-4036-9901-d3b15c189fc3"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BXdpzNqRmQvTNsQzV2dHWL","type":"tool_result","content":"total 36\ndrwxrwxrwx 1 root root   512 Jan 29 07:53 .\ndrwxrwxrwx 1 root root   512 Jan 28 21:50 ..\ndrwxrwxrwx 1 root root   512 Jan 29 08:45 admin\ndrwxrwxrwx 1 root root   512 Jan 29 08:15 agenda\ndrwxrwxrwx 1 root root   512 Jan 29 08:37 api\ndrwxrwxrwx 1 root root   512 Jan 29 07:53 cancel\ndrwxrwxrwx 1 root root   512 Jan 29 07:50 confirm\n-rwxrwxrwx 1 root root 25931 Jan 28 21:27 favicon.ico\n-rwxrwxrwx 1 root root  1985 Jan 28 21:29 globals.css\n-rwxrwxrwx 1 root root  1190 Jan 28 22:06 layout.tsx\ndrwxrwxrwx 1 root root   512 Jan 28 21:49 login\n-rwxrwxrwx 1 root root   299 Jan 28 21:30 page.tsx\ndrwxrwxrwx 1 root root   512 Jan 28 22:42 patients\ndrwxrwxrwx 1 root root   512 Jan 28 22:09 profile\ndrwxrwxrwx 1 root root   512 Jan 28 22:22 settings","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"cd0726e5-3863-4eb6-9b18-cf7f62e319f8"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011f8CpaT18cZr7m6rHorh1S","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RLDHkx9gmsMEmTewRUSDks","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/layout.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":551,"cache_read_input_tokens":15793,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":551},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b70b3155-7137-4806-8500-0783ea9bfd81"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011f8CpaT18cZr7m6rHorh1S","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0142Pf2n4zJrJaPvqxg5a1Dk","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/globals.css"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":551,"cache_read_input_tokens":15793,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":551},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"43950358-68e9-4dbf-9c83-3ea48e9e64de"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011f8CpaT18cZr7m6rHorh1S","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EfwysmkiPG59F877ZS5Cuz","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":551,"cache_read_input_tokens":15793,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":551},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"11a01629-9f10-48d2-b596-eb02a58996c6"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011f8CpaT18cZr7m6rHorh1S","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UkXg1D7tk3x6cnoMY6B5CN","name":"Bash","input":{"command":"ls -la /mnt/d/personal/clinica/src/src/shared/components/"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":551,"cache_read_input_tokens":15793,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":551},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"01d83017-88ea-4d51-9525-fb3f79e85eed"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RLDHkx9gmsMEmTewRUSDks","type":"tool_result","content":"     1→import type { Metadata, Viewport } from \"next\";\n     2→import { Geist, Geist_Mono } from \"next/font/google\";\n     3→import { Toaster } from \"sonner\";\n     4→import { SessionProvider } from \"@/shared/components/session-provider\";\n     5→import \"./globals.css\";\n     6→\n     7→const geistSans = Geist({\n     8→  variable: \"--font-geist-sans\",\n     9→  subsets: [\"latin\"],\n    10→});\n    11→\n    12→const geistMono = Geist_Mono({\n    13→  variable: \"--font-geist-mono\",\n    14→  subsets: [\"latin\"],\n    15→});\n    16→\n    17→export const metadata: Metadata = {\n    18→  title: \"Clinica\",\n    19→  description: \"Sistema de gestao para clinicas\",\n    20→};\n    21→\n    22→export const viewport: Viewport = {\n    23→  width: \"device-width\",\n    24→  initialScale: 1,\n    25→  maximumScale: 1,\n    26→  userScalable: false,\n    27→  themeColor: [\n    28→    { media: \"(prefers-color-scheme: light)\", color: \"#fafafa\" },\n    29→    { media: \"(prefers-color-scheme: dark)\", color: \"#09090b\" },\n    30→  ],\n    31→};\n    32→\n    33→export default function RootLayout({\n    34→  children,\n    35→}: Readonly<{\n    36→  children: React.ReactNode;\n    37→}>) {\n    38→  return (\n    39→    <html lang=\"pt-BR\">\n    40→      <body\n    41→        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n    42→      >\n    43→        <SessionProvider>\n    44→          {children}\n    45→          <Toaster richColors position=\"top-right\" />\n    46→        </SessionProvider>\n    47→      </body>\n    48→    </html>\n    49→  );\n    50→}\n    51→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2190a117-41bd-46e3-972a-476cf7a6509b"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0142Pf2n4zJrJaPvqxg5a1Dk","type":"tool_result","content":"     1→@import \"tailwindcss\";\n     2→\n     3→:root {\n     4→  /* Minimalist color palette - neutral tones */\n     5→  --background: #fafafa;\n     6→  --foreground: #18181b;\n     7→\n     8→  /* Subtle borders */\n     9→  --border: #e4e4e7;\n    10→  --border-muted: #f4f4f5;\n    11→\n    12→  /* Neutral grays */\n    13→  --muted: #f4f4f5;\n    14→  --muted-foreground: #71717a;\n    15→\n    16→  /* Primary - subtle blue-gray */\n    17→  --primary: #3f3f46;\n    18→  --primary-foreground: #fafafa;\n    19→\n    20→  /* Accent - warm neutral */\n    21→  --accent: #f4f4f5;\n    22→  --accent-foreground: #18181b;\n    23→\n    24→  /* Destructive */\n    25→  --destructive: #ef4444;\n    26→  --destructive-foreground: #fafafa;\n    27→\n    28→  /* Card */\n    29→  --card: #ffffff;\n    30→  --card-foreground: #18181b;\n    31→\n    32→  /* Input */\n    33→  --input: #e4e4e7;\n    34→  --ring: #a1a1aa;\n    35→}\n    36→\n    37→@theme inline {\n    38→  --color-background: var(--background);\n    39→  --color-foreground: var(--foreground);\n    40→  --color-border: var(--border);\n    41→  --color-border-muted: var(--border-muted);\n    42→  --color-muted: var(--muted);\n    43→  --color-muted-foreground: var(--muted-foreground);\n    44→  --color-primary: var(--primary);\n    45→  --color-primary-foreground: var(--primary-foreground);\n    46→  --color-accent: var(--accent);\n    47→  --color-accent-foreground: var(--accent-foreground);\n    48→  --color-destructive: var(--destructive);\n    49→  --color-destructive-foreground: var(--destructive-foreground);\n    50→  --color-card: var(--card);\n    51→  --color-card-foreground: var(--card-foreground);\n    52→  --color-input: var(--input);\n    53→  --color-ring: var(--ring);\n    54→  --font-sans: var(--font-geist-sans);\n    55→  --font-mono: var(--font-geist-mono);\n    56→}\n    57→\n    58→@media (prefers-color-scheme: dark) {\n    59→  :root {\n    60→    --background: #09090b;\n    61→    --foreground: #fafafa;\n    62→\n    63→    --border: #27272a;\n    64→    --border-muted: #18181b;\n    65→\n    66→    --muted: #27272a;\n    67→    --muted-foreground: #a1a1aa;\n    68→\n    69→    --primary: #fafafa;\n    70→    --primary-foreground: #18181b;\n    71→\n    72→    --accent: #27272a;\n    73→    --accent-foreground: #fafafa;\n    74→\n    75→    --card: #09090b;\n    76→    --card-foreground: #fafafa;\n    77→\n    78→    --input: #27272a;\n    79→    --ring: #52525b;\n    80→  }\n    81→}\n    82→\n    83→body {\n    84→  background: var(--background);\n    85→  color: var(--foreground);\n    86→  font-family: var(--font-sans), system-ui, sans-serif;\n    87→}\n    88→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"fb59897a-da12-4ea0-9182-535c2bc28309"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EfwysmkiPG59F877ZS5Cuz","type":"tool_result","content":"     1→export default function Home() {\n     2→  return (\n     3→    <main className=\"flex min-h-screen flex-col items-center justify-center bg-background\">\n     4→      <h1 className=\"text-3xl font-semibold text-foreground\">Clinica</h1>\n     5→      <p className=\"mt-2 text-muted-foreground\">Sistema de gestao</p>\n     6→    </main>\n     7→  );\n     8→}\n     9→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f16a7e1c-b29c-4334-8b56-47a830dad2b1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UkXg1D7tk3x6cnoMY6B5CN","type":"tool_result","content":"total 0\ndrwxrwxrwx 1 root root 512 Jan 28 21:46 .\ndrwxrwxrwx 1 root root 512 Jan 28 21:30 ..\n-rwxrwxrwx 1 root root   0 Jan 28 21:30 .gitkeep\n-rwxrwxrwx 1 root root 244 Jan 28 21:46 session-provider.tsx","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"415d557d-013a-4ba7-950d-4e82278bea7c"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BAy3jjdjpqbK9sU87JBBNT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016mhhgRqiGjpKqcG9mAysjp","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src/src -type f \\( -name \"*.tsx\" -o -name \"*.ts\" \\) | head -50"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":2500,"cache_read_input_tokens":16344,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2500},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2ac97790-949c-4fcc-8874-b7cf3b2fb135"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016mhhgRqiGjpKqcG9mAysjp","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/app/admin/audit/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/professionals/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/settings/page.tsx\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx\n/mnt/d/personal/clinica/src/src/app/api/admin/audit-logs/route.ts\n/mnt/d/personal/clinica/src/src/app/api/admin/settings/route.ts\n/mnt/d/personal/clinica/src/src/app/api/appointments/cancel/route.ts\n/mnt/d/personal/clinica/src/src/app/api/appointments/confirm/route.ts\n/mnt/d/personal/clinica/src/src/app/api/appointments/route.ts\n/mnt/d/personal/clinica/src/src/app/api/appointments/[id]/cancel/route.ts\n/mnt/d/personal/clinica/src/src/app/api/appointments/[id]/notifications/route.ts\n/mnt/d/personal/clinica/src/src/app/api/appointments/[id]/route.ts\n/mnt/d/personal/clinica/src/src/app/api/appointments/[id]/status/route.ts\n/mnt/d/personal/clinica/src/src/app/api/auth/[...nextauth]/route.ts\n/mnt/d/personal/clinica/src/src/app/api/availability/exceptions/route.ts\n/mnt/d/personal/clinica/src/src/app/api/availability/exceptions/[id]/route.ts\n/mnt/d/personal/clinica/src/src/app/api/availability/route.ts\n/mnt/d/personal/clinica/src/src/app/api/me/route.ts\n/mnt/d/personal/clinica/src/src/app/api/patients/route.ts\n/mnt/d/personal/clinica/src/src/app/api/patients/[id]/route.ts\n/mnt/d/personal/clinica/src/src/app/api/professionals/route.ts\n/mnt/d/personal/clinica/src/src/app/api/professionals/[id]/route.ts\n/mnt/d/personal/clinica/src/src/app/api/profile/route.ts\n/mnt/d/personal/clinica/src/src/app/api/public/appointments/cancel/route.ts\n/mnt/d/personal/clinica/src/src/app/api/public/appointments/confirm/route.ts\n/mnt/d/personal/clinica/src/src/app/api/public/appointments/lookup/route.ts\n/mnt/d/personal/clinica/src/src/app/cancel/page.tsx\n/mnt/d/personal/clinica/src/src/app/confirm/page.tsx\n/mnt/d/personal/clinica/src/src/app/layout.tsx\n/mnt/d/personal/clinica/src/src/app/login/page.tsx\n/mnt/d/personal/clinica/src/src/app/page.tsx\n/mnt/d/personal/clinica/src/src/app/patients/page.tsx\n/mnt/d/personal/clinica/src/src/app/profile/page.tsx\n/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx\n/mnt/d/personal/clinica/src/src/generated/prisma/browser.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/client.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/commonInputTypes.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/enums.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/internal/class.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/internal/prismaNamespace.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/internal/prismaNamespaceBrowser.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/Appointment.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/AppointmentRecurrence.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/AppointmentToken.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/AuditLog.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/AvailabilityException.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/AvailabilityRule.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/Clinic.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/Notification.ts\n/mnt/d/personal/clinica/src/src/generated/prisma/models/Patient.ts","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f0803cc7-b24a-437d-8caa-a73758cec31f"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUFC3LYXy9qWU1BLjEcXfj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NHRMpEsTuz82SnGa256oAG","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/login/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1476,"cache_read_input_tokens":18844,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1476},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"aba3261e-e514-4601-a8ee-65a3d408d0c9"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUFC3LYXy9qWU1BLjEcXfj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PnoXPxCH4o839fEeyVgPbq","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1476,"cache_read_input_tokens":18844,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1476},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"17e4f7ff-db78-4d4f-ae8d-4c62c3c1c560"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUFC3LYXy9qWU1BLjEcXfj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RaNXvtwV2TnpSkG9FUojHb","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1476,"cache_read_input_tokens":18844,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1476},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9aa3297f-a0a4-4976-a6a3-528ec823af3c"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUFC3LYXy9qWU1BLjEcXfj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BSfck6wepKM5XifiNeq6pX","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/profile/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1476,"cache_read_input_tokens":18844,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1476},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f281195e-6f4d-43e3-9939-b7b3bf5af2de"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NHRMpEsTuz82SnGa256oAG","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { Suspense, useState } from \"react\"\n     4→import { signIn } from \"next-auth/react\"\n     5→import { useRouter, useSearchParams } from \"next/navigation\"\n     6→\n     7→function LoginForm() {\n     8→  const router = useRouter()\n     9→  const searchParams = useSearchParams()\n    10→  const callbackUrl = searchParams.get(\"callbackUrl\") || \"/\"\n    11→  const error = searchParams.get(\"error\")\n    12→\n    13→  const [email, setEmail] = useState(\"\")\n    14→  const [password, setPassword] = useState(\"\")\n    15→  const [isLoading, setIsLoading] = useState(false)\n    16→  const [errorMessage, setErrorMessage] = useState(\n    17→    error === \"CredentialsSignin\" ? \"Email ou senha incorretos\" : \"\"\n    18→  )\n    19→\n    20→  async function handleSubmit(e: React.FormEvent) {\n    21→    e.preventDefault()\n    22→    setIsLoading(true)\n    23→    setErrorMessage(\"\")\n    24→\n    25→    const result = await signIn(\"credentials\", {\n    26→      email,\n    27→      password,\n    28→      redirect: false,\n    29→      callbackUrl,\n    30→    })\n    31→\n    32→    if (result?.error) {\n    33→      setErrorMessage(\"Email ou senha incorretos\")\n    34→      setIsLoading(false)\n    35→    } else if (result?.ok) {\n    36→      router.push(callbackUrl)\n    37→      router.refresh()\n    38→    }\n    39→  }\n    40→\n    41→  return (\n    42→    <form onSubmit={handleSubmit} className=\"space-y-5\">\n    43→      {errorMessage && (\n    44→        <div className=\"bg-destructive/10 border border-destructive/20 text-destructive text-sm rounded-md p-3\">\n    45→          {errorMessage}\n    46→        </div>\n    47→      )}\n    48→\n    49→      <div>\n    50→        <label\n    51→          htmlFor=\"email\"\n    52→          className=\"block text-sm font-medium text-foreground mb-2\"\n    53→        >\n    54→          Email\n    55→        </label>\n    56→        <input\n    57→          id=\"email\"\n    58→          type=\"email\"\n    59→          value={email}\n    60→          onChange={(e) => setEmail(e.target.value)}\n    61→          required\n    62→          autoComplete=\"email\"\n    63→          placeholder=\"seu@email.com\"\n    64→          className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n    65→        />\n    66→      </div>\n    67→\n    68→      <div>\n    69→        <label\n    70→          htmlFor=\"password\"\n    71→          className=\"block text-sm font-medium text-foreground mb-2\"\n    72→        >\n    73→          Senha\n    74→        </label>\n    75→        <input\n    76→          id=\"password\"\n    77→          type=\"password\"\n    78→          value={password}\n    79→          onChange={(e) => setPassword(e.target.value)}\n    80→          required\n    81→          autoComplete=\"current-password\"\n    82→          placeholder=\"Sua senha\"\n    83→          className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n    84→        />\n    85→      </div>\n    86→\n    87→      <button\n    88→        type=\"submit\"\n    89→        disabled={isLoading}\n    90→        className=\"w-full h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n    91→      >\n    92→        {isLoading ? \"Entrando...\" : \"Entrar\"}\n    93→      </button>\n    94→    </form>\n    95→  )\n    96→}\n    97→\n    98→function LoginFormFallback() {\n    99→  return (\n   100→    <div className=\"space-y-5 animate-pulse\">\n   101→      <div>\n   102→        <div className=\"h-4 w-12 bg-muted rounded mb-2\" />\n   103→        <div className=\"h-12 bg-muted rounded\" />\n   104→      </div>\n   105→      <div>\n   106→        <div className=\"h-4 w-12 bg-muted rounded mb-2\" />\n   107→        <div className=\"h-12 bg-muted rounded\" />\n   108→      </div>\n   109→      <div className=\"h-12 bg-muted rounded\" />\n   110→    </div>\n   111→  )\n   112→}\n   113→\n   114→export default function LoginPage() {\n   115→  return (\n   116→    <main className=\"min-h-screen flex items-center justify-center px-4 py-8\">\n   117→      <div className=\"w-full max-w-md\">\n   118→        <div className=\"bg-card border border-border rounded-lg p-6 sm:p-8 shadow-sm\">\n   119→          <div className=\"text-center mb-8\">\n   120→            <h1 className=\"text-2xl font-semibold text-foreground\">Clinica</h1>\n   121→            <p className=\"text-muted-foreground mt-2\">\n   122→              Acesse sua conta para continuar\n   123→            </p>\n   124→          </div>\n   125→\n   126→          <Suspense fallback={<LoginFormFallback />}>\n   127→            <LoginForm />\n   128→          </Suspense>\n   129→        </div>\n   130→      </div>\n   131→    </main>\n   132→  )\n   133→}\n   134→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2b83c74c-9821-4aeb-bcf4-01a5c97850e1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BSfck6wepKM5XifiNeq6pX","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { useCallback, useEffect, useState } from \"react\"\n     4→import { useRouter } from \"next/navigation\"\n     5→import { useSession } from \"next-auth/react\"\n     6→import { useForm } from \"react-hook-form\"\n     7→import { zodResolver } from \"@hookform/resolvers/zod\"\n     8→import { z } from \"zod\"\n     9→import { toast } from \"sonner\"\n    10→\n    11→const profileSchema = z.object({\n    12→  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(100),\n    13→  specialty: z.string().max(100).optional().nullable(),\n    14→  appointmentDuration: z\n    15→    .number()\n    16→    .int()\n    17→    .min(15, \"Duração mínima é 15 minutos\")\n    18→    .max(180, \"Duração máxima é 180 minutos\")\n    19→    .optional(),\n    20→})\n    21→\n    22→type ProfileFormData = z.infer<typeof profileSchema>\n    23→\n    24→interface UserProfile {\n    25→  id: string\n    26→  email: string\n    27→  name: string\n    28→  role: string\n    29→  createdAt: string\n    30→  clinic: {\n    31→    id: string\n    32→    name: string\n    33→    phone: string | null\n    34→  }\n    35→  professionalProfile: {\n    36→    id: string\n    37→    specialty: string | null\n    38→    registrationNumber: string | null\n    39→    bio: string | null\n    40→    appointmentDuration: number\n    41→    bufferBetweenSlots: number\n    42→    allowOnlineBooking: boolean\n    43→    maxAdvanceBookingDays: number\n    44→  } | null\n    45→}\n    46→\n    47→export default function ProfilePage() {\n    48→  const router = useRouter()\n    49→  const { status } = useSession()\n    50→  const [isLoading, setIsLoading] = useState(true)\n    51→  const [isSaving, setIsSaving] = useState(false)\n    52→  const [user, setUser] = useState<UserProfile | null>(null)\n    53→\n    54→  const {\n    55→    register,\n    56→    handleSubmit,\n    57→    reset,\n    58→    formState: { errors, isDirty },\n    59→  } = useForm<ProfileFormData>({\n    60→    resolver: zodResolver(profileSchema),\n    61→  })\n    62→\n    63→  const fetchProfile = useCallback(async () => {\n    64→    try {\n    65→      const response = await fetch(\"/api/me\")\n    66→      if (!response.ok) {\n    67→        throw new Error(\"Failed to fetch profile\")\n    68→      }\n    69→      const data = await response.json()\n    70→      setUser(data.user)\n    71→      reset({\n    72→        name: data.user.name,\n    73→        specialty: data.user.professionalProfile?.specialty ?? \"\",\n    74→        appointmentDuration: data.user.professionalProfile?.appointmentDuration ?? 50,\n    75→      })\n    76→    } catch {\n    77→      toast.error(\"Erro ao carregar perfil\")\n    78→    } finally {\n    79→      setIsLoading(false)\n    80→    }\n    81→  }, [reset])\n    82→\n    83→  useEffect(() => {\n    84→    if (status === \"unauthenticated\") {\n    85→      router.push(\"/login\")\n    86→      return\n    87→    }\n    88→\n    89→    if (status === \"authenticated\") {\n    90→      fetchProfile()\n    91→    }\n    92→  }, [status, router, fetchProfile])\n    93→\n    94→  async function onSubmit(data: ProfileFormData) {\n    95→    setIsSaving(true)\n    96→    try {\n    97→      const response = await fetch(\"/api/me\", {\n    98→        method: \"PATCH\",\n    99→        headers: { \"Content-Type\": \"application/json\" },\n   100→        body: JSON.stringify({\n   101→          name: data.name,\n   102→          specialty: data.specialty || null,\n   103→          appointmentDuration: data.appointmentDuration,\n   104→        }),\n   105→      })\n   106→\n   107→      if (!response.ok) {\n   108→        const error = await response.json()\n   109→        throw new Error(error.message || \"Failed to update profile\")\n   110→      }\n   111→\n   112→      const result = await response.json()\n   113→      setUser(result.user)\n   114→      reset({\n   115→        name: result.user.name,\n   116→        specialty: result.user.professionalProfile?.specialty ?? \"\",\n   117→        appointmentDuration: result.user.professionalProfile?.appointmentDuration ?? 50,\n   118→      })\n   119→      toast.success(\"Perfil atualizado com sucesso\")\n   120→    } catch (error) {\n   121→      toast.error(error instanceof Error ? error.message : \"Erro ao atualizar perfil\")\n   122→    } finally {\n   123→      setIsSaving(false)\n   124→    }\n   125→  }\n   126→\n   127→  if (status === \"loading\" || isLoading) {\n   128→    return (\n   129→      <main className=\"min-h-screen bg-background\">\n   130→        <div className=\"max-w-2xl mx-auto px-4 py-8\">\n   131→          <div className=\"animate-pulse space-y-6\">\n   132→            <div className=\"h-8 w-32 bg-muted rounded\" />\n   133→            <div className=\"bg-card border border-border rounded-lg p-6 space-y-4\">\n   134→              <div className=\"h-4 w-24 bg-muted rounded\" />\n   135→              <div className=\"h-12 bg-muted rounded\" />\n   136→              <div className=\"h-4 w-24 bg-muted rounded\" />\n   137→              <div className=\"h-12 bg-muted rounded\" />\n   138→            </div>\n   139→          </div>\n   140→        </div>\n   141→      </main>\n   142→    )\n   143→  }\n   144→\n   145→  if (!user) {\n   146→    return null\n   147→  }\n   148→\n   149→  const isProfessional = user.role === \"PROFESSIONAL\" && user.professionalProfile\n   150→\n   151→  return (\n   152→    <main className=\"min-h-screen bg-background\">\n   153→      <div className=\"max-w-2xl mx-auto px-4 py-8\">\n   154→        <div className=\"mb-6\">\n   155→          <button\n   156→            onClick={() => router.back()}\n   157→            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n   158→          >\n   159→            &larr; Voltar\n   160→          </button>\n   161→        </div>\n   162→\n   163→        <h1 className=\"text-2xl font-semibold text-foreground mb-6\">Meu Perfil</h1>\n   164→\n   165→        <div className=\"bg-card border border-border rounded-lg p-6 sm:p-8\">\n   166→          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n   167→            <div>\n   168→              <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n   169→                Email\n   170→              </label>\n   171→              <input\n   172→                id=\"email\"\n   173→                type=\"email\"\n   174→                value={user.email}\n   175→                disabled\n   176→                className=\"w-full h-12 px-4 rounded-md border border-input bg-muted text-muted-foreground cursor-not-allowed\"\n   177→              />\n   178→              <p className=\"text-xs text-muted-foreground mt-1\">O email não pode ser alterado</p>\n   179→            </div>\n   180→\n   181→            <div>\n   182→              <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n   183→                Nome\n   184→              </label>\n   185→              <input\n   186→                id=\"name\"\n   187→                type=\"text\"\n   188→                {...register(\"name\")}\n   189→                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   190→              />\n   191→              {errors.name && (\n   192→                <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n   193→              )}\n   194→            </div>\n   195→\n   196→            <div>\n   197→              <label htmlFor=\"clinic\" className=\"block text-sm font-medium text-foreground mb-2\">\n   198→                Clínica\n   199→              </label>\n   200→              <input\n   201→                id=\"clinic\"\n   202→                type=\"text\"\n   203→                value={user.clinic.name}\n   204→                disabled\n   205→                className=\"w-full h-12 px-4 rounded-md border border-input bg-muted text-muted-foreground cursor-not-allowed\"\n   206→              />\n   207→            </div>\n   208→\n   209→            {isProfessional && (\n   210→              <>\n   211→                <hr className=\"border-border\" />\n   212→\n   213→                <h2 className=\"text-lg font-medium text-foreground\">Perfil Profissional</h2>\n   214→\n   215→                <div>\n   216→                  <label\n   217→                    htmlFor=\"specialty\"\n   218→                    className=\"block text-sm font-medium text-foreground mb-2\"\n   219→                  >\n   220→                    Especialidade\n   221→                  </label>\n   222→                  <input\n   223→                    id=\"specialty\"\n   224→                    type=\"text\"\n   225→                    {...register(\"specialty\")}\n   226→                    placeholder=\"Ex: Psicologia Clínica\"\n   227→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   228→                  />\n   229→                  {errors.specialty && (\n   230→                    <p className=\"text-sm text-destructive mt-1\">{errors.specialty.message}</p>\n   231→                  )}\n   232→                </div>\n   233→\n   234→                <div>\n   235→                  <label\n   236→                    htmlFor=\"appointmentDuration\"\n   237→                    className=\"block text-sm font-medium text-foreground mb-2\"\n   238→                  >\n   239→                    Duração padrão da sessão (minutos)\n   240→                  </label>\n   241→                  <input\n   242→                    id=\"appointmentDuration\"\n   243→                    type=\"number\"\n   244→                    min={15}\n   245→                    max={180}\n   246→                    {...register(\"appointmentDuration\")}\n   247→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   248→                  />\n   249→                  {errors.appointmentDuration && (\n   250→                    <p className=\"text-sm text-destructive mt-1\">\n   251→                      {errors.appointmentDuration.message}\n   252→                    </p>\n   253→                  )}\n   254→                  <p className=\"text-xs text-muted-foreground mt-1\">\n   255→                    Tempo padrão para novos agendamentos (15-180 minutos)\n   256→                  </p>\n   257→                </div>\n   258→\n   259→                {user.professionalProfile?.registrationNumber && (\n   260→                  <div>\n   261→                    <label className=\"block text-sm font-medium text-foreground mb-2\">\n   262→                      Registro Profissional\n   263→                    </label>\n   264→                    <input\n   265→                      type=\"text\"\n   266→                      value={user.professionalProfile.registrationNumber}\n   267→                      disabled\n   268→                      className=\"w-full h-12 px-4 rounded-md border border-input bg-muted text-muted-foreground cursor-not-allowed\"\n   269→                    />\n   270→                  </div>\n   271→                )}\n   272→              </>\n   273→            )}\n   274→\n   275→            <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n   276→              <button\n   277→                type=\"submit\"\n   278→                disabled={isSaving || !isDirty}\n   279→                className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n   280→              >\n   281→                {isSaving ? \"Salvando...\" : \"Salvar alterações\"}\n   282→              </button>\n   283→              <button\n   284→                type=\"button\"\n   285→                onClick={() => router.back()}\n   286→                className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   287→              >\n   288→                Cancelar\n   289→              </button>\n   290→            </div>\n   291→          </form>\n   292→        </div>\n   293→\n   294→        <div className=\"mt-6 text-center text-sm text-muted-foreground\">\n   295→          <p>\n   296→            Membro desde{\" \"}\n   297→            {new Date(user.createdAt).toLocaleDateString(\"pt-BR\", {\n   298→              month: \"long\",\n   299→              year: \"numeric\",\n   300→            })}\n   301→          </p>\n   302→        </div>\n   303→      </div>\n   304→    </main>\n   305→  )\n   306→}\n   307→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"24c4e56d-c1a1-4e99-a7bd-39dc929205a9"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PnoXPxCH4o839fEeyVgPbq","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { useCallback, useEffect, useState, useRef } from \"react\"\n     4→import { useRouter } from \"next/navigation\"\n     5→import { useSession } from \"next-auth/react\"\n     6→import { useForm } from \"react-hook-form\"\n     7→import { zodResolver } from \"@hookform/resolvers/zod\"\n     8→import { z } from \"zod\"\n     9→import { toast } from \"sonner\"\n    10→\n    11→const timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n    12→\n    13→const appointmentSchema = z.object({\n    14→  patientId: z.string().min(1, \"Selecione um paciente\"),\n    15→  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n    16→  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n    17→  duration: z.number().int().min(15).max(480).optional(),\n    18→  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n    19→  notes: z.string().max(2000).optional().nullable(),\n    20→})\n    21→\n    22→const editAppointmentSchema = z.object({\n    23→  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n    24→  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n    25→  duration: z.number().int().min(15).max(480).optional(),\n    26→  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n    27→  notes: z.string().max(2000).optional().nullable(),\n    28→  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n    29→})\n    30→\n    31→type AppointmentFormData = z.infer<typeof appointmentSchema>\n    32→type EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n    33→\n    34→interface Patient {\n    35→  id: string\n    36→  name: string\n    37→  phone: string\n    38→  email: string | null\n    39→}\n    40→\n    41→interface Professional {\n    42→  id: string\n    43→  name: string\n    44→  professionalProfile: {\n    45→    id: string\n    46→    specialty: string | null\n    47→    appointmentDuration: number\n    48→  } | null\n    49→}\n    50→\n    51→interface AvailabilityRule {\n    52→  id: string\n    53→  dayOfWeek: number\n    54→  startTime: string\n    55→  endTime: string\n    56→  isActive: boolean\n    57→}\n    58→\n    59→interface AvailabilityException {\n    60→  id: string\n    61→  date: string\n    62→  isAvailable: boolean\n    63→  startTime: string | null\n    64→  endTime: string | null\n    65→  reason: string | null\n    66→}\n    67→\n    68→interface Appointment {\n    69→  id: string\n    70→  scheduledAt: string\n    71→  endAt: string\n    72→  status: string\n    73→  modality: string\n    74→  notes: string | null\n    75→  price: string | null\n    76→  cancellationReason: string | null\n    77→  cancelledAt: string | null\n    78→  patient: {\n    79→    id: string\n    80→    name: string\n    81→    email: string | null\n    82→    phone: string\n    83→    consentWhatsApp?: boolean\n    84→    consentEmail?: boolean\n    85→  }\n    86→  professionalProfile: {\n    87→    id: string\n    88→    user: {\n    89→      name: string\n    90→    }\n    91→  }\n    92→}\n    93→\n    94→interface TimeSlot {\n    95→  time: string\n    96→  isAvailable: boolean\n    97→  appointment: Appointment | null\n    98→  isBlocked: boolean\n    99→  blockReason?: string\n   100→}\n   101→\n   102→const statusLabels: Record<string, string> = {\n   103→  AGENDADO: \"Agendado\",\n   104→  CONFIRMADO: \"Confirmado\",\n   105→  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n   106→  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n   107→  NAO_COMPARECEU: \"Nao compareceu\",\n   108→  FINALIZADO: \"Finalizado\",\n   109→}\n   110→\n   111→const statusColors: Record<string, string> = {\n   112→  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n   113→  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n   114→  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n   115→  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n   116→  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n   117→  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n   118→}\n   119→\n   120→const statusBorderColors: Record<string, string> = {\n   121→  AGENDADO: \"border-l-blue-500\",\n   122→  CONFIRMADO: \"border-l-green-500\",\n   123→  CANCELADO_PACIENTE: \"border-l-red-500\",\n   124→  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n   125→  NAO_COMPARECEU: \"border-l-yellow-500\",\n   126→  FINALIZADO: \"border-l-gray-500\",\n   127→}\n   128→\n   129→function formatTime(time: string): string {\n   130→  return time.slice(0, 5)\n   131→}\n   132→\n   133→function formatDateHeader(date: Date): string {\n   134→  const today = new Date()\n   135→  today.setHours(0, 0, 0, 0)\n   136→  const dateOnly = new Date(date)\n   137→  dateOnly.setHours(0, 0, 0, 0)\n   138→\n   139→  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n   140→\n   141→  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n   142→  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n   143→    day: \"2-digit\",\n   144→    month: \"2-digit\",\n   145→    year: \"numeric\",\n   146→  })\n   147→\n   148→  if (diffDays === 0) return `Hoje, ${formattedDate}`\n   149→  if (diffDays === 1) return `Amanha, ${formattedDate}`\n   150→  if (diffDays === -1) return `Ontem, ${formattedDate}`\n   151→\n   152→  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n   153→}\n   154→\n   155→function formatPhone(phone: string): string {\n   156→  const digits = phone.replace(/\\D/g, \"\")\n   157→  if (digits.length === 11) {\n   158→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n   159→  }\n   160→  if (digits.length === 10) {\n   161→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n   162→  }\n   163→  return phone\n   164→}\n   165→\n   166→function toDateString(date: Date): string {\n   167→  return date.toISOString().split(\"T\")[0]\n   168→}\n   169→\n   170→export default function AgendaPage() {\n   171→  const router = useRouter()\n   172→  const { data: session, status } = useSession()\n   173→  const [isLoading, setIsLoading] = useState(true)\n   174→  const [selectedDate, setSelectedDate] = useState(() => new Date())\n   175→  const [appointments, setAppointments] = useState<Appointment[]>([])\n   176→  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n   177→  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n   178→  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n   179→  const [professionals, setProfessionals] = useState<Professional[]>([])\n   180→  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n   181→  const [showDatePicker, setShowDatePicker] = useState(false)\n   182→  const [appointmentDuration, setAppointmentDuration] = useState(50)\n   183→\n   184→  // Touch gesture handling\n   185→  const touchStartX = useRef<number | null>(null)\n   186→  const touchEndX = useRef<number | null>(null)\n   187→  const containerRef = useRef<HTMLDivElement>(null)\n   188→\n   189→  // Appointment creation state\n   190→  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n   191→  const [patients, setPatients] = useState<Patient[]>([])\n   192→  const [patientSearch, setPatientSearch] = useState(\"\")\n   193→  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n   194→  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n   195→  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n   196→  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n   197→  const patientSearchRef = useRef<HTMLInputElement>(null)\n   198→\n   199→  // Appointment edit/detail state\n   200→  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n   201→  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n   202→  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n   203→\n   204→  // Cancel appointment state\n   205→  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n   206→  const [cancelReason, setCancelReason] = useState(\"\")\n   207→  const [notifyPatient, setNotifyPatient] = useState(true)\n   208→  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n   209→\n   210→  // Status update state\n   211→  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n   212→\n   213→  const {\n   214→    register,\n   215→    handleSubmit,\n   216→    reset,\n   217→    setValue,\n   218→    formState: { errors },\n   219→  } = useForm<AppointmentFormData>({\n   220→    resolver: zodResolver(appointmentSchema),\n   221→    defaultValues: {\n   222→      modality: \"PRESENCIAL\",\n   223→    },\n   224→  })\n   225→\n   226→  const {\n   227→    register: registerEdit,\n   228→    handleSubmit: handleSubmitEdit,\n   229→    reset: resetEdit,\n   230→    formState: { errors: editErrors },\n   231→  } = useForm<EditAppointmentFormData>({\n   232→    resolver: zodResolver(editAppointmentSchema),\n   233→  })\n   234→\n   235→  const isAdmin = session?.user?.role === \"ADMIN\"\n   236→  const currentProfessionalProfileId = session?.user?.professionalProfileId\n   237→\n   238→  // Get the professionalProfileId to use for API calls\n   239→  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n   240→    ? selectedProfessionalId\n   241→    : currentProfessionalProfileId\n   242→\n   243→  const fetchProfessionals = useCallback(async () => {\n   244→    if (!isAdmin) return\n   245→\n   246→    try {\n   247→      const response = await fetch(\"/api/professionals\")\n   248→      if (!response.ok) return\n   249→      const data = await response.json()\n   250→      setProfessionals(data.professionals)\n   251→    } catch {\n   252→      // Silently fail - professionals dropdown is optional\n   253→    }\n   254→  }, [isAdmin])\n   255→\n   256→  const fetchAppointments = useCallback(async () => {\n   257→    if (!activeProfessionalProfileId && !isAdmin) return\n   258→\n   259→    try {\n   260→      const params = new URLSearchParams({\n   261→        date: toDateString(selectedDate),\n   262→      })\n   263→\n   264→      if (isAdmin && selectedProfessionalId) {\n   265→        params.set(\"professionalProfileId\", selectedProfessionalId)\n   266→      }\n   267→\n   268→      const response = await fetch(`/api/appointments?${params.toString()}`)\n   269→      if (!response.ok) {\n   270→        if (response.status === 403) {\n   271→          toast.error(\"Acesso negado\")\n   272→          router.push(\"/login\")\n   273→          return\n   274→        }\n   275→        throw new Error(\"Failed to fetch appointments\")\n   276→      }\n   277→      const data = await response.json()\n   278→      setAppointments(data.appointments)\n   279→    } catch {\n   280→      toast.error(\"Erro ao carregar agenda\")\n   281→    }\n   282→  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n   283→\n   284→  const fetchAvailability = useCallback(async () => {\n   285→    if (!activeProfessionalProfileId) return\n   286→\n   287→    try {\n   288→      const params = new URLSearchParams()\n   289→      if (isAdmin && selectedProfessionalId) {\n   290→        params.set(\"professionalProfileId\", selectedProfessionalId)\n   291→      }\n   292→\n   293→      const response = await fetch(`/api/availability?${params.toString()}`)\n   294→      if (!response.ok) return\n   295→      const data = await response.json()\n   296→      setAvailabilityRules(data.rules)\n   297→\n   298→      // Also fetch the appointment duration from the professional's profile\n   299→      if (data.rules.length > 0) {\n   300→        // Try to get appointment duration from professionals list\n   301→        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n   302→        if (prof?.professionalProfile?.appointmentDuration) {\n   303→          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n   304→        }\n   305→      }\n   306→    } catch {\n   307→      // Silently fail - availability is optional\n   308→    }\n   309→  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n   310→\n   311→  const fetchAvailabilityExceptions = useCallback(async () => {\n   312→    if (!activeProfessionalProfileId) return\n   313→\n   314→    try {\n   315→      const params = new URLSearchParams({\n   316→        startDate: toDateString(selectedDate),\n   317→        endDate: toDateString(selectedDate),\n   318→      })\n   319→\n   320→      if (isAdmin && selectedProfessionalId) {\n   321→        params.set(\"professionalProfileId\", selectedProfessionalId)\n   322→      }\n   323→\n   324→      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n   325→      if (!response.ok) return\n   326→      const data = await response.json()\n   327→      setAvailabilityExceptions(data.exceptions)\n   328→    } catch {\n   329→      // Silently fail - exceptions are optional\n   330→    }\n   331→  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n   332→\n   333→  const searchPatients = useCallback(async (query: string) => {\n   334→    if (query.length < 2) {\n   335→      setPatients([])\n   336→      return\n   337→    }\n   338→\n   339→    setIsSearchingPatients(true)\n   340→    try {\n   341→      const params = new URLSearchParams({\n   342→        search: query,\n   343→        isActive: \"true\",\n   344→      })\n   345→\n   346→      const response = await fetch(`/api/patients?${params.toString()}`)\n   347→      if (!response.ok) return\n   348→      const data = await response.json()\n   349→      setPatients(data.patients)\n   350→    } catch {\n   351→      // Silently fail\n   352→    } finally {\n   353→      setIsSearchingPatients(false)\n   354→    }\n   355→  }, [])\n   356→\n   357→  // Debounced patient search\n   358→  useEffect(() => {\n   359→    const timer = setTimeout(() => {\n   360→      if (patientSearch) {\n   361→        searchPatients(patientSearch)\n   362→      }\n   363→    }, 300)\n   364→\n   365→    return () => clearTimeout(timer)\n   366→  }, [patientSearch, searchPatients])\n   367→\n   368→  function openCreateSheet(slotTime?: string) {\n   369→    setSelectedPatient(null)\n   370→    setPatientSearch(\"\")\n   371→    setPatients([])\n   372→    reset({\n   373→      patientId: \"\",\n   374→      date: toDateString(selectedDate),\n   375→      startTime: slotTime || \"\",\n   376→      modality: \"PRESENCIAL\",\n   377→      notes: \"\",\n   378→    })\n   379→    setIsCreateSheetOpen(true)\n   380→  }\n   381→\n   382→  function closeCreateSheet() {\n   383→    setIsCreateSheetOpen(false)\n   384→    setSelectedPatient(null)\n   385→    setPatientSearch(\"\")\n   386→    setPatients([])\n   387→  }\n   388→\n   389→  function selectPatient(patient: Patient) {\n   390→    setSelectedPatient(patient)\n   391→    setValue(\"patientId\", patient.id)\n   392→    setPatientSearch(patient.name)\n   393→    setShowPatientDropdown(false)\n   394→    setPatients([])\n   395→  }\n   396→\n   397→  function openEditSheet(appointment: Appointment) {\n   398→    setSelectedAppointment(appointment)\n   399→    const scheduledDate = new Date(appointment.scheduledAt)\n   400→    const endDate = new Date(appointment.endAt)\n   401→    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n   402→\n   403→    resetEdit({\n   404→      date: toDateString(scheduledDate),\n   405→      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n   406→      duration: durationMinutes,\n   407→      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n   408→      notes: appointment.notes || \"\",\n   409→      price: appointment.price ? parseFloat(appointment.price) : null,\n   410→    })\n   411→    setIsEditSheetOpen(true)\n   412→  }\n   413→\n   414→  function closeEditSheet() {\n   415→    setIsEditSheetOpen(false)\n   416→    setSelectedAppointment(null)\n   417→  }\n   418→\n   419→  async function onSubmitEdit(data: EditAppointmentFormData) {\n   420→    if (!selectedAppointment) return\n   421→\n   422→    setIsUpdatingAppointment(true)\n   423→\n   424→    try {\n   425→      // Calculate scheduledAt and endAt from date, startTime, and duration\n   426→      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n   427→      const scheduledAt = new Date(data.date + \"T12:00:00\")\n   428→      scheduledAt.setHours(hours, minutes, 0, 0)\n   429→\n   430→      const durationMinutes = data.duration || appointmentDuration\n   431→      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n   432→\n   433→      const body: Record<string, unknown> = {\n   434→        scheduledAt: scheduledAt.toISOString(),\n   435→        endAt: endAt.toISOString(),\n   436→        modality: data.modality,\n   437→        notes: data.notes || null,\n   438→        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n   439→      }\n   440→\n   441→      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n   442→        method: \"PATCH\",\n   443→        headers: { \"Content-Type\": \"application/json\" },\n   444→        body: JSON.stringify(body),\n   445→      })\n   446→\n   447→      const result = await response.json()\n   448→\n   449→      if (!response.ok) {\n   450→        toast.error(result.error || \"Erro ao atualizar agendamento\")\n   451→        return\n   452→      }\n   453→\n   454→      toast.success(\"Agendamento atualizado com sucesso\")\n   455→      closeEditSheet()\n   456→      fetchAppointments()\n   457→    } catch {\n   458→      toast.error(\"Erro ao atualizar agendamento\")\n   459→    } finally {\n   460→      setIsUpdatingAppointment(false)\n   461→    }\n   462→  }\n   463→\n   464→  function openCancelDialog() {\n   465→    setCancelReason(\"\")\n   466→    setNotifyPatient(true)\n   467→    setIsCancelDialogOpen(true)\n   468→  }\n   469→\n   470→  function closeCancelDialog() {\n   471→    setIsCancelDialogOpen(false)\n   472→    setCancelReason(\"\")\n   473→    setNotifyPatient(true)\n   474→  }\n   475→\n   476→  async function handleCancelAppointment() {\n   477→    if (!selectedAppointment) return\n   478→\n   479→    if (!cancelReason.trim()) {\n   480→      toast.error(\"Informe o motivo do cancelamento\")\n   481→      return\n   482→    }\n   483→\n   484→    setIsCancellingAppointment(true)\n   485→\n   486→    try {\n   487→      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n   488→        method: \"POST\",\n   489→        headers: { \"Content-Type\": \"application/json\" },\n   490→        body: JSON.stringify({\n   491→          reason: cancelReason.trim(),\n   492→          notifyPatient,\n   493→        }),\n   494→      })\n   495→\n   496→      const result = await response.json()\n   497→\n   498→      if (!response.ok) {\n   499→        toast.error(result.error || \"Erro ao cancelar agendamento\")\n   500→        return\n   501→      }\n   502→\n   503→      toast.success(\"Agendamento cancelado com sucesso\")\n   504→      if (result.notificationCreated) {\n   505→        toast.success(\"Notificacao enviada ao paciente\")\n   506→      }\n   507→      closeCancelDialog()\n   508→      closeEditSheet()\n   509→      fetchAppointments()\n   510→    } catch {\n   511→      toast.error(\"Erro ao cancelar agendamento\")\n   512→    } finally {\n   513→      setIsCancellingAppointment(false)\n   514→    }\n   515→  }\n   516→\n   517→  // Check if appointment can be cancelled\n   518→  function canCancelAppointment(appointment: Appointment | null): boolean {\n   519→    if (!appointment) return false\n   520→    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n   521→  }\n   522→\n   523→  // Check if patient has notification consent\n   524→  function hasNotificationConsent(appointment: Appointment | null): boolean {\n   525→    if (!appointment) return false\n   526→    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n   527→  }\n   528→\n   529→  // Check if appointment can be marked as finalized or no-show\n   530→  function canMarkStatus(appointment: Appointment | null): boolean {\n   531→    if (!appointment) return false\n   532→    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n   533→  }\n   534→\n   535→  // Update appointment status\n   536→  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n   537→    if (!selectedAppointment) return\n   538→\n   539→    setIsUpdatingStatus(true)\n   540→\n   541→    try {\n   542→      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n   543→        method: \"PATCH\",\n   544→        headers: { \"Content-Type\": \"application/json\" },\n   545→        body: JSON.stringify({ status: newStatus }),\n   546→      })\n   547→\n   548→      const result = await response.json()\n   549→\n   550→      if (!response.ok) {\n   551→        toast.error(result.error || \"Erro ao atualizar status\")\n   552→        return\n   553→      }\n   554→\n   555→      toast.success(successMessage)\n   556→      closeEditSheet()\n   557→      fetchAppointments()\n   558→    } catch {\n   559→      toast.error(\"Erro ao atualizar status\")\n   560→    } finally {\n   561→      setIsUpdatingStatus(false)\n   562→    }\n   563→  }\n   564→\n   565→  async function handleFinalizarAppointment() {\n   566→    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n   567→  }\n   568→\n   569→  async function handleNaoCompareceuAppointment() {\n   570→    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n   571→  }\n   572→\n   573→  async function onSubmitAppointment(data: AppointmentFormData) {\n   574→    setIsSavingAppointment(true)\n   575→\n   576→    try {\n   577→      const body: Record<string, unknown> = {\n   578→        patientId: data.patientId,\n   579→        date: data.date,\n   580→        startTime: data.startTime,\n   581→        modality: data.modality,\n   582→        notes: data.notes || null,\n   583→      }\n   584→\n   585→      // If admin and has selected a professional, include it\n   586→      if (isAdmin && selectedProfessionalId) {\n   587→        body.professionalProfileId = selectedProfessionalId\n   588→      }\n   589→\n   590→      // Include duration if different from default\n   591→      if (data.duration) {\n   592→        body.duration = data.duration\n   593→      }\n   594→\n   595→      const response = await fetch(\"/api/appointments\", {\n   596→        method: \"POST\",\n   597→        headers: { \"Content-Type\": \"application/json\" },\n   598→        body: JSON.stringify(body),\n   599→      })\n   600→\n   601→      const result = await response.json()\n   602→\n   603→      if (!response.ok) {\n   604→        toast.error(result.error || \"Erro ao criar agendamento\")\n   605→        return\n   606→      }\n   607→\n   608→      toast.success(\"Agendamento criado com sucesso\")\n   609→      closeCreateSheet()\n   610→      fetchAppointments()\n   611→    } catch {\n   612→      toast.error(\"Erro ao criar agendamento\")\n   613→    } finally {\n   614→      setIsSavingAppointment(false)\n   615→    }\n   616→  }\n   617→\n   618→  // Generate time slots based on availability\n   619→  const generateTimeSlots = useCallback(() => {\n   620→    const dayOfWeek = selectedDate.getDay()\n   621→    const dateStr = toDateString(selectedDate)\n   622→\n   623→    // Get active rules for this day of week\n   624→    const dayRules = availabilityRules.filter(\n   625→      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n   626→    )\n   627→\n   628→    // Check for full-day exception (block)\n   629→    const fullDayException = availabilityExceptions.find(\n   630→      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n   631→    )\n   632→\n   633→    if (fullDayException) {\n   634→      setTimeSlots([])\n   635→      return\n   636→    }\n   637→\n   638→    // If no availability rules for this day, show empty\n   639→    if (dayRules.length === 0) {\n   640→      setTimeSlots([])\n   641→      return\n   642→    }\n   643→\n   644→    // Generate slots based on availability rules\n   645→    const slots: TimeSlot[] = []\n   646→    const slotDuration = appointmentDuration\n   647→\n   648→    for (const rule of dayRules) {\n   649→      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n   650→      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n   651→\n   652→      let currentMinutes = startHour * 60 + startMin\n   653→      const endMinutes = endHour * 60 + endMin\n   654→\n   655→      while (currentMinutes + slotDuration <= endMinutes) {\n   656→        const hour = Math.floor(currentMinutes / 60)\n   657→        const min = currentMinutes % 60\n   658→        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n   659→\n   660→        // Check for time-specific exception\n   661→        const exception = availabilityExceptions.find((ex) => {\n   662→          if (toDateString(new Date(ex.date)) !== dateStr) return false\n   663→          if (!ex.startTime || !ex.endTime) return false\n   664→          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n   665→        })\n   666→\n   667→        // Find matching appointment\n   668→        const appointment = appointments.find((apt) => {\n   669→          const aptTime = new Date(apt.scheduledAt)\n   670→          const aptHour = aptTime.getHours()\n   671→          const aptMin = aptTime.getMinutes()\n   672→          return aptHour === hour && aptMin === min\n   673→        })\n   674→\n   675→        slots.push({\n   676→          time: timeStr,\n   677→          isAvailable: !exception && !appointment,\n   678→          appointment: appointment || null,\n   679→          isBlocked: !!exception,\n   680→          blockReason: exception?.reason || undefined,\n   681→        })\n   682→\n   683→        currentMinutes += slotDuration\n   684→      }\n   685→    }\n   686→\n   687→    // Sort slots by time\n   688→    slots.sort((a, b) => a.time.localeCompare(b.time))\n   689→    setTimeSlots(slots)\n   690→  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n   691→\n   692→  // Touch gesture handlers\n   693→  function handleTouchStart(e: React.TouchEvent) {\n   694→    touchStartX.current = e.touches[0].clientX\n   695→  }\n   696→\n   697→  function handleTouchMove(e: React.TouchEvent) {\n   698→    touchEndX.current = e.touches[0].clientX\n   699→  }\n   700→\n   701→  function handleTouchEnd() {\n   702→    if (!touchStartX.current || !touchEndX.current) return\n   703→\n   704→    const diff = touchStartX.current - touchEndX.current\n   705→    const threshold = 50 // Minimum swipe distance\n   706→\n   707→    if (Math.abs(diff) > threshold) {\n   708→      if (diff > 0) {\n   709→        // Swipe left - next day\n   710→        goToNextDay()\n   711→      } else {\n   712→        // Swipe right - previous day\n   713→        goToPreviousDay()\n   714→      }\n   715→    }\n   716→\n   717→    touchStartX.current = null\n   718→    touchEndX.current = null\n   719→  }\n   720→\n   721→  function goToPreviousDay() {\n   722→    setSelectedDate((prev) => {\n   723→      const newDate = new Date(prev)\n   724→      newDate.setDate(newDate.getDate() - 1)\n   725→      return newDate\n   726→    })\n   727→  }\n   728→\n   729→  function goToNextDay() {\n   730→    setSelectedDate((prev) => {\n   731→      const newDate = new Date(prev)\n   732→      newDate.setDate(newDate.getDate() + 1)\n   733→      return newDate\n   734→    })\n   735→  }\n   736→\n   737→  function goToToday() {\n   738→    setSelectedDate(new Date())\n   739→    setShowDatePicker(false)\n   740→  }\n   741→\n   742→  // Initial load\n   743→  useEffect(() => {\n   744→    if (status === \"unauthenticated\") {\n   745→      router.push(\"/login\")\n   746→      return\n   747→    }\n   748→\n   749→    if (status === \"authenticated\") {\n   750→      setIsLoading(false)\n   751→      fetchProfessionals()\n   752→    }\n   753→  }, [status, router, fetchProfessionals])\n   754→\n   755→  // Fetch data when date or professional changes\n   756→  useEffect(() => {\n   757→    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n   758→      fetchAppointments()\n   759→      fetchAvailability()\n   760→      fetchAvailabilityExceptions()\n   761→    }\n   762→  }, [\n   763→    status,\n   764→    selectedDate,\n   765→    activeProfessionalProfileId,\n   766→    isAdmin,\n   767→    fetchAppointments,\n   768→    fetchAvailability,\n   769→    fetchAvailabilityExceptions,\n   770→  ])\n   771→\n   772→  // Generate slots when data changes\n   773→  useEffect(() => {\n   774→    generateTimeSlots()\n   775→  }, [generateTimeSlots])\n   776→\n   777→  if (status === \"loading\" || isLoading) {\n   778→    return (\n   779→      <main className=\"min-h-screen bg-background pb-20\">\n   780→        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   781→          <div className=\"animate-pulse space-y-6\">\n   782→            <div className=\"h-12 w-full bg-muted rounded\" />\n   783→            <div className=\"space-y-4\">\n   784→              {[1, 2, 3, 4, 5].map((i) => (\n   785→                <div key={i} className=\"h-16 bg-muted rounded\" />\n   786→              ))}\n   787→            </div>\n   788→          </div>\n   789→        </div>\n   790→      </main>\n   791→    )\n   792→  }\n   793→\n   794→  return (\n   795→    <main className=\"min-h-screen bg-background pb-20\">\n   796→      {/* Header */}\n   797→      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n   798→        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n   799→          {/* Date Header - Tappable */}\n   800→          <button\n   801→            onClick={() => setShowDatePicker(!showDatePicker)}\n   802→            className=\"w-full text-left mb-3\"\n   803→          >\n   804→            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n   805→              {formatDateHeader(selectedDate)}\n   806→              <svg\n   807→                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n   808→                fill=\"none\"\n   809→                stroke=\"currentColor\"\n   810→                viewBox=\"0 0 24 24\"\n   811→              >\n   812→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n   813→              </svg>\n   814→            </h1>\n   815→          </button>\n   816→\n   817→          {/* Professional Filter - ADMIN only */}\n   818→          {isAdmin && professionals.length > 0 && (\n   819→            <select\n   820→              value={selectedProfessionalId}\n   821→              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n   822→              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   823→            >\n   824→              <option value=\"\">Todos os profissionais</option>\n   825→              {professionals.map((prof) => (\n   826→                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n   827→                  {prof.name}\n   828→                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n   829→                </option>\n   830→              ))}\n   831→            </select>\n   832→          )}\n   833→        </div>\n   834→\n   835→        {/* Date Picker Dropdown */}\n   836→        {showDatePicker && (\n   837→          <div className=\"border-t border-border bg-card\">\n   838→            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n   839→              <div className=\"flex items-center justify-between mb-4\">\n   840→                <button\n   841→                  onClick={goToPreviousDay}\n   842→                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n   843→                >\n   844→                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   845→                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n   846→                  </svg>\n   847→                </button>\n   848→                <button\n   849→                  onClick={goToToday}\n   850→                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n   851→                >\n   852→                  Hoje\n   853→                </button>\n   854→                <button\n   855→                  onClick={goToNextDay}\n   856→                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n   857→                >\n   858→                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   859→                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n   860→                  </svg>\n   861→                </button>\n   862→              </div>\n   863→              <input\n   864→                type=\"date\"\n   865→                value={toDateString(selectedDate)}\n   866→                onChange={(e) => {\n   867→                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n   868→                  setShowDatePicker(false)\n   869→                }}\n   870→                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   871→              />\n   872→            </div>\n   873→          </div>\n   874→        )}\n   875→      </header>\n   876→\n   877→      {/* Timeline Content */}\n   878→      <div\n   879→        ref={containerRef}\n   880→        onTouchStart={handleTouchStart}\n   881→        onTouchMove={handleTouchMove}\n   882→        onTouchEnd={handleTouchEnd}\n   883→        className=\"max-w-4xl mx-auto px-4 py-4\"\n   884→      >\n   885→        {/* Day navigation hint */}\n   886→        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n   887→          Deslize para esquerda ou direita para mudar o dia\n   888→        </p>\n   889→\n   890→        {/* No availability message */}\n   891→        {timeSlots.length === 0 && (\n   892→          <div className=\"text-center py-12\">\n   893→            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n   894→              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   895→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n   896→              </svg>\n   897→            </div>\n   898→            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n   899→              Sem disponibilidade\n   900→            </h3>\n   901→            <p className=\"text-sm text-muted-foreground\">\n   902→              {isAdmin && !selectedProfessionalId\n   903→                ? \"Selecione um profissional para ver a agenda\"\n   904→                : \"Nao ha horarios configurados para este dia\"}\n   905→            </p>\n   906→          </div>\n   907→        )}\n   908→\n   909→        {/* Timeline */}\n   910→        {timeSlots.length > 0 && (\n   911→          <div className=\"space-y-2\">\n   912→            {timeSlots.map((slot) => (\n   913→              <div\n   914→                key={slot.time}\n   915→                className={`flex items-stretch gap-3 min-h-[4rem] ${\n   916→                  slot.isBlocked ? \"opacity-50\" : \"\"\n   917→                }`}\n   918→              >\n   919→                {/* Time Column */}\n   920→                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n   921→                  {formatTime(slot.time)}\n   922→                </div>\n   923→\n   924→                {/* Slot Content */}\n   925→                {slot.appointment ? (\n   926→                  <button\n   927→                    type=\"button\"\n   928→                    onClick={() => openEditSheet(slot.appointment!)}\n   929→                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n   930→                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n   931→                    } ${\n   932→                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n   933→                    }`}\n   934→                  >\n   935→                    <div className=\"flex items-start justify-between gap-2\">\n   936→                      <div className=\"min-w-0 flex-1\">\n   937→                        <h4 className=\"font-medium text-foreground truncate\">\n   938→                          {slot.appointment.patient.name}\n   939→                        </h4>\n   940→                        <p className=\"text-sm text-muted-foreground\">\n   941→                          {formatPhone(slot.appointment.patient.phone)}\n   942→                        </p>\n   943→                        {isAdmin && (\n   944→                          <p className=\"text-xs text-muted-foreground mt-1\">\n   945→                            {slot.appointment.professionalProfile.user.name}\n   946→                          </p>\n   947→                        )}\n   948→                      </div>\n   949→                      <span\n   950→                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n   951→                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n   952→                        }`}\n   953→                      >\n   954→                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n   955→                      </span>\n   956→                    </div>\n   957→                    <div className=\"flex items-center gap-2 mt-2\">\n   958→                      <span className=\"text-xs text-muted-foreground\">\n   959→                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n   960→                      </span>\n   961→                      {slot.appointment.notes && (\n   962→                        <span className=\"text-xs text-muted-foreground truncate\">\n   963→                          • {slot.appointment.notes}\n   964→                        </span>\n   965→                      )}\n   966→                    </div>\n   967→                  </button>\n   968→                ) : slot.isBlocked ? (\n   969→                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n   970→                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n   971→                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   972→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n   973→                      </svg>\n   974→                      <span className=\"text-sm\">\n   975→                        {slot.blockReason || \"Bloqueado\"}\n   976→                      </span>\n   977→                    </div>\n   978→                  </div>\n   979→                ) : (\n   980→                  <button\n   981→                    onClick={() => openCreateSheet(slot.time)}\n   982→                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n   983→                  >\n   984→                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   985→                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n   986→                    </svg>\n   987→                    <span className=\"text-sm\">Disponivel</span>\n   988→                  </button>\n   989→                )}\n   990→              </div>\n   991→            ))}\n   992→          </div>\n   993→        )}\n   994→      </div>\n   995→\n   996→      {/* FAB - Floating Action Button */}\n   997→      <button\n   998→        onClick={() => openCreateSheet()}\n   999→        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n  1000→        aria-label=\"Novo agendamento\"\n  1001→      >\n  1002→        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1003→          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n  1004→        </svg>\n  1005→      </button>\n  1006→\n  1007→      {/* Create Appointment Sheet */}\n  1008→      {isCreateSheetOpen && (\n  1009→        <>\n  1010→          {/* Backdrop */}\n  1011→          <div\n  1012→            className=\"fixed inset-0 bg-black/50 z-40\"\n  1013→            onClick={closeCreateSheet}\n  1014→          />\n  1015→\n  1016→          {/* Sheet */}\n  1017→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n  1018→            {/* Handle */}\n  1019→            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n  1020→              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n  1021→              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n  1022→            </div>\n  1023→\n  1024→            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n  1025→              {/* Patient Selection */}\n  1026→              <div className=\"relative\">\n  1027→                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1028→                  Paciente *\n  1029→                </label>\n  1030→                <div className=\"relative\">\n  1031→                  <input\n  1032→                    ref={patientSearchRef}\n  1033→                    id=\"patientSearch\"\n  1034→                    type=\"text\"\n  1035→                    value={patientSearch}\n  1036→                    onChange={(e) => {\n  1037→                      setPatientSearch(e.target.value)\n  1038→                      setShowPatientDropdown(true)\n  1039→                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n  1040→                        setSelectedPatient(null)\n  1041→                        setValue(\"patientId\", \"\")\n  1042→                      }\n  1043→                    }}\n  1044→                    onFocus={() => setShowPatientDropdown(true)}\n  1045→                    placeholder=\"Digite o nome do paciente...\"\n  1046→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1047→                  />\n  1048→                  {isSearchingPatients && (\n  1049→                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n  1050→                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n  1051→                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n  1052→                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n  1053→                      </svg>\n  1054→                    </div>\n  1055→                  )}\n  1056→                </div>\n  1057→                <input type=\"hidden\" {...register(\"patientId\")} />\n  1058→\n  1059→                {/* Patient Dropdown */}\n  1060→                {showPatientDropdown && patients.length > 0 && (\n  1061→                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n  1062→                    {patients.map((patient) => (\n  1063→                      <button\n  1064→                        key={patient.id}\n  1065→                        type=\"button\"\n  1066→                        onClick={() => selectPatient(patient)}\n  1067→                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n  1068→                      >\n  1069→                        <div>\n  1070→                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n  1071→                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n  1072→                        </div>\n  1073→                        {selectedPatient?.id === patient.id && (\n  1074→                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n  1075→                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n  1076→                          </svg>\n  1077→                        )}\n  1078→                      </button>\n  1079→                    ))}\n  1080→                  </div>\n  1081→                )}\n  1082→\n  1083→                {/* No results */}\n  1084→                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n  1085→                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n  1086→                    Nenhum paciente encontrado\n  1087→                  </div>\n  1088→                )}\n  1089→\n  1090→                {errors.patientId && (\n  1091→                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n  1092→                )}\n  1093→\n  1094→                {selectedPatient && (\n  1095→                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n  1096→                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n  1097→                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n  1098→                    {selectedPatient.email && (\n  1099→                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n  1100→                    )}\n  1101→                  </div>\n  1102→                )}\n  1103→              </div>\n  1104→\n  1105→              {/* Date */}\n  1106→              <div>\n  1107→                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1108→                  Data *\n  1109→                </label>\n  1110→                <input\n  1111→                  id=\"date\"\n  1112→                  type=\"date\"\n  1113→                  {...register(\"date\")}\n  1114→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1115→                />\n  1116→                {errors.date && (\n  1117→                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n  1118→                )}\n  1119→              </div>\n  1120→\n  1121→              {/* Start Time */}\n  1122→              <div>\n  1123→                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1124→                  Horario *\n  1125→                </label>\n  1126→                <input\n  1127→                  id=\"startTime\"\n  1128→                  type=\"time\"\n  1129→                  {...register(\"startTime\")}\n  1130→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1131→                />\n  1132→                {errors.startTime && (\n  1133→                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n  1134→                )}\n  1135→              </div>\n  1136→\n  1137→              {/* Duration */}\n  1138→              <div>\n  1139→                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1140→                  Duracao (minutos)\n  1141→                </label>\n  1142→                <input\n  1143→                  id=\"duration\"\n  1144→                  type=\"number\"\n  1145→                  {...register(\"duration\", { valueAsNumber: true })}\n  1146→                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n  1147→                  min={15}\n  1148→                  max={480}\n  1149→                  step={5}\n  1150→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1151→                />\n  1152→                <p className=\"text-xs text-muted-foreground mt-1\">\n  1153→                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n  1154→                </p>\n  1155→                {errors.duration && (\n  1156→                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n  1157→                )}\n  1158→              </div>\n  1159→\n  1160→              {/* Modality */}\n  1161→              <div>\n  1162→                <label className=\"block text-sm font-medium text-foreground mb-2\">\n  1163→                  Modalidade *\n  1164→                </label>\n  1165→                <div className=\"grid grid-cols-2 gap-3\">\n  1166→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1167→                    <input\n  1168→                      type=\"radio\"\n  1169→                      value=\"PRESENCIAL\"\n  1170→                      {...register(\"modality\")}\n  1171→                      className=\"sr-only peer\"\n  1172→                    />\n  1173→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1174→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1175→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n  1176→                      </svg>\n  1177→                      <span className=\"text-sm font-medium\">Presencial</span>\n  1178→                    </div>\n  1179→                  </label>\n  1180→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1181→                    <input\n  1182→                      type=\"radio\"\n  1183→                      value=\"ONLINE\"\n  1184→                      {...register(\"modality\")}\n  1185→                      className=\"sr-only peer\"\n  1186→                    />\n  1187→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1188→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1189→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n  1190→                      </svg>\n  1191→                      <span className=\"text-sm font-medium\">Online</span>\n  1192→                    </div>\n  1193→                  </label>\n  1194→                </div>\n  1195→                {errors.modality && (\n  1196→                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n  1197→                )}\n  1198→              </div>\n  1199→\n  1200→              {/* Notes */}\n  1201→              <div>\n  1202→                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1203→                  Observacoes\n  1204→                </label>\n  1205→                <textarea\n  1206→                  id=\"notes\"\n  1207→                  rows={3}\n  1208→                  {...register(\"notes\")}\n  1209→                  placeholder=\"Observacoes sobre a consulta...\"\n  1210→                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n  1211→                />\n  1212→                {errors.notes && (\n  1213→                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n  1214→                )}\n  1215→              </div>\n  1216→\n  1217→              {/* Actions */}\n  1218→              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n  1219→                <button\n  1220→                  type=\"submit\"\n  1221→                  disabled={isSavingAppointment || !selectedPatient}\n  1222→                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n  1223→                >\n  1224→                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n  1225→                </button>\n  1226→                <button\n  1227→                  type=\"button\"\n  1228→                  onClick={closeCreateSheet}\n  1229→                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n  1230→                >\n  1231→                  Cancelar\n  1232→                </button>\n  1233→              </div>\n  1234→            </form>\n  1235→          </div>\n  1236→        </>\n  1237→      )}\n  1238→\n  1239→      {/* Edit Appointment Sheet */}\n  1240→      {isEditSheetOpen && selectedAppointment && (\n  1241→        <>\n  1242→          {/* Backdrop */}\n  1243→          <div\n  1244→            className=\"fixed inset-0 bg-black/50 z-40\"\n  1245→            onClick={closeEditSheet}\n  1246→          />\n  1247→\n  1248→          {/* Sheet */}\n  1249→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n  1250→            {/* Handle */}\n  1251→            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n  1252→              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n  1253→              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n  1254→            </div>\n  1255→\n  1256→            {/* Patient Info (read-only) */}\n  1257→            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n  1258→              <div className=\"flex items-start justify-between gap-3\">\n  1259→                <div>\n  1260→                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n  1261→                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n  1262→                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n  1263→                  {selectedAppointment.patient.email && (\n  1264→                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n  1265→                  )}\n  1266→                </div>\n  1267→                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n  1268→                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n  1269→                </span>\n  1270→              </div>\n  1271→              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n  1272→                Para alterar o paciente, cancele este agendamento e crie um novo.\n  1273→              </p>\n  1274→            </div>\n  1275→\n  1276→            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n  1277→              {/* Date */}\n  1278→              <div>\n  1279→                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1280→                  Data *\n  1281→                </label>\n  1282→                <input\n  1283→                  id=\"editDate\"\n  1284→                  type=\"date\"\n  1285→                  {...registerEdit(\"date\")}\n  1286→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1287→                />\n  1288→                {editErrors.date && (\n  1289→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n  1290→                )}\n  1291→              </div>\n  1292→\n  1293→              {/* Start Time */}\n  1294→              <div>\n  1295→                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1296→                  Horario *\n  1297→                </label>\n  1298→                <input\n  1299→                  id=\"editStartTime\"\n  1300→                  type=\"time\"\n  1301→                  {...registerEdit(\"startTime\")}\n  1302→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1303→                />\n  1304→                {editErrors.startTime && (\n  1305→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n  1306→                )}\n  1307→              </div>\n  1308→\n  1309→              {/* Duration */}\n  1310→              <div>\n  1311→                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1312→                  Duracao (minutos)\n  1313→                </label>\n  1314→                <input\n  1315→                  id=\"editDuration\"\n  1316→                  type=\"number\"\n  1317→                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n  1318→                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n  1319→                  min={15}\n  1320→                  max={480}\n  1321→                  step={5}\n  1322→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1323→                />\n  1324→                {editErrors.duration && (\n  1325→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n  1326→                )}\n  1327→              </div>\n  1328→\n  1329→              {/* Modality */}\n  1330→              <div>\n  1331→                <label className=\"block text-sm font-medium text-foreground mb-2\">\n  1332→                  Modalidade *\n  1333→                </label>\n  1334→                <div className=\"grid grid-cols-2 gap-3\">\n  1335→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1336→                    <input\n  1337→                      type=\"radio\"\n  1338→                      value=\"PRESENCIAL\"\n  1339→                      {...registerEdit(\"modality\")}\n  1340→                      className=\"sr-only peer\"\n  1341→                    />\n  1342→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1343→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1344→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n  1345→                      </svg>\n  1346→                      <span className=\"text-sm font-medium\">Presencial</span>\n  1347→                    </div>\n  1348→                  </label>\n  1349→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1350→                    <input\n  1351→                      type=\"radio\"\n  1352→                      value=\"ONLINE\"\n  1353→                      {...registerEdit(\"modality\")}\n  1354→                      className=\"sr-only peer\"\n  1355→                    />\n  1356→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1357→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1358→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n  1359→                      </svg>\n  1360→                      <span className=\"text-sm font-medium\">Online</span>\n  1361→                    </div>\n  1362→                  </label>\n  1363→                </div>\n  1364→                {editErrors.modality && (\n  1365→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n  1366→                )}\n  1367→              </div>\n  1368→\n  1369→              {/* Price */}\n  1370→              <div>\n  1371→                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1372→                  Valor (R$)\n  1373→                </label>\n  1374→                <input\n  1375→                  id=\"editPrice\"\n  1376→                  type=\"number\"\n  1377→                  step=\"0.01\"\n  1378→                  min=\"0\"\n  1379→                  {...registerEdit(\"price\", { valueAsNumber: true })}\n  1380→                  placeholder=\"Ex: 150.00\"\n  1381→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1382→                />\n  1383→                {editErrors.price && (\n  1384→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n  1385→                )}\n  1386→              </div>\n  1387→\n  1388→              {/* Notes */}\n  1389→              <div>\n  1390→                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1391→                  Observacoes\n  1392→                </label>\n  1393→                <textarea\n  1394→                  id=\"editNotes\"\n  1395→                  rows={3}\n  1396→                  {...registerEdit(\"notes\")}\n  1397→                  placeholder=\"Observacoes sobre a consulta...\"\n  1398→                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n  1399→                />\n  1400→                {editErrors.notes && (\n  1401→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n  1402→                )}\n  1403→              </div>\n  1404→\n  1405→              {/* Cancellation Info (for cancelled appointments) */}\n  1406→              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n  1407→                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n  1408→                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n  1409→                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n  1410→                  </p>\n  1411→                  {selectedAppointment.cancellationReason && (\n  1412→                    <p className=\"text-sm text-red-700\">\n  1413→                      Motivo: {selectedAppointment.cancellationReason}\n  1414→                    </p>\n  1415→                  )}\n  1416→                  {selectedAppointment.cancelledAt && (\n  1417→                    <p className=\"text-xs text-red-600 mt-1\">\n  1418→                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n  1419→                    </p>\n  1420→                  )}\n  1421→                </div>\n  1422→              )}\n  1423→\n  1424→              {/* Quick Actions (for active appointments) */}\n  1425→              {canMarkStatus(selectedAppointment) && (\n  1426→                <div className=\"border-t border-border pt-6\">\n  1427→                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n  1428→                  <div className=\"grid grid-cols-2 gap-3\">\n  1429→                    <button\n  1430→                      type=\"button\"\n  1431→                      onClick={handleFinalizarAppointment}\n  1432→                      disabled={isUpdatingStatus || isUpdatingAppointment}\n  1433→                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n  1434→                    >\n  1435→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1436→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n  1437→                      </svg>\n  1438→                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n  1439→                    </button>\n  1440→                    <button\n  1441→                      type=\"button\"\n  1442→                      onClick={handleNaoCompareceuAppointment}\n  1443→                      disabled={isUpdatingStatus || isUpdatingAppointment}\n  1444→                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n  1445→                    >\n  1446→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1447→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n  1448→                      </svg>\n  1449→                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n  1450→                    </button>\n  1451→                  </div>\n  1452→                </div>\n  1453→              )}\n  1454→\n  1455→              {/* Actions */}\n  1456→              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n  1457→                {canCancelAppointment(selectedAppointment) ? (\n  1458→                  <>\n  1459→                    <button\n  1460→                      type=\"submit\"\n  1461→                      disabled={isUpdatingAppointment || isUpdatingStatus}\n  1462→                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n  1463→                    >\n  1464→                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n  1465→                    </button>\n  1466→                    <button\n  1467→                      type=\"button\"\n  1468→                      onClick={openCancelDialog}\n  1469→                      disabled={isUpdatingStatus}\n  1470→                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n  1471→                    >\n  1472→                      Cancelar Agendamento\n  1473→                    </button>\n  1474→                  </>\n  1475→                ) : (\n  1476→                  <button\n  1477→                    type=\"button\"\n  1478→                    onClick={closeEditSheet}\n  1479→                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n  1480→                  >\n  1481→                    Fechar\n  1482→                  </button>\n  1483→                )}\n  1484→              </div>\n  1485→            </form>\n  1486→          </div>\n  1487→        </>\n  1488→      )}\n  1489→\n  1490→      {/* Cancel Confirmation Dialog */}\n  1491→      {isCancelDialogOpen && selectedAppointment && (\n  1492→        <>\n  1493→          {/* Backdrop */}\n  1494→          <div\n  1495→            className=\"fixed inset-0 bg-black/70 z-[60]\"\n  1496→            onClick={closeCancelDialog}\n  1497→          />\n  1498→\n  1499→          {/* Dialog */}\n  1500→          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n  1501→            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n  1502→              <div className=\"flex items-center gap-3 mb-4\">\n  1503→                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n  1504→                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1505→                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n  1506→                  </svg>\n  1507→                </div>\n  1508→                <h3 className=\"text-lg font-semibold text-foreground\">\n  1509→                  Cancelar Agendamento\n  1510→                </h3>\n  1511→              </div>\n  1512→\n  1513→              <p className=\"text-sm text-muted-foreground mb-4\">\n  1514→                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n  1515→                Esta acao nao pode ser desfeita.\n  1516→              </p>\n  1517→\n  1518→              {/* Cancellation Reason */}\n  1519→              <div className=\"mb-4\">\n  1520→                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1521→                  Motivo do cancelamento *\n  1522→                </label>\n  1523→                <textarea\n  1524→                  id=\"cancelReason\"\n  1525→                  rows={3}\n  1526→                  value={cancelReason}\n  1527→                  onChange={(e) => setCancelReason(e.target.value)}\n  1528→                  placeholder=\"Informe o motivo do cancelamento...\"\n  1529→                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n  1530→                />\n  1531→              </div>\n  1532→\n  1533→              {/* Notify Patient Option */}\n  1534→              {hasNotificationConsent(selectedAppointment) && (\n  1535→                <div className=\"mb-6\">\n  1536→                  <label className=\"flex items-center gap-3 cursor-pointer\">\n  1537→                    <input\n  1538→                      type=\"checkbox\"\n  1539→                      checked={notifyPatient}\n  1540→                      onChange={(e) => setNotifyPatient(e.target.checked)}\n  1541→                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n  1542→                    />\n  1543→                    <span className=\"text-sm text-foreground\">\n  1544→                      Notificar paciente sobre o cancelamento\n  1545→                    </span>\n  1546→                  </label>\n  1547→                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n  1548→                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n  1549→                  </p>\n  1550→                </div>\n  1551→              )}\n  1552→\n  1553→              {!hasNotificationConsent(selectedAppointment) && (\n  1554→                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n  1555→                  <p className=\"text-xs text-muted-foreground\">\n  1556→                    O paciente nao possui consentimento para receber notificacoes.\n  1557→                  </p>\n  1558→                </div>\n  1559→              )}\n  1560→\n  1561→              {/* Dialog Actions */}\n  1562→              <div className=\"flex gap-3\">\n  1563→                <button\n  1564→                  type=\"button\"\n  1565→                  onClick={closeCancelDialog}\n  1566→                  disabled={isCancellingAppointment}\n  1567→                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n  1568→                >\n  1569→                  Voltar\n  1570→                </button>\n  1571→                <button\n  1572→                  type=\"button\"\n  1573→                  onClick={handleCancelAppointment}\n  1574→                  disabled={isCancellingAppointment || !cancelReason.trim()}\n  1575→                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n  1576→                >\n  1577→                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n  1578→                </button>\n  1579→              </div>\n  1580→            </div>\n  1581→          </div>\n  1582→        </>\n  1583→      )}\n  1584→\n  1585→      {/* Bottom Navigation */}\n  1586→      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n  1587→        <div className=\"max-w-4xl mx-auto px-4\">\n  1588→          <div className=\"flex items-center justify-around h-16\">\n  1589→            <button\n  1590→              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n  1591→              onClick={() => router.push(\"/agenda\")}\n  1592→            >\n  1593→              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1594→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n  1595→              </svg>\n  1596→              <span className=\"text-xs font-medium\">Agenda</span>\n  1597→            </button>\n  1598→\n  1599→            <button\n  1600→              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n  1601→              onClick={() => router.push(\"/patients\")}\n  1602→            >\n  1603→              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1604→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n  1605→              </svg>\n  1606→              <span className=\"text-xs\">Pacientes</span>\n  1607→            </button>\n  1608→\n  1609→            <button\n  1610→              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n  1611→              onClick={() => router.push(\"/settings/availability\")}\n  1612→            >\n  1613→              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1614→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n  1615→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n  1616→              </svg>\n  1617→              <span className=\"text-xs\">Configuracoes</span>\n  1618→            </button>\n  1619→          </div>\n  1620→        </div>\n  1621→      </nav>\n  1622→\n  1623→      {/* Animation Styles */}\n  1624→      <style jsx>{`\n  1625→        @keyframes slide-up {\n  1626→          from {\n  1627→            transform: translateY(100%);\n  1628→          }\n  1629→          to {\n  1630→            transform: translateY(0);\n  1631→          }\n  1632→        }\n  1633→        .animate-slide-up {\n  1634→          animation: slide-up 0.3s ease-out;\n  1635→        }\n  1636→        @keyframes scale-in {\n  1637→          from {\n  1638→            opacity: 0;\n  1639→            transform: scale(0.95);\n  1640→          }\n  1641→          to {\n  1642→            opacity: 1;\n  1643→            transform: scale(1);\n  1644→          }\n  1645→        }\n  1646→        .animate-scale-in {\n  1647→          animation: scale-in 0.2s ease-out;\n  1648→        }\n  1649→      `}</style>\n  1650→    </main>\n  1651→  )\n  1652→}\n  1653→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a539a412-905f-41b3-8234-bc614608509c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RaNXvtwV2TnpSkG9FUojHb","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { useCallback, useEffect, useState } from \"react\"\n     4→import { useRouter } from \"next/navigation\"\n     5→import { useSession } from \"next-auth/react\"\n     6→import { useForm } from \"react-hook-form\"\n     7→import { zodResolver } from \"@hookform/resolvers/zod\"\n     8→import { z } from \"zod\"\n     9→import { toast } from \"sonner\"\n    10→\n    11→// WhatsApp format validation\n    12→const phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n    13→\n    14→const patientSchema = z.object({\n    15→  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n    16→  phone: z\n    17→    .string()\n    18→    .min(1, \"Telefone é obrigatório\")\n    19→    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n    20→  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n    21→  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n    22→  consentWhatsApp: z.boolean(),\n    23→  consentEmail: z.boolean(),\n    24→})\n    25→\n    26→type PatientFormData = z.infer<typeof patientSchema>\n    27→\n    28→interface Appointment {\n    29→  id: string\n    30→  scheduledAt: string\n    31→  endAt: string\n    32→  status: string\n    33→  modality: string\n    34→  notes: string | null\n    35→  professionalProfile: {\n    36→    id: string\n    37→    user: {\n    38→      name: string\n    39→    }\n    40→  }\n    41→}\n    42→\n    43→interface Patient {\n    44→  id: string\n    45→  name: string\n    46→  email: string | null\n    47→  phone: string\n    48→  birthDate: string | null\n    49→  notes: string | null\n    50→  isActive: boolean\n    51→  lastVisitAt: string | null\n    52→  consentWhatsApp: boolean\n    53→  consentWhatsAppAt: string | null\n    54→  consentEmail: boolean\n    55→  consentEmailAt: string | null\n    56→  createdAt: string\n    57→  appointments?: Appointment[]\n    58→}\n    59→\n    60→function formatPhone(phone: string): string {\n    61→  // Format: (11) 99999-9999\n    62→  const digits = phone.replace(/\\D/g, \"\")\n    63→  if (digits.length === 11) {\n    64→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n    65→  }\n    66→  if (digits.length === 10) {\n    67→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n    68→  }\n    69→  return phone\n    70→}\n    71→\n    72→function formatDate(dateString: string | null): string {\n    73→  if (!dateString) return \"-\"\n    74→  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n    75→}\n    76→\n    77→function formatDateTime(dateString: string): string {\n    78→  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    79→    day: \"2-digit\",\n    80→    month: \"2-digit\",\n    81→    year: \"numeric\",\n    82→    hour: \"2-digit\",\n    83→    minute: \"2-digit\",\n    84→  })\n    85→}\n    86→\n    87→const statusLabels: Record<string, string> = {\n    88→  AGENDADO: \"Agendado\",\n    89→  CONFIRMADO: \"Confirmado\",\n    90→  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n    91→  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n    92→  NAO_COMPARECEU: \"Não compareceu\",\n    93→  FINALIZADO: \"Finalizado\",\n    94→}\n    95→\n    96→const statusColors: Record<string, string> = {\n    97→  AGENDADO: \"bg-blue-100 text-blue-800\",\n    98→  CONFIRMADO: \"bg-green-100 text-green-800\",\n    99→  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n   100→  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n   101→  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n   102→  FINALIZADO: \"bg-gray-100 text-gray-800\",\n   103→}\n   104→\n   105→export default function PatientsPage() {\n   106→  const router = useRouter()\n   107→  const { data: session, status } = useSession()\n   108→  const [isLoading, setIsLoading] = useState(true)\n   109→  const [patients, setPatients] = useState<Patient[]>([])\n   110→  const [search, setSearch] = useState(\"\")\n   111→  const [filterActive, setFilterActive] = useState<string>(\"all\")\n   112→  const [isSheetOpen, setIsSheetOpen] = useState(false)\n   113→  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n   114→  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n   115→  const [isSaving, setIsSaving] = useState(false)\n   116→  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n   117→\n   118→  const isAdmin = session?.user?.role === \"ADMIN\"\n   119→\n   120→  const {\n   121→    register,\n   122→    handleSubmit,\n   123→    reset,\n   124→    formState: { errors },\n   125→  } = useForm<PatientFormData>({\n   126→    resolver: zodResolver(patientSchema),\n   127→    defaultValues: {\n   128→      consentWhatsApp: false,\n   129→      consentEmail: false,\n   130→    },\n   131→  })\n   132→\n   133→  const fetchPatients = useCallback(async () => {\n   134→    try {\n   135→      const params = new URLSearchParams()\n   136→      if (search) params.set(\"search\", search)\n   137→      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n   138→\n   139→      const response = await fetch(`/api/patients?${params.toString()}`)\n   140→      if (!response.ok) {\n   141→        if (response.status === 403) {\n   142→          toast.error(\"Acesso negado\")\n   143→          router.push(\"/\")\n   144→          return\n   145→        }\n   146→        throw new Error(\"Failed to fetch patients\")\n   147→      }\n   148→      const data = await response.json()\n   149→      setPatients(data.patients)\n   150→    } catch {\n   151→      toast.error(\"Erro ao carregar pacientes\")\n   152→    } finally {\n   153→      setIsLoading(false)\n   154→    }\n   155→  }, [search, filterActive, router])\n   156→\n   157→  const fetchPatientDetails = useCallback(async (patientId: string) => {\n   158→    setIsLoadingDetails(true)\n   159→    try {\n   160→      const response = await fetch(`/api/patients/${patientId}`)\n   161→      if (!response.ok) {\n   162→        throw new Error(\"Failed to fetch patient details\")\n   163→      }\n   164→      const data = await response.json()\n   165→      setViewingPatient(data.patient)\n   166→    } catch {\n   167→      toast.error(\"Erro ao carregar detalhes do paciente\")\n   168→    } finally {\n   169→      setIsLoadingDetails(false)\n   170→    }\n   171→  }, [])\n   172→\n   173→  useEffect(() => {\n   174→    if (status === \"unauthenticated\") {\n   175→      router.push(\"/login\")\n   176→      return\n   177→    }\n   178→\n   179→    if (status === \"authenticated\") {\n   180→      fetchPatients()\n   181→    }\n   182→  }, [status, router, fetchPatients])\n   183→\n   184→  function openCreateSheet() {\n   185→    setEditingPatient(null)\n   186→    setViewingPatient(null)\n   187→    reset({\n   188→      name: \"\",\n   189→      phone: \"\",\n   190→      email: \"\",\n   191→      notes: \"\",\n   192→      consentWhatsApp: false,\n   193→      consentEmail: false,\n   194→    })\n   195→    setIsSheetOpen(true)\n   196→  }\n   197→\n   198→  function openEditSheet(patient: Patient) {\n   199→    setEditingPatient(patient)\n   200→    setViewingPatient(null)\n   201→    reset({\n   202→      name: patient.name,\n   203→      phone: patient.phone,\n   204→      email: patient.email ?? \"\",\n   205→      notes: patient.notes ?? \"\",\n   206→      consentWhatsApp: patient.consentWhatsApp,\n   207→      consentEmail: patient.consentEmail,\n   208→    })\n   209→    setIsSheetOpen(true)\n   210→  }\n   211→\n   212→  function openViewSheet(patient: Patient) {\n   213→    setEditingPatient(null)\n   214→    fetchPatientDetails(patient.id)\n   215→    setIsSheetOpen(true)\n   216→  }\n   217→\n   218→  function closeSheet() {\n   219→    setIsSheetOpen(false)\n   220→    setEditingPatient(null)\n   221→    setViewingPatient(null)\n   222→  }\n   223→\n   224→  async function onSubmit(data: PatientFormData) {\n   225→    setIsSaving(true)\n   226→    try {\n   227→      const url = editingPatient\n   228→        ? `/api/patients/${editingPatient.id}`\n   229→        : \"/api/patients\"\n   230→      const method = editingPatient ? \"PATCH\" : \"POST\"\n   231→\n   232→      const payload: Record<string, unknown> = {\n   233→        name: data.name,\n   234→        phone: data.phone.replace(/\\D/g, \"\"),\n   235→        email: data.email || null,\n   236→        notes: data.notes || null,\n   237→        consentWhatsApp: data.consentWhatsApp,\n   238→        consentEmail: data.consentEmail,\n   239→      }\n   240→\n   241→      const response = await fetch(url, {\n   242→        method,\n   243→        headers: { \"Content-Type\": \"application/json\" },\n   244→        body: JSON.stringify(payload),\n   245→      })\n   246→\n   247→      if (!response.ok) {\n   248→        const error = await response.json()\n   249→        throw new Error(error.error || \"Failed to save patient\")\n   250→      }\n   251→\n   252→      toast.success(\n   253→        editingPatient\n   254→          ? \"Paciente atualizado com sucesso\"\n   255→          : \"Paciente criado com sucesso\"\n   256→      )\n   257→      closeSheet()\n   258→      fetchPatients()\n   259→    } catch (error) {\n   260→      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n   261→    } finally {\n   262→      setIsSaving(false)\n   263→    }\n   264→  }\n   265→\n   266→  async function handleDeactivate(patient: Patient) {\n   267→    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n   268→      return\n   269→    }\n   270→\n   271→    try {\n   272→      const response = await fetch(`/api/patients/${patient.id}`, {\n   273→        method: \"DELETE\",\n   274→      })\n   275→\n   276→      if (!response.ok) {\n   277→        const error = await response.json()\n   278→        throw new Error(error.error || \"Failed to deactivate patient\")\n   279→      }\n   280→\n   281→      toast.success(\"Paciente desativado com sucesso\")\n   282→      fetchPatients()\n   283→    } catch (error) {\n   284→      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n   285→    }\n   286→  }\n   287→\n   288→  async function handleReactivate(patient: Patient) {\n   289→    try {\n   290→      const response = await fetch(`/api/patients/${patient.id}`, {\n   291→        method: \"PATCH\",\n   292→        headers: { \"Content-Type\": \"application/json\" },\n   293→        body: JSON.stringify({ isActive: true }),\n   294→      })\n   295→\n   296→      if (!response.ok) {\n   297→        const error = await response.json()\n   298→        throw new Error(error.error || \"Failed to reactivate patient\")\n   299→      }\n   300→\n   301→      toast.success(\"Paciente reativado com sucesso\")\n   302→      fetchPatients()\n   303→    } catch (error) {\n   304→      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n   305→    }\n   306→  }\n   307→\n   308→  if (status === \"loading\" || isLoading) {\n   309→    return (\n   310→      <main className=\"min-h-screen bg-background\">\n   311→        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   312→          <div className=\"animate-pulse space-y-6\">\n   313→            <div className=\"h-8 w-48 bg-muted rounded\" />\n   314→            <div className=\"flex gap-4\">\n   315→              <div className=\"h-12 flex-1 bg-muted rounded\" />\n   316→              <div className=\"h-12 w-32 bg-muted rounded\" />\n   317→            </div>\n   318→            <div className=\"space-y-4\">\n   319→              {[1, 2, 3].map((i) => (\n   320→                <div key={i} className=\"h-20 bg-muted rounded\" />\n   321→              ))}\n   322→            </div>\n   323→          </div>\n   324→        </div>\n   325→      </main>\n   326→    )\n   327→  }\n   328→\n   329→  return (\n   330→    <main className=\"min-h-screen bg-background\">\n   331→      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   332→        <div className=\"mb-6\">\n   333→          <button\n   334→            onClick={() => router.back()}\n   335→            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n   336→          >\n   337→            &larr; Voltar\n   338→          </button>\n   339→        </div>\n   340→\n   341→        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n   342→          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n   343→          {isAdmin && (\n   344→            <button\n   345→              onClick={openCreateSheet}\n   346→              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n   347→            >\n   348→              + Novo Paciente\n   349→            </button>\n   350→          )}\n   351→        </div>\n   352→\n   353→        {/* Search and Filter */}\n   354→        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n   355→          <div className=\"flex-1\">\n   356→            <input\n   357→              type=\"text\"\n   358→              placeholder=\"Buscar por nome, email ou telefone...\"\n   359→              value={search}\n   360→              onChange={(e) => setSearch(e.target.value)}\n   361→              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   362→            />\n   363→          </div>\n   364→          <select\n   365→            value={filterActive}\n   366→            onChange={(e) => setFilterActive(e.target.value)}\n   367→            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   368→          >\n   369→            <option value=\"all\">Todos</option>\n   370→            <option value=\"true\">Ativos</option>\n   371→            <option value=\"false\">Inativos</option>\n   372→          </select>\n   373→        </div>\n   374→\n   375→        {/* Patients List */}\n   376→        <div className=\"space-y-4\">\n   377→          {patients.length === 0 ? (\n   378→            <div className=\"text-center py-12 text-muted-foreground\">\n   379→              {search || filterActive !== \"all\"\n   380→                ? \"Nenhum paciente encontrado\"\n   381→                : \"Nenhum paciente cadastrado\"}\n   382→            </div>\n   383→          ) : (\n   384→            patients.map((patient) => (\n   385→              <div\n   386→                key={patient.id}\n   387→                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n   388→                  !patient.isActive ? \"opacity-60\" : \"\"\n   389→                }`}\n   390→              >\n   391→                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n   392→                  <div\n   393→                    className=\"flex-1 min-w-0 cursor-pointer\"\n   394→                    onClick={() => openViewSheet(patient)}\n   395→                  >\n   396→                    <div className=\"flex items-center gap-2 mb-1\">\n   397→                      <h3 className=\"font-medium text-foreground truncate\">\n   398→                        {patient.name}\n   399→                      </h3>\n   400→                      {!patient.isActive && (\n   401→                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n   402→                          Inativo\n   403→                        </span>\n   404→                      )}\n   405→                    </div>\n   406→                    <p className=\"text-sm text-muted-foreground\">\n   407→                      {formatPhone(patient.phone)}\n   408→                    </p>\n   409→                    {patient.email && (\n   410→                      <p className=\"text-sm text-muted-foreground truncate\">\n   411→                        {patient.email}\n   412→                      </p>\n   413→                    )}\n   414→                    <div className=\"flex gap-3 mt-2\">\n   415→                      {patient.consentWhatsApp && (\n   416→                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n   417→                          WhatsApp\n   418→                        </span>\n   419→                      )}\n   420→                      {patient.consentEmail && (\n   421→                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n   422→                          Email\n   423→                        </span>\n   424→                      )}\n   425→                    </div>\n   426→                  </div>\n   427→                  {isAdmin && (\n   428→                    <div className=\"flex gap-2\">\n   429→                      <button\n   430→                        onClick={() => openEditSheet(patient)}\n   431→                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   432→                      >\n   433→                        Editar\n   434→                      </button>\n   435→                      {patient.isActive ? (\n   436→                        <button\n   437→                          onClick={() => handleDeactivate(patient)}\n   438→                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   439→                        >\n   440→                          Desativar\n   441→                        </button>\n   442→                      ) : (\n   443→                        <button\n   444→                          onClick={() => handleReactivate(patient)}\n   445→                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   446→                        >\n   447→                          Reativar\n   448→                        </button>\n   449→                      )}\n   450→                    </div>\n   451→                  )}\n   452→                </div>\n   453→              </div>\n   454→            ))\n   455→          )}\n   456→        </div>\n   457→      </div>\n   458→\n   459→      {/* Bottom Sheet */}\n   460→      {isSheetOpen && (\n   461→        <>\n   462→          {/* Backdrop */}\n   463→          <div\n   464→            className=\"fixed inset-0 bg-black/50 z-40\"\n   465→            onClick={closeSheet}\n   466→          />\n   467→          {/* Sheet */}\n   468→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n   469→            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n   470→              {/* Handle */}\n   471→              <div className=\"flex justify-center mb-4\">\n   472→                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n   473→              </div>\n   474→\n   475→              {/* View Mode */}\n   476→              {viewingPatient && !editingPatient && (\n   477→                <>\n   478→                  <div className=\"flex items-center justify-between mb-6\">\n   479→                    <h2 className=\"text-xl font-semibold text-foreground\">\n   480→                      {viewingPatient.name}\n   481→                    </h2>\n   482→                    {isAdmin && (\n   483→                      <button\n   484→                        onClick={() => openEditSheet(viewingPatient)}\n   485→                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   486→                      >\n   487→                        Editar\n   488→                      </button>\n   489→                    )}\n   490→                  </div>\n   491→\n   492→                  {isLoadingDetails ? (\n   493→                    <div className=\"animate-pulse space-y-4\">\n   494→                      <div className=\"h-6 w-32 bg-muted rounded\" />\n   495→                      <div className=\"h-4 w-48 bg-muted rounded\" />\n   496→                      <div className=\"h-4 w-40 bg-muted rounded\" />\n   497→                    </div>\n   498→                  ) : (\n   499→                    <div className=\"space-y-6\">\n   500→                      {/* Contact Info */}\n   501→                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n   502→                        <div>\n   503→                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n   504→                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n   505→                        </div>\n   506→                        <div>\n   507→                          <label className=\"text-sm text-muted-foreground\">Email</label>\n   508→                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n   509→                        </div>\n   510→                      </div>\n   511→\n   512→                      {/* Notes */}\n   513→                      {viewingPatient.notes && (\n   514→                        <div>\n   515→                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n   516→                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n   517→                        </div>\n   518→                      )}\n   519→\n   520→                      {/* Consent Info */}\n   521→                      <div>\n   522→                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n   523→                        <div className=\"flex gap-4\">\n   524→                          <div className=\"flex items-center gap-2\">\n   525→                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n   526→                            <span className=\"text-sm\">WhatsApp</span>\n   527→                            {viewingPatient.consentWhatsAppAt && (\n   528→                              <span className=\"text-xs text-muted-foreground\">\n   529→                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n   530→                              </span>\n   531→                            )}\n   532→                          </div>\n   533→                          <div className=\"flex items-center gap-2\">\n   534→                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n   535→                            <span className=\"text-sm\">Email</span>\n   536→                            {viewingPatient.consentEmailAt && (\n   537→                              <span className=\"text-xs text-muted-foreground\">\n   538→                                ({formatDate(viewingPatient.consentEmailAt)})\n   539→                              </span>\n   540→                            )}\n   541→                          </div>\n   542→                        </div>\n   543→                      </div>\n   544→\n   545→                      {/* Appointment History */}\n   546→                      <div>\n   547→                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n   548→                          Historico de Consultas\n   549→                        </h3>\n   550→                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n   551→                          <div className=\"space-y-3\">\n   552→                            {viewingPatient.appointments.map((appointment) => (\n   553→                              <div\n   554→                                key={appointment.id}\n   555→                                className=\"bg-muted/50 rounded-lg p-4\"\n   556→                              >\n   557→                                <div className=\"flex items-center justify-between mb-2\">\n   558→                                  <span className=\"font-medium\">\n   559→                                    {formatDateTime(appointment.scheduledAt)}\n   560→                                  </span>\n   561→                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n   562→                                    {statusLabels[appointment.status] || appointment.status}\n   563→                                  </span>\n   564→                                </div>\n   565→                                <p className=\"text-sm text-muted-foreground\">\n   566→                                  {appointment.professionalProfile.user.name}\n   567→                                </p>\n   568→                                <p className=\"text-sm text-muted-foreground\">\n   569→                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n   570→                                </p>\n   571→                              </div>\n   572→                            ))}\n   573→                          </div>\n   574→                        ) : (\n   575→                          <p className=\"text-muted-foreground text-sm\">\n   576→                            Nenhuma consulta registrada\n   577→                          </p>\n   578→                        )}\n   579→                      </div>\n   580→\n   581→                      <div className=\"pt-4\">\n   582→                        <button\n   583→                          type=\"button\"\n   584→                          onClick={closeSheet}\n   585→                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   586→                        >\n   587→                          Fechar\n   588→                        </button>\n   589→                      </div>\n   590→                    </div>\n   591→                  )}\n   592→                </>\n   593→              )}\n   594→\n   595→              {/* Create/Edit Mode */}\n   596→              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n   597→                <>\n   598→                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n   599→                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n   600→                  </h2>\n   601→\n   602→                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n   603→                    <div>\n   604→                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n   605→                        Nome *\n   606→                      </label>\n   607→                      <input\n   608→                        id=\"name\"\n   609→                        type=\"text\"\n   610→                        {...register(\"name\")}\n   611→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   612→                      />\n   613→                      {errors.name && (\n   614→                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n   615→                      )}\n   616→                    </div>\n   617→\n   618→                    <div>\n   619→                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n   620→                        Telefone (WhatsApp) *\n   621→                      </label>\n   622→                      <input\n   623→                        id=\"phone\"\n   624→                        type=\"tel\"\n   625→                        {...register(\"phone\")}\n   626→                        placeholder=\"11999999999\"\n   627→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   628→                      />\n   629→                      {errors.phone && (\n   630→                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n   631→                      )}\n   632→                      <p className=\"text-xs text-muted-foreground mt-1\">\n   633→                        Formato: DDD + numero (ex: 11999999999)\n   634→                      </p>\n   635→                    </div>\n   636→\n   637→                    <div>\n   638→                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n   639→                        Email\n   640→                      </label>\n   641→                      <input\n   642→                        id=\"email\"\n   643→                        type=\"email\"\n   644→                        {...register(\"email\")}\n   645→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   646→                      />\n   647→                      {errors.email && (\n   648→                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n   649→                      )}\n   650→                    </div>\n   651→\n   652→                    <div>\n   653→                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n   654→                        Observacoes administrativas\n   655→                      </label>\n   656→                      <textarea\n   657→                        id=\"notes\"\n   658→                        rows={3}\n   659→                        {...register(\"notes\")}\n   660→                        placeholder=\"Observacoes internas sobre o paciente...\"\n   661→                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n   662→                      />\n   663→                      {errors.notes && (\n   664→                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n   665→                      )}\n   666→                    </div>\n   667→\n   668→                    {/* LGPD Consent Section */}\n   669→                    <div className=\"border border-border rounded-lg p-4\">\n   670→                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n   671→                        Consentimentos LGPD\n   672→                      </h3>\n   673→                      <div className=\"space-y-4\">\n   674→                        <label className=\"flex items-start gap-3 cursor-pointer\">\n   675→                          <input\n   676→                            type=\"checkbox\"\n   677→                            {...register(\"consentWhatsApp\")}\n   678→                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n   679→                          />\n   680→                          <div>\n   681→                            <span className=\"text-sm text-foreground\">\n   682→                              Autorizo receber mensagens via WhatsApp\n   683→                            </span>\n   684→                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n   685→                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n   686→                            </p>\n   687→                          </div>\n   688→                        </label>\n   689→\n   690→                        <label className=\"flex items-start gap-3 cursor-pointer\">\n   691→                          <input\n   692→                            type=\"checkbox\"\n   693→                            {...register(\"consentEmail\")}\n   694→                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n   695→                          />\n   696→                          <div>\n   697→                            <span className=\"text-sm text-foreground\">\n   698→                              Autorizo receber comunicacoes por email\n   699→                            </span>\n   700→                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n   701→                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n   702→                            </p>\n   703→                          </div>\n   704→                        </label>\n   705→                      </div>\n   706→                    </div>\n   707→\n   708→                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n   709→                      <button\n   710→                        type=\"submit\"\n   711→                        disabled={isSaving}\n   712→                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n   713→                      >\n   714→                        {isSaving\n   715→                          ? \"Salvando...\"\n   716→                          : editingPatient\n   717→                          ? \"Salvar alteracoes\"\n   718→                          : \"Criar paciente\"}\n   719→                      </button>\n   720→                      <button\n   721→                        type=\"button\"\n   722→                        onClick={closeSheet}\n   723→                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   724→                      >\n   725→                        Cancelar\n   726→                      </button>\n   727→                    </div>\n   728→                  </form>\n   729→                </>\n   730→              )}\n   731→            </div>\n   732→          </div>\n   733→        </>\n   734→      )}\n   735→\n   736→      {/* Animation Styles */}\n   737→      <style jsx>{`\n   738→        @keyframes slide-up {\n   739→          from {\n   740→            transform: translateY(100%);\n   741→          }\n   742→          to {\n   743→            transform: translateY(0);\n   744→          }\n   745→        }\n   746→        .animate-slide-up {\n   747→          animation: slide-up 0.3s ease-out;\n   748→        }\n   749→      `}</style>\n   750→    </main>\n   751→  )\n   752→}\n   753→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"901447bb-6922-4496-82f3-440546b4cea2"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JFgZ283FSotw7yhxrBHeUH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Rfx8xRd2X3WV3DSwNapNAC","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/tailwind.config.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4056,"cache_creation_input_tokens":39015,"cache_read_input_tokens":20320,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":39015},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2322ca12-e1a6-4be6-8cf0-6d47c169cea5"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JFgZ283FSotw7yhxrBHeUH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DR5Do3Pb6fn8ZjgrVd1s7d","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/session-provider.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4056,"cache_creation_input_tokens":39015,"cache_read_input_tokens":20320,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":39015},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"df9aaa08-f5f9-4833-8c71-1da0428427e4"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JFgZ283FSotw7yhxrBHeUH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014Kpw9WXMWX11rnybZu3F9g","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src/src/shared/components -type f -name \"*.tsx\" -o -name \"*.ts\" | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4056,"cache_creation_input_tokens":39015,"cache_read_input_tokens":20320,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":39015},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a80d42d1-0390-42be-8d73-4d31c968d41f"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JFgZ283FSotw7yhxrBHeUH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DVpVL5JQ9vk89EbjwqGD6Y","name":"Bash","input":{"command":"ls -la /mnt/d/personal/clinica/src/src/shared/hooks/"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4056,"cache_creation_input_tokens":39015,"cache_read_input_tokens":20320,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":39015},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"19f72f43-c2b7-41b4-9fd6-36ed4001a0a6"}
{"type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File does not exist.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01Rfx8xRd2X3WV3DSwNapNAC"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"45749a7a-ee3f-4d38-9c80-b613f3781c2f","tool_use_result":"Error: File does not exist."}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DR5Do3Pb6fn8ZjgrVd1s7d","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { SessionProvider as NextAuthSessionProvider } from \"next-auth/react\"\n     4→\n     5→export function SessionProvider({ children }: { children: React.ReactNode }) {\n     6→  return <NextAuthSessionProvider>{children}</NextAuthSessionProvider>\n     7→}\n     8→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e79997df-de24-4cb7-8f0f-b21bab3802aa"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014Kpw9WXMWX11rnybZu3F9g","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/shared/components/session-provider.tsx","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"643829d0-1c72-480b-8784-5582981766d0"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DVpVL5JQ9vk89EbjwqGD6Y","type":"tool_result","content":"total 0\ndrwxrwxrwx 1 root root 512 Jan 28 21:30 .\ndrwxrwxrwx 1 root root 512 Jan 28 21:30 ..\n-rwxrwxrwx 1 root root   0 Jan 28 21:30 .gitkeep","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"0e98f242-ac74-4fa4-98c4-37517c1e4f00"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01AvzkJHecX5Y5rAT8onzXrx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018SisCP6Bga6qiw3hhksNys","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4768,"cache_read_input_tokens":59335,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4768},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"21aa84ba-e080-4a27-9e06-092c2df41bd9"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01AvzkJHecX5Y5rAT8onzXrx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0193GLr7ioKwrWTRjA6rb6p2","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src/src -type f -name \"*.css\" -o -name \"*.module.css\" 2>/dev/null"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4768,"cache_read_input_tokens":59335,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4768},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"8fd94d7c-7516-44be-b9ea-e9024edee94a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0193GLr7ioKwrWTRjA6rb6p2","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/app/globals.css","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"dc14de67-f93a-460d-aedf-1cdf5d02f777"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018SisCP6Bga6qiw3hhksNys","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { Suspense, useCallback, useEffect, useState } from \"react\"\n     4→import { useRouter, useSearchParams } from \"next/navigation\"\n     5→import { useSession } from \"next-auth/react\"\n     6→import { toast } from \"sonner\"\n     7→\n     8→const DAYS_OF_WEEK = [\n     9→  { value: 0, label: \"Domingo\", short: \"Dom\" },\n    10→  { value: 1, label: \"Segunda\", short: \"Seg\" },\n    11→  { value: 2, label: \"Terça\", short: \"Ter\" },\n    12→  { value: 3, label: \"Quarta\", short: \"Qua\" },\n    13→  { value: 4, label: \"Quinta\", short: \"Qui\" },\n    14→  { value: 5, label: \"Sexta\", short: \"Sex\" },\n    15→  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n    16→]\n    17→\n    18→interface TimeBlock {\n    19→  id?: string\n    20→  dayOfWeek: number\n    21→  startTime: string\n    22→  endTime: string\n    23→  isActive: boolean\n    24→}\n    25→\n    26→interface AvailabilityException {\n    27→  id: string\n    28→  date: string\n    29→  isAvailable: boolean\n    30→  startTime: string | null\n    31→  endTime: string | null\n    32→  reason: string | null\n    33→  createdAt: string\n    34→}\n    35→\n    36→interface Professional {\n    37→  id: string\n    38→  name: string\n    39→  professionalProfile: {\n    40→    id: string\n    41→  } | null\n    42→}\n    43→\n    44→function LoadingState() {\n    45→  return (\n    46→    <main className=\"min-h-screen bg-background\">\n    47→      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n    48→        <div className=\"animate-pulse space-y-6\">\n    49→          <div className=\"h-8 w-48 bg-muted rounded\" />\n    50→          <div className=\"space-y-4\">\n    51→            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n    52→              <div key={i} className=\"h-20 bg-muted rounded\" />\n    53→            ))}\n    54→          </div>\n    55→        </div>\n    56→      </div>\n    57→    </main>\n    58→  )\n    59→}\n    60→\n    61→export default function AvailabilitySettingsPage() {\n    62→  return (\n    63→    <Suspense fallback={<LoadingState />}>\n    64→      <AvailabilitySettingsContent />\n    65→    </Suspense>\n    66→  )\n    67→}\n    68→\n    69→function AvailabilitySettingsContent() {\n    70→  const router = useRouter()\n    71→  const searchParams = useSearchParams()\n    72→  const { data: session, status } = useSession()\n    73→\n    74→  const [isLoading, setIsLoading] = useState(true)\n    75→  const [isSaving, setIsSaving] = useState(false)\n    76→  const [rules, setRules] = useState<TimeBlock[]>([])\n    77→  const [editingBlock, setEditingBlock] = useState<{\n    78→    dayOfWeek: number\n    79→    index: number | null\n    80→    block: TimeBlock\n    81→  } | null>(null)\n    82→\n    83→  // Exceptions state\n    84→  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n    85→  const [editingException, setEditingException] = useState<{\n    86→    id?: string\n    87→    date: string\n    88→    isAvailable: boolean\n    89→    startTime: string | null\n    90→    endTime: string | null\n    91→    reason: string | null\n    92→    isFullDay: boolean\n    93→  } | null>(null)\n    94→  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n    95→\n    96→  // ADMIN-only: professional selection\n    97→  const [professionals, setProfessionals] = useState<Professional[]>([])\n    98→  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n    99→  const professionalIdParam = searchParams.get(\"professionalId\")\n   100→\n   101→  const isAdmin = session?.user?.role === \"ADMIN\"\n   102→\n   103→  const fetchProfessionals = useCallback(async () => {\n   104→    if (!isAdmin) return\n   105→\n   106→    try {\n   107→      const response = await fetch(\"/api/professionals?isActive=true\")\n   108→      if (response.ok) {\n   109→        const data = await response.json()\n   110→        setProfessionals(data.professionals)\n   111→      }\n   112→    } catch {\n   113→      // Ignore errors for professional list\n   114→    }\n   115→  }, [isAdmin])\n   116→\n   117→  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n   118→    try {\n   119→      const params = new URLSearchParams()\n   120→      if (profileId) {\n   121→        params.set(\"professionalProfileId\", profileId)\n   122→      }\n   123→\n   124→      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n   125→      if (response.ok) {\n   126→        const data = await response.json()\n   127→        setExceptions(data.exceptions || [])\n   128→      }\n   129→    } catch {\n   130→      // Silently fail for exceptions\n   131→    }\n   132→  }, [])\n   133→\n   134→  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n   135→    try {\n   136→      const params = new URLSearchParams()\n   137→      if (profileId) {\n   138→        params.set(\"professionalProfileId\", profileId)\n   139→      }\n   140→\n   141→      const response = await fetch(`/api/availability?${params.toString()}`)\n   142→      if (!response.ok) {\n   143→        if (response.status === 403) {\n   144→          toast.error(\"Acesso negado\")\n   145→          router.push(\"/\")\n   146→          return\n   147→        }\n   148→        throw new Error(\"Failed to fetch availability\")\n   149→      }\n   150→\n   151→      const data = await response.json()\n   152→      setRules(data.rules || [])\n   153→\n   154→      // Also fetch exceptions\n   155→      await fetchExceptions(profileId)\n   156→    } catch {\n   157→      toast.error(\"Erro ao carregar disponibilidade\")\n   158→    } finally {\n   159→      setIsLoading(false)\n   160→    }\n   161→  }, [router, fetchExceptions])\n   162→\n   163→  useEffect(() => {\n   164→    if (status === \"unauthenticated\") {\n   165→      router.push(\"/login\")\n   166→      return\n   167→    }\n   168→\n   169→    if (status === \"authenticated\") {\n   170→      fetchProfessionals()\n   171→\n   172→      // If ADMIN with professionalId param, use that\n   173→      if (isAdmin && professionalIdParam) {\n   174→        setSelectedProfessionalId(professionalIdParam)\n   175→        // Find the professional profile ID\n   176→        const prof = professionals.find((p) => p.id === professionalIdParam)\n   177→        if (prof?.professionalProfile?.id) {\n   178→          fetchAvailability(prof.professionalProfile.id)\n   179→        } else {\n   180→          // Fetch all professionals first, then get availability\n   181→          fetch(\"/api/professionals?isActive=true\")\n   182→            .then((res) => res.json())\n   183→            .then((data) => {\n   184→              const foundProf = data.professionals?.find(\n   185→                (p: Professional) => p.id === professionalIdParam\n   186→              )\n   187→              if (foundProf?.professionalProfile?.id) {\n   188→                fetchAvailability(foundProf.professionalProfile.id)\n   189→              } else {\n   190→                setIsLoading(false)\n   191→              }\n   192→            })\n   193→            .catch(() => setIsLoading(false))\n   194→        }\n   195→      } else {\n   196→        fetchAvailability()\n   197→      }\n   198→    }\n   199→  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n   200→\n   201→  async function handleProfessionalChange(professionalId: string) {\n   202→    setSelectedProfessionalId(professionalId)\n   203→    setIsLoading(true)\n   204→\n   205→    const prof = professionals.find((p) => p.id === professionalId)\n   206→    if (prof?.professionalProfile?.id) {\n   207→      await fetchAvailability(prof.professionalProfile.id)\n   208→    } else {\n   209→      setRules([])\n   210→      setIsLoading(false)\n   211→    }\n   212→  }\n   213→\n   214→  async function saveAvailability() {\n   215→    setIsSaving(true)\n   216→\n   217→    try {\n   218→      let professionalProfileId: string | undefined\n   219→\n   220→      if (isAdmin && selectedProfessionalId) {\n   221→        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n   222→        professionalProfileId = prof?.professionalProfile?.id\n   223→      }\n   224→\n   225→      const response = await fetch(\"/api/availability\", {\n   226→        method: \"POST\",\n   227→        headers: { \"Content-Type\": \"application/json\" },\n   228→        body: JSON.stringify({\n   229→          professionalProfileId,\n   230→          rules,\n   231→        }),\n   232→      })\n   233→\n   234→      if (!response.ok) {\n   235→        const error = await response.json()\n   236→        throw new Error(error.error || \"Failed to save availability\")\n   237→      }\n   238→\n   239→      const data = await response.json()\n   240→      setRules(data.rules || [])\n   241→      toast.success(\"Disponibilidade salva com sucesso\")\n   242→    } catch (error) {\n   243→      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n   244→    } finally {\n   245→      setIsSaving(false)\n   246→    }\n   247→  }\n   248→\n   249→  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n   250→    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n   251→  }\n   252→\n   253→  function toggleDayActive(dayOfWeek: number) {\n   254→    const dayRules = getRulesForDay(dayOfWeek)\n   255→\n   256→    if (dayRules.length === 0) {\n   257→      // Add default time block for this day\n   258→      setRules([\n   259→        ...rules,\n   260→        {\n   261→          dayOfWeek,\n   262→          startTime: \"08:00\",\n   263→          endTime: \"18:00\",\n   264→          isActive: true,\n   265→        },\n   266→      ])\n   267→    } else {\n   268→      // Toggle isActive for all blocks on this day\n   269→      const allActive = dayRules.every((r) => r.isActive)\n   270→      setRules(\n   271→        rules.map((r) =>\n   272→          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n   273→        )\n   274→      )\n   275→    }\n   276→  }\n   277→\n   278→  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n   279→    const dayRules = getRulesForDay(dayOfWeek)\n   280→    const block =\n   281→      index !== null\n   282→        ? dayRules[index]\n   283→        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n   284→\n   285→    setEditingBlock({ dayOfWeek, index, block })\n   286→  }\n   287→\n   288→  function closeBlockEditor() {\n   289→    setEditingBlock(null)\n   290→  }\n   291→\n   292→  function saveBlock() {\n   293→    if (!editingBlock) return\n   294→\n   295→    const { dayOfWeek, index, block } = editingBlock\n   296→\n   297→    // Validate times\n   298→    if (block.startTime >= block.endTime) {\n   299→      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n   300→      return\n   301→    }\n   302→\n   303→    if (index !== null) {\n   304→      // Update existing block\n   305→      let blockIndex = 0\n   306→      setRules(\n   307→        rules.map((r) => {\n   308→          if (r.dayOfWeek === dayOfWeek) {\n   309→            if (blockIndex === index) {\n   310→              blockIndex++\n   311→              return { ...block }\n   312→            }\n   313→            blockIndex++\n   314→          }\n   315→          return r\n   316→        })\n   317→      )\n   318→    } else {\n   319→      // Add new block\n   320→      setRules([...rules, { ...block }])\n   321→    }\n   322→\n   323→    closeBlockEditor()\n   324→  }\n   325→\n   326→  function deleteBlock() {\n   327→    if (!editingBlock || editingBlock.index === null) return\n   328→\n   329→    const { dayOfWeek, index } = editingBlock\n   330→    let blockIndex = 0\n   331→\n   332→    setRules(\n   333→      rules.filter((r) => {\n   334→        if (r.dayOfWeek === dayOfWeek) {\n   335→          if (blockIndex === index) {\n   336→            blockIndex++\n   337→            return false\n   338→          }\n   339→          blockIndex++\n   340→        }\n   341→        return true\n   342→      })\n   343→    )\n   344→\n   345→    closeBlockEditor()\n   346→  }\n   347→\n   348→  function removeAllBlocksForDay(dayOfWeek: number) {\n   349→    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n   350→  }\n   351→\n   352→  // Exception handlers\n   353→  function openExceptionEditor(exception?: AvailabilityException) {\n   354→    if (exception) {\n   355→      setEditingException({\n   356→        id: exception.id,\n   357→        date: exception.date.split(\"T\")[0],\n   358→        isAvailable: exception.isAvailable,\n   359→        startTime: exception.startTime,\n   360→        endTime: exception.endTime,\n   361→        reason: exception.reason,\n   362→        isFullDay: !exception.startTime && !exception.endTime,\n   363→      })\n   364→    } else {\n   365→      // New exception - default to block (unavailable)\n   366→      const tomorrow = new Date()\n   367→      tomorrow.setDate(tomorrow.getDate() + 1)\n   368→      setEditingException({\n   369→        date: tomorrow.toISOString().split(\"T\")[0],\n   370→        isAvailable: false,\n   371→        startTime: null,\n   372→        endTime: null,\n   373→        reason: null,\n   374→        isFullDay: true,\n   375→      })\n   376→    }\n   377→  }\n   378→\n   379→  function closeExceptionEditor() {\n   380→    setEditingException(null)\n   381→  }\n   382→\n   383→  async function saveException() {\n   384→    if (!editingException) return\n   385→\n   386→    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n   387→\n   388→    // Validate time range if not full day\n   389→    if (!isFullDay) {\n   390→      if (!startTime || !endTime) {\n   391→        toast.error(\"Selecione os horários de início e término\")\n   392→        return\n   393→      }\n   394→      if (startTime >= endTime) {\n   395→        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n   396→        return\n   397→      }\n   398→    }\n   399→\n   400→    setIsSaving(true)\n   401→\n   402→    try {\n   403→      let professionalProfileId: string | undefined\n   404→\n   405→      if (isAdmin && selectedProfessionalId) {\n   406→        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n   407→        professionalProfileId = prof?.professionalProfile?.id\n   408→      }\n   409→\n   410→      const response = await fetch(\"/api/availability/exceptions\", {\n   411→        method: \"POST\",\n   412→        headers: { \"Content-Type\": \"application/json\" },\n   413→        body: JSON.stringify({\n   414→          professionalProfileId,\n   415→          date,\n   416→          isAvailable,\n   417→          startTime: isFullDay ? null : startTime,\n   418→          endTime: isFullDay ? null : endTime,\n   419→          reason: reason || null,\n   420→        }),\n   421→      })\n   422→\n   423→      if (!response.ok) {\n   424→        const error = await response.json()\n   425→        throw new Error(error.error || \"Erro ao salvar exceção\")\n   426→      }\n   427→\n   428→      const data = await response.json()\n   429→      setExceptions([...exceptions, data.exception])\n   430→      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n   431→      closeExceptionEditor()\n   432→    } catch (error) {\n   433→      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n   434→    } finally {\n   435→      setIsSaving(false)\n   436→    }\n   437→  }\n   438→\n   439→  async function deleteException(id: string) {\n   440→    setIsDeletingException(id)\n   441→\n   442→    try {\n   443→      const response = await fetch(`/api/availability/exceptions/${id}`, {\n   444→        method: \"DELETE\",\n   445→      })\n   446→\n   447→      if (!response.ok) {\n   448→        const error = await response.json()\n   449→        throw new Error(error.error || \"Erro ao excluir exceção\")\n   450→      }\n   451→\n   452→      setExceptions(exceptions.filter((e) => e.id !== id))\n   453→      toast.success(\"Exceção removida\")\n   454→    } catch (error) {\n   455→      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n   456→    } finally {\n   457→      setIsDeletingException(null)\n   458→    }\n   459→  }\n   460→\n   461→  function formatExceptionDate(dateStr: string): string {\n   462→    const date = new Date(dateStr + \"T00:00:00\")\n   463→    return date.toLocaleDateString(\"pt-BR\", {\n   464→      weekday: \"short\",\n   465→      day: \"2-digit\",\n   466→      month: \"short\",\n   467→      year: \"numeric\",\n   468→    })\n   469→  }\n   470→\n   471→  if (status === \"loading\" || isLoading) {\n   472→    return (\n   473→      <main className=\"min-h-screen bg-background\">\n   474→        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   475→          <div className=\"animate-pulse space-y-6\">\n   476→            <div className=\"h-8 w-48 bg-muted rounded\" />\n   477→            <div className=\"space-y-4\">\n   478→              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n   479→                <div key={i} className=\"h-20 bg-muted rounded\" />\n   480→              ))}\n   481→            </div>\n   482→          </div>\n   483→        </div>\n   484→      </main>\n   485→    )\n   486→  }\n   487→\n   488→  return (\n   489→    <main className=\"min-h-screen bg-background\">\n   490→      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   491→        <div className=\"mb-6\">\n   492→          <button\n   493→            onClick={() => router.back()}\n   494→            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n   495→          >\n   496→            &larr; Voltar\n   497→          </button>\n   498→        </div>\n   499→\n   500→        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n   501→          <h1 className=\"text-2xl font-semibold text-foreground\">\n   502→            Disponibilidade Semanal\n   503→          </h1>\n   504→          <button\n   505→            onClick={saveAvailability}\n   506→            disabled={isSaving}\n   507→            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n   508→          >\n   509→            {isSaving ? \"Salvando...\" : \"Salvar\"}\n   510→          </button>\n   511→        </div>\n   512→\n   513→        {/* ADMIN: Professional selector */}\n   514→        {isAdmin && professionals.length > 0 && (\n   515→          <div className=\"mb-6\">\n   516→            <label\n   517→              htmlFor=\"professional\"\n   518→              className=\"block text-sm font-medium text-foreground mb-2\"\n   519→            >\n   520→              Profissional\n   521→            </label>\n   522→            <select\n   523→              id=\"professional\"\n   524→              value={selectedProfessionalId || \"\"}\n   525→              onChange={(e) => handleProfessionalChange(e.target.value)}\n   526→              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   527→            >\n   528→              <option value=\"\">Selecione um profissional</option>\n   529→              {professionals.map((prof) => (\n   530→                <option key={prof.id} value={prof.id}>\n   531→                  {prof.name}\n   532→                </option>\n   533→              ))}\n   534→            </select>\n   535→          </div>\n   536→        )}\n   537→\n   538→        {/* Weekly Grid */}\n   539→        <div className=\"space-y-4\">\n   540→          {DAYS_OF_WEEK.map((day) => {\n   541→            const dayRules = getRulesForDay(day.value)\n   542→            const hasRules = dayRules.length > 0\n   543→            const allActive = hasRules && dayRules.every((r) => r.isActive)\n   544→\n   545→            return (\n   546→              <div\n   547→                key={day.value}\n   548→                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n   549→                  !allActive && hasRules ? \"opacity-60\" : \"\"\n   550→                }`}\n   551→              >\n   552→                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n   553→                  {/* Day toggle */}\n   554→                  <div className=\"flex items-center gap-3 sm:w-32\">\n   555→                    <button\n   556→                      type=\"button\"\n   557→                      onClick={() => toggleDayActive(day.value)}\n   558→                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   559→                        allActive ? \"bg-primary\" : \"bg-muted\"\n   560→                      }`}\n   561→                      aria-label={`Toggle ${day.label}`}\n   562→                    >\n   563→                      <span\n   564→                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n   565→                          allActive ? \"left-7\" : \"left-1\"\n   566→                        }`}\n   567→                      />\n   568→                    </button>\n   569→                    <span className=\"font-medium text-foreground\">\n   570→                      <span className=\"hidden sm:inline\">{day.label}</span>\n   571→                      <span className=\"sm:hidden\">{day.short}</span>\n   572→                    </span>\n   573→                  </div>\n   574→\n   575→                  {/* Time blocks */}\n   576→                  <div className=\"flex-1 flex flex-wrap gap-2\">\n   577→                    {dayRules.map((rule, index) => (\n   578→                      <button\n   579→                        key={rule.id || `${day.value}-${index}`}\n   580→                        type=\"button\"\n   581→                        onClick={() => openBlockEditor(day.value, index)}\n   582→                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   583→                          rule.isActive\n   584→                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n   585→                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n   586→                        }`}\n   587→                      >\n   588→                        {rule.startTime} - {rule.endTime}\n   589→                      </button>\n   590→                    ))}\n   591→\n   592→                    {/* Add time block button */}\n   593→                    <button\n   594→                      type=\"button\"\n   595→                      onClick={() => openBlockEditor(day.value)}\n   596→                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n   597→                    >\n   598→                      + Adicionar\n   599→                    </button>\n   600→                  </div>\n   601→\n   602→                  {/* Remove all */}\n   603→                  {hasRules && (\n   604→                    <button\n   605→                      type=\"button\"\n   606→                      onClick={() => removeAllBlocksForDay(day.value)}\n   607→                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n   608→                    >\n   609→                      Limpar\n   610→                    </button>\n   611→                  )}\n   612→                </div>\n   613→              </div>\n   614→            )\n   615→          })}\n   616→        </div>\n   617→\n   618→        <p className=\"text-sm text-muted-foreground mt-6\">\n   619→          Configure os horários em que você está disponível para atendimentos.\n   620→          Você pode adicionar múltiplos blocos de horário por dia.\n   621→        </p>\n   622→\n   623→        {/* Exceptions Section */}\n   624→        <div className=\"mt-10\">\n   625→          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n   626→            <h2 className=\"text-xl font-semibold text-foreground\">\n   627→              Bloqueios e Exceções\n   628→            </h2>\n   629→            <button\n   630→              type=\"button\"\n   631→              onClick={() => openExceptionEditor()}\n   632→              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   633→            >\n   634→              + Adicionar Exceção\n   635→            </button>\n   636→          </div>\n   637→\n   638→          {exceptions.length === 0 ? (\n   639→            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n   640→              <p className=\"text-muted-foreground\">\n   641→                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n   642→              </p>\n   643→            </div>\n   644→          ) : (\n   645→            <div className=\"space-y-3\">\n   646→              {exceptions\n   647→                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n   648→                .map((exception) => (\n   649→                  <div\n   650→                    key={exception.id}\n   651→                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n   652→                      exception.isAvailable\n   653→                        ? \"border-green-500/30 bg-green-500/5\"\n   654→                        : \"border-red-500/30 bg-red-500/5\"\n   655→                    }`}\n   656→                  >\n   657→                    <div className=\"flex-1 min-w-0\">\n   658→                      <div className=\"flex items-center gap-2 mb-1\">\n   659→                        <span\n   660→                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n   661→                            exception.isAvailable\n   662→                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n   663→                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n   664→                          }`}\n   665→                        >\n   666→                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n   667→                        </span>\n   668→                        {exception.startTime && exception.endTime && (\n   669→                          <span className=\"text-sm text-muted-foreground\">\n   670→                            {exception.startTime} - {exception.endTime}\n   671→                          </span>\n   672→                        )}\n   673→                        {!exception.startTime && (\n   674→                          <span className=\"text-sm text-muted-foreground\">\n   675→                            Dia inteiro\n   676→                          </span>\n   677→                        )}\n   678→                      </div>\n   679→                      <p className=\"font-medium text-foreground\">\n   680→                        {formatExceptionDate(exception.date)}\n   681→                      </p>\n   682→                      {exception.reason && (\n   683→                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n   684→                          {exception.reason}\n   685→                        </p>\n   686→                      )}\n   687→                    </div>\n   688→                    <button\n   689→                      type=\"button\"\n   690→                      onClick={() => deleteException(exception.id)}\n   691→                      disabled={isDeletingException === exception.id}\n   692→                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n   693→                    >\n   694→                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n   695→                    </button>\n   696→                  </div>\n   697→                ))}\n   698→            </div>\n   699→          )}\n   700→\n   701→          <p className=\"text-sm text-muted-foreground mt-4\">\n   702→            Use bloqueios para marcar dias de férias ou indisponibilidade.\n   703→            Use exceções de disponibilidade para atender fora do horário normal.\n   704→          </p>\n   705→        </div>\n   706→      </div>\n   707→\n   708→      {/* Time Block Editor Modal */}\n   709→      {editingBlock && (\n   710→        <>\n   711→          <div\n   712→            className=\"fixed inset-0 bg-black/50 z-40\"\n   713→            onClick={closeBlockEditor}\n   714→          />\n   715→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n   716→            <div className=\"max-w-md mx-auto px-4 py-6\">\n   717→              <div className=\"flex justify-center mb-4\">\n   718→                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n   719→              </div>\n   720→\n   721→              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n   722→                {editingBlock.index !== null\n   723→                  ? \"Editar Horário\"\n   724→                  : \"Novo Horário\"}\n   725→                {\" - \"}\n   726→                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n   727→              </h2>\n   728→\n   729→              <div className=\"space-y-6\">\n   730→                <div className=\"grid grid-cols-2 gap-4\">\n   731→                  <div>\n   732→                    <label\n   733→                      htmlFor=\"startTime\"\n   734→                      className=\"block text-sm font-medium text-foreground mb-2\"\n   735→                    >\n   736→                      Início\n   737→                    </label>\n   738→                    <input\n   739→                      id=\"startTime\"\n   740→                      type=\"time\"\n   741→                      value={editingBlock.block.startTime}\n   742→                      onChange={(e) =>\n   743→                        setEditingBlock({\n   744→                          ...editingBlock,\n   745→                          block: {\n   746→                            ...editingBlock.block,\n   747→                            startTime: e.target.value,\n   748→                          },\n   749→                        })\n   750→                      }\n   751→                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   752→                    />\n   753→                  </div>\n   754→                  <div>\n   755→                    <label\n   756→                      htmlFor=\"endTime\"\n   757→                      className=\"block text-sm font-medium text-foreground mb-2\"\n   758→                    >\n   759→                      Término\n   760→                    </label>\n   761→                    <input\n   762→                      id=\"endTime\"\n   763→                      type=\"time\"\n   764→                      value={editingBlock.block.endTime}\n   765→                      onChange={(e) =>\n   766→                        setEditingBlock({\n   767→                          ...editingBlock,\n   768→                          block: {\n   769→                            ...editingBlock.block,\n   770→                            endTime: e.target.value,\n   771→                          },\n   772→                        })\n   773→                      }\n   774→                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   775→                    />\n   776→                  </div>\n   777→                </div>\n   778→\n   779→                <div className=\"flex items-center gap-3\">\n   780→                  <button\n   781→                    type=\"button\"\n   782→                    onClick={() =>\n   783→                      setEditingBlock({\n   784→                        ...editingBlock,\n   785→                        block: {\n   786→                          ...editingBlock.block,\n   787→                          isActive: !editingBlock.block.isActive,\n   788→                        },\n   789→                      })\n   790→                    }\n   791→                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   792→                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n   793→                    }`}\n   794→                  >\n   795→                    <span\n   796→                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n   797→                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n   798→                      }`}\n   799→                    />\n   800→                  </button>\n   801→                  <span className=\"text-sm text-foreground\">\n   802→                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n   803→                  </span>\n   804→                </div>\n   805→\n   806→                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n   807→                  <button\n   808→                    type=\"button\"\n   809→                    onClick={saveBlock}\n   810→                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n   811→                  >\n   812→                    Salvar\n   813→                  </button>\n   814→                  {editingBlock.index !== null && (\n   815→                    <button\n   816→                      type=\"button\"\n   817→                      onClick={deleteBlock}\n   818→                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   819→                    >\n   820→                      Excluir\n   821→                    </button>\n   822→                  )}\n   823→                  <button\n   824→                    type=\"button\"\n   825→                    onClick={closeBlockEditor}\n   826→                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   827→                  >\n   828→                    Cancelar\n   829→                  </button>\n   830→                </div>\n   831→              </div>\n   832→            </div>\n   833→          </div>\n   834→        </>\n   835→      )}\n   836→\n   837→      {/* Exception Editor Modal */}\n   838→      {editingException && (\n   839→        <>\n   840→          <div\n   841→            className=\"fixed inset-0 bg-black/50 z-40\"\n   842→            onClick={closeExceptionEditor}\n   843→          />\n   844→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n   845→            <div className=\"max-w-md mx-auto px-4 py-6\">\n   846→              <div className=\"flex justify-center mb-4\">\n   847→                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n   848→              </div>\n   849→\n   850→              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n   851→                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n   852→              </h2>\n   853→\n   854→              <div className=\"space-y-6\">\n   855→                {/* Exception Type */}\n   856→                <div>\n   857→                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n   858→                    Tipo\n   859→                  </label>\n   860→                  <div className=\"grid grid-cols-2 gap-3\">\n   861→                    <button\n   862→                      type=\"button\"\n   863→                      onClick={() =>\n   864→                        setEditingException({\n   865→                          ...editingException,\n   866→                          isAvailable: false,\n   867→                        })\n   868→                      }\n   869→                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n   870→                        !editingException.isAvailable\n   871→                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n   872→                          : \"border-border text-muted-foreground hover:border-foreground\"\n   873→                      }`}\n   874→                    >\n   875→                      Bloqueio\n   876→                    </button>\n   877→                    <button\n   878→                      type=\"button\"\n   879→                      onClick={() =>\n   880→                        setEditingException({\n   881→                          ...editingException,\n   882→                          isAvailable: true,\n   883→                        })\n   884→                      }\n   885→                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n   886→                        editingException.isAvailable\n   887→                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n   888→                          : \"border-border text-muted-foreground hover:border-foreground\"\n   889→                      }`}\n   890→                    >\n   891→                      Disponibilidade Extra\n   892→                    </button>\n   893→                  </div>\n   894→                  <p className=\"text-xs text-muted-foreground mt-2\">\n   895→                    {editingException.isAvailable\n   896→                      ? \"Adiciona disponibilidade fora do horário normal\"\n   897→                      : \"Bloqueia a agenda para este período\"}\n   898→                  </p>\n   899→                </div>\n   900→\n   901→                {/* Date */}\n   902→                <div>\n   903→                  <label\n   904→                    htmlFor=\"exceptionDate\"\n   905→                    className=\"block text-sm font-medium text-foreground mb-2\"\n   906→                  >\n   907→                    Data\n   908→                  </label>\n   909→                  <input\n   910→                    id=\"exceptionDate\"\n   911→                    type=\"date\"\n   912→                    value={editingException.date}\n   913→                    onChange={(e) =>\n   914→                      setEditingException({\n   915→                        ...editingException,\n   916→                        date: e.target.value,\n   917→                      })\n   918→                    }\n   919→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   920→                  />\n   921→                </div>\n   922→\n   923→                {/* Full Day Toggle */}\n   924→                <div className=\"flex items-center gap-3\">\n   925→                  <button\n   926→                    type=\"button\"\n   927→                    onClick={() =>\n   928→                      setEditingException({\n   929→                        ...editingException,\n   930→                        isFullDay: !editingException.isFullDay,\n   931→                        startTime: !editingException.isFullDay ? null : \"08:00\",\n   932→                        endTime: !editingException.isFullDay ? null : \"18:00\",\n   933→                      })\n   934→                    }\n   935→                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   936→                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n   937→                    }`}\n   938→                  >\n   939→                    <span\n   940→                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n   941→                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n   942→                      }`}\n   943→                    />\n   944→                  </button>\n   945→                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n   946→                </div>\n   947→\n   948→                {/* Time Range (only if not full day) */}\n   949→                {!editingException.isFullDay && (\n   950→                  <div className=\"grid grid-cols-2 gap-4\">\n   951→                    <div>\n   952→                      <label\n   953→                        htmlFor=\"exceptionStartTime\"\n   954→                        className=\"block text-sm font-medium text-foreground mb-2\"\n   955→                      >\n   956→                        Início\n   957→                      </label>\n   958→                      <input\n   959→                        id=\"exceptionStartTime\"\n   960→                        type=\"time\"\n   961→                        value={editingException.startTime || \"\"}\n   962→                        onChange={(e) =>\n   963→                          setEditingException({\n   964→                            ...editingException,\n   965→                            startTime: e.target.value,\n   966→                          })\n   967→                        }\n   968→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   969→                      />\n   970→                    </div>\n   971→                    <div>\n   972→                      <label\n   973→                        htmlFor=\"exceptionEndTime\"\n   974→                        className=\"block text-sm font-medium text-foreground mb-2\"\n   975→                      >\n   976→                        Término\n   977→                      </label>\n   978→                      <input\n   979→                        id=\"exceptionEndTime\"\n   980→                        type=\"time\"\n   981→                        value={editingException.endTime || \"\"}\n   982→                        onChange={(e) =>\n   983→                          setEditingException({\n   984→                            ...editingException,\n   985→                            endTime: e.target.value,\n   986→                          })\n   987→                        }\n   988→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   989→                      />\n   990→                    </div>\n   991→                  </div>\n   992→                )}\n   993→\n   994→                {/* Reason */}\n   995→                <div>\n   996→                  <label\n   997→                    htmlFor=\"exceptionReason\"\n   998→                    className=\"block text-sm font-medium text-foreground mb-2\"\n   999→                  >\n  1000→                    Motivo (opcional)\n  1001→                  </label>\n  1002→                  <input\n  1003→                    id=\"exceptionReason\"\n  1004→                    type=\"text\"\n  1005→                    value={editingException.reason || \"\"}\n  1006→                    onChange={(e) =>\n  1007→                      setEditingException({\n  1008→                        ...editingException,\n  1009→                        reason: e.target.value,\n  1010→                      })\n  1011→                    }\n  1012→                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n  1013→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1014→                  />\n  1015→                </div>\n  1016→\n  1017→                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n  1018→                  <button\n  1019→                    type=\"button\"\n  1020→                    onClick={saveException}\n  1021→                    disabled={isSaving}\n  1022→                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n  1023→                  >\n  1024→                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n  1025→                  </button>\n  1026→                  <button\n  1027→                    type=\"button\"\n  1028→                    onClick={closeExceptionEditor}\n  1029→                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n  1030→                  >\n  1031→                    Cancelar\n  1032→                  </button>\n  1033→                </div>\n  1034→              </div>\n  1035→            </div>\n  1036→          </div>\n  1037→        </>\n  1038→      )}\n  1039→\n  1040→      <style jsx>{`\n  1041→        @keyframes slide-up {\n  1042→          from {\n  1043→            transform: translateY(100%);\n  1044→          }\n  1045→          to {\n  1046→            transform: translateY(0);\n  1047→          }\n  1048→        }\n  1049→        .animate-slide-up {\n  1050→          animation: slide-up 0.3s ease-out;\n  1051→        }\n  1052→      `}</style>\n  1053→    </main>\n  1054→  )\n  1055→}\n  1056→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"044aced4-e2ab-429a-83da-d2fe79563b32"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HnSNx1k447ZK2ua3MSJE8D","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01APfsZjK9NkyxYgvWAptuuj","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/tsconfig.json"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":44,"cache_creation_input_tokens":14212,"cache_read_input_tokens":64103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":14212},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7a95e5c9-7a00-4e47-b675-5be7d67e7786"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HnSNx1k447ZK2ua3MSJE8D","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FdwmQk2uWg6WM3i959XWLL","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/next.config.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":44,"cache_creation_input_tokens":14212,"cache_read_input_tokens":64103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":14212},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"330748a2-aa3b-4866-b1b8-71eea7248044"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01HnSNx1k447ZK2ua3MSJE8D","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VZiu3xHEY11Akg8bdmjije","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src/src -type f -name \"*.tsx\" | xargs grep -l \"bottom\\|navigation\\|nav\" 2>/dev/null | head -10"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":44,"cache_creation_input_tokens":14212,"cache_read_input_tokens":64103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":14212},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"3a85f97d-3b1f-4f34-a0d7-f66fa89a2354"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01APfsZjK9NkyxYgvWAptuuj","type":"tool_result","content":"     1→{\n     2→  \"compilerOptions\": {\n     3→    \"target\": \"ES2017\",\n     4→    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n     5→    \"allowJs\": true,\n     6→    \"skipLibCheck\": true,\n     7→    \"strict\": true,\n     8→    \"noEmit\": true,\n     9→    \"esModuleInterop\": true,\n    10→    \"module\": \"esnext\",\n    11→    \"moduleResolution\": \"bundler\",\n    12→    \"resolveJsonModule\": true,\n    13→    \"isolatedModules\": true,\n    14→    \"jsx\": \"react-jsx\",\n    15→    \"incremental\": true,\n    16→    \"plugins\": [\n    17→      {\n    18→        \"name\": \"next\"\n    19→      }\n    20→    ],\n    21→    \"paths\": {\n    22→      \"@/*\": [\"./src/*\"]\n    23→    }\n    24→  },\n    25→  \"include\": [\n    26→    \"next-env.d.ts\",\n    27→    \"**/*.ts\",\n    28→    \"**/*.tsx\",\n    29→    \".next/types/**/*.ts\",\n    30→    \".next/dev/types/**/*.ts\",\n    31→    \"**/*.mts\"\n    32→  ],\n    33→  \"exclude\": [\"node_modules\"]\n    34→}\n    35→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e209651c-4e66-46b3-9e85-f108cb6bd350"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FdwmQk2uWg6WM3i959XWLL","type":"tool_result","content":"     1→import type { NextConfig } from \"next\";\n     2→\n     3→const nextConfig: NextConfig = {\n     4→  /* config options here */\n     5→};\n     6→\n     7→export default nextConfig;\n     8→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"946ff98e-9355-4bbd-a1a1-ff24004be141"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VZiu3xHEY11Akg8bdmjije","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/app/admin/audit/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/professionals/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/settings/page.tsx\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx\n/mnt/d/personal/clinica/src/src/app/cancel/page.tsx\n/mnt/d/personal/clinica/src/src/app/confirm/page.tsx\n/mnt/d/personal/clinica/src/src/app/login/page.tsx\n/mnt/d/personal/clinica/src/src/app/patients/page.tsx\n/mnt/d/personal/clinica/src/src/app/profile/page.tsx\n/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"cda6ed35-c4e5-4671-89a2-01feb7488e98"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Ebv4FpH5y1pstcDjXURBa9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GJZ5rZktznzHgz1XwmL3WC","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src/prisma -name \"*.prisma\" -o -name \"schema.*\" | head -5"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1317,"cache_read_input_tokens":78315,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1317},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4ec4c9d4-e001-44d0-92ba-685e3defaee2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GJZ5rZktznzHgz1XwmL3WC","type":"tool_result","content":"/mnt/d/personal/clinica/src/prisma/schema.prisma","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a9e44fc1-9327-4330-9e66-82ac549d15cb"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01AmFXqHhzP4C2gNXNaDCvDn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YRtwi5MK6uoQqKXz1Zk196","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/prisma/schema.prisma","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":179,"cache_read_input_tokens":79632,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":179},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e72067b6-3b65-4519-813e-e335a8da809f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YRtwi5MK6uoQqKXz1Zk196","type":"tool_result","content":"     1→// This is your Prisma schema file,\n     2→// learn more about it in the docs: https://pris.ly/d/prisma-schema\n     3→\n     4→generator client {\n     5→  provider = \"prisma-client\"\n     6→  output   = \"../src/generated/prisma\"\n     7→}\n     8→\n     9→datasource db {\n    10→  provider = \"postgresql\"\n    11→  url      = env(\"DATABASE_URL\")\n    12→}\n    13→\n    14→// ============================================================================\n    15→// ENUMS\n    16→// ============================================================================\n    17→\n    18→enum Role {\n    19→  ADMIN\n    20→  PROFESSIONAL\n    21→}\n    22→\n    23→enum AppointmentStatus {\n    24→  AGENDADO\n    25→  CONFIRMADO\n    26→  CANCELADO_PACIENTE\n    27→  CANCELADO_PROFISSIONAL\n    28→  NAO_COMPARECEU\n    29→  FINALIZADO\n    30→}\n    31→\n    32→enum AppointmentModality {\n    33→  ONLINE\n    34→  PRESENCIAL\n    35→}\n    36→\n    37→enum NotificationType {\n    38→  APPOINTMENT_REMINDER\n    39→  APPOINTMENT_CONFIRMATION\n    40→  APPOINTMENT_CANCELLATION\n    41→  APPOINTMENT_RESCHEDULED\n    42→  PASSWORD_RESET\n    43→  WELCOME\n    44→}\n    45→\n    46→enum NotificationStatus {\n    47→  PENDING\n    48→  SENT\n    49→  FAILED\n    50→}\n    51→\n    52→enum NotificationChannel {\n    53→  WHATSAPP\n    54→  EMAIL\n    55→}\n    56→\n    57→enum ConsentType {\n    58→  TERMS_OF_SERVICE\n    59→  PRIVACY_POLICY\n    60→  DATA_PROCESSING\n    61→  MARKETING_COMMUNICATIONS\n    62→}\n    63→\n    64→// ============================================================================\n    65→// MODELS\n    66→// ============================================================================\n    67→\n    68→/// Represents a clinic in the multi-tenant system\n    69→model Clinic {\n    70→  id        String   @id @default(cuid())\n    71→  name      String\n    72→  slug      String   @unique\n    73→  email     String?\n    74→  phone     String?\n    75→  address   String?\n    76→  logoUrl   String?\n    77→  timezone  String   @default(\"America/Sao_Paulo\")\n    78→  isActive  Boolean  @default(true)\n    79→  createdAt DateTime @default(now())\n    80→  updatedAt DateTime @updatedAt\n    81→\n    82→  // Clinic settings\n    83→  defaultSessionDuration Int    @default(50) // in minutes\n    84→  minAdvanceBooking      Int    @default(2)  // minimum hours in advance for booking\n    85→  reminderHours          Int[]  @default([24, 2]) // hours before appointment to send reminders\n    86→\n    87→  // Relations\n    88→  users                  User[]\n    89→  patients               Patient[]\n    90→  appointments           Appointment[]\n    91→  appointmentRecurrences AppointmentRecurrence[]\n    92→  notifications          Notification[]\n    93→  auditLogs              AuditLog[]\n    94→\n    95→  @@index([slug])\n    96→  @@index([isActive])\n    97→}\n    98→\n    99→/// User account for clinic staff (admins and professionals)\n   100→model User {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"86bc133b-1f56-468c-a850-055156cb1abc"}
{"type":"assistant","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014RBamVRyauDQ9JmSUsudkK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012cdTXVwQwutwKZJ59comem","name":"Bash","input":{"command":"grep -r \"pb-\\|bottom-\" /mnt/d/personal/clinica/src/src --include=\"*.tsx\" | head -10"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1137,"cache_read_input_tokens":79811,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1137},"output_tokens":7,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a0175ea2-b974-4a56-9340-115ef5905526"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012cdTXVwQwutwKZJ59comem","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/app/admin/audit/page.tsx:          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[85vh] overflow-y-auto animate-slide-up\">\n/mnt/d/personal/clinica/src/src/app/admin/professionals/page.tsx:          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:      <main className=\"min-h-screen bg-background pb-20\">\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:    <main className=\"min-h-screen bg-background pb-20\">\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx:            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">","is_error":false}]},"parent_tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"1f7a803b-1a39-4bec-abc5-a9c357802708"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019N5mccVv3hamcLEK4DzYUN","type":"tool_result","content":[{"type":"text","text":"Perfect! Now I have a comprehensive understanding. Let me create a detailed report:\n\n## Codebase Exploration Report\n\nI've completed a thorough exploration of the **Clinica** application. Here's a comprehensive breakdown:\n\n---\n\n### 1. PROJECT STRUCTURE & FRAMEWORK\n\n**Framework**: Next.js 16.1.6 (App Router)\n- **React Version**: 19.2.3\n- **Language**: TypeScript 5\n- **Database**: PostgreSQL with Prisma ORM\n- **Authentication**: NextAuth 5 (beta)\n- **Environment**: Multi-tenant clinic management system\n\n**Directory Structure**:\n```\n/src\n├── /app                    # Next.js app router pages\n│   ├── /admin             # Admin pages (audit, professionals, settings)\n│   ├── /agenda            # Appointment scheduling\n│   ├── /api              # API routes\n│   ├── /patients         # Patient management\n│   ├── /profile          # User profile\n│   ├── /settings         # Professional settings\n│   ├── /login            # Authentication\n│   └── /cancel, /confirm # Public appointment actions\n├── /shared               # Shared components & utilities\n│   ├── /components       # SessionProvider component\n│   ├── /hooks            # (hooks library - empty structure)\n│   ├── /lib              # Utilities\n│   └── /types            # Shared TypeScript types\n├── /lib                  # Business logic\n│   ├── /api              # API utilities\n│   ├── /appointments     # Appointment logic\n│   ├── /notifications    # Notification system\n│   └── /rbac             # Role-based access control\n├── /types                # Global types\n├── /generated            # Prisma client (auto-generated)\n└── middleware.ts         # Authentication middleware\n```\n\n---\n\n### 2. UI FRAMEWORK & STYLING APPROACH\n\n**CSS Framework**: Tailwind CSS 4 with PostCSS\n\n**Styling Strategy**:\n- **Utilities**: Primarily Tailwind utility classes (no CSS modules or styled-components)\n- **Color System**: Custom CSS variables in `globals.css` with light/dark mode support\n- **Variables Used**:\n  - `--background`, `--foreground`\n  - `--border`, `--border-muted`\n  - `--muted`, `--muted-foreground`\n  - `--primary`, `--primary-foreground`\n  - `--accent`, `--accent-foreground`\n  - `--destructive`, `--destructive-foreground`\n  - `--card`, `--card-foreground`\n  - `--input`, `--ring`\n\n**Typography**: Geist Sans and Geist Mono fonts from Google Fonts\n\n**Animation Approach**: Inline CSS-in-JS with `<style jsx>` for animations:\n- `slide-up` animation for bottom sheets (300ms ease-out)\n- `scale-in` animation for dialogs (200ms ease-out)\n- `animate-pulse` for skeleton loaders\n- Standard Tailwind transitions\n\n**Responsive Design**: Mobile-first with `sm:` breakpoints throughout\n\n---\n\n### 3. COMPONENT ORGANIZATION\n\n**Layout Components**:\n- Root layout: `/src/app/layout.tsx` - Sets up Geist fonts, SessionProvider, Sonner toaster\n- Page-level layouts: Each route has its own layout structure\n\n**Key Component Patterns**:\n- **Sheet/Modal Pattern**: Fixed bottom sheets for mobile (`.fixed.inset-x-0.bottom-0.rounded-t-2xl`)\n- **Suspense Boundaries**: Used for loading states (e.g., LoginForm, AvailabilitySettings)\n- **Client Components**: Marked with `\"use client\"` for interactivity\n\n**Session Management**:\n- `SessionProvider` wraps entire app (next-auth integration)\n- Session data accessed via `useSession()` hook\n- Authentication-based routing with redirects to `/login`\n\n---\n\n### 4. EXISTING NAVIGATION PATTERNS\n\n**Bottom Navigation Implementation** (Fixed/Persistent):\nLocation: `/src/app/agenda/page.tsx` (lines 1586-1621)\n\n```tsx\n<nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n  <div className=\"max-w-4xl mx-auto px-4\">\n    <div className=\"flex items-center justify-around h-16\">\n      {/* 3 navigation items */}\n    </div>\n  </div>\n</nav>\n```\n\n**Navigation Items** (Current):\n1. **Agenda** - Calendar/scheduling view (`/agenda`)\n   - Icon: Calendar icon\n   - Status: Active with `text-primary`\n   \n2. **Patients** - Patient list/management (`/patients`)\n   - Icon: People/users icon\n   - Status: Inactive with `text-muted-foreground`\n   \n3. **Settings** - Availability configuration (`/settings/availability`)\n   - Icon: Gear/settings icon\n   - Status: Inactive with `text-muted-foreground`\n\n**Navigation Styling**:\n- Height: `h-16` (64px)\n- Layout: `flex items-center justify-around`\n- Typography: Icons + `text-xs font-medium` labels\n- Z-index: `z-40`\n- Border: Top border with `border-border` color\n- Hover state: `transition-colors` on inactive items\n\n**Content Padding**:\n- Main pages use `pb-20` to add bottom padding (to prevent content overlap with nav)\n- FAB (Floating Action Button) positioned at `bottom-24` (to sit above navigation)\n\n---\n\n### 5. MOBILE/RESPONSIVE IMPLEMENTATIONS\n\n**Mobile-First Design**:\n- All pages use responsive Tailwind classes (`sm:`, `md:`)\n- Flexible layouts with `flex flex-col sm:flex-row`\n- Adaptive grid systems for form layouts\n\n**Viewport Configuration**:\n```typescript\nviewport: {\n  width: \"device-width\",\n  initialScale: 1,\n  maximumScale: 1,\n  userScalable: false,\n  themeColor: [...]\n}\n```\n\n**Mobile Features Implemented**:\n1. **Touch Gestures** (Agenda page):\n   - Swipe left/right for date navigation\n   - Touch handlers: `handleTouchStart`, `handleTouchMove`, `handleTouchEnd`\n   - Threshold: 50px for swipe detection\n\n2. **Bottom Sheets**: Mobile-optimized modal pattern\n   - Appear from bottom with rounded top corners\n   - Drag handle indicator (small bar at top)\n   - Max height: 90vh for overflow content\n   - Click outside to close (backdrop)\n\n3. **FAB Pattern** (Floating Action Button):\n   - Position: `fixed right-4 bottom-24`\n   - Size: `w-14 h-14` (56x56px)\n   - Purpose: Quick action for creating appointments\n   - Accessible with shadow and hover states\n\n4. **Form Inputs**: Mobile-optimized\n   - Height: `h-12` (48px) for easy touch targets\n   - Full width on mobile with `w-full`\n   - Conditional stacking on small screens\n\n5. **Landscape/Portrait Awareness**:\n   - Forms adapt to screen size\n   - Input fields stack vertically on mobile\n   - Buttons flex to available space\n\n---\n\n### 6. LOADING & ERROR STATE PATTERNS\n\n**Loading States**:\n1. **Skeleton Loaders** (Pulse Animation):\n   ```tsx\n   <div className=\"animate-pulse space-y-6\">\n     <div className=\"h-12 w-full bg-muted rounded\" />\n     {/* repeated blocks */}\n   </div>\n   ```\n   - Used in: Agenda, Patients, Profile pages\n   - Pattern: Repeated `div` elements with `bg-muted` matching content structure\n\n2. **Loading Indicators**:\n   - Button states: `disabled:opacity-50 disabled:cursor-not-allowed`\n   - Spinner: SVG circle animation (seen in patient search)\n   - Text updates: \"Salvando...\" vs \"Salvar alterações\"\n\n3. **Suspense Boundaries**:\n   ```tsx\n   <Suspense fallback={<LoginFormFallback />}>\n     <LoginForm />\n   </Suspense>\n   ```\n\n**Error Handling**:\n1. **Toast Notifications** (Sonner):\n   - Position: `top-right`\n   - Rich colors enabled\n   - Usage: `toast.error()`, `toast.success()`\n   - Examples: \"Erro ao carregar pacientes\", \"Agendamento criado com sucesso\"\n\n2. **Inline Form Errors** (Zod Validation):\n   ```tsx\n   {errors.name && (\n     <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n   )}\n   ```\n   - Color: `text-destructive` (red)\n   - Positioned below inputs with `mt-1`\n\n3. **Auth Errors**:\n   - Login page shows error banner above form\n   - Format: `bg-destructive/10 border border-destructive/20`\n   - Message: \"Email ou senha incorretos\"\n\n4. **Empty States**:\n   - Centered layout with icon placeholder\n   - Descriptive messaging\n   - Secondary actions when relevant\n\n---\n\n### 7. CSS/STYLING APPROACH - DETAILED\n\n**Design System**:\n- **Color Palette**: Minimalist, neutral-focused\n  - Primary: Dark gray (`#3f3f46`) - switches to light in dark mode\n  - Background: Light (`#fafafa`) - switches to dark (`#09090b`)\n  - Borders: Subtle (`#e4e4e7`)\n  - Status colors: Blue (scheduled), Green (confirmed), Red (cancelled), Yellow (no-show)\n\n**Tailwind Customization**:\n- Theme defined via CSS variables in `globals.css`\n- Config uses `@theme inline` with custom color palette\n- No custom Tailwind config file (uses Tailwind 4 defaults)\n\n**Layout Patterns**:\n1. **Container**: `max-w-4xl mx-auto px-4`\n2. **Grid**: `grid grid-cols-1 sm:grid-cols-2 gap-4`\n3. **Flex Containers**: `flex flex-col sm:flex-row gap-4`\n4. **Spacing**: Consistent `mb-6`, `py-8`, `space-y-4` patterns\n\n**Button Styling**:\n- Primary: `bg-primary text-primary-foreground`\n- Secondary: `border border-input bg-background text-foreground`\n- Destructive: `border-destructive text-destructive`\n- Always include: Focus rings `focus:ring-2 focus:ring-ring`\n\n**Input Styling**:\n```tsx\nclassName=\"w-full h-12 px-4 rounded-md border border-input bg-background \n  text-foreground placeholder:text-muted-foreground \n  focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent \n  transition-colors\"\n```\n\n**Animation Utilities**:\n- `transition-colors`, `transition-all` for smooth state changes\n- `animate-pulse` for skeleton loaders\n- Custom `slide-up` for sheet animations\n- Custom `scale-in` for dialog animations\n\n---\n\n### 8. EXISTING BOTTOM NAVIGATION & FAB COMPONENTS\n\n**Current Bottom Navigation** (Agenda page):\n- **Location**: Fixed to bottom (z-40)\n- **Height**: 16 units (64px)\n- **Items**: 3 navigation buttons\n- **Typography**: Icons + text labels below\n- **Inactive State**: Gray color with hover transition\n\n**FAB Implementation**:\n- **Position**: `fixed right-4 bottom-24` (24 units = 96px from bottom)\n- **Size**: 56x56px (w-14 h-14)\n- **Shape**: `rounded-full`\n- **Styling**: Primary background, white icon, shadow\n- **Interaction**: Hover opacity change, focus ring\n- **Z-index**: 30 (below bottom nav which is z-40)\n\n**Action Sheets/Modals**:\n- **Bottom Sheets**: Pop up from bottom of screen\n- **Handle Bar**: Small visual indicator at top\n- **Backdrop**: Semi-transparent black overlay (z-40)\n- **Content**: Scrollable with max-height 90vh\n- **Animations**: Slide up from bottom (300ms)\n- **Close**: Click backdrop or button\n\n---\n\n### 9. FORM PATTERNS & VALIDATION\n\n**Form Library**: React Hook Form with Zod schema validation\n\n**Example Schema**:\n```typescript\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n```\n\n**Form Features**:\n- Dynamic field visibility (e.g., time fields only if not full day)\n- Conditional required fields\n- Real-time validation feedback\n- Dirty state tracking for save buttons\n- Reset/clear functionality\n\n---\n\n### 10. KEY FILE LOCATIONS FOR REFERENCE\n\n| Component/Feature | Location |\n|---|---|\n| **Bottom Navigation** | `/src/app/agenda/page.tsx` (lines 1586-1621) |\n| **FAB Button** | `/src/app/agenda/page.tsx` (lines 996-1005) |\n| **Styling System** | `/src/app/globals.css` |\n| **Layout Root** | `/src/app/layout.tsx` |\n| **Session Provider** | `/src/shared/components/session-provider.tsx` |\n| **Theme Colors** | `/src/app/globals.css` (lines 3-81) |\n| **Toast Notifications** | Sonner (installed, used via `toast` from `sonner`) |\n| **Touch Gestures** | `/src/app/agenda/page.tsx` (lines 693-719) |\n| **Bottom Sheet Pattern** | Multiple pages (agenda, patients, settings) |\n| **Animations** | Inline `<style jsx>` in each component |\n\n---\n\n### 11. STATE MANAGEMENT & DATA FLOW\n\n**Patterns Used**:\n- **React Hooks**: `useState`, `useCallback`, `useEffect`, `useRef`, `useContext`\n- **Next.js Hooks**: `useRouter`, `useSearchParams`, `useSession`\n- **Form State**: React Hook Form with Zod validation\n- **API Fetching**: Native `fetch()` API with error handling\n\n**Session Management**:\n- NextAuth for authentication\n- Session stored in context via SessionProvider\n- Protected routes redirect to `/login` if unauthenticated\n- Role-based features (ADMIN vs PROFESSIONAL)\n\n---\n\n### 12. RESPONSIVE BREAKPOINTS IN USE\n\n- **Mobile-first** design with `sm:` (640px) breakpoint\n- Some `md:` usage for larger layouts\n- Flex direction changes: `flex-col` → `sm:flex-row`\n- Width adjustments: `w-full` → `sm:w-auto`\n- Grid columns: `grid-cols-1` → `sm:grid-cols-2`\n\n---\n\n### SUMMARY\n\nThis is a **modern Next.js clinic management application** with:\n- ✓ React 19 + TypeScript\n- ✓ Tailwind CSS 4 with custom theme variables\n- ✓ Bottom navigation for mobile (3 items)\n- ✓ FAB for quick actions\n- ✓ Bottom sheet modals for forms\n- ✓ Touch gesture support (swipe navigation)\n- ✓ Comprehensive error handling with toasts\n- ✓ Skeleton loaders for loading states\n- ✓ Form validation with Zod + React Hook Form\n- ✓ Mobile-first responsive design\n- ✓ Dark mode support via CSS variables\n- ✓ Multi-tenant Prisma database\n- ✓ NextAuth authentication with roles (ADMIN, PROFESSIONAL)\n\nAll file paths are absolute and ready for reference!"},{"type":"text","text":"agentId: a3eb09b (for resuming to continue this agent's work if needed)"}]}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"250fe3f3-11db-4baa-8b74-8075ffdc9bbe","tool_use_result":{"status":"completed","prompt":"Explore this codebase to understand:\n1. The overall project structure (is it React, Vue, Next.js, etc.)\n2. Current component organization\n3. Existing navigation patterns\n4. Current mobile/responsive implementations\n5. CSS/styling approach (Tailwind, CSS modules, styled-components, etc.)\n6. Any existing bottom navigation or FAB components\n7. Current loading/error state patterns\n\nFocus on finding:\n- Main layout components\n- Navigation components\n- Any mobile-specific code\n- UI component library being used (if any)","agentId":"a3eb09b","content":[{"type":"text","text":"Perfect! Now I have a comprehensive understanding. Let me create a detailed report:\n\n## Codebase Exploration Report\n\nI've completed a thorough exploration of the **Clinica** application. Here's a comprehensive breakdown:\n\n---\n\n### 1. PROJECT STRUCTURE & FRAMEWORK\n\n**Framework**: Next.js 16.1.6 (App Router)\n- **React Version**: 19.2.3\n- **Language**: TypeScript 5\n- **Database**: PostgreSQL with Prisma ORM\n- **Authentication**: NextAuth 5 (beta)\n- **Environment**: Multi-tenant clinic management system\n\n**Directory Structure**:\n```\n/src\n├── /app                    # Next.js app router pages\n│   ├── /admin             # Admin pages (audit, professionals, settings)\n│   ├── /agenda            # Appointment scheduling\n│   ├── /api              # API routes\n│   ├── /patients         # Patient management\n│   ├── /profile          # User profile\n│   ├── /settings         # Professional settings\n│   ├── /login            # Authentication\n│   └── /cancel, /confirm # Public appointment actions\n├── /shared               # Shared components & utilities\n│   ├── /components       # SessionProvider component\n│   ├── /hooks            # (hooks library - empty structure)\n│   ├── /lib              # Utilities\n│   └── /types            # Shared TypeScript types\n├── /lib                  # Business logic\n│   ├── /api              # API utilities\n│   ├── /appointments     # Appointment logic\n│   ├── /notifications    # Notification system\n│   └── /rbac             # Role-based access control\n├── /types                # Global types\n├── /generated            # Prisma client (auto-generated)\n└── middleware.ts         # Authentication middleware\n```\n\n---\n\n### 2. UI FRAMEWORK & STYLING APPROACH\n\n**CSS Framework**: Tailwind CSS 4 with PostCSS\n\n**Styling Strategy**:\n- **Utilities**: Primarily Tailwind utility classes (no CSS modules or styled-components)\n- **Color System**: Custom CSS variables in `globals.css` with light/dark mode support\n- **Variables Used**:\n  - `--background`, `--foreground`\n  - `--border`, `--border-muted`\n  - `--muted`, `--muted-foreground`\n  - `--primary`, `--primary-foreground`\n  - `--accent`, `--accent-foreground`\n  - `--destructive`, `--destructive-foreground`\n  - `--card`, `--card-foreground`\n  - `--input`, `--ring`\n\n**Typography**: Geist Sans and Geist Mono fonts from Google Fonts\n\n**Animation Approach**: Inline CSS-in-JS with `<style jsx>` for animations:\n- `slide-up` animation for bottom sheets (300ms ease-out)\n- `scale-in` animation for dialogs (200ms ease-out)\n- `animate-pulse` for skeleton loaders\n- Standard Tailwind transitions\n\n**Responsive Design**: Mobile-first with `sm:` breakpoints throughout\n\n---\n\n### 3. COMPONENT ORGANIZATION\n\n**Layout Components**:\n- Root layout: `/src/app/layout.tsx` - Sets up Geist fonts, SessionProvider, Sonner toaster\n- Page-level layouts: Each route has its own layout structure\n\n**Key Component Patterns**:\n- **Sheet/Modal Pattern**: Fixed bottom sheets for mobile (`.fixed.inset-x-0.bottom-0.rounded-t-2xl`)\n- **Suspense Boundaries**: Used for loading states (e.g., LoginForm, AvailabilitySettings)\n- **Client Components**: Marked with `\"use client\"` for interactivity\n\n**Session Management**:\n- `SessionProvider` wraps entire app (next-auth integration)\n- Session data accessed via `useSession()` hook\n- Authentication-based routing with redirects to `/login`\n\n---\n\n### 4. EXISTING NAVIGATION PATTERNS\n\n**Bottom Navigation Implementation** (Fixed/Persistent):\nLocation: `/src/app/agenda/page.tsx` (lines 1586-1621)\n\n```tsx\n<nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n  <div className=\"max-w-4xl mx-auto px-4\">\n    <div className=\"flex items-center justify-around h-16\">\n      {/* 3 navigation items */}\n    </div>\n  </div>\n</nav>\n```\n\n**Navigation Items** (Current):\n1. **Agenda** - Calendar/scheduling view (`/agenda`)\n   - Icon: Calendar icon\n   - Status: Active with `text-primary`\n   \n2. **Patients** - Patient list/management (`/patients`)\n   - Icon: People/users icon\n   - Status: Inactive with `text-muted-foreground`\n   \n3. **Settings** - Availability configuration (`/settings/availability`)\n   - Icon: Gear/settings icon\n   - Status: Inactive with `text-muted-foreground`\n\n**Navigation Styling**:\n- Height: `h-16` (64px)\n- Layout: `flex items-center justify-around`\n- Typography: Icons + `text-xs font-medium` labels\n- Z-index: `z-40`\n- Border: Top border with `border-border` color\n- Hover state: `transition-colors` on inactive items\n\n**Content Padding**:\n- Main pages use `pb-20` to add bottom padding (to prevent content overlap with nav)\n- FAB (Floating Action Button) positioned at `bottom-24` (to sit above navigation)\n\n---\n\n### 5. MOBILE/RESPONSIVE IMPLEMENTATIONS\n\n**Mobile-First Design**:\n- All pages use responsive Tailwind classes (`sm:`, `md:`)\n- Flexible layouts with `flex flex-col sm:flex-row`\n- Adaptive grid systems for form layouts\n\n**Viewport Configuration**:\n```typescript\nviewport: {\n  width: \"device-width\",\n  initialScale: 1,\n  maximumScale: 1,\n  userScalable: false,\n  themeColor: [...]\n}\n```\n\n**Mobile Features Implemented**:\n1. **Touch Gestures** (Agenda page):\n   - Swipe left/right for date navigation\n   - Touch handlers: `handleTouchStart`, `handleTouchMove`, `handleTouchEnd`\n   - Threshold: 50px for swipe detection\n\n2. **Bottom Sheets**: Mobile-optimized modal pattern\n   - Appear from bottom with rounded top corners\n   - Drag handle indicator (small bar at top)\n   - Max height: 90vh for overflow content\n   - Click outside to close (backdrop)\n\n3. **FAB Pattern** (Floating Action Button):\n   - Position: `fixed right-4 bottom-24`\n   - Size: `w-14 h-14` (56x56px)\n   - Purpose: Quick action for creating appointments\n   - Accessible with shadow and hover states\n\n4. **Form Inputs**: Mobile-optimized\n   - Height: `h-12` (48px) for easy touch targets\n   - Full width on mobile with `w-full`\n   - Conditional stacking on small screens\n\n5. **Landscape/Portrait Awareness**:\n   - Forms adapt to screen size\n   - Input fields stack vertically on mobile\n   - Buttons flex to available space\n\n---\n\n### 6. LOADING & ERROR STATE PATTERNS\n\n**Loading States**:\n1. **Skeleton Loaders** (Pulse Animation):\n   ```tsx\n   <div className=\"animate-pulse space-y-6\">\n     <div className=\"h-12 w-full bg-muted rounded\" />\n     {/* repeated blocks */}\n   </div>\n   ```\n   - Used in: Agenda, Patients, Profile pages\n   - Pattern: Repeated `div` elements with `bg-muted` matching content structure\n\n2. **Loading Indicators**:\n   - Button states: `disabled:opacity-50 disabled:cursor-not-allowed`\n   - Spinner: SVG circle animation (seen in patient search)\n   - Text updates: \"Salvando...\" vs \"Salvar alterações\"\n\n3. **Suspense Boundaries**:\n   ```tsx\n   <Suspense fallback={<LoginFormFallback />}>\n     <LoginForm />\n   </Suspense>\n   ```\n\n**Error Handling**:\n1. **Toast Notifications** (Sonner):\n   - Position: `top-right`\n   - Rich colors enabled\n   - Usage: `toast.error()`, `toast.success()`\n   - Examples: \"Erro ao carregar pacientes\", \"Agendamento criado com sucesso\"\n\n2. **Inline Form Errors** (Zod Validation):\n   ```tsx\n   {errors.name && (\n     <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n   )}\n   ```\n   - Color: `text-destructive` (red)\n   - Positioned below inputs with `mt-1`\n\n3. **Auth Errors**:\n   - Login page shows error banner above form\n   - Format: `bg-destructive/10 border border-destructive/20`\n   - Message: \"Email ou senha incorretos\"\n\n4. **Empty States**:\n   - Centered layout with icon placeholder\n   - Descriptive messaging\n   - Secondary actions when relevant\n\n---\n\n### 7. CSS/STYLING APPROACH - DETAILED\n\n**Design System**:\n- **Color Palette**: Minimalist, neutral-focused\n  - Primary: Dark gray (`#3f3f46`) - switches to light in dark mode\n  - Background: Light (`#fafafa`) - switches to dark (`#09090b`)\n  - Borders: Subtle (`#e4e4e7`)\n  - Status colors: Blue (scheduled), Green (confirmed), Red (cancelled), Yellow (no-show)\n\n**Tailwind Customization**:\n- Theme defined via CSS variables in `globals.css`\n- Config uses `@theme inline` with custom color palette\n- No custom Tailwind config file (uses Tailwind 4 defaults)\n\n**Layout Patterns**:\n1. **Container**: `max-w-4xl mx-auto px-4`\n2. **Grid**: `grid grid-cols-1 sm:grid-cols-2 gap-4`\n3. **Flex Containers**: `flex flex-col sm:flex-row gap-4`\n4. **Spacing**: Consistent `mb-6`, `py-8`, `space-y-4` patterns\n\n**Button Styling**:\n- Primary: `bg-primary text-primary-foreground`\n- Secondary: `border border-input bg-background text-foreground`\n- Destructive: `border-destructive text-destructive`\n- Always include: Focus rings `focus:ring-2 focus:ring-ring`\n\n**Input Styling**:\n```tsx\nclassName=\"w-full h-12 px-4 rounded-md border border-input bg-background \n  text-foreground placeholder:text-muted-foreground \n  focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent \n  transition-colors\"\n```\n\n**Animation Utilities**:\n- `transition-colors`, `transition-all` for smooth state changes\n- `animate-pulse` for skeleton loaders\n- Custom `slide-up` for sheet animations\n- Custom `scale-in` for dialog animations\n\n---\n\n### 8. EXISTING BOTTOM NAVIGATION & FAB COMPONENTS\n\n**Current Bottom Navigation** (Agenda page):\n- **Location**: Fixed to bottom (z-40)\n- **Height**: 16 units (64px)\n- **Items**: 3 navigation buttons\n- **Typography**: Icons + text labels below\n- **Inactive State**: Gray color with hover transition\n\n**FAB Implementation**:\n- **Position**: `fixed right-4 bottom-24` (24 units = 96px from bottom)\n- **Size**: 56x56px (w-14 h-14)\n- **Shape**: `rounded-full`\n- **Styling**: Primary background, white icon, shadow\n- **Interaction**: Hover opacity change, focus ring\n- **Z-index**: 30 (below bottom nav which is z-40)\n\n**Action Sheets/Modals**:\n- **Bottom Sheets**: Pop up from bottom of screen\n- **Handle Bar**: Small visual indicator at top\n- **Backdrop**: Semi-transparent black overlay (z-40)\n- **Content**: Scrollable with max-height 90vh\n- **Animations**: Slide up from bottom (300ms)\n- **Close**: Click backdrop or button\n\n---\n\n### 9. FORM PATTERNS & VALIDATION\n\n**Form Library**: React Hook Form with Zod schema validation\n\n**Example Schema**:\n```typescript\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n```\n\n**Form Features**:\n- Dynamic field visibility (e.g., time fields only if not full day)\n- Conditional required fields\n- Real-time validation feedback\n- Dirty state tracking for save buttons\n- Reset/clear functionality\n\n---\n\n### 10. KEY FILE LOCATIONS FOR REFERENCE\n\n| Component/Feature | Location |\n|---|---|\n| **Bottom Navigation** | `/src/app/agenda/page.tsx` (lines 1586-1621) |\n| **FAB Button** | `/src/app/agenda/page.tsx` (lines 996-1005) |\n| **Styling System** | `/src/app/globals.css` |\n| **Layout Root** | `/src/app/layout.tsx` |\n| **Session Provider** | `/src/shared/components/session-provider.tsx` |\n| **Theme Colors** | `/src/app/globals.css` (lines 3-81) |\n| **Toast Notifications** | Sonner (installed, used via `toast` from `sonner`) |\n| **Touch Gestures** | `/src/app/agenda/page.tsx` (lines 693-719) |\n| **Bottom Sheet Pattern** | Multiple pages (agenda, patients, settings) |\n| **Animations** | Inline `<style jsx>` in each component |\n\n---\n\n### 11. STATE MANAGEMENT & DATA FLOW\n\n**Patterns Used**:\n- **React Hooks**: `useState`, `useCallback`, `useEffect`, `useRef`, `useContext`\n- **Next.js Hooks**: `useRouter`, `useSearchParams`, `useSession`\n- **Form State**: React Hook Form with Zod validation\n- **API Fetching**: Native `fetch()` API with error handling\n\n**Session Management**:\n- NextAuth for authentication\n- Session stored in context via SessionProvider\n- Protected routes redirect to `/login` if unauthenticated\n- Role-based features (ADMIN vs PROFESSIONAL)\n\n---\n\n### 12. RESPONSIVE BREAKPOINTS IN USE\n\n- **Mobile-first** design with `sm:` (640px) breakpoint\n- Some `md:` usage for larger layouts\n- Flex direction changes: `flex-col` → `sm:flex-row`\n- Width adjustments: `w-full` → `sm:w-auto`\n- Grid columns: `grid-cols-1` → `sm:grid-cols-2`\n\n---\n\n### SUMMARY\n\nThis is a **modern Next.js clinic management application** with:\n- ✓ React 19 + TypeScript\n- ✓ Tailwind CSS 4 with custom theme variables\n- ✓ Bottom navigation for mobile (3 items)\n- ✓ FAB for quick actions\n- ✓ Bottom sheet modals for forms\n- ✓ Touch gesture support (swipe navigation)\n- ✓ Comprehensive error handling with toasts\n- ✓ Skeleton loaders for loading states\n- ✓ Form validation with Zod + React Hook Form\n- ✓ Mobile-first responsive design\n- ✓ Dark mode support via CSS variables\n- ✓ Multi-tenant Prisma database\n- ✓ NextAuth authentication with roles (ADMIN, PROFESSIONAL)\n\nAll file paths are absolute and ready for reference!"}],"totalDurationMs":67220,"totalTokens":81764,"totalToolUseCount":28,"usage":{"input_tokens":0,"cache_creation_input_tokens":815,"cache_read_input_tokens":80948,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":815},"output_tokens":1,"service_tier":"standard"}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017vETjXS1juiRmb5VWgWEzi","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a comprehensive understanding of the codebase. Let me create a todo list to track the implementation of all acceptance criteria."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4289,"cache_read_input_tokens":31635,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4289},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"d3cac430-6995-44ac-9e88-4cd825ab0947"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017vETjXS1juiRmb5VWgWEzi","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VoR7YhCfuv8mWPdJTMPQtX","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"pending","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"pending","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4289,"cache_read_input_tokens":31635,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4289},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"07c15baf-87bd-4544-b583-f1caf06ef22c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VoR7YhCfuv8mWPdJTMPQtX","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a0f71054-46e9-4be4-8987-8137caea585e","tool_use_result":{"oldTodos":[],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"pending","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"pending","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_013Wx995iYgNaUtvF9WJTUSD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011X5emrp4xrCPQMMsV6qAFk","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"in_progress","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"pending","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":440,"cache_read_input_tokens":35924,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":440},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9bc07c60-6fec-472b-b9db-659bb6953c15"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011X5emrp4xrCPQMMsV6qAFk","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"5a507926-06d6-4b98-91f5-fa817380323b","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"pending","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"pending","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"in_progress","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"pending","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014oLTEB4SSwyoyfQyn83Kdp","type":"message","role":"assistant","content":[{"type":"text","text":"Let me read the current component directory structure and look at existing patterns more closely."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":36364,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"02881352-2a5c-4088-969f-fb92d8856acc"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014oLTEB4SSwyoyfQyn83Kdp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JNybtZL3PuGYTqZn2EhqpZ","name":"Glob","input":{"pattern":"**/components/**/*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":36364,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"62b391e0-26f2-40e7-9b49-f13dbe53587a"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014oLTEB4SSwyoyfQyn83Kdp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0174LRmo2bCUrD19AvkA5eyL","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/app/globals.css"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":36364,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9df6cbd6-a106-4cdd-b5ab-8b1fb33c64ad"}
{"type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File does not exist.</tool_use_error>","is_error":true,"tool_use_id":"toolu_0174LRmo2bCUrD19AvkA5eyL"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e09b6157-0136-4a7f-8408-ae2cc91d97ec","tool_use_result":"Error: File does not exist."}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JNybtZL3PuGYTqZn2EhqpZ","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/shared/components/session-provider.tsx"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b8ea47d2-6b3f-4b04-ac3d-6f4ec76c436c","tool_use_result":{"filenames":["/mnt/d/personal/clinica/src/src/shared/components/session-provider.tsx"],"durationMs":6032,"numFiles":1,"truncated":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014kNKAtduRBQcriF234Zf2Z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01K1ATcLaKHTxfHJci2ev7hm","name":"Bash","input":{"command":"ls -la /mnt/d/personal/clinica/src/","description":"List root directory structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":46,"cache_creation_input_tokens":181,"cache_read_input_tokens":36778,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":181},"output_tokens":26,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9e76a138-b161-4934-a8e6-3435766a6b96"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01K1ATcLaKHTxfHJci2ev7hm","type":"tool_result","content":"total 471\ndrwxrwxrwx 1 root root    512 Jan 29 08:49 .\ndrwxrwxrwx 1 root root    512 Jan 28 21:14 ..\n-rwxrwxrwx 1 root root    327 Jan 28 21:36 .env\n-rwxrwxrwx 1 root root    431 Jan 28 21:46 .env.example\n-rwxrwxrwx 1 root root    115 Jan 28 21:46 .env.local\ndrwxrwxrwx 1 root root    512 Jan 29 08:52 .git\n-rwxrwxrwx 1 root root    517 Jan 28 21:36 .gitignore\ndrwxrwxrwx 1 root root    512 Jan 29 08:41 .next\ndrwxrwxrwx 1 root root    512 Jan 29 08:42 .ralph-tui\n-rwxrwxrwx 1 root root   2670 Jan 29 08:49 README.md\n-rwxrwxrwx 1 root root    580 Jan 28 21:29 docker-compose.yml\n-rwxrwxrwx 1 root root    465 Jan 28 21:27 eslint.config.mjs\n-rwxrwxrwx 1 root root    247 Jan 29 07:26 next-env.d.ts\n-rwxrwxrwx 1 root root    133 Jan 28 21:27 next.config.ts\ndrwxrwxrwx 1 root root    512 Jan 29 08:50 node_modules\n-rwxrwxrwx 1 root root 264676 Jan 29 08:50 package-lock.json\n-rwxrwxrwx 1 root root   1173 Jan 29 08:50 package.json\n-rwxrwxrwx 1 root root     94 Jan 28 21:27 postcss.config.mjs\ndrwxrwxrwx 1 root root    512 Jan 29 08:49 prisma\n-rwxrwxrwx 1 root root    392 Jan 28 21:36 prisma.config.ts\ndrwxrwxrwx 1 root root    512 Jan 28 21:27 public\ndrwxrwxrwx 1 root root    512 Jan 28 21:50 src\ndrwxrwxrwx 1 root root    512 Jan 28 21:26 tasks\n-rwxrwxrwx 1 root root    670 Jan 28 21:27 tsconfig.json\n-rwxrwxrwx 1 root root 202036 Jan 29 08:51 tsconfig.tsbuildinfo","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"23040c90-d57f-4ead-a27b-9605bd28eb23","tool_use_result":{"stdout":"total 471\ndrwxrwxrwx 1 root root    512 Jan 29 08:49 .\ndrwxrwxrwx 1 root root    512 Jan 28 21:14 ..\n-rwxrwxrwx 1 root root    327 Jan 28 21:36 .env\n-rwxrwxrwx 1 root root    431 Jan 28 21:46 .env.example\n-rwxrwxrwx 1 root root    115 Jan 28 21:46 .env.local\ndrwxrwxrwx 1 root root    512 Jan 29 08:52 .git\n-rwxrwxrwx 1 root root    517 Jan 28 21:36 .gitignore\ndrwxrwxrwx 1 root root    512 Jan 29 08:41 .next\ndrwxrwxrwx 1 root root    512 Jan 29 08:42 .ralph-tui\n-rwxrwxrwx 1 root root   2670 Jan 29 08:49 README.md\n-rwxrwxrwx 1 root root    580 Jan 28 21:29 docker-compose.yml\n-rwxrwxrwx 1 root root    465 Jan 28 21:27 eslint.config.mjs\n-rwxrwxrwx 1 root root    247 Jan 29 07:26 next-env.d.ts\n-rwxrwxrwx 1 root root    133 Jan 28 21:27 next.config.ts\ndrwxrwxrwx 1 root root    512 Jan 29 08:50 node_modules\n-rwxrwxrwx 1 root root 264676 Jan 29 08:50 package-lock.json\n-rwxrwxrwx 1 root root   1173 Jan 29 08:50 package.json\n-rwxrwxrwx 1 root root     94 Jan 28 21:27 postcss.config.mjs\ndrwxrwxrwx 1 root root    512 Jan 29 08:49 prisma\n-rwxrwxrwx 1 root root    392 Jan 28 21:36 prisma.config.ts\ndrwxrwxrwx 1 root root    512 Jan 28 21:27 public\ndrwxrwxrwx 1 root root    512 Jan 28 21:50 src\ndrwxrwxrwx 1 root root    512 Jan 28 21:26 tasks\n-rwxrwxrwx 1 root root    670 Jan 28 21:27 tsconfig.json\n-rwxrwxrwx 1 root root 202036 Jan 29 08:51 tsconfig.tsbuildinfo","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Fy6FhAGSA2YVFw7JSKXkVX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JZTQLuPyg93Rx5fd5aorWT","name":"Bash","input":{"command":"find /mnt/d/personal/clinica/src/src -type f -name \"*.tsx\" -o -name \"*.css\" | head -50","description":"Find all tsx and css files"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":893,"cache_read_input_tokens":36959,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":893},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"ea3c1ebf-3639-495b-8e75-b00421fcbd4d"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JZTQLuPyg93Rx5fd5aorWT","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/app/admin/audit/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/professionals/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/settings/page.tsx\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx\n/mnt/d/personal/clinica/src/src/app/cancel/page.tsx\n/mnt/d/personal/clinica/src/src/app/confirm/page.tsx\n/mnt/d/personal/clinica/src/src/app/globals.css\n/mnt/d/personal/clinica/src/src/app/layout.tsx\n/mnt/d/personal/clinica/src/src/app/login/page.tsx\n/mnt/d/personal/clinica/src/src/app/page.tsx\n/mnt/d/personal/clinica/src/src/app/patients/page.tsx\n/mnt/d/personal/clinica/src/src/app/profile/page.tsx\n/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx\n/mnt/d/personal/clinica/src/src/shared/components/session-provider.tsx","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"ff3e1a19-b445-4c57-b1aa-7dbee154a3cb","tool_use_result":{"stdout":"/mnt/d/personal/clinica/src/src/app/admin/audit/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/professionals/page.tsx\n/mnt/d/personal/clinica/src/src/app/admin/settings/page.tsx\n/mnt/d/personal/clinica/src/src/app/agenda/page.tsx\n/mnt/d/personal/clinica/src/src/app/cancel/page.tsx\n/mnt/d/personal/clinica/src/src/app/confirm/page.tsx\n/mnt/d/personal/clinica/src/src/app/globals.css\n/mnt/d/personal/clinica/src/src/app/layout.tsx\n/mnt/d/personal/clinica/src/src/app/login/page.tsx\n/mnt/d/personal/clinica/src/src/app/page.tsx\n/mnt/d/personal/clinica/src/src/app/patients/page.tsx\n/mnt/d/personal/clinica/src/src/app/profile/page.tsx\n/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx\n/mnt/d/personal/clinica/src/src/shared/components/session-provider.tsx","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RraJVdK4TkSKMRH5bE9tca","type":"message","role":"assistant","content":[{"type":"text","text":"Now I understand the structure - the src folder is inside `/mnt/d/personal/clinica/src/src/`. Let me read the key files."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":445,"cache_read_input_tokens":37852,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":445},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"1d617435-73e8-4b63-b1c5-daefe7d13b3e"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RraJVdK4TkSKMRH5bE9tca","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014SLBShiRNb4o5ZVdUZ6VWg","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/globals.css"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":445,"cache_read_input_tokens":37852,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":445},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"993bdc8e-55a1-498f-922e-bce2b8de7580"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RraJVdK4TkSKMRH5bE9tca","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VRPbDyNU15skNeegpNU5QK","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/layout.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":445,"cache_read_input_tokens":37852,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":445},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"62dfa6d5-2065-4d0b-a2e2-9d655b4ac4cc"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RraJVdK4TkSKMRH5bE9tca","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JpRtjxMintTg3asP6qm2KU","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":445,"cache_read_input_tokens":37852,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":445},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"6a566fda-1966-4ce9-b907-bc72fb4c9e58"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014SLBShiRNb4o5ZVdUZ6VWg","type":"tool_result","content":"     1→@import \"tailwindcss\";\n     2→\n     3→:root {\n     4→  /* Minimalist color palette - neutral tones */\n     5→  --background: #fafafa;\n     6→  --foreground: #18181b;\n     7→\n     8→  /* Subtle borders */\n     9→  --border: #e4e4e7;\n    10→  --border-muted: #f4f4f5;\n    11→\n    12→  /* Neutral grays */\n    13→  --muted: #f4f4f5;\n    14→  --muted-foreground: #71717a;\n    15→\n    16→  /* Primary - subtle blue-gray */\n    17→  --primary: #3f3f46;\n    18→  --primary-foreground: #fafafa;\n    19→\n    20→  /* Accent - warm neutral */\n    21→  --accent: #f4f4f5;\n    22→  --accent-foreground: #18181b;\n    23→\n    24→  /* Destructive */\n    25→  --destructive: #ef4444;\n    26→  --destructive-foreground: #fafafa;\n    27→\n    28→  /* Card */\n    29→  --card: #ffffff;\n    30→  --card-foreground: #18181b;\n    31→\n    32→  /* Input */\n    33→  --input: #e4e4e7;\n    34→  --ring: #a1a1aa;\n    35→}\n    36→\n    37→@theme inline {\n    38→  --color-background: var(--background);\n    39→  --color-foreground: var(--foreground);\n    40→  --color-border: var(--border);\n    41→  --color-border-muted: var(--border-muted);\n    42→  --color-muted: var(--muted);\n    43→  --color-muted-foreground: var(--muted-foreground);\n    44→  --color-primary: var(--primary);\n    45→  --color-primary-foreground: var(--primary-foreground);\n    46→  --color-accent: var(--accent);\n    47→  --color-accent-foreground: var(--accent-foreground);\n    48→  --color-destructive: var(--destructive);\n    49→  --color-destructive-foreground: var(--destructive-foreground);\n    50→  --color-card: var(--card);\n    51→  --color-card-foreground: var(--card-foreground);\n    52→  --color-input: var(--input);\n    53→  --color-ring: var(--ring);\n    54→  --font-sans: var(--font-geist-sans);\n    55→  --font-mono: var(--font-geist-mono);\n    56→}\n    57→\n    58→@media (prefers-color-scheme: dark) {\n    59→  :root {\n    60→    --background: #09090b;\n    61→    --foreground: #fafafa;\n    62→\n    63→    --border: #27272a;\n    64→    --border-muted: #18181b;\n    65→\n    66→    --muted: #27272a;\n    67→    --muted-foreground: #a1a1aa;\n    68→\n    69→    --primary: #fafafa;\n    70→    --primary-foreground: #18181b;\n    71→\n    72→    --accent: #27272a;\n    73→    --accent-foreground: #fafafa;\n    74→\n    75→    --card: #09090b;\n    76→    --card-foreground: #fafafa;\n    77→\n    78→    --input: #27272a;\n    79→    --ring: #52525b;\n    80→  }\n    81→}\n    82→\n    83→body {\n    84→  background: var(--background);\n    85→  color: var(--foreground);\n    86→  font-family: var(--font-sans), system-ui, sans-serif;\n    87→}\n    88→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"cd72625d-62be-4b70-b11a-bd183535c2ff","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/globals.css","content":"@import \"tailwindcss\";\n\n:root {\n  /* Minimalist color palette - neutral tones */\n  --background: #fafafa;\n  --foreground: #18181b;\n\n  /* Subtle borders */\n  --border: #e4e4e7;\n  --border-muted: #f4f4f5;\n\n  /* Neutral grays */\n  --muted: #f4f4f5;\n  --muted-foreground: #71717a;\n\n  /* Primary - subtle blue-gray */\n  --primary: #3f3f46;\n  --primary-foreground: #fafafa;\n\n  /* Accent - warm neutral */\n  --accent: #f4f4f5;\n  --accent-foreground: #18181b;\n\n  /* Destructive */\n  --destructive: #ef4444;\n  --destructive-foreground: #fafafa;\n\n  /* Card */\n  --card: #ffffff;\n  --card-foreground: #18181b;\n\n  /* Input */\n  --input: #e4e4e7;\n  --ring: #a1a1aa;\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n  --color-border: var(--border);\n  --color-border-muted: var(--border-muted);\n  --color-muted: var(--muted);\n  --color-muted-foreground: var(--muted-foreground);\n  --color-primary: var(--primary);\n  --color-primary-foreground: var(--primary-foreground);\n  --color-accent: var(--accent);\n  --color-accent-foreground: var(--accent-foreground);\n  --color-destructive: var(--destructive);\n  --color-destructive-foreground: var(--destructive-foreground);\n  --color-card: var(--card);\n  --color-card-foreground: var(--card-foreground);\n  --color-input: var(--input);\n  --color-ring: var(--ring);\n  --font-sans: var(--font-geist-sans);\n  --font-mono: var(--font-geist-mono);\n}\n\n@media (prefers-color-scheme: dark) {\n  :root {\n    --background: #09090b;\n    --foreground: #fafafa;\n\n    --border: #27272a;\n    --border-muted: #18181b;\n\n    --muted: #27272a;\n    --muted-foreground: #a1a1aa;\n\n    --primary: #fafafa;\n    --primary-foreground: #18181b;\n\n    --accent: #27272a;\n    --accent-foreground: #fafafa;\n\n    --card: #09090b;\n    --card-foreground: #fafafa;\n\n    --input: #27272a;\n    --ring: #52525b;\n  }\n}\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: var(--font-sans), system-ui, sans-serif;\n}\n","numLines":88,"startLine":1,"totalLines":88}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VRPbDyNU15skNeegpNU5QK","type":"tool_result","content":"     1→import type { Metadata, Viewport } from \"next\";\n     2→import { Geist, Geist_Mono } from \"next/font/google\";\n     3→import { Toaster } from \"sonner\";\n     4→import { SessionProvider } from \"@/shared/components/session-provider\";\n     5→import \"./globals.css\";\n     6→\n     7→const geistSans = Geist({\n     8→  variable: \"--font-geist-sans\",\n     9→  subsets: [\"latin\"],\n    10→});\n    11→\n    12→const geistMono = Geist_Mono({\n    13→  variable: \"--font-geist-mono\",\n    14→  subsets: [\"latin\"],\n    15→});\n    16→\n    17→export const metadata: Metadata = {\n    18→  title: \"Clinica\",\n    19→  description: \"Sistema de gestao para clinicas\",\n    20→};\n    21→\n    22→export const viewport: Viewport = {\n    23→  width: \"device-width\",\n    24→  initialScale: 1,\n    25→  maximumScale: 1,\n    26→  userScalable: false,\n    27→  themeColor: [\n    28→    { media: \"(prefers-color-scheme: light)\", color: \"#fafafa\" },\n    29→    { media: \"(prefers-color-scheme: dark)\", color: \"#09090b\" },\n    30→  ],\n    31→};\n    32→\n    33→export default function RootLayout({\n    34→  children,\n    35→}: Readonly<{\n    36→  children: React.ReactNode;\n    37→}>) {\n    38→  return (\n    39→    <html lang=\"pt-BR\">\n    40→      <body\n    41→        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n    42→      >\n    43→        <SessionProvider>\n    44→          {children}\n    45→          <Toaster richColors position=\"top-right\" />\n    46→        </SessionProvider>\n    47→      </body>\n    48→    </html>\n    49→  );\n    50→}\n    51→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"c59774b9-5262-4275-8724-dc51744045ae","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/layout.tsx","content":"import type { Metadata, Viewport } from \"next\";\nimport { Geist, Geist_Mono } from \"next/font/google\";\nimport { Toaster } from \"sonner\";\nimport { SessionProvider } from \"@/shared/components/session-provider\";\nimport \"./globals.css\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata: Metadata = {\n  title: \"Clinica\",\n  description: \"Sistema de gestao para clinicas\",\n};\n\nexport const viewport: Viewport = {\n  width: \"device-width\",\n  initialScale: 1,\n  maximumScale: 1,\n  userScalable: false,\n  themeColor: [\n    { media: \"(prefers-color-scheme: light)\", color: \"#fafafa\" },\n    { media: \"(prefers-color-scheme: dark)\", color: \"#09090b\" },\n  ],\n};\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <html lang=\"pt-BR\">\n      <body\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n      >\n        <SessionProvider>\n          {children}\n          <Toaster richColors position=\"top-right\" />\n        </SessionProvider>\n      </body>\n    </html>\n  );\n}\n","numLines":51,"startLine":1,"totalLines":51}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JpRtjxMintTg3asP6qm2KU","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { useCallback, useEffect, useState, useRef } from \"react\"\n     4→import { useRouter } from \"next/navigation\"\n     5→import { useSession } from \"next-auth/react\"\n     6→import { useForm } from \"react-hook-form\"\n     7→import { zodResolver } from \"@hookform/resolvers/zod\"\n     8→import { z } from \"zod\"\n     9→import { toast } from \"sonner\"\n    10→\n    11→const timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n    12→\n    13→const appointmentSchema = z.object({\n    14→  patientId: z.string().min(1, \"Selecione um paciente\"),\n    15→  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n    16→  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n    17→  duration: z.number().int().min(15).max(480).optional(),\n    18→  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n    19→  notes: z.string().max(2000).optional().nullable(),\n    20→})\n    21→\n    22→const editAppointmentSchema = z.object({\n    23→  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n    24→  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n    25→  duration: z.number().int().min(15).max(480).optional(),\n    26→  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n    27→  notes: z.string().max(2000).optional().nullable(),\n    28→  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n    29→})\n    30→\n    31→type AppointmentFormData = z.infer<typeof appointmentSchema>\n    32→type EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n    33→\n    34→interface Patient {\n    35→  id: string\n    36→  name: string\n    37→  phone: string\n    38→  email: string | null\n    39→}\n    40→\n    41→interface Professional {\n    42→  id: string\n    43→  name: string\n    44→  professionalProfile: {\n    45→    id: string\n    46→    specialty: string | null\n    47→    appointmentDuration: number\n    48→  } | null\n    49→}\n    50→\n    51→interface AvailabilityRule {\n    52→  id: string\n    53→  dayOfWeek: number\n    54→  startTime: string\n    55→  endTime: string\n    56→  isActive: boolean\n    57→}\n    58→\n    59→interface AvailabilityException {\n    60→  id: string\n    61→  date: string\n    62→  isAvailable: boolean\n    63→  startTime: string | null\n    64→  endTime: string | null\n    65→  reason: string | null\n    66→}\n    67→\n    68→interface Appointment {\n    69→  id: string\n    70→  scheduledAt: string\n    71→  endAt: string\n    72→  status: string\n    73→  modality: string\n    74→  notes: string | null\n    75→  price: string | null\n    76→  cancellationReason: string | null\n    77→  cancelledAt: string | null\n    78→  patient: {\n    79→    id: string\n    80→    name: string\n    81→    email: string | null\n    82→    phone: string\n    83→    consentWhatsApp?: boolean\n    84→    consentEmail?: boolean\n    85→  }\n    86→  professionalProfile: {\n    87→    id: string\n    88→    user: {\n    89→      name: string\n    90→    }\n    91→  }\n    92→}\n    93→\n    94→interface TimeSlot {\n    95→  time: string\n    96→  isAvailable: boolean\n    97→  appointment: Appointment | null\n    98→  isBlocked: boolean\n    99→  blockReason?: string\n   100→}\n   101→\n   102→const statusLabels: Record<string, string> = {\n   103→  AGENDADO: \"Agendado\",\n   104→  CONFIRMADO: \"Confirmado\",\n   105→  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n   106→  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n   107→  NAO_COMPARECEU: \"Nao compareceu\",\n   108→  FINALIZADO: \"Finalizado\",\n   109→}\n   110→\n   111→const statusColors: Record<string, string> = {\n   112→  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n   113→  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n   114→  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n   115→  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n   116→  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n   117→  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n   118→}\n   119→\n   120→const statusBorderColors: Record<string, string> = {\n   121→  AGENDADO: \"border-l-blue-500\",\n   122→  CONFIRMADO: \"border-l-green-500\",\n   123→  CANCELADO_PACIENTE: \"border-l-red-500\",\n   124→  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n   125→  NAO_COMPARECEU: \"border-l-yellow-500\",\n   126→  FINALIZADO: \"border-l-gray-500\",\n   127→}\n   128→\n   129→function formatTime(time: string): string {\n   130→  return time.slice(0, 5)\n   131→}\n   132→\n   133→function formatDateHeader(date: Date): string {\n   134→  const today = new Date()\n   135→  today.setHours(0, 0, 0, 0)\n   136→  const dateOnly = new Date(date)\n   137→  dateOnly.setHours(0, 0, 0, 0)\n   138→\n   139→  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n   140→\n   141→  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n   142→  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n   143→    day: \"2-digit\",\n   144→    month: \"2-digit\",\n   145→    year: \"numeric\",\n   146→  })\n   147→\n   148→  if (diffDays === 0) return `Hoje, ${formattedDate}`\n   149→  if (diffDays === 1) return `Amanha, ${formattedDate}`\n   150→  if (diffDays === -1) return `Ontem, ${formattedDate}`\n   151→\n   152→  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n   153→}\n   154→\n   155→function formatPhone(phone: string): string {\n   156→  const digits = phone.replace(/\\D/g, \"\")\n   157→  if (digits.length === 11) {\n   158→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n   159→  }\n   160→  if (digits.length === 10) {\n   161→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n   162→  }\n   163→  return phone\n   164→}\n   165→\n   166→function toDateString(date: Date): string {\n   167→  return date.toISOString().split(\"T\")[0]\n   168→}\n   169→\n   170→export default function AgendaPage() {\n   171→  const router = useRouter()\n   172→  const { data: session, status } = useSession()\n   173→  const [isLoading, setIsLoading] = useState(true)\n   174→  const [selectedDate, setSelectedDate] = useState(() => new Date())\n   175→  const [appointments, setAppointments] = useState<Appointment[]>([])\n   176→  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n   177→  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n   178→  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n   179→  const [professionals, setProfessionals] = useState<Professional[]>([])\n   180→  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n   181→  const [showDatePicker, setShowDatePicker] = useState(false)\n   182→  const [appointmentDuration, setAppointmentDuration] = useState(50)\n   183→\n   184→  // Touch gesture handling\n   185→  const touchStartX = useRef<number | null>(null)\n   186→  const touchEndX = useRef<number | null>(null)\n   187→  const containerRef = useRef<HTMLDivElement>(null)\n   188→\n   189→  // Appointment creation state\n   190→  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n   191→  const [patients, setPatients] = useState<Patient[]>([])\n   192→  const [patientSearch, setPatientSearch] = useState(\"\")\n   193→  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n   194→  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n   195→  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n   196→  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n   197→  const patientSearchRef = useRef<HTMLInputElement>(null)\n   198→\n   199→  // Appointment edit/detail state\n   200→  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n   201→  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n   202→  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n   203→\n   204→  // Cancel appointment state\n   205→  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n   206→  const [cancelReason, setCancelReason] = useState(\"\")\n   207→  const [notifyPatient, setNotifyPatient] = useState(true)\n   208→  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n   209→\n   210→  // Status update state\n   211→  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n   212→\n   213→  const {\n   214→    register,\n   215→    handleSubmit,\n   216→    reset,\n   217→    setValue,\n   218→    formState: { errors },\n   219→  } = useForm<AppointmentFormData>({\n   220→    resolver: zodResolver(appointmentSchema),\n   221→    defaultValues: {\n   222→      modality: \"PRESENCIAL\",\n   223→    },\n   224→  })\n   225→\n   226→  const {\n   227→    register: registerEdit,\n   228→    handleSubmit: handleSubmitEdit,\n   229→    reset: resetEdit,\n   230→    formState: { errors: editErrors },\n   231→  } = useForm<EditAppointmentFormData>({\n   232→    resolver: zodResolver(editAppointmentSchema),\n   233→  })\n   234→\n   235→  const isAdmin = session?.user?.role === \"ADMIN\"\n   236→  const currentProfessionalProfileId = session?.user?.professionalProfileId\n   237→\n   238→  // Get the professionalProfileId to use for API calls\n   239→  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n   240→    ? selectedProfessionalId\n   241→    : currentProfessionalProfileId\n   242→\n   243→  const fetchProfessionals = useCallback(async () => {\n   244→    if (!isAdmin) return\n   245→\n   246→    try {\n   247→      const response = await fetch(\"/api/professionals\")\n   248→      if (!response.ok) return\n   249→      const data = await response.json()\n   250→      setProfessionals(data.professionals)\n   251→    } catch {\n   252→      // Silently fail - professionals dropdown is optional\n   253→    }\n   254→  }, [isAdmin])\n   255→\n   256→  const fetchAppointments = useCallback(async () => {\n   257→    if (!activeProfessionalProfileId && !isAdmin) return\n   258→\n   259→    try {\n   260→      const params = new URLSearchParams({\n   261→        date: toDateString(selectedDate),\n   262→      })\n   263→\n   264→      if (isAdmin && selectedProfessionalId) {\n   265→        params.set(\"professionalProfileId\", selectedProfessionalId)\n   266→      }\n   267→\n   268→      const response = await fetch(`/api/appointments?${params.toString()}`)\n   269→      if (!response.ok) {\n   270→        if (response.status === 403) {\n   271→          toast.error(\"Acesso negado\")\n   272→          router.push(\"/login\")\n   273→          return\n   274→        }\n   275→        throw new Error(\"Failed to fetch appointments\")\n   276→      }\n   277→      const data = await response.json()\n   278→      setAppointments(data.appointments)\n   279→    } catch {\n   280→      toast.error(\"Erro ao carregar agenda\")\n   281→    }\n   282→  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n   283→\n   284→  const fetchAvailability = useCallback(async () => {\n   285→    if (!activeProfessionalProfileId) return\n   286→\n   287→    try {\n   288→      const params = new URLSearchParams()\n   289→      if (isAdmin && selectedProfessionalId) {\n   290→        params.set(\"professionalProfileId\", selectedProfessionalId)\n   291→      }\n   292→\n   293→      const response = await fetch(`/api/availability?${params.toString()}`)\n   294→      if (!response.ok) return\n   295→      const data = await response.json()\n   296→      setAvailabilityRules(data.rules)\n   297→\n   298→      // Also fetch the appointment duration from the professional's profile\n   299→      if (data.rules.length > 0) {\n   300→        // Try to get appointment duration from professionals list\n   301→        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n   302→        if (prof?.professionalProfile?.appointmentDuration) {\n   303→          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n   304→        }\n   305→      }\n   306→    } catch {\n   307→      // Silently fail - availability is optional\n   308→    }\n   309→  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n   310→\n   311→  const fetchAvailabilityExceptions = useCallback(async () => {\n   312→    if (!activeProfessionalProfileId) return\n   313→\n   314→    try {\n   315→      const params = new URLSearchParams({\n   316→        startDate: toDateString(selectedDate),\n   317→        endDate: toDateString(selectedDate),\n   318→      })\n   319→\n   320→      if (isAdmin && selectedProfessionalId) {\n   321→        params.set(\"professionalProfileId\", selectedProfessionalId)\n   322→      }\n   323→\n   324→      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n   325→      if (!response.ok) return\n   326→      const data = await response.json()\n   327→      setAvailabilityExceptions(data.exceptions)\n   328→    } catch {\n   329→      // Silently fail - exceptions are optional\n   330→    }\n   331→  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n   332→\n   333→  const searchPatients = useCallback(async (query: string) => {\n   334→    if (query.length < 2) {\n   335→      setPatients([])\n   336→      return\n   337→    }\n   338→\n   339→    setIsSearchingPatients(true)\n   340→    try {\n   341→      const params = new URLSearchParams({\n   342→        search: query,\n   343→        isActive: \"true\",\n   344→      })\n   345→\n   346→      const response = await fetch(`/api/patients?${params.toString()}`)\n   347→      if (!response.ok) return\n   348→      const data = await response.json()\n   349→      setPatients(data.patients)\n   350→    } catch {\n   351→      // Silently fail\n   352→    } finally {\n   353→      setIsSearchingPatients(false)\n   354→    }\n   355→  }, [])\n   356→\n   357→  // Debounced patient search\n   358→  useEffect(() => {\n   359→    const timer = setTimeout(() => {\n   360→      if (patientSearch) {\n   361→        searchPatients(patientSearch)\n   362→      }\n   363→    }, 300)\n   364→\n   365→    return () => clearTimeout(timer)\n   366→  }, [patientSearch, searchPatients])\n   367→\n   368→  function openCreateSheet(slotTime?: string) {\n   369→    setSelectedPatient(null)\n   370→    setPatientSearch(\"\")\n   371→    setPatients([])\n   372→    reset({\n   373→      patientId: \"\",\n   374→      date: toDateString(selectedDate),\n   375→      startTime: slotTime || \"\",\n   376→      modality: \"PRESENCIAL\",\n   377→      notes: \"\",\n   378→    })\n   379→    setIsCreateSheetOpen(true)\n   380→  }\n   381→\n   382→  function closeCreateSheet() {\n   383→    setIsCreateSheetOpen(false)\n   384→    setSelectedPatient(null)\n   385→    setPatientSearch(\"\")\n   386→    setPatients([])\n   387→  }\n   388→\n   389→  function selectPatient(patient: Patient) {\n   390→    setSelectedPatient(patient)\n   391→    setValue(\"patientId\", patient.id)\n   392→    setPatientSearch(patient.name)\n   393→    setShowPatientDropdown(false)\n   394→    setPatients([])\n   395→  }\n   396→\n   397→  function openEditSheet(appointment: Appointment) {\n   398→    setSelectedAppointment(appointment)\n   399→    const scheduledDate = new Date(appointment.scheduledAt)\n   400→    const endDate = new Date(appointment.endAt)\n   401→    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n   402→\n   403→    resetEdit({\n   404→      date: toDateString(scheduledDate),\n   405→      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n   406→      duration: durationMinutes,\n   407→      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n   408→      notes: appointment.notes || \"\",\n   409→      price: appointment.price ? parseFloat(appointment.price) : null,\n   410→    })\n   411→    setIsEditSheetOpen(true)\n   412→  }\n   413→\n   414→  function closeEditSheet() {\n   415→    setIsEditSheetOpen(false)\n   416→    setSelectedAppointment(null)\n   417→  }\n   418→\n   419→  async function onSubmitEdit(data: EditAppointmentFormData) {\n   420→    if (!selectedAppointment) return\n   421→\n   422→    setIsUpdatingAppointment(true)\n   423→\n   424→    try {\n   425→      // Calculate scheduledAt and endAt from date, startTime, and duration\n   426→      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n   427→      const scheduledAt = new Date(data.date + \"T12:00:00\")\n   428→      scheduledAt.setHours(hours, minutes, 0, 0)\n   429→\n   430→      const durationMinutes = data.duration || appointmentDuration\n   431→      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n   432→\n   433→      const body: Record<string, unknown> = {\n   434→        scheduledAt: scheduledAt.toISOString(),\n   435→        endAt: endAt.toISOString(),\n   436→        modality: data.modality,\n   437→        notes: data.notes || null,\n   438→        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n   439→      }\n   440→\n   441→      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n   442→        method: \"PATCH\",\n   443→        headers: { \"Content-Type\": \"application/json\" },\n   444→        body: JSON.stringify(body),\n   445→      })\n   446→\n   447→      const result = await response.json()\n   448→\n   449→      if (!response.ok) {\n   450→        toast.error(result.error || \"Erro ao atualizar agendamento\")\n   451→        return\n   452→      }\n   453→\n   454→      toast.success(\"Agendamento atualizado com sucesso\")\n   455→      closeEditSheet()\n   456→      fetchAppointments()\n   457→    } catch {\n   458→      toast.error(\"Erro ao atualizar agendamento\")\n   459→    } finally {\n   460→      setIsUpdatingAppointment(false)\n   461→    }\n   462→  }\n   463→\n   464→  function openCancelDialog() {\n   465→    setCancelReason(\"\")\n   466→    setNotifyPatient(true)\n   467→    setIsCancelDialogOpen(true)\n   468→  }\n   469→\n   470→  function closeCancelDialog() {\n   471→    setIsCancelDialogOpen(false)\n   472→    setCancelReason(\"\")\n   473→    setNotifyPatient(true)\n   474→  }\n   475→\n   476→  async function handleCancelAppointment() {\n   477→    if (!selectedAppointment) return\n   478→\n   479→    if (!cancelReason.trim()) {\n   480→      toast.error(\"Informe o motivo do cancelamento\")\n   481→      return\n   482→    }\n   483→\n   484→    setIsCancellingAppointment(true)\n   485→\n   486→    try {\n   487→      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n   488→        method: \"POST\",\n   489→        headers: { \"Content-Type\": \"application/json\" },\n   490→        body: JSON.stringify({\n   491→          reason: cancelReason.trim(),\n   492→          notifyPatient,\n   493→        }),\n   494→      })\n   495→\n   496→      const result = await response.json()\n   497→\n   498→      if (!response.ok) {\n   499→        toast.error(result.error || \"Erro ao cancelar agendamento\")\n   500→        return\n   501→      }\n   502→\n   503→      toast.success(\"Agendamento cancelado com sucesso\")\n   504→      if (result.notificationCreated) {\n   505→        toast.success(\"Notificacao enviada ao paciente\")\n   506→      }\n   507→      closeCancelDialog()\n   508→      closeEditSheet()\n   509→      fetchAppointments()\n   510→    } catch {\n   511→      toast.error(\"Erro ao cancelar agendamento\")\n   512→    } finally {\n   513→      setIsCancellingAppointment(false)\n   514→    }\n   515→  }\n   516→\n   517→  // Check if appointment can be cancelled\n   518→  function canCancelAppointment(appointment: Appointment | null): boolean {\n   519→    if (!appointment) return false\n   520→    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n   521→  }\n   522→\n   523→  // Check if patient has notification consent\n   524→  function hasNotificationConsent(appointment: Appointment | null): boolean {\n   525→    if (!appointment) return false\n   526→    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n   527→  }\n   528→\n   529→  // Check if appointment can be marked as finalized or no-show\n   530→  function canMarkStatus(appointment: Appointment | null): boolean {\n   531→    if (!appointment) return false\n   532→    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n   533→  }\n   534→\n   535→  // Update appointment status\n   536→  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n   537→    if (!selectedAppointment) return\n   538→\n   539→    setIsUpdatingStatus(true)\n   540→\n   541→    try {\n   542→      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n   543→        method: \"PATCH\",\n   544→        headers: { \"Content-Type\": \"application/json\" },\n   545→        body: JSON.stringify({ status: newStatus }),\n   546→      })\n   547→\n   548→      const result = await response.json()\n   549→\n   550→      if (!response.ok) {\n   551→        toast.error(result.error || \"Erro ao atualizar status\")\n   552→        return\n   553→      }\n   554→\n   555→      toast.success(successMessage)\n   556→      closeEditSheet()\n   557→      fetchAppointments()\n   558→    } catch {\n   559→      toast.error(\"Erro ao atualizar status\")\n   560→    } finally {\n   561→      setIsUpdatingStatus(false)\n   562→    }\n   563→  }\n   564→\n   565→  async function handleFinalizarAppointment() {\n   566→    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n   567→  }\n   568→\n   569→  async function handleNaoCompareceuAppointment() {\n   570→    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n   571→  }\n   572→\n   573→  async function onSubmitAppointment(data: AppointmentFormData) {\n   574→    setIsSavingAppointment(true)\n   575→\n   576→    try {\n   577→      const body: Record<string, unknown> = {\n   578→        patientId: data.patientId,\n   579→        date: data.date,\n   580→        startTime: data.startTime,\n   581→        modality: data.modality,\n   582→        notes: data.notes || null,\n   583→      }\n   584→\n   585→      // If admin and has selected a professional, include it\n   586→      if (isAdmin && selectedProfessionalId) {\n   587→        body.professionalProfileId = selectedProfessionalId\n   588→      }\n   589→\n   590→      // Include duration if different from default\n   591→      if (data.duration) {\n   592→        body.duration = data.duration\n   593→      }\n   594→\n   595→      const response = await fetch(\"/api/appointments\", {\n   596→        method: \"POST\",\n   597→        headers: { \"Content-Type\": \"application/json\" },\n   598→        body: JSON.stringify(body),\n   599→      })\n   600→\n   601→      const result = await response.json()\n   602→\n   603→      if (!response.ok) {\n   604→        toast.error(result.error || \"Erro ao criar agendamento\")\n   605→        return\n   606→      }\n   607→\n   608→      toast.success(\"Agendamento criado com sucesso\")\n   609→      closeCreateSheet()\n   610→      fetchAppointments()\n   611→    } catch {\n   612→      toast.error(\"Erro ao criar agendamento\")\n   613→    } finally {\n   614→      setIsSavingAppointment(false)\n   615→    }\n   616→  }\n   617→\n   618→  // Generate time slots based on availability\n   619→  const generateTimeSlots = useCallback(() => {\n   620→    const dayOfWeek = selectedDate.getDay()\n   621→    const dateStr = toDateString(selectedDate)\n   622→\n   623→    // Get active rules for this day of week\n   624→    const dayRules = availabilityRules.filter(\n   625→      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n   626→    )\n   627→\n   628→    // Check for full-day exception (block)\n   629→    const fullDayException = availabilityExceptions.find(\n   630→      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n   631→    )\n   632→\n   633→    if (fullDayException) {\n   634→      setTimeSlots([])\n   635→      return\n   636→    }\n   637→\n   638→    // If no availability rules for this day, show empty\n   639→    if (dayRules.length === 0) {\n   640→      setTimeSlots([])\n   641→      return\n   642→    }\n   643→\n   644→    // Generate slots based on availability rules\n   645→    const slots: TimeSlot[] = []\n   646→    const slotDuration = appointmentDuration\n   647→\n   648→    for (const rule of dayRules) {\n   649→      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n   650→      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n   651→\n   652→      let currentMinutes = startHour * 60 + startMin\n   653→      const endMinutes = endHour * 60 + endMin\n   654→\n   655→      while (currentMinutes + slotDuration <= endMinutes) {\n   656→        const hour = Math.floor(currentMinutes / 60)\n   657→        const min = currentMinutes % 60\n   658→        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n   659→\n   660→        // Check for time-specific exception\n   661→        const exception = availabilityExceptions.find((ex) => {\n   662→          if (toDateString(new Date(ex.date)) !== dateStr) return false\n   663→          if (!ex.startTime || !ex.endTime) return false\n   664→          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n   665→        })\n   666→\n   667→        // Find matching appointment\n   668→        const appointment = appointments.find((apt) => {\n   669→          const aptTime = new Date(apt.scheduledAt)\n   670→          const aptHour = aptTime.getHours()\n   671→          const aptMin = aptTime.getMinutes()\n   672→          return aptHour === hour && aptMin === min\n   673→        })\n   674→\n   675→        slots.push({\n   676→          time: timeStr,\n   677→          isAvailable: !exception && !appointment,\n   678→          appointment: appointment || null,\n   679→          isBlocked: !!exception,\n   680→          blockReason: exception?.reason || undefined,\n   681→        })\n   682→\n   683→        currentMinutes += slotDuration\n   684→      }\n   685→    }\n   686→\n   687→    // Sort slots by time\n   688→    slots.sort((a, b) => a.time.localeCompare(b.time))\n   689→    setTimeSlots(slots)\n   690→  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n   691→\n   692→  // Touch gesture handlers\n   693→  function handleTouchStart(e: React.TouchEvent) {\n   694→    touchStartX.current = e.touches[0].clientX\n   695→  }\n   696→\n   697→  function handleTouchMove(e: React.TouchEvent) {\n   698→    touchEndX.current = e.touches[0].clientX\n   699→  }\n   700→\n   701→  function handleTouchEnd() {\n   702→    if (!touchStartX.current || !touchEndX.current) return\n   703→\n   704→    const diff = touchStartX.current - touchEndX.current\n   705→    const threshold = 50 // Minimum swipe distance\n   706→\n   707→    if (Math.abs(diff) > threshold) {\n   708→      if (diff > 0) {\n   709→        // Swipe left - next day\n   710→        goToNextDay()\n   711→      } else {\n   712→        // Swipe right - previous day\n   713→        goToPreviousDay()\n   714→      }\n   715→    }\n   716→\n   717→    touchStartX.current = null\n   718→    touchEndX.current = null\n   719→  }\n   720→\n   721→  function goToPreviousDay() {\n   722→    setSelectedDate((prev) => {\n   723→      const newDate = new Date(prev)\n   724→      newDate.setDate(newDate.getDate() - 1)\n   725→      return newDate\n   726→    })\n   727→  }\n   728→\n   729→  function goToNextDay() {\n   730→    setSelectedDate((prev) => {\n   731→      const newDate = new Date(prev)\n   732→      newDate.setDate(newDate.getDate() + 1)\n   733→      return newDate\n   734→    })\n   735→  }\n   736→\n   737→  function goToToday() {\n   738→    setSelectedDate(new Date())\n   739→    setShowDatePicker(false)\n   740→  }\n   741→\n   742→  // Initial load\n   743→  useEffect(() => {\n   744→    if (status === \"unauthenticated\") {\n   745→      router.push(\"/login\")\n   746→      return\n   747→    }\n   748→\n   749→    if (status === \"authenticated\") {\n   750→      setIsLoading(false)\n   751→      fetchProfessionals()\n   752→    }\n   753→  }, [status, router, fetchProfessionals])\n   754→\n   755→  // Fetch data when date or professional changes\n   756→  useEffect(() => {\n   757→    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n   758→      fetchAppointments()\n   759→      fetchAvailability()\n   760→      fetchAvailabilityExceptions()\n   761→    }\n   762→  }, [\n   763→    status,\n   764→    selectedDate,\n   765→    activeProfessionalProfileId,\n   766→    isAdmin,\n   767→    fetchAppointments,\n   768→    fetchAvailability,\n   769→    fetchAvailabilityExceptions,\n   770→  ])\n   771→\n   772→  // Generate slots when data changes\n   773→  useEffect(() => {\n   774→    generateTimeSlots()\n   775→  }, [generateTimeSlots])\n   776→\n   777→  if (status === \"loading\" || isLoading) {\n   778→    return (\n   779→      <main className=\"min-h-screen bg-background pb-20\">\n   780→        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   781→          <div className=\"animate-pulse space-y-6\">\n   782→            <div className=\"h-12 w-full bg-muted rounded\" />\n   783→            <div className=\"space-y-4\">\n   784→              {[1, 2, 3, 4, 5].map((i) => (\n   785→                <div key={i} className=\"h-16 bg-muted rounded\" />\n   786→              ))}\n   787→            </div>\n   788→          </div>\n   789→        </div>\n   790→      </main>\n   791→    )\n   792→  }\n   793→\n   794→  return (\n   795→    <main className=\"min-h-screen bg-background pb-20\">\n   796→      {/* Header */}\n   797→      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n   798→        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n   799→          {/* Date Header - Tappable */}\n   800→          <button\n   801→            onClick={() => setShowDatePicker(!showDatePicker)}\n   802→            className=\"w-full text-left mb-3\"\n   803→          >\n   804→            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n   805→              {formatDateHeader(selectedDate)}\n   806→              <svg\n   807→                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n   808→                fill=\"none\"\n   809→                stroke=\"currentColor\"\n   810→                viewBox=\"0 0 24 24\"\n   811→              >\n   812→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n   813→              </svg>\n   814→            </h1>\n   815→          </button>\n   816→\n   817→          {/* Professional Filter - ADMIN only */}\n   818→          {isAdmin && professionals.length > 0 && (\n   819→            <select\n   820→              value={selectedProfessionalId}\n   821→              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n   822→              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   823→            >\n   824→              <option value=\"\">Todos os profissionais</option>\n   825→              {professionals.map((prof) => (\n   826→                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n   827→                  {prof.name}\n   828→                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n   829→                </option>\n   830→              ))}\n   831→            </select>\n   832→          )}\n   833→        </div>\n   834→\n   835→        {/* Date Picker Dropdown */}\n   836→        {showDatePicker && (\n   837→          <div className=\"border-t border-border bg-card\">\n   838→            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n   839→              <div className=\"flex items-center justify-between mb-4\">\n   840→                <button\n   841→                  onClick={goToPreviousDay}\n   842→                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n   843→                >\n   844→                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   845→                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n   846→                  </svg>\n   847→                </button>\n   848→                <button\n   849→                  onClick={goToToday}\n   850→                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n   851→                >\n   852→                  Hoje\n   853→                </button>\n   854→                <button\n   855→                  onClick={goToNextDay}\n   856→                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n   857→                >\n   858→                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   859→                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n   860→                  </svg>\n   861→                </button>\n   862→              </div>\n   863→              <input\n   864→                type=\"date\"\n   865→                value={toDateString(selectedDate)}\n   866→                onChange={(e) => {\n   867→                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n   868→                  setShowDatePicker(false)\n   869→                }}\n   870→                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   871→              />\n   872→            </div>\n   873→          </div>\n   874→        )}\n   875→      </header>\n   876→\n   877→      {/* Timeline Content */}\n   878→      <div\n   879→        ref={containerRef}\n   880→        onTouchStart={handleTouchStart}\n   881→        onTouchMove={handleTouchMove}\n   882→        onTouchEnd={handleTouchEnd}\n   883→        className=\"max-w-4xl mx-auto px-4 py-4\"\n   884→      >\n   885→        {/* Day navigation hint */}\n   886→        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n   887→          Deslize para esquerda ou direita para mudar o dia\n   888→        </p>\n   889→\n   890→        {/* No availability message */}\n   891→        {timeSlots.length === 0 && (\n   892→          <div className=\"text-center py-12\">\n   893→            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n   894→              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   895→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n   896→              </svg>\n   897→            </div>\n   898→            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n   899→              Sem disponibilidade\n   900→            </h3>\n   901→            <p className=\"text-sm text-muted-foreground\">\n   902→              {isAdmin && !selectedProfessionalId\n   903→                ? \"Selecione um profissional para ver a agenda\"\n   904→                : \"Nao ha horarios configurados para este dia\"}\n   905→            </p>\n   906→          </div>\n   907→        )}\n   908→\n   909→        {/* Timeline */}\n   910→        {timeSlots.length > 0 && (\n   911→          <div className=\"space-y-2\">\n   912→            {timeSlots.map((slot) => (\n   913→              <div\n   914→                key={slot.time}\n   915→                className={`flex items-stretch gap-3 min-h-[4rem] ${\n   916→                  slot.isBlocked ? \"opacity-50\" : \"\"\n   917→                }`}\n   918→              >\n   919→                {/* Time Column */}\n   920→                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n   921→                  {formatTime(slot.time)}\n   922→                </div>\n   923→\n   924→                {/* Slot Content */}\n   925→                {slot.appointment ? (\n   926→                  <button\n   927→                    type=\"button\"\n   928→                    onClick={() => openEditSheet(slot.appointment!)}\n   929→                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n   930→                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n   931→                    } ${\n   932→                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n   933→                    }`}\n   934→                  >\n   935→                    <div className=\"flex items-start justify-between gap-2\">\n   936→                      <div className=\"min-w-0 flex-1\">\n   937→                        <h4 className=\"font-medium text-foreground truncate\">\n   938→                          {slot.appointment.patient.name}\n   939→                        </h4>\n   940→                        <p className=\"text-sm text-muted-foreground\">\n   941→                          {formatPhone(slot.appointment.patient.phone)}\n   942→                        </p>\n   943→                        {isAdmin && (\n   944→                          <p className=\"text-xs text-muted-foreground mt-1\">\n   945→                            {slot.appointment.professionalProfile.user.name}\n   946→                          </p>\n   947→                        )}\n   948→                      </div>\n   949→                      <span\n   950→                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n   951→                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n   952→                        }`}\n   953→                      >\n   954→                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n   955→                      </span>\n   956→                    </div>\n   957→                    <div className=\"flex items-center gap-2 mt-2\">\n   958→                      <span className=\"text-xs text-muted-foreground\">\n   959→                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n   960→                      </span>\n   961→                      {slot.appointment.notes && (\n   962→                        <span className=\"text-xs text-muted-foreground truncate\">\n   963→                          • {slot.appointment.notes}\n   964→                        </span>\n   965→                      )}\n   966→                    </div>\n   967→                  </button>\n   968→                ) : slot.isBlocked ? (\n   969→                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n   970→                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n   971→                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   972→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n   973→                      </svg>\n   974→                      <span className=\"text-sm\">\n   975→                        {slot.blockReason || \"Bloqueado\"}\n   976→                      </span>\n   977→                    </div>\n   978→                  </div>\n   979→                ) : (\n   980→                  <button\n   981→                    onClick={() => openCreateSheet(slot.time)}\n   982→                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n   983→                  >\n   984→                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   985→                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n   986→                    </svg>\n   987→                    <span className=\"text-sm\">Disponivel</span>\n   988→                  </button>\n   989→                )}\n   990→              </div>\n   991→            ))}\n   992→          </div>\n   993→        )}\n   994→      </div>\n   995→\n   996→      {/* FAB - Floating Action Button */}\n   997→      <button\n   998→        onClick={() => openCreateSheet()}\n   999→        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n  1000→        aria-label=\"Novo agendamento\"\n  1001→      >\n  1002→        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1003→          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n  1004→        </svg>\n  1005→      </button>\n  1006→\n  1007→      {/* Create Appointment Sheet */}\n  1008→      {isCreateSheetOpen && (\n  1009→        <>\n  1010→          {/* Backdrop */}\n  1011→          <div\n  1012→            className=\"fixed inset-0 bg-black/50 z-40\"\n  1013→            onClick={closeCreateSheet}\n  1014→          />\n  1015→\n  1016→          {/* Sheet */}\n  1017→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n  1018→            {/* Handle */}\n  1019→            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n  1020→              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n  1021→              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n  1022→            </div>\n  1023→\n  1024→            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n  1025→              {/* Patient Selection */}\n  1026→              <div className=\"relative\">\n  1027→                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1028→                  Paciente *\n  1029→                </label>\n  1030→                <div className=\"relative\">\n  1031→                  <input\n  1032→                    ref={patientSearchRef}\n  1033→                    id=\"patientSearch\"\n  1034→                    type=\"text\"\n  1035→                    value={patientSearch}\n  1036→                    onChange={(e) => {\n  1037→                      setPatientSearch(e.target.value)\n  1038→                      setShowPatientDropdown(true)\n  1039→                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n  1040→                        setSelectedPatient(null)\n  1041→                        setValue(\"patientId\", \"\")\n  1042→                      }\n  1043→                    }}\n  1044→                    onFocus={() => setShowPatientDropdown(true)}\n  1045→                    placeholder=\"Digite o nome do paciente...\"\n  1046→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1047→                  />\n  1048→                  {isSearchingPatients && (\n  1049→                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n  1050→                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n  1051→                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n  1052→                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n  1053→                      </svg>\n  1054→                    </div>\n  1055→                  )}\n  1056→                </div>\n  1057→                <input type=\"hidden\" {...register(\"patientId\")} />\n  1058→\n  1059→                {/* Patient Dropdown */}\n  1060→                {showPatientDropdown && patients.length > 0 && (\n  1061→                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n  1062→                    {patients.map((patient) => (\n  1063→                      <button\n  1064→                        key={patient.id}\n  1065→                        type=\"button\"\n  1066→                        onClick={() => selectPatient(patient)}\n  1067→                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n  1068→                      >\n  1069→                        <div>\n  1070→                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n  1071→                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n  1072→                        </div>\n  1073→                        {selectedPatient?.id === patient.id && (\n  1074→                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n  1075→                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n  1076→                          </svg>\n  1077→                        )}\n  1078→                      </button>\n  1079→                    ))}\n  1080→                  </div>\n  1081→                )}\n  1082→\n  1083→                {/* No results */}\n  1084→                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n  1085→                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n  1086→                    Nenhum paciente encontrado\n  1087→                  </div>\n  1088→                )}\n  1089→\n  1090→                {errors.patientId && (\n  1091→                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n  1092→                )}\n  1093→\n  1094→                {selectedPatient && (\n  1095→                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n  1096→                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n  1097→                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n  1098→                    {selectedPatient.email && (\n  1099→                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n  1100→                    )}\n  1101→                  </div>\n  1102→                )}\n  1103→              </div>\n  1104→\n  1105→              {/* Date */}\n  1106→              <div>\n  1107→                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1108→                  Data *\n  1109→                </label>\n  1110→                <input\n  1111→                  id=\"date\"\n  1112→                  type=\"date\"\n  1113→                  {...register(\"date\")}\n  1114→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1115→                />\n  1116→                {errors.date && (\n  1117→                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n  1118→                )}\n  1119→              </div>\n  1120→\n  1121→              {/* Start Time */}\n  1122→              <div>\n  1123→                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1124→                  Horario *\n  1125→                </label>\n  1126→                <input\n  1127→                  id=\"startTime\"\n  1128→                  type=\"time\"\n  1129→                  {...register(\"startTime\")}\n  1130→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1131→                />\n  1132→                {errors.startTime && (\n  1133→                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n  1134→                )}\n  1135→              </div>\n  1136→\n  1137→              {/* Duration */}\n  1138→              <div>\n  1139→                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1140→                  Duracao (minutos)\n  1141→                </label>\n  1142→                <input\n  1143→                  id=\"duration\"\n  1144→                  type=\"number\"\n  1145→                  {...register(\"duration\", { valueAsNumber: true })}\n  1146→                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n  1147→                  min={15}\n  1148→                  max={480}\n  1149→                  step={5}\n  1150→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1151→                />\n  1152→                <p className=\"text-xs text-muted-foreground mt-1\">\n  1153→                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n  1154→                </p>\n  1155→                {errors.duration && (\n  1156→                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n  1157→                )}\n  1158→              </div>\n  1159→\n  1160→              {/* Modality */}\n  1161→              <div>\n  1162→                <label className=\"block text-sm font-medium text-foreground mb-2\">\n  1163→                  Modalidade *\n  1164→                </label>\n  1165→                <div className=\"grid grid-cols-2 gap-3\">\n  1166→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1167→                    <input\n  1168→                      type=\"radio\"\n  1169→                      value=\"PRESENCIAL\"\n  1170→                      {...register(\"modality\")}\n  1171→                      className=\"sr-only peer\"\n  1172→                    />\n  1173→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1174→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1175→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n  1176→                      </svg>\n  1177→                      <span className=\"text-sm font-medium\">Presencial</span>\n  1178→                    </div>\n  1179→                  </label>\n  1180→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1181→                    <input\n  1182→                      type=\"radio\"\n  1183→                      value=\"ONLINE\"\n  1184→                      {...register(\"modality\")}\n  1185→                      className=\"sr-only peer\"\n  1186→                    />\n  1187→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1188→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1189→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n  1190→                      </svg>\n  1191→                      <span className=\"text-sm font-medium\">Online</span>\n  1192→                    </div>\n  1193→                  </label>\n  1194→                </div>\n  1195→                {errors.modality && (\n  1196→                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n  1197→                )}\n  1198→              </div>\n  1199→\n  1200→              {/* Notes */}\n  1201→              <div>\n  1202→                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1203→                  Observacoes\n  1204→                </label>\n  1205→                <textarea\n  1206→                  id=\"notes\"\n  1207→                  rows={3}\n  1208→                  {...register(\"notes\")}\n  1209→                  placeholder=\"Observacoes sobre a consulta...\"\n  1210→                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n  1211→                />\n  1212→                {errors.notes && (\n  1213→                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n  1214→                )}\n  1215→              </div>\n  1216→\n  1217→              {/* Actions */}\n  1218→              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n  1219→                <button\n  1220→                  type=\"submit\"\n  1221→                  disabled={isSavingAppointment || !selectedPatient}\n  1222→                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n  1223→                >\n  1224→                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n  1225→                </button>\n  1226→                <button\n  1227→                  type=\"button\"\n  1228→                  onClick={closeCreateSheet}\n  1229→                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n  1230→                >\n  1231→                  Cancelar\n  1232→                </button>\n  1233→              </div>\n  1234→            </form>\n  1235→          </div>\n  1236→        </>\n  1237→      )}\n  1238→\n  1239→      {/* Edit Appointment Sheet */}\n  1240→      {isEditSheetOpen && selectedAppointment && (\n  1241→        <>\n  1242→          {/* Backdrop */}\n  1243→          <div\n  1244→            className=\"fixed inset-0 bg-black/50 z-40\"\n  1245→            onClick={closeEditSheet}\n  1246→          />\n  1247→\n  1248→          {/* Sheet */}\n  1249→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n  1250→            {/* Handle */}\n  1251→            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n  1252→              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n  1253→              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n  1254→            </div>\n  1255→\n  1256→            {/* Patient Info (read-only) */}\n  1257→            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n  1258→              <div className=\"flex items-start justify-between gap-3\">\n  1259→                <div>\n  1260→                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n  1261→                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n  1262→                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n  1263→                  {selectedAppointment.patient.email && (\n  1264→                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n  1265→                  )}\n  1266→                </div>\n  1267→                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n  1268→                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n  1269→                </span>\n  1270→              </div>\n  1271→              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n  1272→                Para alterar o paciente, cancele este agendamento e crie um novo.\n  1273→              </p>\n  1274→            </div>\n  1275→\n  1276→            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n  1277→              {/* Date */}\n  1278→              <div>\n  1279→                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1280→                  Data *\n  1281→                </label>\n  1282→                <input\n  1283→                  id=\"editDate\"\n  1284→                  type=\"date\"\n  1285→                  {...registerEdit(\"date\")}\n  1286→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1287→                />\n  1288→                {editErrors.date && (\n  1289→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n  1290→                )}\n  1291→              </div>\n  1292→\n  1293→              {/* Start Time */}\n  1294→              <div>\n  1295→                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1296→                  Horario *\n  1297→                </label>\n  1298→                <input\n  1299→                  id=\"editStartTime\"\n  1300→                  type=\"time\"\n  1301→                  {...registerEdit(\"startTime\")}\n  1302→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1303→                />\n  1304→                {editErrors.startTime && (\n  1305→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n  1306→                )}\n  1307→              </div>\n  1308→\n  1309→              {/* Duration */}\n  1310→              <div>\n  1311→                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1312→                  Duracao (minutos)\n  1313→                </label>\n  1314→                <input\n  1315→                  id=\"editDuration\"\n  1316→                  type=\"number\"\n  1317→                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n  1318→                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n  1319→                  min={15}\n  1320→                  max={480}\n  1321→                  step={5}\n  1322→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1323→                />\n  1324→                {editErrors.duration && (\n  1325→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n  1326→                )}\n  1327→              </div>\n  1328→\n  1329→              {/* Modality */}\n  1330→              <div>\n  1331→                <label className=\"block text-sm font-medium text-foreground mb-2\">\n  1332→                  Modalidade *\n  1333→                </label>\n  1334→                <div className=\"grid grid-cols-2 gap-3\">\n  1335→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1336→                    <input\n  1337→                      type=\"radio\"\n  1338→                      value=\"PRESENCIAL\"\n  1339→                      {...registerEdit(\"modality\")}\n  1340→                      className=\"sr-only peer\"\n  1341→                    />\n  1342→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1343→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1344→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n  1345→                      </svg>\n  1346→                      <span className=\"text-sm font-medium\">Presencial</span>\n  1347→                    </div>\n  1348→                  </label>\n  1349→                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n  1350→                    <input\n  1351→                      type=\"radio\"\n  1352→                      value=\"ONLINE\"\n  1353→                      {...registerEdit(\"modality\")}\n  1354→                      className=\"sr-only peer\"\n  1355→                    />\n  1356→                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n  1357→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1358→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n  1359→                      </svg>\n  1360→                      <span className=\"text-sm font-medium\">Online</span>\n  1361→                    </div>\n  1362→                  </label>\n  1363→                </div>\n  1364→                {editErrors.modality && (\n  1365→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n  1366→                )}\n  1367→              </div>\n  1368→\n  1369→              {/* Price */}\n  1370→              <div>\n  1371→                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1372→                  Valor (R$)\n  1373→                </label>\n  1374→                <input\n  1375→                  id=\"editPrice\"\n  1376→                  type=\"number\"\n  1377→                  step=\"0.01\"\n  1378→                  min=\"0\"\n  1379→                  {...registerEdit(\"price\", { valueAsNumber: true })}\n  1380→                  placeholder=\"Ex: 150.00\"\n  1381→                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1382→                />\n  1383→                {editErrors.price && (\n  1384→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n  1385→                )}\n  1386→              </div>\n  1387→\n  1388→              {/* Notes */}\n  1389→              <div>\n  1390→                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1391→                  Observacoes\n  1392→                </label>\n  1393→                <textarea\n  1394→                  id=\"editNotes\"\n  1395→                  rows={3}\n  1396→                  {...registerEdit(\"notes\")}\n  1397→                  placeholder=\"Observacoes sobre a consulta...\"\n  1398→                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n  1399→                />\n  1400→                {editErrors.notes && (\n  1401→                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n  1402→                )}\n  1403→              </div>\n  1404→\n  1405→              {/* Cancellation Info (for cancelled appointments) */}\n  1406→              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n  1407→                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n  1408→                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n  1409→                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n  1410→                  </p>\n  1411→                  {selectedAppointment.cancellationReason && (\n  1412→                    <p className=\"text-sm text-red-700\">\n  1413→                      Motivo: {selectedAppointment.cancellationReason}\n  1414→                    </p>\n  1415→                  )}\n  1416→                  {selectedAppointment.cancelledAt && (\n  1417→                    <p className=\"text-xs text-red-600 mt-1\">\n  1418→                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n  1419→                    </p>\n  1420→                  )}\n  1421→                </div>\n  1422→              )}\n  1423→\n  1424→              {/* Quick Actions (for active appointments) */}\n  1425→              {canMarkStatus(selectedAppointment) && (\n  1426→                <div className=\"border-t border-border pt-6\">\n  1427→                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n  1428→                  <div className=\"grid grid-cols-2 gap-3\">\n  1429→                    <button\n  1430→                      type=\"button\"\n  1431→                      onClick={handleFinalizarAppointment}\n  1432→                      disabled={isUpdatingStatus || isUpdatingAppointment}\n  1433→                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n  1434→                    >\n  1435→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1436→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n  1437→                      </svg>\n  1438→                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n  1439→                    </button>\n  1440→                    <button\n  1441→                      type=\"button\"\n  1442→                      onClick={handleNaoCompareceuAppointment}\n  1443→                      disabled={isUpdatingStatus || isUpdatingAppointment}\n  1444→                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n  1445→                    >\n  1446→                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1447→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n  1448→                      </svg>\n  1449→                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n  1450→                    </button>\n  1451→                  </div>\n  1452→                </div>\n  1453→              )}\n  1454→\n  1455→              {/* Actions */}\n  1456→              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n  1457→                {canCancelAppointment(selectedAppointment) ? (\n  1458→                  <>\n  1459→                    <button\n  1460→                      type=\"submit\"\n  1461→                      disabled={isUpdatingAppointment || isUpdatingStatus}\n  1462→                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n  1463→                    >\n  1464→                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n  1465→                    </button>\n  1466→                    <button\n  1467→                      type=\"button\"\n  1468→                      onClick={openCancelDialog}\n  1469→                      disabled={isUpdatingStatus}\n  1470→                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n  1471→                    >\n  1472→                      Cancelar Agendamento\n  1473→                    </button>\n  1474→                  </>\n  1475→                ) : (\n  1476→                  <button\n  1477→                    type=\"button\"\n  1478→                    onClick={closeEditSheet}\n  1479→                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n  1480→                  >\n  1481→                    Fechar\n  1482→                  </button>\n  1483→                )}\n  1484→              </div>\n  1485→            </form>\n  1486→          </div>\n  1487→        </>\n  1488→      )}\n  1489→\n  1490→      {/* Cancel Confirmation Dialog */}\n  1491→      {isCancelDialogOpen && selectedAppointment && (\n  1492→        <>\n  1493→          {/* Backdrop */}\n  1494→          <div\n  1495→            className=\"fixed inset-0 bg-black/70 z-[60]\"\n  1496→            onClick={closeCancelDialog}\n  1497→          />\n  1498→\n  1499→          {/* Dialog */}\n  1500→          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n  1501→            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n  1502→              <div className=\"flex items-center gap-3 mb-4\">\n  1503→                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n  1504→                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1505→                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n  1506→                  </svg>\n  1507→                </div>\n  1508→                <h3 className=\"text-lg font-semibold text-foreground\">\n  1509→                  Cancelar Agendamento\n  1510→                </h3>\n  1511→              </div>\n  1512→\n  1513→              <p className=\"text-sm text-muted-foreground mb-4\">\n  1514→                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n  1515→                Esta acao nao pode ser desfeita.\n  1516→              </p>\n  1517→\n  1518→              {/* Cancellation Reason */}\n  1519→              <div className=\"mb-4\">\n  1520→                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n  1521→                  Motivo do cancelamento *\n  1522→                </label>\n  1523→                <textarea\n  1524→                  id=\"cancelReason\"\n  1525→                  rows={3}\n  1526→                  value={cancelReason}\n  1527→                  onChange={(e) => setCancelReason(e.target.value)}\n  1528→                  placeholder=\"Informe o motivo do cancelamento...\"\n  1529→                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n  1530→                />\n  1531→              </div>\n  1532→\n  1533→              {/* Notify Patient Option */}\n  1534→              {hasNotificationConsent(selectedAppointment) && (\n  1535→                <div className=\"mb-6\">\n  1536→                  <label className=\"flex items-center gap-3 cursor-pointer\">\n  1537→                    <input\n  1538→                      type=\"checkbox\"\n  1539→                      checked={notifyPatient}\n  1540→                      onChange={(e) => setNotifyPatient(e.target.checked)}\n  1541→                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n  1542→                    />\n  1543→                    <span className=\"text-sm text-foreground\">\n  1544→                      Notificar paciente sobre o cancelamento\n  1545→                    </span>\n  1546→                  </label>\n  1547→                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n  1548→                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n  1549→                  </p>\n  1550→                </div>\n  1551→              )}\n  1552→\n  1553→              {!hasNotificationConsent(selectedAppointment) && (\n  1554→                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n  1555→                  <p className=\"text-xs text-muted-foreground\">\n  1556→                    O paciente nao possui consentimento para receber notificacoes.\n  1557→                  </p>\n  1558→                </div>\n  1559→              )}\n  1560→\n  1561→              {/* Dialog Actions */}\n  1562→              <div className=\"flex gap-3\">\n  1563→                <button\n  1564→                  type=\"button\"\n  1565→                  onClick={closeCancelDialog}\n  1566→                  disabled={isCancellingAppointment}\n  1567→                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n  1568→                >\n  1569→                  Voltar\n  1570→                </button>\n  1571→                <button\n  1572→                  type=\"button\"\n  1573→                  onClick={handleCancelAppointment}\n  1574→                  disabled={isCancellingAppointment || !cancelReason.trim()}\n  1575→                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n  1576→                >\n  1577→                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n  1578→                </button>\n  1579→              </div>\n  1580→            </div>\n  1581→          </div>\n  1582→        </>\n  1583→      )}\n  1584→\n  1585→      {/* Bottom Navigation */}\n  1586→      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n  1587→        <div className=\"max-w-4xl mx-auto px-4\">\n  1588→          <div className=\"flex items-center justify-around h-16\">\n  1589→            <button\n  1590→              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n  1591→              onClick={() => router.push(\"/agenda\")}\n  1592→            >\n  1593→              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1594→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n  1595→              </svg>\n  1596→              <span className=\"text-xs font-medium\">Agenda</span>\n  1597→            </button>\n  1598→\n  1599→            <button\n  1600→              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n  1601→              onClick={() => router.push(\"/patients\")}\n  1602→            >\n  1603→              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1604→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n  1605→              </svg>\n  1606→              <span className=\"text-xs\">Pacientes</span>\n  1607→            </button>\n  1608→\n  1609→            <button\n  1610→              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n  1611→              onClick={() => router.push(\"/settings/availability\")}\n  1612→            >\n  1613→              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n  1614→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n  1615→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n  1616→              </svg>\n  1617→              <span className=\"text-xs\">Configuracoes</span>\n  1618→            </button>\n  1619→          </div>\n  1620→        </div>\n  1621→      </nav>\n  1622→\n  1623→      {/* Animation Styles */}\n  1624→      <style jsx>{`\n  1625→        @keyframes slide-up {\n  1626→          from {\n  1627→            transform: translateY(100%);\n  1628→          }\n  1629→          to {\n  1630→            transform: translateY(0);\n  1631→          }\n  1632→        }\n  1633→        .animate-slide-up {\n  1634→          animation: slide-up 0.3s ease-out;\n  1635→        }\n  1636→        @keyframes scale-in {\n  1637→          from {\n  1638→            opacity: 0;\n  1639→            transform: scale(0.95);\n  1640→          }\n  1641→          to {\n  1642→            opacity: 1;\n  1643→            transform: scale(1);\n  1644→          }\n  1645→        }\n  1646→        .animate-scale-in {\n  1647→          animation: scale-in 0.2s ease-out;\n  1648→        }\n  1649→      `}</style>\n  1650→    </main>\n  1651→  )\n  1652→}\n  1653→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"3f9d6244-8988-4df2-a468-5ae00e182302","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","content":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-12 w-full bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <div key={i} className=\"h-16 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <div className=\"text-center py-12\">\n            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n              Sem disponibilidade\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              {isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"}\n            </p>\n          </div>\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <button\n        onClick={() => openCreateSheet()}\n        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n        aria-label=\"Novo agendamento\"\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n        </svg>\n      </button>\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","numLines":1653,"startLine":1,"totalLines":1653}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_012hnJCDZAwm8mTLVrnLDedw","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me also read the other pages to understand the current state."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":28369,"cache_read_input_tokens":38297,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":28369},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4e981c88-fdb2-4970-a32a-833c0858c36f"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_012hnJCDZAwm8mTLVrnLDedw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XZwoGuiAxeJUAeA1uqbzdu","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":28369,"cache_read_input_tokens":38297,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":28369},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"0cd998d7-bfe1-4d5a-9643-ed2e917a514c"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_012hnJCDZAwm8mTLVrnLDedw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JCL8zqmiEUPtqhrHxbAXRW","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":28369,"cache_read_input_tokens":38297,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":28369},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b4b05bce-fe31-49b5-bdc2-1379d3ebf6a2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XZwoGuiAxeJUAeA1uqbzdu","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { useCallback, useEffect, useState } from \"react\"\n     4→import { useRouter } from \"next/navigation\"\n     5→import { useSession } from \"next-auth/react\"\n     6→import { useForm } from \"react-hook-form\"\n     7→import { zodResolver } from \"@hookform/resolvers/zod\"\n     8→import { z } from \"zod\"\n     9→import { toast } from \"sonner\"\n    10→\n    11→// WhatsApp format validation\n    12→const phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n    13→\n    14→const patientSchema = z.object({\n    15→  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n    16→  phone: z\n    17→    .string()\n    18→    .min(1, \"Telefone é obrigatório\")\n    19→    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n    20→  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n    21→  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n    22→  consentWhatsApp: z.boolean(),\n    23→  consentEmail: z.boolean(),\n    24→})\n    25→\n    26→type PatientFormData = z.infer<typeof patientSchema>\n    27→\n    28→interface Appointment {\n    29→  id: string\n    30→  scheduledAt: string\n    31→  endAt: string\n    32→  status: string\n    33→  modality: string\n    34→  notes: string | null\n    35→  professionalProfile: {\n    36→    id: string\n    37→    user: {\n    38→      name: string\n    39→    }\n    40→  }\n    41→}\n    42→\n    43→interface Patient {\n    44→  id: string\n    45→  name: string\n    46→  email: string | null\n    47→  phone: string\n    48→  birthDate: string | null\n    49→  notes: string | null\n    50→  isActive: boolean\n    51→  lastVisitAt: string | null\n    52→  consentWhatsApp: boolean\n    53→  consentWhatsAppAt: string | null\n    54→  consentEmail: boolean\n    55→  consentEmailAt: string | null\n    56→  createdAt: string\n    57→  appointments?: Appointment[]\n    58→}\n    59→\n    60→function formatPhone(phone: string): string {\n    61→  // Format: (11) 99999-9999\n    62→  const digits = phone.replace(/\\D/g, \"\")\n    63→  if (digits.length === 11) {\n    64→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n    65→  }\n    66→  if (digits.length === 10) {\n    67→    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n    68→  }\n    69→  return phone\n    70→}\n    71→\n    72→function formatDate(dateString: string | null): string {\n    73→  if (!dateString) return \"-\"\n    74→  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n    75→}\n    76→\n    77→function formatDateTime(dateString: string): string {\n    78→  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    79→    day: \"2-digit\",\n    80→    month: \"2-digit\",\n    81→    year: \"numeric\",\n    82→    hour: \"2-digit\",\n    83→    minute: \"2-digit\",\n    84→  })\n    85→}\n    86→\n    87→const statusLabels: Record<string, string> = {\n    88→  AGENDADO: \"Agendado\",\n    89→  CONFIRMADO: \"Confirmado\",\n    90→  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n    91→  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n    92→  NAO_COMPARECEU: \"Não compareceu\",\n    93→  FINALIZADO: \"Finalizado\",\n    94→}\n    95→\n    96→const statusColors: Record<string, string> = {\n    97→  AGENDADO: \"bg-blue-100 text-blue-800\",\n    98→  CONFIRMADO: \"bg-green-100 text-green-800\",\n    99→  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n   100→  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n   101→  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n   102→  FINALIZADO: \"bg-gray-100 text-gray-800\",\n   103→}\n   104→\n   105→export default function PatientsPage() {\n   106→  const router = useRouter()\n   107→  const { data: session, status } = useSession()\n   108→  const [isLoading, setIsLoading] = useState(true)\n   109→  const [patients, setPatients] = useState<Patient[]>([])\n   110→  const [search, setSearch] = useState(\"\")\n   111→  const [filterActive, setFilterActive] = useState<string>(\"all\")\n   112→  const [isSheetOpen, setIsSheetOpen] = useState(false)\n   113→  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n   114→  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n   115→  const [isSaving, setIsSaving] = useState(false)\n   116→  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n   117→\n   118→  const isAdmin = session?.user?.role === \"ADMIN\"\n   119→\n   120→  const {\n   121→    register,\n   122→    handleSubmit,\n   123→    reset,\n   124→    formState: { errors },\n   125→  } = useForm<PatientFormData>({\n   126→    resolver: zodResolver(patientSchema),\n   127→    defaultValues: {\n   128→      consentWhatsApp: false,\n   129→      consentEmail: false,\n   130→    },\n   131→  })\n   132→\n   133→  const fetchPatients = useCallback(async () => {\n   134→    try {\n   135→      const params = new URLSearchParams()\n   136→      if (search) params.set(\"search\", search)\n   137→      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n   138→\n   139→      const response = await fetch(`/api/patients?${params.toString()}`)\n   140→      if (!response.ok) {\n   141→        if (response.status === 403) {\n   142→          toast.error(\"Acesso negado\")\n   143→          router.push(\"/\")\n   144→          return\n   145→        }\n   146→        throw new Error(\"Failed to fetch patients\")\n   147→      }\n   148→      const data = await response.json()\n   149→      setPatients(data.patients)\n   150→    } catch {\n   151→      toast.error(\"Erro ao carregar pacientes\")\n   152→    } finally {\n   153→      setIsLoading(false)\n   154→    }\n   155→  }, [search, filterActive, router])\n   156→\n   157→  const fetchPatientDetails = useCallback(async (patientId: string) => {\n   158→    setIsLoadingDetails(true)\n   159→    try {\n   160→      const response = await fetch(`/api/patients/${patientId}`)\n   161→      if (!response.ok) {\n   162→        throw new Error(\"Failed to fetch patient details\")\n   163→      }\n   164→      const data = await response.json()\n   165→      setViewingPatient(data.patient)\n   166→    } catch {\n   167→      toast.error(\"Erro ao carregar detalhes do paciente\")\n   168→    } finally {\n   169→      setIsLoadingDetails(false)\n   170→    }\n   171→  }, [])\n   172→\n   173→  useEffect(() => {\n   174→    if (status === \"unauthenticated\") {\n   175→      router.push(\"/login\")\n   176→      return\n   177→    }\n   178→\n   179→    if (status === \"authenticated\") {\n   180→      fetchPatients()\n   181→    }\n   182→  }, [status, router, fetchPatients])\n   183→\n   184→  function openCreateSheet() {\n   185→    setEditingPatient(null)\n   186→    setViewingPatient(null)\n   187→    reset({\n   188→      name: \"\",\n   189→      phone: \"\",\n   190→      email: \"\",\n   191→      notes: \"\",\n   192→      consentWhatsApp: false,\n   193→      consentEmail: false,\n   194→    })\n   195→    setIsSheetOpen(true)\n   196→  }\n   197→\n   198→  function openEditSheet(patient: Patient) {\n   199→    setEditingPatient(patient)\n   200→    setViewingPatient(null)\n   201→    reset({\n   202→      name: patient.name,\n   203→      phone: patient.phone,\n   204→      email: patient.email ?? \"\",\n   205→      notes: patient.notes ?? \"\",\n   206→      consentWhatsApp: patient.consentWhatsApp,\n   207→      consentEmail: patient.consentEmail,\n   208→    })\n   209→    setIsSheetOpen(true)\n   210→  }\n   211→\n   212→  function openViewSheet(patient: Patient) {\n   213→    setEditingPatient(null)\n   214→    fetchPatientDetails(patient.id)\n   215→    setIsSheetOpen(true)\n   216→  }\n   217→\n   218→  function closeSheet() {\n   219→    setIsSheetOpen(false)\n   220→    setEditingPatient(null)\n   221→    setViewingPatient(null)\n   222→  }\n   223→\n   224→  async function onSubmit(data: PatientFormData) {\n   225→    setIsSaving(true)\n   226→    try {\n   227→      const url = editingPatient\n   228→        ? `/api/patients/${editingPatient.id}`\n   229→        : \"/api/patients\"\n   230→      const method = editingPatient ? \"PATCH\" : \"POST\"\n   231→\n   232→      const payload: Record<string, unknown> = {\n   233→        name: data.name,\n   234→        phone: data.phone.replace(/\\D/g, \"\"),\n   235→        email: data.email || null,\n   236→        notes: data.notes || null,\n   237→        consentWhatsApp: data.consentWhatsApp,\n   238→        consentEmail: data.consentEmail,\n   239→      }\n   240→\n   241→      const response = await fetch(url, {\n   242→        method,\n   243→        headers: { \"Content-Type\": \"application/json\" },\n   244→        body: JSON.stringify(payload),\n   245→      })\n   246→\n   247→      if (!response.ok) {\n   248→        const error = await response.json()\n   249→        throw new Error(error.error || \"Failed to save patient\")\n   250→      }\n   251→\n   252→      toast.success(\n   253→        editingPatient\n   254→          ? \"Paciente atualizado com sucesso\"\n   255→          : \"Paciente criado com sucesso\"\n   256→      )\n   257→      closeSheet()\n   258→      fetchPatients()\n   259→    } catch (error) {\n   260→      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n   261→    } finally {\n   262→      setIsSaving(false)\n   263→    }\n   264→  }\n   265→\n   266→  async function handleDeactivate(patient: Patient) {\n   267→    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n   268→      return\n   269→    }\n   270→\n   271→    try {\n   272→      const response = await fetch(`/api/patients/${patient.id}`, {\n   273→        method: \"DELETE\",\n   274→      })\n   275→\n   276→      if (!response.ok) {\n   277→        const error = await response.json()\n   278→        throw new Error(error.error || \"Failed to deactivate patient\")\n   279→      }\n   280→\n   281→      toast.success(\"Paciente desativado com sucesso\")\n   282→      fetchPatients()\n   283→    } catch (error) {\n   284→      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n   285→    }\n   286→  }\n   287→\n   288→  async function handleReactivate(patient: Patient) {\n   289→    try {\n   290→      const response = await fetch(`/api/patients/${patient.id}`, {\n   291→        method: \"PATCH\",\n   292→        headers: { \"Content-Type\": \"application/json\" },\n   293→        body: JSON.stringify({ isActive: true }),\n   294→      })\n   295→\n   296→      if (!response.ok) {\n   297→        const error = await response.json()\n   298→        throw new Error(error.error || \"Failed to reactivate patient\")\n   299→      }\n   300→\n   301→      toast.success(\"Paciente reativado com sucesso\")\n   302→      fetchPatients()\n   303→    } catch (error) {\n   304→      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n   305→    }\n   306→  }\n   307→\n   308→  if (status === \"loading\" || isLoading) {\n   309→    return (\n   310→      <main className=\"min-h-screen bg-background\">\n   311→        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   312→          <div className=\"animate-pulse space-y-6\">\n   313→            <div className=\"h-8 w-48 bg-muted rounded\" />\n   314→            <div className=\"flex gap-4\">\n   315→              <div className=\"h-12 flex-1 bg-muted rounded\" />\n   316→              <div className=\"h-12 w-32 bg-muted rounded\" />\n   317→            </div>\n   318→            <div className=\"space-y-4\">\n   319→              {[1, 2, 3].map((i) => (\n   320→                <div key={i} className=\"h-20 bg-muted rounded\" />\n   321→              ))}\n   322→            </div>\n   323→          </div>\n   324→        </div>\n   325→      </main>\n   326→    )\n   327→  }\n   328→\n   329→  return (\n   330→    <main className=\"min-h-screen bg-background\">\n   331→      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   332→        <div className=\"mb-6\">\n   333→          <button\n   334→            onClick={() => router.back()}\n   335→            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n   336→          >\n   337→            &larr; Voltar\n   338→          </button>\n   339→        </div>\n   340→\n   341→        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n   342→          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n   343→          {isAdmin && (\n   344→            <button\n   345→              onClick={openCreateSheet}\n   346→              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n   347→            >\n   348→              + Novo Paciente\n   349→            </button>\n   350→          )}\n   351→        </div>\n   352→\n   353→        {/* Search and Filter */}\n   354→        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n   355→          <div className=\"flex-1\">\n   356→            <input\n   357→              type=\"text\"\n   358→              placeholder=\"Buscar por nome, email ou telefone...\"\n   359→              value={search}\n   360→              onChange={(e) => setSearch(e.target.value)}\n   361→              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   362→            />\n   363→          </div>\n   364→          <select\n   365→            value={filterActive}\n   366→            onChange={(e) => setFilterActive(e.target.value)}\n   367→            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   368→          >\n   369→            <option value=\"all\">Todos</option>\n   370→            <option value=\"true\">Ativos</option>\n   371→            <option value=\"false\">Inativos</option>\n   372→          </select>\n   373→        </div>\n   374→\n   375→        {/* Patients List */}\n   376→        <div className=\"space-y-4\">\n   377→          {patients.length === 0 ? (\n   378→            <div className=\"text-center py-12 text-muted-foreground\">\n   379→              {search || filterActive !== \"all\"\n   380→                ? \"Nenhum paciente encontrado\"\n   381→                : \"Nenhum paciente cadastrado\"}\n   382→            </div>\n   383→          ) : (\n   384→            patients.map((patient) => (\n   385→              <div\n   386→                key={patient.id}\n   387→                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n   388→                  !patient.isActive ? \"opacity-60\" : \"\"\n   389→                }`}\n   390→              >\n   391→                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n   392→                  <div\n   393→                    className=\"flex-1 min-w-0 cursor-pointer\"\n   394→                    onClick={() => openViewSheet(patient)}\n   395→                  >\n   396→                    <div className=\"flex items-center gap-2 mb-1\">\n   397→                      <h3 className=\"font-medium text-foreground truncate\">\n   398→                        {patient.name}\n   399→                      </h3>\n   400→                      {!patient.isActive && (\n   401→                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n   402→                          Inativo\n   403→                        </span>\n   404→                      )}\n   405→                    </div>\n   406→                    <p className=\"text-sm text-muted-foreground\">\n   407→                      {formatPhone(patient.phone)}\n   408→                    </p>\n   409→                    {patient.email && (\n   410→                      <p className=\"text-sm text-muted-foreground truncate\">\n   411→                        {patient.email}\n   412→                      </p>\n   413→                    )}\n   414→                    <div className=\"flex gap-3 mt-2\">\n   415→                      {patient.consentWhatsApp && (\n   416→                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n   417→                          WhatsApp\n   418→                        </span>\n   419→                      )}\n   420→                      {patient.consentEmail && (\n   421→                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n   422→                          Email\n   423→                        </span>\n   424→                      )}\n   425→                    </div>\n   426→                  </div>\n   427→                  {isAdmin && (\n   428→                    <div className=\"flex gap-2\">\n   429→                      <button\n   430→                        onClick={() => openEditSheet(patient)}\n   431→                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   432→                      >\n   433→                        Editar\n   434→                      </button>\n   435→                      {patient.isActive ? (\n   436→                        <button\n   437→                          onClick={() => handleDeactivate(patient)}\n   438→                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   439→                        >\n   440→                          Desativar\n   441→                        </button>\n   442→                      ) : (\n   443→                        <button\n   444→                          onClick={() => handleReactivate(patient)}\n   445→                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   446→                        >\n   447→                          Reativar\n   448→                        </button>\n   449→                      )}\n   450→                    </div>\n   451→                  )}\n   452→                </div>\n   453→              </div>\n   454→            ))\n   455→          )}\n   456→        </div>\n   457→      </div>\n   458→\n   459→      {/* Bottom Sheet */}\n   460→      {isSheetOpen && (\n   461→        <>\n   462→          {/* Backdrop */}\n   463→          <div\n   464→            className=\"fixed inset-0 bg-black/50 z-40\"\n   465→            onClick={closeSheet}\n   466→          />\n   467→          {/* Sheet */}\n   468→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n   469→            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n   470→              {/* Handle */}\n   471→              <div className=\"flex justify-center mb-4\">\n   472→                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n   473→              </div>\n   474→\n   475→              {/* View Mode */}\n   476→              {viewingPatient && !editingPatient && (\n   477→                <>\n   478→                  <div className=\"flex items-center justify-between mb-6\">\n   479→                    <h2 className=\"text-xl font-semibold text-foreground\">\n   480→                      {viewingPatient.name}\n   481→                    </h2>\n   482→                    {isAdmin && (\n   483→                      <button\n   484→                        onClick={() => openEditSheet(viewingPatient)}\n   485→                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   486→                      >\n   487→                        Editar\n   488→                      </button>\n   489→                    )}\n   490→                  </div>\n   491→\n   492→                  {isLoadingDetails ? (\n   493→                    <div className=\"animate-pulse space-y-4\">\n   494→                      <div className=\"h-6 w-32 bg-muted rounded\" />\n   495→                      <div className=\"h-4 w-48 bg-muted rounded\" />\n   496→                      <div className=\"h-4 w-40 bg-muted rounded\" />\n   497→                    </div>\n   498→                  ) : (\n   499→                    <div className=\"space-y-6\">\n   500→                      {/* Contact Info */}\n   501→                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n   502→                        <div>\n   503→                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n   504→                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n   505→                        </div>\n   506→                        <div>\n   507→                          <label className=\"text-sm text-muted-foreground\">Email</label>\n   508→                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n   509→                        </div>\n   510→                      </div>\n   511→\n   512→                      {/* Notes */}\n   513→                      {viewingPatient.notes && (\n   514→                        <div>\n   515→                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n   516→                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n   517→                        </div>\n   518→                      )}\n   519→\n   520→                      {/* Consent Info */}\n   521→                      <div>\n   522→                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n   523→                        <div className=\"flex gap-4\">\n   524→                          <div className=\"flex items-center gap-2\">\n   525→                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n   526→                            <span className=\"text-sm\">WhatsApp</span>\n   527→                            {viewingPatient.consentWhatsAppAt && (\n   528→                              <span className=\"text-xs text-muted-foreground\">\n   529→                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n   530→                              </span>\n   531→                            )}\n   532→                          </div>\n   533→                          <div className=\"flex items-center gap-2\">\n   534→                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n   535→                            <span className=\"text-sm\">Email</span>\n   536→                            {viewingPatient.consentEmailAt && (\n   537→                              <span className=\"text-xs text-muted-foreground\">\n   538→                                ({formatDate(viewingPatient.consentEmailAt)})\n   539→                              </span>\n   540→                            )}\n   541→                          </div>\n   542→                        </div>\n   543→                      </div>\n   544→\n   545→                      {/* Appointment History */}\n   546→                      <div>\n   547→                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n   548→                          Historico de Consultas\n   549→                        </h3>\n   550→                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n   551→                          <div className=\"space-y-3\">\n   552→                            {viewingPatient.appointments.map((appointment) => (\n   553→                              <div\n   554→                                key={appointment.id}\n   555→                                className=\"bg-muted/50 rounded-lg p-4\"\n   556→                              >\n   557→                                <div className=\"flex items-center justify-between mb-2\">\n   558→                                  <span className=\"font-medium\">\n   559→                                    {formatDateTime(appointment.scheduledAt)}\n   560→                                  </span>\n   561→                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n   562→                                    {statusLabels[appointment.status] || appointment.status}\n   563→                                  </span>\n   564→                                </div>\n   565→                                <p className=\"text-sm text-muted-foreground\">\n   566→                                  {appointment.professionalProfile.user.name}\n   567→                                </p>\n   568→                                <p className=\"text-sm text-muted-foreground\">\n   569→                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n   570→                                </p>\n   571→                              </div>\n   572→                            ))}\n   573→                          </div>\n   574→                        ) : (\n   575→                          <p className=\"text-muted-foreground text-sm\">\n   576→                            Nenhuma consulta registrada\n   577→                          </p>\n   578→                        )}\n   579→                      </div>\n   580→\n   581→                      <div className=\"pt-4\">\n   582→                        <button\n   583→                          type=\"button\"\n   584→                          onClick={closeSheet}\n   585→                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   586→                        >\n   587→                          Fechar\n   588→                        </button>\n   589→                      </div>\n   590→                    </div>\n   591→                  )}\n   592→                </>\n   593→              )}\n   594→\n   595→              {/* Create/Edit Mode */}\n   596→              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n   597→                <>\n   598→                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n   599→                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n   600→                  </h2>\n   601→\n   602→                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n   603→                    <div>\n   604→                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n   605→                        Nome *\n   606→                      </label>\n   607→                      <input\n   608→                        id=\"name\"\n   609→                        type=\"text\"\n   610→                        {...register(\"name\")}\n   611→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   612→                      />\n   613→                      {errors.name && (\n   614→                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n   615→                      )}\n   616→                    </div>\n   617→\n   618→                    <div>\n   619→                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n   620→                        Telefone (WhatsApp) *\n   621→                      </label>\n   622→                      <input\n   623→                        id=\"phone\"\n   624→                        type=\"tel\"\n   625→                        {...register(\"phone\")}\n   626→                        placeholder=\"11999999999\"\n   627→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   628→                      />\n   629→                      {errors.phone && (\n   630→                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n   631→                      )}\n   632→                      <p className=\"text-xs text-muted-foreground mt-1\">\n   633→                        Formato: DDD + numero (ex: 11999999999)\n   634→                      </p>\n   635→                    </div>\n   636→\n   637→                    <div>\n   638→                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n   639→                        Email\n   640→                      </label>\n   641→                      <input\n   642→                        id=\"email\"\n   643→                        type=\"email\"\n   644→                        {...register(\"email\")}\n   645→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   646→                      />\n   647→                      {errors.email && (\n   648→                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n   649→                      )}\n   650→                    </div>\n   651→\n   652→                    <div>\n   653→                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n   654→                        Observacoes administrativas\n   655→                      </label>\n   656→                      <textarea\n   657→                        id=\"notes\"\n   658→                        rows={3}\n   659→                        {...register(\"notes\")}\n   660→                        placeholder=\"Observacoes internas sobre o paciente...\"\n   661→                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n   662→                      />\n   663→                      {errors.notes && (\n   664→                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n   665→                      )}\n   666→                    </div>\n   667→\n   668→                    {/* LGPD Consent Section */}\n   669→                    <div className=\"border border-border rounded-lg p-4\">\n   670→                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n   671→                        Consentimentos LGPD\n   672→                      </h3>\n   673→                      <div className=\"space-y-4\">\n   674→                        <label className=\"flex items-start gap-3 cursor-pointer\">\n   675→                          <input\n   676→                            type=\"checkbox\"\n   677→                            {...register(\"consentWhatsApp\")}\n   678→                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n   679→                          />\n   680→                          <div>\n   681→                            <span className=\"text-sm text-foreground\">\n   682→                              Autorizo receber mensagens via WhatsApp\n   683→                            </span>\n   684→                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n   685→                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n   686→                            </p>\n   687→                          </div>\n   688→                        </label>\n   689→\n   690→                        <label className=\"flex items-start gap-3 cursor-pointer\">\n   691→                          <input\n   692→                            type=\"checkbox\"\n   693→                            {...register(\"consentEmail\")}\n   694→                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n   695→                          />\n   696→                          <div>\n   697→                            <span className=\"text-sm text-foreground\">\n   698→                              Autorizo receber comunicacoes por email\n   699→                            </span>\n   700→                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n   701→                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n   702→                            </p>\n   703→                          </div>\n   704→                        </label>\n   705→                      </div>\n   706→                    </div>\n   707→\n   708→                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n   709→                      <button\n   710→                        type=\"submit\"\n   711→                        disabled={isSaving}\n   712→                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n   713→                      >\n   714→                        {isSaving\n   715→                          ? \"Salvando...\"\n   716→                          : editingPatient\n   717→                          ? \"Salvar alteracoes\"\n   718→                          : \"Criar paciente\"}\n   719→                      </button>\n   720→                      <button\n   721→                        type=\"button\"\n   722→                        onClick={closeSheet}\n   723→                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   724→                      >\n   725→                        Cancelar\n   726→                      </button>\n   727→                    </div>\n   728→                  </form>\n   729→                </>\n   730→              )}\n   731→            </div>\n   732→          </div>\n   733→        </>\n   734→      )}\n   735→\n   736→      {/* Animation Styles */}\n   737→      <style jsx>{`\n   738→        @keyframes slide-up {\n   739→          from {\n   740→            transform: translateY(100%);\n   741→          }\n   742→          to {\n   743→            transform: translateY(0);\n   744→          }\n   745→        }\n   746→        .animate-slide-up {\n   747→          animation: slide-up 0.3s ease-out;\n   748→        }\n   749→      `}</style>\n   750→    </main>\n   751→  )\n   752→}\n   753→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4fe6be41-f97a-4cc3-9463-1c486d8985db","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","content":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\n\n// WhatsApp format validation\nconst phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n\nconst patientSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n  phone: z\n    .string()\n    .min(1, \"Telefone é obrigatório\")\n    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n  consentWhatsApp: z.boolean(),\n  consentEmail: z.boolean(),\n})\n\ntype PatientFormData = z.infer<typeof patientSchema>\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface Patient {\n  id: string\n  name: string\n  email: string | null\n  phone: string\n  birthDate: string | null\n  notes: string | null\n  isActive: boolean\n  lastVisitAt: string | null\n  consentWhatsApp: boolean\n  consentWhatsAppAt: string | null\n  consentEmail: boolean\n  consentEmailAt: string | null\n  createdAt: string\n  appointments?: Appointment[]\n}\n\nfunction formatPhone(phone: string): string {\n  // Format: (11) 99999-9999\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"-\"\n  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Não compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800\",\n  CONFIRMADO: \"bg-green-100 text-green-800\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n  FINALIZADO: \"bg-gray-100 text-gray-800\",\n}\n\nexport default function PatientsPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [search, setSearch] = useState(\"\")\n  const [filterActive, setFilterActive] = useState<string>(\"all\")\n  const [isSheetOpen, setIsSheetOpen] = useState(false)\n  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n  const [isSaving, setIsSaving] = useState(false)\n  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    formState: { errors },\n  } = useForm<PatientFormData>({\n    resolver: zodResolver(patientSchema),\n    defaultValues: {\n      consentWhatsApp: false,\n      consentEmail: false,\n    },\n  })\n\n  const fetchPatients = useCallback(async () => {\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set(\"search\", search)\n      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch patients\")\n      }\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      toast.error(\"Erro ao carregar pacientes\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [search, filterActive, router])\n\n  const fetchPatientDetails = useCallback(async (patientId: string) => {\n    setIsLoadingDetails(true)\n    try {\n      const response = await fetch(`/api/patients/${patientId}`)\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch patient details\")\n      }\n      const data = await response.json()\n      setViewingPatient(data.patient)\n    } catch {\n      toast.error(\"Erro ao carregar detalhes do paciente\")\n    } finally {\n      setIsLoadingDetails(false)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchPatients()\n    }\n  }, [status, router, fetchPatients])\n\n  function openCreateSheet() {\n    setEditingPatient(null)\n    setViewingPatient(null)\n    reset({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      notes: \"\",\n      consentWhatsApp: false,\n      consentEmail: false,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openEditSheet(patient: Patient) {\n    setEditingPatient(patient)\n    setViewingPatient(null)\n    reset({\n      name: patient.name,\n      phone: patient.phone,\n      email: patient.email ?? \"\",\n      notes: patient.notes ?? \"\",\n      consentWhatsApp: patient.consentWhatsApp,\n      consentEmail: patient.consentEmail,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openViewSheet(patient: Patient) {\n    setEditingPatient(null)\n    fetchPatientDetails(patient.id)\n    setIsSheetOpen(true)\n  }\n\n  function closeSheet() {\n    setIsSheetOpen(false)\n    setEditingPatient(null)\n    setViewingPatient(null)\n  }\n\n  async function onSubmit(data: PatientFormData) {\n    setIsSaving(true)\n    try {\n      const url = editingPatient\n        ? `/api/patients/${editingPatient.id}`\n        : \"/api/patients\"\n      const method = editingPatient ? \"PATCH\" : \"POST\"\n\n      const payload: Record<string, unknown> = {\n        name: data.name,\n        phone: data.phone.replace(/\\D/g, \"\"),\n        email: data.email || null,\n        notes: data.notes || null,\n        consentWhatsApp: data.consentWhatsApp,\n        consentEmail: data.consentEmail,\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save patient\")\n      }\n\n      toast.success(\n        editingPatient\n          ? \"Paciente atualizado com sucesso\"\n          : \"Paciente criado com sucesso\"\n      )\n      closeSheet()\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function handleDeactivate(patient: Patient) {\n    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n      return\n    }\n\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to deactivate patient\")\n      }\n\n      toast.success(\"Paciente desativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n    }\n  }\n\n  async function handleReactivate(patient: Patient) {\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isActive: true }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to reactivate patient\")\n      }\n\n      toast.success(\"Paciente reativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n    }\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"flex gap-4\">\n              <div className=\"h-12 flex-1 bg-muted rounded\" />\n              <div className=\"h-12 w-32 bg-muted rounded\" />\n            </div>\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n          {isAdmin && (\n            <button\n              onClick={openCreateSheet}\n              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n            >\n              + Novo Paciente\n            </button>\n          )}\n        </div>\n\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1\">\n            <input\n              type=\"text\"\n              placeholder=\"Buscar por nome, email ou telefone...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            />\n          </div>\n          <select\n            value={filterActive}\n            onChange={(e) => setFilterActive(e.target.value)}\n            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n          >\n            <option value=\"all\">Todos</option>\n            <option value=\"true\">Ativos</option>\n            <option value=\"false\">Inativos</option>\n          </select>\n        </div>\n\n        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              {search || filterActive !== \"all\"\n                ? \"Nenhum paciente encontrado\"\n                : \"Nenhum paciente cadastrado\"}\n            </div>\n          ) : (\n            patients.map((patient) => (\n              <div\n                key={patient.id}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !patient.isActive ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                  <div\n                    className=\"flex-1 min-w-0 cursor-pointer\"\n                    onClick={() => openViewSheet(patient)}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <h3 className=\"font-medium text-foreground truncate\">\n                        {patient.name}\n                      </h3>\n                      {!patient.isActive && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n                          Inativo\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatPhone(patient.phone)}\n                    </p>\n                    {patient.email && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {patient.email}\n                      </p>\n                    )}\n                    <div className=\"flex gap-3 mt-2\">\n                      {patient.consentWhatsApp && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n                          WhatsApp\n                        </span>\n                      )}\n                      {patient.consentEmail && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n                          Email\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  {isAdmin && (\n                    <div className=\"flex gap-2\">\n                      <button\n                        onClick={() => openEditSheet(patient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                      {patient.isActive ? (\n                        <button\n                          onClick={() => handleDeactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Desativar\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => handleReactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Reativar\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>\n                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n                        </div>\n                      </div>\n\n                      {/* Notes */}\n                      {viewingPatient.notes && (\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n                        </div>\n                      )}\n\n                      {/* Consent Info */}\n                      <div>\n                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">WhatsApp</span>\n                            {viewingPatient.consentWhatsAppAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">Email</span>\n                            {viewingPatient.consentEmailAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentEmailAt)})\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Appointment History */}\n                      <div>\n                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n                          Historico de Consultas\n                        </h3>\n                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {viewingPatient.appointments.map((appointment) => (\n                              <div\n                                key={appointment.id}\n                                className=\"bg-muted/50 rounded-lg p-4\"\n                              >\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <span className=\"font-medium\">\n                                    {formatDateTime(appointment.scheduledAt)}\n                                  </span>\n                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n                                    {statusLabels[appointment.status] || appointment.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.professionalProfile.user.name}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                                </p>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-muted-foreground text-sm\">\n                            Nenhuma consulta registrada\n                          </p>\n                        )}\n                      </div>\n\n                      <div className=\"pt-4\">\n                        <button\n                          type=\"button\"\n                          onClick={closeSheet}\n                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Fechar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Create/Edit Mode */}\n              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n                <>\n                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n                  </h2>\n\n                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div>\n                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Nome *\n                      </label>\n                      <input\n                        id=\"name\"\n                        type=\"text\"\n                        {...register(\"name\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.name && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Telefone (WhatsApp) *\n                      </label>\n                      <input\n                        id=\"phone\"\n                        type=\"tel\"\n                        {...register(\"phone\")}\n                        placeholder=\"11999999999\"\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.phone && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Formato: DDD + numero (ex: 11999999999)\n                      </p>\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Email\n                      </label>\n                      <input\n                        id=\"email\"\n                        type=\"email\"\n                        {...register(\"email\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.email && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Observacoes administrativas\n                      </label>\n                      <textarea\n                        id=\"notes\"\n                        rows={3}\n                        {...register(\"notes\")}\n                        placeholder=\"Observacoes internas sobre o paciente...\"\n                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                      />\n                      {errors.notes && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                      )}\n                    </div>\n\n                    {/* LGPD Consent Section */}\n                    <div className=\"border border-border rounded-lg p-4\">\n                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n                        Consentimentos LGPD\n                      </h3>\n                      <div className=\"space-y-4\">\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentWhatsApp\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber mensagens via WhatsApp\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentEmail\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber comunicacoes por email\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                      <button\n                        type=\"submit\"\n                        disabled={isSaving}\n                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                      >\n                        {isSaving\n                          ? \"Salvando...\"\n                          : editingPatient\n                          ? \"Salvar alteracoes\"\n                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","numLines":753,"startLine":1,"totalLines":753}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JCL8zqmiEUPtqhrHxbAXRW","type":"tool_result","content":"     1→\"use client\"\n     2→\n     3→import { Suspense, useCallback, useEffect, useState } from \"react\"\n     4→import { useRouter, useSearchParams } from \"next/navigation\"\n     5→import { useSession } from \"next-auth/react\"\n     6→import { toast } from \"sonner\"\n     7→\n     8→const DAYS_OF_WEEK = [\n     9→  { value: 0, label: \"Domingo\", short: \"Dom\" },\n    10→  { value: 1, label: \"Segunda\", short: \"Seg\" },\n    11→  { value: 2, label: \"Terça\", short: \"Ter\" },\n    12→  { value: 3, label: \"Quarta\", short: \"Qua\" },\n    13→  { value: 4, label: \"Quinta\", short: \"Qui\" },\n    14→  { value: 5, label: \"Sexta\", short: \"Sex\" },\n    15→  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n    16→]\n    17→\n    18→interface TimeBlock {\n    19→  id?: string\n    20→  dayOfWeek: number\n    21→  startTime: string\n    22→  endTime: string\n    23→  isActive: boolean\n    24→}\n    25→\n    26→interface AvailabilityException {\n    27→  id: string\n    28→  date: string\n    29→  isAvailable: boolean\n    30→  startTime: string | null\n    31→  endTime: string | null\n    32→  reason: string | null\n    33→  createdAt: string\n    34→}\n    35→\n    36→interface Professional {\n    37→  id: string\n    38→  name: string\n    39→  professionalProfile: {\n    40→    id: string\n    41→  } | null\n    42→}\n    43→\n    44→function LoadingState() {\n    45→  return (\n    46→    <main className=\"min-h-screen bg-background\">\n    47→      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n    48→        <div className=\"animate-pulse space-y-6\">\n    49→          <div className=\"h-8 w-48 bg-muted rounded\" />\n    50→          <div className=\"space-y-4\">\n    51→            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n    52→              <div key={i} className=\"h-20 bg-muted rounded\" />\n    53→            ))}\n    54→          </div>\n    55→        </div>\n    56→      </div>\n    57→    </main>\n    58→  )\n    59→}\n    60→\n    61→export default function AvailabilitySettingsPage() {\n    62→  return (\n    63→    <Suspense fallback={<LoadingState />}>\n    64→      <AvailabilitySettingsContent />\n    65→    </Suspense>\n    66→  )\n    67→}\n    68→\n    69→function AvailabilitySettingsContent() {\n    70→  const router = useRouter()\n    71→  const searchParams = useSearchParams()\n    72→  const { data: session, status } = useSession()\n    73→\n    74→  const [isLoading, setIsLoading] = useState(true)\n    75→  const [isSaving, setIsSaving] = useState(false)\n    76→  const [rules, setRules] = useState<TimeBlock[]>([])\n    77→  const [editingBlock, setEditingBlock] = useState<{\n    78→    dayOfWeek: number\n    79→    index: number | null\n    80→    block: TimeBlock\n    81→  } | null>(null)\n    82→\n    83→  // Exceptions state\n    84→  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n    85→  const [editingException, setEditingException] = useState<{\n    86→    id?: string\n    87→    date: string\n    88→    isAvailable: boolean\n    89→    startTime: string | null\n    90→    endTime: string | null\n    91→    reason: string | null\n    92→    isFullDay: boolean\n    93→  } | null>(null)\n    94→  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n    95→\n    96→  // ADMIN-only: professional selection\n    97→  const [professionals, setProfessionals] = useState<Professional[]>([])\n    98→  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n    99→  const professionalIdParam = searchParams.get(\"professionalId\")\n   100→\n   101→  const isAdmin = session?.user?.role === \"ADMIN\"\n   102→\n   103→  const fetchProfessionals = useCallback(async () => {\n   104→    if (!isAdmin) return\n   105→\n   106→    try {\n   107→      const response = await fetch(\"/api/professionals?isActive=true\")\n   108→      if (response.ok) {\n   109→        const data = await response.json()\n   110→        setProfessionals(data.professionals)\n   111→      }\n   112→    } catch {\n   113→      // Ignore errors for professional list\n   114→    }\n   115→  }, [isAdmin])\n   116→\n   117→  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n   118→    try {\n   119→      const params = new URLSearchParams()\n   120→      if (profileId) {\n   121→        params.set(\"professionalProfileId\", profileId)\n   122→      }\n   123→\n   124→      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n   125→      if (response.ok) {\n   126→        const data = await response.json()\n   127→        setExceptions(data.exceptions || [])\n   128→      }\n   129→    } catch {\n   130→      // Silently fail for exceptions\n   131→    }\n   132→  }, [])\n   133→\n   134→  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n   135→    try {\n   136→      const params = new URLSearchParams()\n   137→      if (profileId) {\n   138→        params.set(\"professionalProfileId\", profileId)\n   139→      }\n   140→\n   141→      const response = await fetch(`/api/availability?${params.toString()}`)\n   142→      if (!response.ok) {\n   143→        if (response.status === 403) {\n   144→          toast.error(\"Acesso negado\")\n   145→          router.push(\"/\")\n   146→          return\n   147→        }\n   148→        throw new Error(\"Failed to fetch availability\")\n   149→      }\n   150→\n   151→      const data = await response.json()\n   152→      setRules(data.rules || [])\n   153→\n   154→      // Also fetch exceptions\n   155→      await fetchExceptions(profileId)\n   156→    } catch {\n   157→      toast.error(\"Erro ao carregar disponibilidade\")\n   158→    } finally {\n   159→      setIsLoading(false)\n   160→    }\n   161→  }, [router, fetchExceptions])\n   162→\n   163→  useEffect(() => {\n   164→    if (status === \"unauthenticated\") {\n   165→      router.push(\"/login\")\n   166→      return\n   167→    }\n   168→\n   169→    if (status === \"authenticated\") {\n   170→      fetchProfessionals()\n   171→\n   172→      // If ADMIN with professionalId param, use that\n   173→      if (isAdmin && professionalIdParam) {\n   174→        setSelectedProfessionalId(professionalIdParam)\n   175→        // Find the professional profile ID\n   176→        const prof = professionals.find((p) => p.id === professionalIdParam)\n   177→        if (prof?.professionalProfile?.id) {\n   178→          fetchAvailability(prof.professionalProfile.id)\n   179→        } else {\n   180→          // Fetch all professionals first, then get availability\n   181→          fetch(\"/api/professionals?isActive=true\")\n   182→            .then((res) => res.json())\n   183→            .then((data) => {\n   184→              const foundProf = data.professionals?.find(\n   185→                (p: Professional) => p.id === professionalIdParam\n   186→              )\n   187→              if (foundProf?.professionalProfile?.id) {\n   188→                fetchAvailability(foundProf.professionalProfile.id)\n   189→              } else {\n   190→                setIsLoading(false)\n   191→              }\n   192→            })\n   193→            .catch(() => setIsLoading(false))\n   194→        }\n   195→      } else {\n   196→        fetchAvailability()\n   197→      }\n   198→    }\n   199→  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n   200→\n   201→  async function handleProfessionalChange(professionalId: string) {\n   202→    setSelectedProfessionalId(professionalId)\n   203→    setIsLoading(true)\n   204→\n   205→    const prof = professionals.find((p) => p.id === professionalId)\n   206→    if (prof?.professionalProfile?.id) {\n   207→      await fetchAvailability(prof.professionalProfile.id)\n   208→    } else {\n   209→      setRules([])\n   210→      setIsLoading(false)\n   211→    }\n   212→  }\n   213→\n   214→  async function saveAvailability() {\n   215→    setIsSaving(true)\n   216→\n   217→    try {\n   218→      let professionalProfileId: string | undefined\n   219→\n   220→      if (isAdmin && selectedProfessionalId) {\n   221→        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n   222→        professionalProfileId = prof?.professionalProfile?.id\n   223→      }\n   224→\n   225→      const response = await fetch(\"/api/availability\", {\n   226→        method: \"POST\",\n   227→        headers: { \"Content-Type\": \"application/json\" },\n   228→        body: JSON.stringify({\n   229→          professionalProfileId,\n   230→          rules,\n   231→        }),\n   232→      })\n   233→\n   234→      if (!response.ok) {\n   235→        const error = await response.json()\n   236→        throw new Error(error.error || \"Failed to save availability\")\n   237→      }\n   238→\n   239→      const data = await response.json()\n   240→      setRules(data.rules || [])\n   241→      toast.success(\"Disponibilidade salva com sucesso\")\n   242→    } catch (error) {\n   243→      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n   244→    } finally {\n   245→      setIsSaving(false)\n   246→    }\n   247→  }\n   248→\n   249→  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n   250→    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n   251→  }\n   252→\n   253→  function toggleDayActive(dayOfWeek: number) {\n   254→    const dayRules = getRulesForDay(dayOfWeek)\n   255→\n   256→    if (dayRules.length === 0) {\n   257→      // Add default time block for this day\n   258→      setRules([\n   259→        ...rules,\n   260→        {\n   261→          dayOfWeek,\n   262→          startTime: \"08:00\",\n   263→          endTime: \"18:00\",\n   264→          isActive: true,\n   265→        },\n   266→      ])\n   267→    } else {\n   268→      // Toggle isActive for all blocks on this day\n   269→      const allActive = dayRules.every((r) => r.isActive)\n   270→      setRules(\n   271→        rules.map((r) =>\n   272→          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n   273→        )\n   274→      )\n   275→    }\n   276→  }\n   277→\n   278→  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n   279→    const dayRules = getRulesForDay(dayOfWeek)\n   280→    const block =\n   281→      index !== null\n   282→        ? dayRules[index]\n   283→        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n   284→\n   285→    setEditingBlock({ dayOfWeek, index, block })\n   286→  }\n   287→\n   288→  function closeBlockEditor() {\n   289→    setEditingBlock(null)\n   290→  }\n   291→\n   292→  function saveBlock() {\n   293→    if (!editingBlock) return\n   294→\n   295→    const { dayOfWeek, index, block } = editingBlock\n   296→\n   297→    // Validate times\n   298→    if (block.startTime >= block.endTime) {\n   299→      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n   300→      return\n   301→    }\n   302→\n   303→    if (index !== null) {\n   304→      // Update existing block\n   305→      let blockIndex = 0\n   306→      setRules(\n   307→        rules.map((r) => {\n   308→          if (r.dayOfWeek === dayOfWeek) {\n   309→            if (blockIndex === index) {\n   310→              blockIndex++\n   311→              return { ...block }\n   312→            }\n   313→            blockIndex++\n   314→          }\n   315→          return r\n   316→        })\n   317→      )\n   318→    } else {\n   319→      // Add new block\n   320→      setRules([...rules, { ...block }])\n   321→    }\n   322→\n   323→    closeBlockEditor()\n   324→  }\n   325→\n   326→  function deleteBlock() {\n   327→    if (!editingBlock || editingBlock.index === null) return\n   328→\n   329→    const { dayOfWeek, index } = editingBlock\n   330→    let blockIndex = 0\n   331→\n   332→    setRules(\n   333→      rules.filter((r) => {\n   334→        if (r.dayOfWeek === dayOfWeek) {\n   335→          if (blockIndex === index) {\n   336→            blockIndex++\n   337→            return false\n   338→          }\n   339→          blockIndex++\n   340→        }\n   341→        return true\n   342→      })\n   343→    )\n   344→\n   345→    closeBlockEditor()\n   346→  }\n   347→\n   348→  function removeAllBlocksForDay(dayOfWeek: number) {\n   349→    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n   350→  }\n   351→\n   352→  // Exception handlers\n   353→  function openExceptionEditor(exception?: AvailabilityException) {\n   354→    if (exception) {\n   355→      setEditingException({\n   356→        id: exception.id,\n   357→        date: exception.date.split(\"T\")[0],\n   358→        isAvailable: exception.isAvailable,\n   359→        startTime: exception.startTime,\n   360→        endTime: exception.endTime,\n   361→        reason: exception.reason,\n   362→        isFullDay: !exception.startTime && !exception.endTime,\n   363→      })\n   364→    } else {\n   365→      // New exception - default to block (unavailable)\n   366→      const tomorrow = new Date()\n   367→      tomorrow.setDate(tomorrow.getDate() + 1)\n   368→      setEditingException({\n   369→        date: tomorrow.toISOString().split(\"T\")[0],\n   370→        isAvailable: false,\n   371→        startTime: null,\n   372→        endTime: null,\n   373→        reason: null,\n   374→        isFullDay: true,\n   375→      })\n   376→    }\n   377→  }\n   378→\n   379→  function closeExceptionEditor() {\n   380→    setEditingException(null)\n   381→  }\n   382→\n   383→  async function saveException() {\n   384→    if (!editingException) return\n   385→\n   386→    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n   387→\n   388→    // Validate time range if not full day\n   389→    if (!isFullDay) {\n   390→      if (!startTime || !endTime) {\n   391→        toast.error(\"Selecione os horários de início e término\")\n   392→        return\n   393→      }\n   394→      if (startTime >= endTime) {\n   395→        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n   396→        return\n   397→      }\n   398→    }\n   399→\n   400→    setIsSaving(true)\n   401→\n   402→    try {\n   403→      let professionalProfileId: string | undefined\n   404→\n   405→      if (isAdmin && selectedProfessionalId) {\n   406→        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n   407→        professionalProfileId = prof?.professionalProfile?.id\n   408→      }\n   409→\n   410→      const response = await fetch(\"/api/availability/exceptions\", {\n   411→        method: \"POST\",\n   412→        headers: { \"Content-Type\": \"application/json\" },\n   413→        body: JSON.stringify({\n   414→          professionalProfileId,\n   415→          date,\n   416→          isAvailable,\n   417→          startTime: isFullDay ? null : startTime,\n   418→          endTime: isFullDay ? null : endTime,\n   419→          reason: reason || null,\n   420→        }),\n   421→      })\n   422→\n   423→      if (!response.ok) {\n   424→        const error = await response.json()\n   425→        throw new Error(error.error || \"Erro ao salvar exceção\")\n   426→      }\n   427→\n   428→      const data = await response.json()\n   429→      setExceptions([...exceptions, data.exception])\n   430→      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n   431→      closeExceptionEditor()\n   432→    } catch (error) {\n   433→      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n   434→    } finally {\n   435→      setIsSaving(false)\n   436→    }\n   437→  }\n   438→\n   439→  async function deleteException(id: string) {\n   440→    setIsDeletingException(id)\n   441→\n   442→    try {\n   443→      const response = await fetch(`/api/availability/exceptions/${id}`, {\n   444→        method: \"DELETE\",\n   445→      })\n   446→\n   447→      if (!response.ok) {\n   448→        const error = await response.json()\n   449→        throw new Error(error.error || \"Erro ao excluir exceção\")\n   450→      }\n   451→\n   452→      setExceptions(exceptions.filter((e) => e.id !== id))\n   453→      toast.success(\"Exceção removida\")\n   454→    } catch (error) {\n   455→      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n   456→    } finally {\n   457→      setIsDeletingException(null)\n   458→    }\n   459→  }\n   460→\n   461→  function formatExceptionDate(dateStr: string): string {\n   462→    const date = new Date(dateStr + \"T00:00:00\")\n   463→    return date.toLocaleDateString(\"pt-BR\", {\n   464→      weekday: \"short\",\n   465→      day: \"2-digit\",\n   466→      month: \"short\",\n   467→      year: \"numeric\",\n   468→    })\n   469→  }\n   470→\n   471→  if (status === \"loading\" || isLoading) {\n   472→    return (\n   473→      <main className=\"min-h-screen bg-background\">\n   474→        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   475→          <div className=\"animate-pulse space-y-6\">\n   476→            <div className=\"h-8 w-48 bg-muted rounded\" />\n   477→            <div className=\"space-y-4\">\n   478→              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n   479→                <div key={i} className=\"h-20 bg-muted rounded\" />\n   480→              ))}\n   481→            </div>\n   482→          </div>\n   483→        </div>\n   484→      </main>\n   485→    )\n   486→  }\n   487→\n   488→  return (\n   489→    <main className=\"min-h-screen bg-background\">\n   490→      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n   491→        <div className=\"mb-6\">\n   492→          <button\n   493→            onClick={() => router.back()}\n   494→            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n   495→          >\n   496→            &larr; Voltar\n   497→          </button>\n   498→        </div>\n   499→\n   500→        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n   501→          <h1 className=\"text-2xl font-semibold text-foreground\">\n   502→            Disponibilidade Semanal\n   503→          </h1>\n   504→          <button\n   505→            onClick={saveAvailability}\n   506→            disabled={isSaving}\n   507→            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n   508→          >\n   509→            {isSaving ? \"Salvando...\" : \"Salvar\"}\n   510→          </button>\n   511→        </div>\n   512→\n   513→        {/* ADMIN: Professional selector */}\n   514→        {isAdmin && professionals.length > 0 && (\n   515→          <div className=\"mb-6\">\n   516→            <label\n   517→              htmlFor=\"professional\"\n   518→              className=\"block text-sm font-medium text-foreground mb-2\"\n   519→            >\n   520→              Profissional\n   521→            </label>\n   522→            <select\n   523→              id=\"professional\"\n   524→              value={selectedProfessionalId || \"\"}\n   525→              onChange={(e) => handleProfessionalChange(e.target.value)}\n   526→              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   527→            >\n   528→              <option value=\"\">Selecione um profissional</option>\n   529→              {professionals.map((prof) => (\n   530→                <option key={prof.id} value={prof.id}>\n   531→                  {prof.name}\n   532→                </option>\n   533→              ))}\n   534→            </select>\n   535→          </div>\n   536→        )}\n   537→\n   538→        {/* Weekly Grid */}\n   539→        <div className=\"space-y-4\">\n   540→          {DAYS_OF_WEEK.map((day) => {\n   541→            const dayRules = getRulesForDay(day.value)\n   542→            const hasRules = dayRules.length > 0\n   543→            const allActive = hasRules && dayRules.every((r) => r.isActive)\n   544→\n   545→            return (\n   546→              <div\n   547→                key={day.value}\n   548→                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n   549→                  !allActive && hasRules ? \"opacity-60\" : \"\"\n   550→                }`}\n   551→              >\n   552→                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n   553→                  {/* Day toggle */}\n   554→                  <div className=\"flex items-center gap-3 sm:w-32\">\n   555→                    <button\n   556→                      type=\"button\"\n   557→                      onClick={() => toggleDayActive(day.value)}\n   558→                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   559→                        allActive ? \"bg-primary\" : \"bg-muted\"\n   560→                      }`}\n   561→                      aria-label={`Toggle ${day.label}`}\n   562→                    >\n   563→                      <span\n   564→                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n   565→                          allActive ? \"left-7\" : \"left-1\"\n   566→                        }`}\n   567→                      />\n   568→                    </button>\n   569→                    <span className=\"font-medium text-foreground\">\n   570→                      <span className=\"hidden sm:inline\">{day.label}</span>\n   571→                      <span className=\"sm:hidden\">{day.short}</span>\n   572→                    </span>\n   573→                  </div>\n   574→\n   575→                  {/* Time blocks */}\n   576→                  <div className=\"flex-1 flex flex-wrap gap-2\">\n   577→                    {dayRules.map((rule, index) => (\n   578→                      <button\n   579→                        key={rule.id || `${day.value}-${index}`}\n   580→                        type=\"button\"\n   581→                        onClick={() => openBlockEditor(day.value, index)}\n   582→                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   583→                          rule.isActive\n   584→                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n   585→                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n   586→                        }`}\n   587→                      >\n   588→                        {rule.startTime} - {rule.endTime}\n   589→                      </button>\n   590→                    ))}\n   591→\n   592→                    {/* Add time block button */}\n   593→                    <button\n   594→                      type=\"button\"\n   595→                      onClick={() => openBlockEditor(day.value)}\n   596→                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n   597→                    >\n   598→                      + Adicionar\n   599→                    </button>\n   600→                  </div>\n   601→\n   602→                  {/* Remove all */}\n   603→                  {hasRules && (\n   604→                    <button\n   605→                      type=\"button\"\n   606→                      onClick={() => removeAllBlocksForDay(day.value)}\n   607→                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n   608→                    >\n   609→                      Limpar\n   610→                    </button>\n   611→                  )}\n   612→                </div>\n   613→              </div>\n   614→            )\n   615→          })}\n   616→        </div>\n   617→\n   618→        <p className=\"text-sm text-muted-foreground mt-6\">\n   619→          Configure os horários em que você está disponível para atendimentos.\n   620→          Você pode adicionar múltiplos blocos de horário por dia.\n   621→        </p>\n   622→\n   623→        {/* Exceptions Section */}\n   624→        <div className=\"mt-10\">\n   625→          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n   626→            <h2 className=\"text-xl font-semibold text-foreground\">\n   627→              Bloqueios e Exceções\n   628→            </h2>\n   629→            <button\n   630→              type=\"button\"\n   631→              onClick={() => openExceptionEditor()}\n   632→              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   633→            >\n   634→              + Adicionar Exceção\n   635→            </button>\n   636→          </div>\n   637→\n   638→          {exceptions.length === 0 ? (\n   639→            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n   640→              <p className=\"text-muted-foreground\">\n   641→                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n   642→              </p>\n   643→            </div>\n   644→          ) : (\n   645→            <div className=\"space-y-3\">\n   646→              {exceptions\n   647→                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n   648→                .map((exception) => (\n   649→                  <div\n   650→                    key={exception.id}\n   651→                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n   652→                      exception.isAvailable\n   653→                        ? \"border-green-500/30 bg-green-500/5\"\n   654→                        : \"border-red-500/30 bg-red-500/5\"\n   655→                    }`}\n   656→                  >\n   657→                    <div className=\"flex-1 min-w-0\">\n   658→                      <div className=\"flex items-center gap-2 mb-1\">\n   659→                        <span\n   660→                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n   661→                            exception.isAvailable\n   662→                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n   663→                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n   664→                          }`}\n   665→                        >\n   666→                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n   667→                        </span>\n   668→                        {exception.startTime && exception.endTime && (\n   669→                          <span className=\"text-sm text-muted-foreground\">\n   670→                            {exception.startTime} - {exception.endTime}\n   671→                          </span>\n   672→                        )}\n   673→                        {!exception.startTime && (\n   674→                          <span className=\"text-sm text-muted-foreground\">\n   675→                            Dia inteiro\n   676→                          </span>\n   677→                        )}\n   678→                      </div>\n   679→                      <p className=\"font-medium text-foreground\">\n   680→                        {formatExceptionDate(exception.date)}\n   681→                      </p>\n   682→                      {exception.reason && (\n   683→                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n   684→                          {exception.reason}\n   685→                        </p>\n   686→                      )}\n   687→                    </div>\n   688→                    <button\n   689→                      type=\"button\"\n   690→                      onClick={() => deleteException(exception.id)}\n   691→                      disabled={isDeletingException === exception.id}\n   692→                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n   693→                    >\n   694→                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n   695→                    </button>\n   696→                  </div>\n   697→                ))}\n   698→            </div>\n   699→          )}\n   700→\n   701→          <p className=\"text-sm text-muted-foreground mt-4\">\n   702→            Use bloqueios para marcar dias de férias ou indisponibilidade.\n   703→            Use exceções de disponibilidade para atender fora do horário normal.\n   704→          </p>\n   705→        </div>\n   706→      </div>\n   707→\n   708→      {/* Time Block Editor Modal */}\n   709→      {editingBlock && (\n   710→        <>\n   711→          <div\n   712→            className=\"fixed inset-0 bg-black/50 z-40\"\n   713→            onClick={closeBlockEditor}\n   714→          />\n   715→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n   716→            <div className=\"max-w-md mx-auto px-4 py-6\">\n   717→              <div className=\"flex justify-center mb-4\">\n   718→                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n   719→              </div>\n   720→\n   721→              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n   722→                {editingBlock.index !== null\n   723→                  ? \"Editar Horário\"\n   724→                  : \"Novo Horário\"}\n   725→                {\" - \"}\n   726→                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n   727→              </h2>\n   728→\n   729→              <div className=\"space-y-6\">\n   730→                <div className=\"grid grid-cols-2 gap-4\">\n   731→                  <div>\n   732→                    <label\n   733→                      htmlFor=\"startTime\"\n   734→                      className=\"block text-sm font-medium text-foreground mb-2\"\n   735→                    >\n   736→                      Início\n   737→                    </label>\n   738→                    <input\n   739→                      id=\"startTime\"\n   740→                      type=\"time\"\n   741→                      value={editingBlock.block.startTime}\n   742→                      onChange={(e) =>\n   743→                        setEditingBlock({\n   744→                          ...editingBlock,\n   745→                          block: {\n   746→                            ...editingBlock.block,\n   747→                            startTime: e.target.value,\n   748→                          },\n   749→                        })\n   750→                      }\n   751→                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   752→                    />\n   753→                  </div>\n   754→                  <div>\n   755→                    <label\n   756→                      htmlFor=\"endTime\"\n   757→                      className=\"block text-sm font-medium text-foreground mb-2\"\n   758→                    >\n   759→                      Término\n   760→                    </label>\n   761→                    <input\n   762→                      id=\"endTime\"\n   763→                      type=\"time\"\n   764→                      value={editingBlock.block.endTime}\n   765→                      onChange={(e) =>\n   766→                        setEditingBlock({\n   767→                          ...editingBlock,\n   768→                          block: {\n   769→                            ...editingBlock.block,\n   770→                            endTime: e.target.value,\n   771→                          },\n   772→                        })\n   773→                      }\n   774→                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   775→                    />\n   776→                  </div>\n   777→                </div>\n   778→\n   779→                <div className=\"flex items-center gap-3\">\n   780→                  <button\n   781→                    type=\"button\"\n   782→                    onClick={() =>\n   783→                      setEditingBlock({\n   784→                        ...editingBlock,\n   785→                        block: {\n   786→                          ...editingBlock.block,\n   787→                          isActive: !editingBlock.block.isActive,\n   788→                        },\n   789→                      })\n   790→                    }\n   791→                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   792→                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n   793→                    }`}\n   794→                  >\n   795→                    <span\n   796→                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n   797→                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n   798→                      }`}\n   799→                    />\n   800→                  </button>\n   801→                  <span className=\"text-sm text-foreground\">\n   802→                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n   803→                  </span>\n   804→                </div>\n   805→\n   806→                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n   807→                  <button\n   808→                    type=\"button\"\n   809→                    onClick={saveBlock}\n   810→                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n   811→                  >\n   812→                    Salvar\n   813→                  </button>\n   814→                  {editingBlock.index !== null && (\n   815→                    <button\n   816→                      type=\"button\"\n   817→                      onClick={deleteBlock}\n   818→                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   819→                    >\n   820→                      Excluir\n   821→                    </button>\n   822→                  )}\n   823→                  <button\n   824→                    type=\"button\"\n   825→                    onClick={closeBlockEditor}\n   826→                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   827→                  >\n   828→                    Cancelar\n   829→                  </button>\n   830→                </div>\n   831→              </div>\n   832→            </div>\n   833→          </div>\n   834→        </>\n   835→      )}\n   836→\n   837→      {/* Exception Editor Modal */}\n   838→      {editingException && (\n   839→        <>\n   840→          <div\n   841→            className=\"fixed inset-0 bg-black/50 z-40\"\n   842→            onClick={closeExceptionEditor}\n   843→          />\n   844→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n   845→            <div className=\"max-w-md mx-auto px-4 py-6\">\n   846→              <div className=\"flex justify-center mb-4\">\n   847→                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n   848→              </div>\n   849→\n   850→              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n   851→                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n   852→              </h2>\n   853→\n   854→              <div className=\"space-y-6\">\n   855→                {/* Exception Type */}\n   856→                <div>\n   857→                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n   858→                    Tipo\n   859→                  </label>\n   860→                  <div className=\"grid grid-cols-2 gap-3\">\n   861→                    <button\n   862→                      type=\"button\"\n   863→                      onClick={() =>\n   864→                        setEditingException({\n   865→                          ...editingException,\n   866→                          isAvailable: false,\n   867→                        })\n   868→                      }\n   869→                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n   870→                        !editingException.isAvailable\n   871→                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n   872→                          : \"border-border text-muted-foreground hover:border-foreground\"\n   873→                      }`}\n   874→                    >\n   875→                      Bloqueio\n   876→                    </button>\n   877→                    <button\n   878→                      type=\"button\"\n   879→                      onClick={() =>\n   880→                        setEditingException({\n   881→                          ...editingException,\n   882→                          isAvailable: true,\n   883→                        })\n   884→                      }\n   885→                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n   886→                        editingException.isAvailable\n   887→                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n   888→                          : \"border-border text-muted-foreground hover:border-foreground\"\n   889→                      }`}\n   890→                    >\n   891→                      Disponibilidade Extra\n   892→                    </button>\n   893→                  </div>\n   894→                  <p className=\"text-xs text-muted-foreground mt-2\">\n   895→                    {editingException.isAvailable\n   896→                      ? \"Adiciona disponibilidade fora do horário normal\"\n   897→                      : \"Bloqueia a agenda para este período\"}\n   898→                  </p>\n   899→                </div>\n   900→\n   901→                {/* Date */}\n   902→                <div>\n   903→                  <label\n   904→                    htmlFor=\"exceptionDate\"\n   905→                    className=\"block text-sm font-medium text-foreground mb-2\"\n   906→                  >\n   907→                    Data\n   908→                  </label>\n   909→                  <input\n   910→                    id=\"exceptionDate\"\n   911→                    type=\"date\"\n   912→                    value={editingException.date}\n   913→                    onChange={(e) =>\n   914→                      setEditingException({\n   915→                        ...editingException,\n   916→                        date: e.target.value,\n   917→                      })\n   918→                    }\n   919→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   920→                  />\n   921→                </div>\n   922→\n   923→                {/* Full Day Toggle */}\n   924→                <div className=\"flex items-center gap-3\">\n   925→                  <button\n   926→                    type=\"button\"\n   927→                    onClick={() =>\n   928→                      setEditingException({\n   929→                        ...editingException,\n   930→                        isFullDay: !editingException.isFullDay,\n   931→                        startTime: !editingException.isFullDay ? null : \"08:00\",\n   932→                        endTime: !editingException.isFullDay ? null : \"18:00\",\n   933→                      })\n   934→                    }\n   935→                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n   936→                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n   937→                    }`}\n   938→                  >\n   939→                    <span\n   940→                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n   941→                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n   942→                      }`}\n   943→                    />\n   944→                  </button>\n   945→                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n   946→                </div>\n   947→\n   948→                {/* Time Range (only if not full day) */}\n   949→                {!editingException.isFullDay && (\n   950→                  <div className=\"grid grid-cols-2 gap-4\">\n   951→                    <div>\n   952→                      <label\n   953→                        htmlFor=\"exceptionStartTime\"\n   954→                        className=\"block text-sm font-medium text-foreground mb-2\"\n   955→                      >\n   956→                        Início\n   957→                      </label>\n   958→                      <input\n   959→                        id=\"exceptionStartTime\"\n   960→                        type=\"time\"\n   961→                        value={editingException.startTime || \"\"}\n   962→                        onChange={(e) =>\n   963→                          setEditingException({\n   964→                            ...editingException,\n   965→                            startTime: e.target.value,\n   966→                          })\n   967→                        }\n   968→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   969→                      />\n   970→                    </div>\n   971→                    <div>\n   972→                      <label\n   973→                        htmlFor=\"exceptionEndTime\"\n   974→                        className=\"block text-sm font-medium text-foreground mb-2\"\n   975→                      >\n   976→                        Término\n   977→                      </label>\n   978→                      <input\n   979→                        id=\"exceptionEndTime\"\n   980→                        type=\"time\"\n   981→                        value={editingException.endTime || \"\"}\n   982→                        onChange={(e) =>\n   983→                          setEditingException({\n   984→                            ...editingException,\n   985→                            endTime: e.target.value,\n   986→                          })\n   987→                        }\n   988→                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n   989→                      />\n   990→                    </div>\n   991→                  </div>\n   992→                )}\n   993→\n   994→                {/* Reason */}\n   995→                <div>\n   996→                  <label\n   997→                    htmlFor=\"exceptionReason\"\n   998→                    className=\"block text-sm font-medium text-foreground mb-2\"\n   999→                  >\n  1000→                    Motivo (opcional)\n  1001→                  </label>\n  1002→                  <input\n  1003→                    id=\"exceptionReason\"\n  1004→                    type=\"text\"\n  1005→                    value={editingException.reason || \"\"}\n  1006→                    onChange={(e) =>\n  1007→                      setEditingException({\n  1008→                        ...editingException,\n  1009→                        reason: e.target.value,\n  1010→                      })\n  1011→                    }\n  1012→                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n  1013→                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n  1014→                  />\n  1015→                </div>\n  1016→\n  1017→                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n  1018→                  <button\n  1019→                    type=\"button\"\n  1020→                    onClick={saveException}\n  1021→                    disabled={isSaving}\n  1022→                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n  1023→                  >\n  1024→                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n  1025→                  </button>\n  1026→                  <button\n  1027→                    type=\"button\"\n  1028→                    onClick={closeExceptionEditor}\n  1029→                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n  1030→                  >\n  1031→                    Cancelar\n  1032→                  </button>\n  1033→                </div>\n  1034→              </div>\n  1035→            </div>\n  1036→          </div>\n  1037→        </>\n  1038→      )}\n  1039→\n  1040→      <style jsx>{`\n  1041→        @keyframes slide-up {\n  1042→          from {\n  1043→            transform: translateY(100%);\n  1044→          }\n  1045→          to {\n  1046→            transform: translateY(0);\n  1047→          }\n  1048→        }\n  1049→        .animate-slide-up {\n  1050→          animation: slide-up 0.3s ease-out;\n  1051→        }\n  1052→      `}</style>\n  1053→    </main>\n  1054→  )\n  1055→}\n  1056→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9a6c1fb3-13b1-430b-a19c-1245873071ef","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","content":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"animate-pulse space-y-6\">\n          <div className=\"h-8 w-48 bg-muted rounded\" />\n          <div className=\"space-y-4\">\n            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n              <div key={i} className=\"h-20 bg-muted rounded\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","numLines":1056,"startLine":1,"totalLines":1056}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FPu2rrcETKXGzAWKKS4wBt","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a clear understanding of the codebase. Let me start creating the reusable components. I'll create a shared components directory and build the mobile UX components."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":24956,"cache_read_input_tokens":66666,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":24956},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"65369a8a-3954-48bd-901b-346fcbdab893"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FPu2rrcETKXGzAWKKS4wBt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PqYovt46NXB9yRju9inonK","name":"Bash","input":{"command":"mkdir -p /mnt/d/personal/clinica/src/src/shared/components/ui","description":"Create UI components directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":24956,"cache_read_input_tokens":66666,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":24956},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"bfc56510-c2f3-4707-b4c0-3b853c727648"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PqYovt46NXB9yRju9inonK","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"fe4cb482-8b34-48e5-85da-abff7f12802e","tool_use_result":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J839hMKGL8fPCPTu98nR3m","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DirEAgiuGKeiHGZNdjStwz","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"in_progress","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":158,"cache_read_input_tokens":91622,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":158},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"57c0b3ac-4bbb-40ab-acd7-9a613bc97c55"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DirEAgiuGKeiHGZNdjStwz","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"270c5422-7793-4e31-a225-3252842ccdb3","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"in_progress","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"pending","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"in_progress","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_019a4SLdEKLRNgpFdH4uSG2F","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create all the reusable UI components. I'll start with the BottomNavigation component."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":91780,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"93e17975-c54d-425e-bb6f-90ae73adeed3"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_019a4SLdEKLRNgpFdH4uSG2F","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WNSg4RgEL59HV88vyuB6GT","name":"Write","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/ui/bottom-navigation.tsx","content":"\"use client\"\n\nimport { usePathname, useRouter } from \"next/navigation\"\n\ninterface NavItem {\n  href: string\n  label: string\n  icon: React.ReactNode\n  matchPaths?: string[]\n}\n\nconst navItems: NavItem[] = [\n  {\n    href: \"/agenda\",\n    label: \"Agenda\",\n    icon: (\n      <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n      </svg>\n    ),\n    matchPaths: [\"/agenda\"],\n  },\n  {\n    href: \"/patients\",\n    label: \"Pacientes\",\n    icon: (\n      <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n      </svg>\n    ),\n    matchPaths: [\"/patients\"],\n  },\n  {\n    href: \"/settings/availability\",\n    label: \"Config\",\n    icon: (\n      <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n      </svg>\n    ),\n    matchPaths: [\"/settings\", \"/admin\"],\n  },\n]\n\nexport function BottomNavigation() {\n  const router = useRouter()\n  const pathname = usePathname()\n\n  const isActive = (item: NavItem) => {\n    if (item.matchPaths) {\n      return item.matchPaths.some((path) => pathname.startsWith(path))\n    }\n    return pathname === item.href\n  }\n\n  return (\n    <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40 safe-area-pb\">\n      <div className=\"max-w-4xl mx-auto px-4\">\n        <div className=\"flex items-center justify-around h-16\">\n          {navItems.map((item) => {\n            const active = isActive(item)\n            return (\n              <button\n                key={item.href}\n                onClick={() => router.push(item.href)}\n                className={`flex flex-col items-center justify-center gap-1 min-w-[64px] min-h-[44px] py-2 px-3 rounded-lg transition-colors touch-manipulation ${\n                  active\n                    ? \"text-primary\"\n                    : \"text-muted-foreground hover:text-foreground active:bg-muted\"\n                }`}\n                aria-current={active ? \"page\" : undefined}\n              >\n                {item.icon}\n                <span className={`text-xs ${active ? \"font-medium\" : \"\"}`}>\n                  {item.label}\n                </span>\n              </button>\n            )\n          })}\n        </div>\n      </div>\n    </nav>\n  )\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":91780,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"0e0e7ca6-c53c-4320-8668-cc01b9c31140"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WNSg4RgEL59HV88vyuB6GT","type":"tool_result","content":"File created successfully at: /mnt/d/personal/clinica/src/src/shared/components/ui/bottom-navigation.tsx"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7ccd9f02-c1f0-4efa-ba1e-56c65deec322","tool_use_result":{"type":"create","filePath":"/mnt/d/personal/clinica/src/src/shared/components/ui/bottom-navigation.tsx","content":"\"use client\"\n\nimport { usePathname, useRouter } from \"next/navigation\"\n\ninterface NavItem {\n  href: string\n  label: string\n  icon: React.ReactNode\n  matchPaths?: string[]\n}\n\nconst navItems: NavItem[] = [\n  {\n    href: \"/agenda\",\n    label: \"Agenda\",\n    icon: (\n      <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n      </svg>\n    ),\n    matchPaths: [\"/agenda\"],\n  },\n  {\n    href: \"/patients\",\n    label: \"Pacientes\",\n    icon: (\n      <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n      </svg>\n    ),\n    matchPaths: [\"/patients\"],\n  },\n  {\n    href: \"/settings/availability\",\n    label: \"Config\",\n    icon: (\n      <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n      </svg>\n    ),\n    matchPaths: [\"/settings\", \"/admin\"],\n  },\n]\n\nexport function BottomNavigation() {\n  const router = useRouter()\n  const pathname = usePathname()\n\n  const isActive = (item: NavItem) => {\n    if (item.matchPaths) {\n      return item.matchPaths.some((path) => pathname.startsWith(path))\n    }\n    return pathname === item.href\n  }\n\n  return (\n    <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40 safe-area-pb\">\n      <div className=\"max-w-4xl mx-auto px-4\">\n        <div className=\"flex items-center justify-around h-16\">\n          {navItems.map((item) => {\n            const active = isActive(item)\n            return (\n              <button\n                key={item.href}\n                onClick={() => router.push(item.href)}\n                className={`flex flex-col items-center justify-center gap-1 min-w-[64px] min-h-[44px] py-2 px-3 rounded-lg transition-colors touch-manipulation ${\n                  active\n                    ? \"text-primary\"\n                    : \"text-muted-foreground hover:text-foreground active:bg-muted\"\n                }`}\n                aria-current={active ? \"page\" : undefined}\n              >\n                {item.icon}\n                <span className={`text-xs ${active ? \"font-medium\" : \"\"}`}>\n                  {item.label}\n                </span>\n              </button>\n            )\n          })}\n        </div>\n      </div>\n    </nav>\n  )\n}\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_011yh565Y9DBiV49mW5TjG6s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PuCroCxbwYWNp2cWcEp8RA","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"in_progress","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1497,"cache_read_input_tokens":92194,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1497},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"5ed30fe5-a4d2-4048-8fd2-53a0dcb41a9a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PuCroCxbwYWNp2cWcEp8RA","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"3abce641-6191-4e49-9c3d-28438c22498d","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"in_progress","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"pending","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"in_progress","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014UXzVSjHeL7ta1DPPTecA3","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create the FAB component."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":93691,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":8,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"81b27369-d045-43e8-b2d7-8f10799f668e"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014UXzVSjHeL7ta1DPPTecA3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FgqazPSQ8pYC67BCj85mfw","name":"Write","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/ui/fab.tsx","content":"\"use client\"\n\nimport { forwardRef } from \"react\"\n\ninterface FABProps {\n  onClick: () => void\n  icon?: React.ReactNode\n  label: string\n  className?: string\n}\n\nexport const FAB = forwardRef<HTMLButtonElement, FABProps>(\n  ({ onClick, icon, label, className = \"\" }, ref) => {\n    return (\n      <button\n        ref={ref}\n        onClick={onClick}\n        className={`fixed right-4 bottom-24 w-14 h-14 min-w-[56px] min-h-[56px] rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 active:scale-95 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center touch-manipulation ${className}`}\n        aria-label={label}\n      >\n        {icon || (\n          <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n          </svg>\n        )}\n      </button>\n    )\n  }\n)\n\nFAB.displayName = \"FAB\"\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":93691,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":8,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"195c4afb-d247-415b-87ec-c23058df1d6e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FgqazPSQ8pYC67BCj85mfw","type":"tool_result","content":"File created successfully at: /mnt/d/personal/clinica/src/src/shared/components/ui/fab.tsx"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"622931f0-b931-4908-a163-cf09bf701930","tool_use_result":{"type":"create","filePath":"/mnt/d/personal/clinica/src/src/shared/components/ui/fab.tsx","content":"\"use client\"\n\nimport { forwardRef } from \"react\"\n\ninterface FABProps {\n  onClick: () => void\n  icon?: React.ReactNode\n  label: string\n  className?: string\n}\n\nexport const FAB = forwardRef<HTMLButtonElement, FABProps>(\n  ({ onClick, icon, label, className = \"\" }, ref) => {\n    return (\n      <button\n        ref={ref}\n        onClick={onClick}\n        className={`fixed right-4 bottom-24 w-14 h-14 min-w-[56px] min-h-[56px] rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 active:scale-95 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center touch-manipulation ${className}`}\n        aria-label={label}\n      >\n        {icon || (\n          <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n          </svg>\n        )}\n      </button>\n    )\n  }\n)\n\nFAB.displayName = \"FAB\"\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ETcTVLZEgmxVzWcQim63HJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016jadYqDNRqH8e3ZdPWWAzT","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"in_progress","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":486,"cache_read_input_tokens":94105,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":486},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e96f2581-d39f-453e-9af3-b34c0de16223"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016jadYqDNRqH8e3ZdPWWAzT","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"453638ff-1829-4f37-b840-bf4b2ca088b7","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"in_progress","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"pending","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"in_progress","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JL8Huyg2s9NRM9YTopzipe","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create the BottomSheet component."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":94591,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":8,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"0a3151a2-30a6-4224-9d3f-8a71bb233cbf"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JL8Huyg2s9NRM9YTopzipe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017gPBWtDUFtYfdP7P7oirET","name":"Write","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/ui/bottom-sheet.tsx","content":"\"use client\"\n\nimport { useEffect, useRef, useCallback } from \"react\"\n\ninterface BottomSheetProps {\n  isOpen: boolean\n  onClose: () => void\n  title?: string\n  children: React.ReactNode\n  showHandle?: boolean\n}\n\nexport function BottomSheet({\n  isOpen,\n  onClose,\n  title,\n  children,\n  showHandle = true,\n}: BottomSheetProps) {\n  const sheetRef = useRef<HTMLDivElement>(null)\n  const touchStartY = useRef<number | null>(null)\n  const touchCurrentY = useRef<number | null>(null)\n\n  // Handle escape key\n  useEffect(() => {\n    const handleEscape = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\" && isOpen) {\n        onClose()\n      }\n    }\n\n    document.addEventListener(\"keydown\", handleEscape)\n    return () => document.removeEventListener(\"keydown\", handleEscape)\n  }, [isOpen, onClose])\n\n  // Prevent body scroll when sheet is open\n  useEffect(() => {\n    if (isOpen) {\n      document.body.style.overflow = \"hidden\"\n    } else {\n      document.body.style.overflow = \"\"\n    }\n\n    return () => {\n      document.body.style.overflow = \"\"\n    }\n  }, [isOpen])\n\n  // Handle swipe down to close\n  const handleTouchStart = useCallback((e: React.TouchEvent) => {\n    touchStartY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchMove = useCallback((e: React.TouchEvent) => {\n    touchCurrentY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchEnd = useCallback(() => {\n    if (touchStartY.current === null || touchCurrentY.current === null) return\n\n    const diff = touchCurrentY.current - touchStartY.current\n    const threshold = 100\n\n    if (diff > threshold) {\n      onClose()\n    }\n\n    touchStartY.current = null\n    touchCurrentY.current = null\n  }, [onClose])\n\n  if (!isOpen) return null\n\n  return (\n    <>\n      {/* Backdrop */}\n      <div\n        className=\"fixed inset-0 bg-black/50 z-40 animate-fade-in\"\n        onClick={onClose}\n        aria-hidden=\"true\"\n      />\n\n      {/* Sheet */}\n      <div\n        ref={sheetRef}\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-labelledby={title ? \"sheet-title\" : undefined}\n        className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-hidden animate-slide-up\"\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n      >\n        {/* Handle */}\n        {showHandle && (\n          <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border z-10\">\n            <div\n              className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-3 cursor-grab active:cursor-grabbing\"\n              aria-hidden=\"true\"\n            />\n            {title && (\n              <h2\n                id=\"sheet-title\"\n                className=\"text-xl font-semibold text-foreground\"\n              >\n                {title}\n              </h2>\n            )}\n          </div>\n        )}\n\n        {/* Content */}\n        <div className=\"overflow-y-auto max-h-[calc(90vh-60px)] overscroll-contain\">\n          {children}\n        </div>\n      </div>\n\n      {/* Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        @keyframes fade-in {\n          from {\n            opacity: 0;\n          }\n          to {\n            opacity: 1;\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        .animate-fade-in {\n          animation: fade-in 0.2s ease-out;\n        }\n      `}</style>\n    </>\n  )\n}\n\ninterface BottomSheetActionProps {\n  icon?: React.ReactNode\n  label: string\n  description?: string\n  onClick: () => void\n  variant?: \"default\" | \"destructive\"\n}\n\nexport function BottomSheetAction({\n  icon,\n  label,\n  description,\n  onClick,\n  variant = \"default\",\n}: BottomSheetActionProps) {\n  return (\n    <button\n      type=\"button\"\n      onClick={onClick}\n      className={`w-full flex items-center gap-4 px-4 py-4 min-h-[56px] text-left transition-colors touch-manipulation ${\n        variant === \"destructive\"\n          ? \"text-destructive hover:bg-destructive/10 active:bg-destructive/20\"\n          : \"text-foreground hover:bg-muted active:bg-muted/80\"\n      }`}\n    >\n      {icon && (\n        <div className={`flex-shrink-0 ${variant === \"destructive\" ? \"text-destructive\" : \"text-muted-foreground\"}`}>\n          {icon}\n        </div>\n      )}\n      <div className=\"flex-1 min-w-0\">\n        <p className=\"font-medium\">{label}</p>\n        {description && (\n          <p className=\"text-sm text-muted-foreground truncate\">{description}</p>\n        )}\n      </div>\n    </button>\n  )\n}\n\nexport function BottomSheetDivider() {\n  return <div className=\"h-px bg-border mx-4\" />\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":94591,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":8,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"0c965dd2-504a-4a10-beb5-62bda4dfafd4"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017gPBWtDUFtYfdP7P7oirET","type":"tool_result","content":"File created successfully at: /mnt/d/personal/clinica/src/src/shared/components/ui/bottom-sheet.tsx"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"12832fa7-e51f-4679-9d42-22fa0a3f264a","tool_use_result":{"type":"create","filePath":"/mnt/d/personal/clinica/src/src/shared/components/ui/bottom-sheet.tsx","content":"\"use client\"\n\nimport { useEffect, useRef, useCallback } from \"react\"\n\ninterface BottomSheetProps {\n  isOpen: boolean\n  onClose: () => void\n  title?: string\n  children: React.ReactNode\n  showHandle?: boolean\n}\n\nexport function BottomSheet({\n  isOpen,\n  onClose,\n  title,\n  children,\n  showHandle = true,\n}: BottomSheetProps) {\n  const sheetRef = useRef<HTMLDivElement>(null)\n  const touchStartY = useRef<number | null>(null)\n  const touchCurrentY = useRef<number | null>(null)\n\n  // Handle escape key\n  useEffect(() => {\n    const handleEscape = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\" && isOpen) {\n        onClose()\n      }\n    }\n\n    document.addEventListener(\"keydown\", handleEscape)\n    return () => document.removeEventListener(\"keydown\", handleEscape)\n  }, [isOpen, onClose])\n\n  // Prevent body scroll when sheet is open\n  useEffect(() => {\n    if (isOpen) {\n      document.body.style.overflow = \"hidden\"\n    } else {\n      document.body.style.overflow = \"\"\n    }\n\n    return () => {\n      document.body.style.overflow = \"\"\n    }\n  }, [isOpen])\n\n  // Handle swipe down to close\n  const handleTouchStart = useCallback((e: React.TouchEvent) => {\n    touchStartY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchMove = useCallback((e: React.TouchEvent) => {\n    touchCurrentY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchEnd = useCallback(() => {\n    if (touchStartY.current === null || touchCurrentY.current === null) return\n\n    const diff = touchCurrentY.current - touchStartY.current\n    const threshold = 100\n\n    if (diff > threshold) {\n      onClose()\n    }\n\n    touchStartY.current = null\n    touchCurrentY.current = null\n  }, [onClose])\n\n  if (!isOpen) return null\n\n  return (\n    <>\n      {/* Backdrop */}\n      <div\n        className=\"fixed inset-0 bg-black/50 z-40 animate-fade-in\"\n        onClick={onClose}\n        aria-hidden=\"true\"\n      />\n\n      {/* Sheet */}\n      <div\n        ref={sheetRef}\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-labelledby={title ? \"sheet-title\" : undefined}\n        className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-hidden animate-slide-up\"\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n      >\n        {/* Handle */}\n        {showHandle && (\n          <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border z-10\">\n            <div\n              className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-3 cursor-grab active:cursor-grabbing\"\n              aria-hidden=\"true\"\n            />\n            {title && (\n              <h2\n                id=\"sheet-title\"\n                className=\"text-xl font-semibold text-foreground\"\n              >\n                {title}\n              </h2>\n            )}\n          </div>\n        )}\n\n        {/* Content */}\n        <div className=\"overflow-y-auto max-h-[calc(90vh-60px)] overscroll-contain\">\n          {children}\n        </div>\n      </div>\n\n      {/* Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        @keyframes fade-in {\n          from {\n            opacity: 0;\n          }\n          to {\n            opacity: 1;\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        .animate-fade-in {\n          animation: fade-in 0.2s ease-out;\n        }\n      `}</style>\n    </>\n  )\n}\n\ninterface BottomSheetActionProps {\n  icon?: React.ReactNode\n  label: string\n  description?: string\n  onClick: () => void\n  variant?: \"default\" | \"destructive\"\n}\n\nexport function BottomSheetAction({\n  icon,\n  label,\n  description,\n  onClick,\n  variant = \"default\",\n}: BottomSheetActionProps) {\n  return (\n    <button\n      type=\"button\"\n      onClick={onClick}\n      className={`w-full flex items-center gap-4 px-4 py-4 min-h-[56px] text-left transition-colors touch-manipulation ${\n        variant === \"destructive\"\n          ? \"text-destructive hover:bg-destructive/10 active:bg-destructive/20\"\n          : \"text-foreground hover:bg-muted active:bg-muted/80\"\n      }`}\n    >\n      {icon && (\n        <div className={`flex-shrink-0 ${variant === \"destructive\" ? \"text-destructive\" : \"text-muted-foreground\"}`}>\n          {icon}\n        </div>\n      )}\n      <div className=\"flex-1 min-w-0\">\n        <p className=\"font-medium\">{label}</p>\n        {description && (\n          <p className=\"text-sm text-muted-foreground truncate\">{description}</p>\n        )}\n      </div>\n    </button>\n  )\n}\n\nexport function BottomSheetDivider() {\n  return <div className=\"h-px bg-border mx-4\" />\n}\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01En7DBE4j7KncH5xwnroV9p","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B5gt2bpoNdq3E7tUDVmXFz","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"in_progress","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1666,"cache_read_input_tokens":95005,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1666},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"73ad948a-cd7d-4ac9-9441-d3fc93d4dfb6"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B5gt2bpoNdq3E7tUDVmXFz","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"ad46ee51-51ec-4ed8-a1b3-a209dcc9ff27","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"in_progress","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"pending","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"in_progress","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J1LrYB9afrQVjQbuWir8v8","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create the Skeleton components."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":96671,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4fefe29a-8ece-4f64-bc86-46c908867c03"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J1LrYB9afrQVjQbuWir8v8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LCphU3VgNd9KS9jCxU14cx","name":"Write","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/ui/skeleton.tsx","content":"\"use client\"\n\ninterface SkeletonProps {\n  className?: string\n}\n\nexport function Skeleton({ className = \"\" }: SkeletonProps) {\n  return (\n    <div\n      className={`animate-pulse bg-muted rounded ${className}`}\n      aria-hidden=\"true\"\n    />\n  )\n}\n\nexport function SkeletonText({\n  lines = 1,\n  className = \"\",\n}: {\n  lines?: number\n  className?: string\n}) {\n  return (\n    <div className={`space-y-2 ${className}`} aria-hidden=\"true\">\n      {Array.from({ length: lines }).map((_, i) => (\n        <Skeleton\n          key={i}\n          className={`h-4 ${i === lines - 1 && lines > 1 ? \"w-3/4\" : \"w-full\"}`}\n        />\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonCard({ className = \"\" }: SkeletonProps) {\n  return (\n    <div\n      className={`bg-card border border-border rounded-lg p-4 ${className}`}\n      aria-hidden=\"true\"\n    >\n      <div className=\"animate-pulse space-y-3\">\n        <Skeleton className=\"h-5 w-3/4\" />\n        <Skeleton className=\"h-4 w-1/2\" />\n        <Skeleton className=\"h-4 w-2/3\" />\n      </div>\n    </div>\n  )\n}\n\nexport function SkeletonTimeSlot({ className = \"\" }: SkeletonProps) {\n  return (\n    <div\n      className={`flex items-stretch gap-3 min-h-[4rem] ${className}`}\n      aria-hidden=\"true\"\n    >\n      <div className=\"w-14 flex-shrink-0\">\n        <Skeleton className=\"h-5 w-12\" />\n      </div>\n      <div className=\"flex-1\">\n        <Skeleton className=\"h-16 w-full rounded-lg\" />\n      </div>\n    </div>\n  )\n}\n\nexport function SkeletonAgenda() {\n  return (\n    <div className=\"space-y-2\" aria-busy=\"true\" aria-label=\"Carregando agenda\">\n      {Array.from({ length: 6 }).map((_, i) => (\n        <SkeletonTimeSlot key={i} />\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonList({ items = 3 }: { items?: number }) {\n  return (\n    <div className=\"space-y-4\" aria-busy=\"true\" aria-label=\"Carregando lista\">\n      {Array.from({ length: items }).map((_, i) => (\n        <SkeletonCard key={i} />\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonPage() {\n  return (\n    <div className=\"space-y-6\" aria-busy=\"true\" aria-label=\"Carregando pagina\">\n      <Skeleton className=\"h-8 w-48\" />\n      <div className=\"flex gap-4\">\n        <Skeleton className=\"h-12 flex-1\" />\n        <Skeleton className=\"h-12 w-32\" />\n      </div>\n      <SkeletonList items={3} />\n    </div>\n  )\n}\n\nexport function SkeletonForm() {\n  return (\n    <div className=\"space-y-6\" aria-busy=\"true\" aria-label=\"Carregando formulario\">\n      {Array.from({ length: 4 }).map((_, i) => (\n        <div key={i} className=\"space-y-2\">\n          <Skeleton className=\"h-4 w-24\" />\n          <Skeleton className=\"h-12 w-full\" />\n        </div>\n      ))}\n      <div className=\"flex gap-3 pt-4\">\n        <Skeleton className=\"h-12 flex-1\" />\n        <Skeleton className=\"h-12 w-32\" />\n      </div>\n    </div>\n  )\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":96671,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4f5de91a-cd8b-42e6-8883-e5b7e407c3f9"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LCphU3VgNd9KS9jCxU14cx","type":"tool_result","content":"File created successfully at: /mnt/d/personal/clinica/src/src/shared/components/ui/skeleton.tsx"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"faa5068f-9700-41b6-8728-3d6bd6386839","tool_use_result":{"type":"create","filePath":"/mnt/d/personal/clinica/src/src/shared/components/ui/skeleton.tsx","content":"\"use client\"\n\ninterface SkeletonProps {\n  className?: string\n}\n\nexport function Skeleton({ className = \"\" }: SkeletonProps) {\n  return (\n    <div\n      className={`animate-pulse bg-muted rounded ${className}`}\n      aria-hidden=\"true\"\n    />\n  )\n}\n\nexport function SkeletonText({\n  lines = 1,\n  className = \"\",\n}: {\n  lines?: number\n  className?: string\n}) {\n  return (\n    <div className={`space-y-2 ${className}`} aria-hidden=\"true\">\n      {Array.from({ length: lines }).map((_, i) => (\n        <Skeleton\n          key={i}\n          className={`h-4 ${i === lines - 1 && lines > 1 ? \"w-3/4\" : \"w-full\"}`}\n        />\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonCard({ className = \"\" }: SkeletonProps) {\n  return (\n    <div\n      className={`bg-card border border-border rounded-lg p-4 ${className}`}\n      aria-hidden=\"true\"\n    >\n      <div className=\"animate-pulse space-y-3\">\n        <Skeleton className=\"h-5 w-3/4\" />\n        <Skeleton className=\"h-4 w-1/2\" />\n        <Skeleton className=\"h-4 w-2/3\" />\n      </div>\n    </div>\n  )\n}\n\nexport function SkeletonTimeSlot({ className = \"\" }: SkeletonProps) {\n  return (\n    <div\n      className={`flex items-stretch gap-3 min-h-[4rem] ${className}`}\n      aria-hidden=\"true\"\n    >\n      <div className=\"w-14 flex-shrink-0\">\n        <Skeleton className=\"h-5 w-12\" />\n      </div>\n      <div className=\"flex-1\">\n        <Skeleton className=\"h-16 w-full rounded-lg\" />\n      </div>\n    </div>\n  )\n}\n\nexport function SkeletonAgenda() {\n  return (\n    <div className=\"space-y-2\" aria-busy=\"true\" aria-label=\"Carregando agenda\">\n      {Array.from({ length: 6 }).map((_, i) => (\n        <SkeletonTimeSlot key={i} />\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonList({ items = 3 }: { items?: number }) {\n  return (\n    <div className=\"space-y-4\" aria-busy=\"true\" aria-label=\"Carregando lista\">\n      {Array.from({ length: items }).map((_, i) => (\n        <SkeletonCard key={i} />\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonPage() {\n  return (\n    <div className=\"space-y-6\" aria-busy=\"true\" aria-label=\"Carregando pagina\">\n      <Skeleton className=\"h-8 w-48\" />\n      <div className=\"flex gap-4\">\n        <Skeleton className=\"h-12 flex-1\" />\n        <Skeleton className=\"h-12 w-32\" />\n      </div>\n      <SkeletonList items={3} />\n    </div>\n  )\n}\n\nexport function SkeletonForm() {\n  return (\n    <div className=\"space-y-6\" aria-busy=\"true\" aria-label=\"Carregando formulario\">\n      {Array.from({ length: 4 }).map((_, i) => (\n        <div key={i} className=\"space-y-2\">\n          <Skeleton className=\"h-4 w-24\" />\n          <Skeleton className=\"h-12 w-full\" />\n        </div>\n      ))}\n      <div className=\"flex gap-3 pt-4\">\n        <Skeleton className=\"h-12 flex-1\" />\n        <Skeleton className=\"h-12 w-32\" />\n      </div>\n    </div>\n  )\n}\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_019CP8MKcJnaoP8pq81uW4wm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LB7gP8BQ3di2og2ZYey4DU","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"in_progress","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1170,"cache_read_input_tokens":97085,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1170},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b825869d-881a-42a5-bf11-e06034bb1254"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LB7gP8BQ3di2og2ZYey4DU","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2d0fdd55-d39b-4864-985a-549f33124954","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"in_progress","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"pending","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"in_progress","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UGc8p1tTes8g8kccg9Mebn","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create the ErrorState component."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":98255,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":8,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2984cb47-118b-4834-a5c2-830048ffa8ed"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UGc8p1tTes8g8kccg9Mebn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016yNVooxR58Zkrs1XWFCimu","name":"Write","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/ui/error-state.tsx","content":"\"use client\"\n\ninterface ErrorStateProps {\n  title?: string\n  message?: string\n  onRetry?: () => void\n  retryLabel?: string\n  icon?: React.ReactNode\n  className?: string\n}\n\nexport function ErrorState({\n  title = \"Algo deu errado\",\n  message = \"Nao foi possivel carregar os dados. Tente novamente.\",\n  onRetry,\n  retryLabel = \"Tentar novamente\",\n  icon,\n  className = \"\",\n}: ErrorStateProps) {\n  return (\n    <div\n      className={`flex flex-col items-center justify-center py-12 px-4 text-center ${className}`}\n      role=\"alert\"\n    >\n      <div className=\"w-16 h-16 mb-4 rounded-full bg-destructive/10 flex items-center justify-center\">\n        {icon || (\n          <svg\n            className=\"w-8 h-8 text-destructive\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            viewBox=\"0 0 24 24\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"\n            />\n          </svg>\n        )}\n      </div>\n\n      <h3 className=\"text-lg font-medium text-foreground mb-2\">{title}</h3>\n      <p className=\"text-sm text-muted-foreground mb-6 max-w-sm\">{message}</p>\n\n      {onRetry && (\n        <button\n          onClick={onRetry}\n          className=\"h-12 px-6 min-w-[120px] rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 active:scale-98 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all touch-manipulation\"\n        >\n          {retryLabel}\n        </button>\n      )}\n    </div>\n  )\n}\n\ninterface EmptyStateProps {\n  title: string\n  message?: string\n  icon?: React.ReactNode\n  action?: {\n    label: string\n    onClick: () => void\n  }\n  className?: string\n}\n\nexport function EmptyState({\n  title,\n  message,\n  icon,\n  action,\n  className = \"\",\n}: EmptyStateProps) {\n  return (\n    <div\n      className={`flex flex-col items-center justify-center py-12 px-4 text-center ${className}`}\n    >\n      <div className=\"w-16 h-16 mb-4 rounded-full bg-muted flex items-center justify-center\">\n        {icon || (\n          <svg\n            className=\"w-8 h-8 text-muted-foreground\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            viewBox=\"0 0 24 24\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4\"\n            />\n          </svg>\n        )}\n      </div>\n\n      <h3 className=\"text-lg font-medium text-foreground mb-2\">{title}</h3>\n      {message && (\n        <p className=\"text-sm text-muted-foreground mb-6 max-w-sm\">{message}</p>\n      )}\n\n      {action && (\n        <button\n          onClick={action.onClick}\n          className=\"h-12 px-6 min-w-[120px] rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted active:scale-98 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all touch-manipulation\"\n        >\n          {action.label}\n        </button>\n      )}\n    </div>\n  )\n}\n\ninterface OfflineStateProps {\n  onRetry?: () => void\n  className?: string\n}\n\nexport function OfflineState({ onRetry, className = \"\" }: OfflineStateProps) {\n  return (\n    <ErrorState\n      title=\"Sem conexao\"\n      message=\"Verifique sua conexao com a internet e tente novamente.\"\n      onRetry={onRetry}\n      icon={\n        <svg\n          className=\"w-8 h-8 text-muted-foreground\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          viewBox=\"0 0 24 24\"\n        >\n          <path\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            strokeWidth={2}\n            d=\"M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414\"\n          />\n        </svg>\n      }\n      className={className}\n    />\n  )\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":98255,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":8,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"1cfa046e-a693-4c05-b1d7-7960ed899360"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016yNVooxR58Zkrs1XWFCimu","type":"tool_result","content":"File created successfully at: /mnt/d/personal/clinica/src/src/shared/components/ui/error-state.tsx"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"6175d63b-651c-4e98-8ef8-a396afa91427","tool_use_result":{"type":"create","filePath":"/mnt/d/personal/clinica/src/src/shared/components/ui/error-state.tsx","content":"\"use client\"\n\ninterface ErrorStateProps {\n  title?: string\n  message?: string\n  onRetry?: () => void\n  retryLabel?: string\n  icon?: React.ReactNode\n  className?: string\n}\n\nexport function ErrorState({\n  title = \"Algo deu errado\",\n  message = \"Nao foi possivel carregar os dados. Tente novamente.\",\n  onRetry,\n  retryLabel = \"Tentar novamente\",\n  icon,\n  className = \"\",\n}: ErrorStateProps) {\n  return (\n    <div\n      className={`flex flex-col items-center justify-center py-12 px-4 text-center ${className}`}\n      role=\"alert\"\n    >\n      <div className=\"w-16 h-16 mb-4 rounded-full bg-destructive/10 flex items-center justify-center\">\n        {icon || (\n          <svg\n            className=\"w-8 h-8 text-destructive\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            viewBox=\"0 0 24 24\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"\n            />\n          </svg>\n        )}\n      </div>\n\n      <h3 className=\"text-lg font-medium text-foreground mb-2\">{title}</h3>\n      <p className=\"text-sm text-muted-foreground mb-6 max-w-sm\">{message}</p>\n\n      {onRetry && (\n        <button\n          onClick={onRetry}\n          className=\"h-12 px-6 min-w-[120px] rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 active:scale-98 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all touch-manipulation\"\n        >\n          {retryLabel}\n        </button>\n      )}\n    </div>\n  )\n}\n\ninterface EmptyStateProps {\n  title: string\n  message?: string\n  icon?: React.ReactNode\n  action?: {\n    label: string\n    onClick: () => void\n  }\n  className?: string\n}\n\nexport function EmptyState({\n  title,\n  message,\n  icon,\n  action,\n  className = \"\",\n}: EmptyStateProps) {\n  return (\n    <div\n      className={`flex flex-col items-center justify-center py-12 px-4 text-center ${className}`}\n    >\n      <div className=\"w-16 h-16 mb-4 rounded-full bg-muted flex items-center justify-center\">\n        {icon || (\n          <svg\n            className=\"w-8 h-8 text-muted-foreground\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            viewBox=\"0 0 24 24\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4\"\n            />\n          </svg>\n        )}\n      </div>\n\n      <h3 className=\"text-lg font-medium text-foreground mb-2\">{title}</h3>\n      {message && (\n        <p className=\"text-sm text-muted-foreground mb-6 max-w-sm\">{message}</p>\n      )}\n\n      {action && (\n        <button\n          onClick={action.onClick}\n          className=\"h-12 px-6 min-w-[120px] rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted active:scale-98 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all touch-manipulation\"\n        >\n          {action.label}\n        </button>\n      )}\n    </div>\n  )\n}\n\ninterface OfflineStateProps {\n  onRetry?: () => void\n  className?: string\n}\n\nexport function OfflineState({ onRetry, className = \"\" }: OfflineStateProps) {\n  return (\n    <ErrorState\n      title=\"Sem conexao\"\n      message=\"Verifique sua conexao com a internet e tente novamente.\"\n      onRetry={onRetry}\n      icon={\n        <svg\n          className=\"w-8 h-8 text-muted-foreground\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          viewBox=\"0 0 24 24\"\n        >\n          <path\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            strokeWidth={2}\n            d=\"M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414\"\n          />\n        </svg>\n      }\n      className={className}\n    />\n  )\n}\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SqTeSWHuJwu1rN1EtjBiqY","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create a SwipeContainer component for better swipe gestures and an index file to export all components."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1768,"cache_read_input_tokens":98669,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1768},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7cd609b0-f557-4061-88b7-ea37e6b8e45b"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SqTeSWHuJwu1rN1EtjBiqY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01USebcU7dXhTQAB591m1Cp8","name":"Write","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/ui/swipe-container.tsx","content":"\"use client\"\n\nimport { useRef, useCallback } from \"react\"\n\ninterface SwipeContainerProps {\n  onSwipeLeft?: () => void\n  onSwipeRight?: () => void\n  threshold?: number\n  children: React.ReactNode\n  className?: string\n}\n\nexport function SwipeContainer({\n  onSwipeLeft,\n  onSwipeRight,\n  threshold = 50,\n  children,\n  className = \"\",\n}: SwipeContainerProps) {\n  const touchStartX = useRef<number | null>(null)\n  const touchStartY = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const touchEndY = useRef<number | null>(null)\n\n  const handleTouchStart = useCallback((e: React.TouchEvent) => {\n    touchStartX.current = e.touches[0].clientX\n    touchStartY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchMove = useCallback((e: React.TouchEvent) => {\n    touchEndX.current = e.touches[0].clientX\n    touchEndY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchEnd = useCallback(() => {\n    if (\n      touchStartX.current === null ||\n      touchStartY.current === null ||\n      touchEndX.current === null ||\n      touchEndY.current === null\n    ) {\n      return\n    }\n\n    const diffX = touchStartX.current - touchEndX.current\n    const diffY = touchStartY.current - touchEndY.current\n\n    // Only trigger horizontal swipe if horizontal movement is greater than vertical\n    // This prevents accidental swipes during scrolling\n    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {\n      if (diffX > 0 && onSwipeLeft) {\n        onSwipeLeft()\n      } else if (diffX < 0 && onSwipeRight) {\n        onSwipeRight()\n      }\n    }\n\n    // Reset values\n    touchStartX.current = null\n    touchStartY.current = null\n    touchEndX.current = null\n    touchEndY.current = null\n  }, [onSwipeLeft, onSwipeRight, threshold])\n\n  return (\n    <div\n      onTouchStart={handleTouchStart}\n      onTouchMove={handleTouchMove}\n      onTouchEnd={handleTouchEnd}\n      className={`touch-pan-y ${className}`}\n    >\n      {children}\n    </div>\n  )\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1768,"cache_read_input_tokens":98669,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1768},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"6904c731-a89c-4bab-a7fb-d06c9a50ae09"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01USebcU7dXhTQAB591m1Cp8","type":"tool_result","content":"File created successfully at: /mnt/d/personal/clinica/src/src/shared/components/ui/swipe-container.tsx"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"646e7ee6-f6e6-4e36-af87-8eb9c298a1fe","tool_use_result":{"type":"create","filePath":"/mnt/d/personal/clinica/src/src/shared/components/ui/swipe-container.tsx","content":"\"use client\"\n\nimport { useRef, useCallback } from \"react\"\n\ninterface SwipeContainerProps {\n  onSwipeLeft?: () => void\n  onSwipeRight?: () => void\n  threshold?: number\n  children: React.ReactNode\n  className?: string\n}\n\nexport function SwipeContainer({\n  onSwipeLeft,\n  onSwipeRight,\n  threshold = 50,\n  children,\n  className = \"\",\n}: SwipeContainerProps) {\n  const touchStartX = useRef<number | null>(null)\n  const touchStartY = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const touchEndY = useRef<number | null>(null)\n\n  const handleTouchStart = useCallback((e: React.TouchEvent) => {\n    touchStartX.current = e.touches[0].clientX\n    touchStartY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchMove = useCallback((e: React.TouchEvent) => {\n    touchEndX.current = e.touches[0].clientX\n    touchEndY.current = e.touches[0].clientY\n  }, [])\n\n  const handleTouchEnd = useCallback(() => {\n    if (\n      touchStartX.current === null ||\n      touchStartY.current === null ||\n      touchEndX.current === null ||\n      touchEndY.current === null\n    ) {\n      return\n    }\n\n    const diffX = touchStartX.current - touchEndX.current\n    const diffY = touchStartY.current - touchEndY.current\n\n    // Only trigger horizontal swipe if horizontal movement is greater than vertical\n    // This prevents accidental swipes during scrolling\n    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {\n      if (diffX > 0 && onSwipeLeft) {\n        onSwipeLeft()\n      } else if (diffX < 0 && onSwipeRight) {\n        onSwipeRight()\n      }\n    }\n\n    // Reset values\n    touchStartX.current = null\n    touchStartY.current = null\n    touchEndX.current = null\n    touchEndY.current = null\n  }, [onSwipeLeft, onSwipeRight, threshold])\n\n  return (\n    <div\n      onTouchStart={handleTouchStart}\n      onTouchMove={handleTouchMove}\n      onTouchEnd={handleTouchEnd}\n      className={`touch-pan-y ${className}`}\n    >\n      {children}\n    </div>\n  )\n}\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_018rhdbYp6Dq31wq3giW8pqH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EioENCBmBarQwZnwtfAwmD","name":"Write","input":{"file_path":"/mnt/d/personal/clinica/src/src/shared/components/ui/index.ts","content":"export { BottomNavigation } from \"./bottom-navigation\"\nexport { FAB } from \"./fab\"\nexport { BottomSheet, BottomSheetAction, BottomSheetDivider } from \"./bottom-sheet\"\nexport {\n  Skeleton,\n  SkeletonText,\n  SkeletonCard,\n  SkeletonTimeSlot,\n  SkeletonAgenda,\n  SkeletonList,\n  SkeletonPage,\n  SkeletonForm,\n} from \"./skeleton\"\nexport { ErrorState, EmptyState, OfflineState } from \"./error-state\"\nexport { SwipeContainer } from \"./swipe-container\"\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":801,"cache_read_input_tokens":100437,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":801},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4b815fee-a09d-4a71-9f12-a05f964ea47f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EioENCBmBarQwZnwtfAwmD","type":"tool_result","content":"File created successfully at: /mnt/d/personal/clinica/src/src/shared/components/ui/index.ts"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"5556dc66-f899-4b86-b5e6-d9ff63117120","tool_use_result":{"type":"create","filePath":"/mnt/d/personal/clinica/src/src/shared/components/ui/index.ts","content":"export { BottomNavigation } from \"./bottom-navigation\"\nexport { FAB } from \"./fab\"\nexport { BottomSheet, BottomSheetAction, BottomSheetDivider } from \"./bottom-sheet\"\nexport {\n  Skeleton,\n  SkeletonText,\n  SkeletonCard,\n  SkeletonTimeSlot,\n  SkeletonAgenda,\n  SkeletonList,\n  SkeletonPage,\n  SkeletonForm,\n} from \"./skeleton\"\nexport { ErrorState, EmptyState, OfflineState } from \"./error-state\"\nexport { SwipeContainer } from \"./swipe-container\"\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QPgZrmc3NkNs47gxtW2PMn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WanFkZdTza6pUB7ufkT3Lg","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"in_progress","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":296,"cache_read_input_tokens":101238,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":296},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a85693b5-d888-4dd2-aaba-623413840f3a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WanFkZdTza6pUB7ufkT3Lg","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"8c2b1713-619a-4c52-846e-cde6fb41ad81","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"in_progress","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"pending","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"pending","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"in_progress","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_013e7v8aFBQ8PqF7nAdq9XwR","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the globals.css to add horizontal scroll prevention and other mobile-specific improvements."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":101534,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7c8842fe-feca-4e06-b3dc-10bb5a61a345"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_013e7v8aFBQ8PqF7nAdq9XwR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VaqaSkZ3KFCxEPjQtaXqcN","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/globals.css"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":101534,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"73a3da48-b2df-42d1-abe7-e3f24d2c30a7"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VaqaSkZ3KFCxEPjQtaXqcN","type":"tool_result","content":"     1→@import \"tailwindcss\";\n     2→\n     3→:root {\n     4→  /* Minimalist color palette - neutral tones */\n     5→  --background: #fafafa;\n     6→  --foreground: #18181b;\n     7→\n     8→  /* Subtle borders */\n     9→  --border: #e4e4e7;\n    10→  --border-muted: #f4f4f5;\n    11→\n    12→  /* Neutral grays */\n    13→  --muted: #f4f4f5;\n    14→  --muted-foreground: #71717a;\n    15→\n    16→  /* Primary - subtle blue-gray */\n    17→  --primary: #3f3f46;\n    18→  --primary-foreground: #fafafa;\n    19→\n    20→  /* Accent - warm neutral */\n    21→  --accent: #f4f4f5;\n    22→  --accent-foreground: #18181b;\n    23→\n    24→  /* Destructive */\n    25→  --destructive: #ef4444;\n    26→  --destructive-foreground: #fafafa;\n    27→\n    28→  /* Card */\n    29→  --card: #ffffff;\n    30→  --card-foreground: #18181b;\n    31→\n    32→  /* Input */\n    33→  --input: #e4e4e7;\n    34→  --ring: #a1a1aa;\n    35→}\n    36→\n    37→@theme inline {\n    38→  --color-background: var(--background);\n    39→  --color-foreground: var(--foreground);\n    40→  --color-border: var(--border);\n    41→  --color-border-muted: var(--border-muted);\n    42→  --color-muted: var(--muted);\n    43→  --color-muted-foreground: var(--muted-foreground);\n    44→  --color-primary: var(--primary);\n    45→  --color-primary-foreground: var(--primary-foreground);\n    46→  --color-accent: var(--accent);\n    47→  --color-accent-foreground: var(--accent-foreground);\n    48→  --color-destructive: var(--destructive);\n    49→  --color-destructive-foreground: var(--destructive-foreground);\n    50→  --color-card: var(--card);\n    51→  --color-card-foreground: var(--card-foreground);\n    52→  --color-input: var(--input);\n    53→  --color-ring: var(--ring);\n    54→  --font-sans: var(--font-geist-sans);\n    55→  --font-mono: var(--font-geist-mono);\n    56→}\n    57→\n    58→@media (prefers-color-scheme: dark) {\n    59→  :root {\n    60→    --background: #09090b;\n    61→    --foreground: #fafafa;\n    62→\n    63→    --border: #27272a;\n    64→    --border-muted: #18181b;\n    65→\n    66→    --muted: #27272a;\n    67→    --muted-foreground: #a1a1aa;\n    68→\n    69→    --primary: #fafafa;\n    70→    --primary-foreground: #18181b;\n    71→\n    72→    --accent: #27272a;\n    73→    --accent-foreground: #fafafa;\n    74→\n    75→    --card: #09090b;\n    76→    --card-foreground: #fafafa;\n    77→\n    78→    --input: #27272a;\n    79→    --ring: #52525b;\n    80→  }\n    81→}\n    82→\n    83→body {\n    84→  background: var(--background);\n    85→  color: var(--foreground);\n    86→  font-family: var(--font-sans), system-ui, sans-serif;\n    87→}\n    88→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7e6007c4-f65e-4921-b2b1-d3cdb959d0a1","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/globals.css","content":"@import \"tailwindcss\";\n\n:root {\n  /* Minimalist color palette - neutral tones */\n  --background: #fafafa;\n  --foreground: #18181b;\n\n  /* Subtle borders */\n  --border: #e4e4e7;\n  --border-muted: #f4f4f5;\n\n  /* Neutral grays */\n  --muted: #f4f4f5;\n  --muted-foreground: #71717a;\n\n  /* Primary - subtle blue-gray */\n  --primary: #3f3f46;\n  --primary-foreground: #fafafa;\n\n  /* Accent - warm neutral */\n  --accent: #f4f4f5;\n  --accent-foreground: #18181b;\n\n  /* Destructive */\n  --destructive: #ef4444;\n  --destructive-foreground: #fafafa;\n\n  /* Card */\n  --card: #ffffff;\n  --card-foreground: #18181b;\n\n  /* Input */\n  --input: #e4e4e7;\n  --ring: #a1a1aa;\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n  --color-border: var(--border);\n  --color-border-muted: var(--border-muted);\n  --color-muted: var(--muted);\n  --color-muted-foreground: var(--muted-foreground);\n  --color-primary: var(--primary);\n  --color-primary-foreground: var(--primary-foreground);\n  --color-accent: var(--accent);\n  --color-accent-foreground: var(--accent-foreground);\n  --color-destructive: var(--destructive);\n  --color-destructive-foreground: var(--destructive-foreground);\n  --color-card: var(--card);\n  --color-card-foreground: var(--card-foreground);\n  --color-input: var(--input);\n  --color-ring: var(--ring);\n  --font-sans: var(--font-geist-sans);\n  --font-mono: var(--font-geist-mono);\n}\n\n@media (prefers-color-scheme: dark) {\n  :root {\n    --background: #09090b;\n    --foreground: #fafafa;\n\n    --border: #27272a;\n    --border-muted: #18181b;\n\n    --muted: #27272a;\n    --muted-foreground: #a1a1aa;\n\n    --primary: #fafafa;\n    --primary-foreground: #18181b;\n\n    --accent: #27272a;\n    --accent-foreground: #fafafa;\n\n    --card: #09090b;\n    --card-foreground: #fafafa;\n\n    --input: #27272a;\n    --ring: #52525b;\n  }\n}\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: var(--font-sans), system-ui, sans-serif;\n}\n","numLines":88,"startLine":1,"totalLines":88}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PwDheFw5kecjqge3n5LDon","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YJjjYKmE97CkdwTSiKcxqF","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/globals.css","old_string":"body {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: var(--font-sans), system-ui, sans-serif;\n}","new_string":"/* Prevent horizontal scroll */\nhtml,\nbody {\n  overflow-x: hidden;\n  overscroll-behavior-x: none;\n}\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: var(--font-sans), system-ui, sans-serif;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n/* Safe area padding for iOS */\n.safe-area-pb {\n  padding-bottom: env(safe-area-inset-bottom);\n}\n\n.safe-area-pt {\n  padding-top: env(safe-area-inset-top);\n}\n\n/* Touch-friendly targets */\n.touch-target {\n  min-height: 44px;\n  min-width: 44px;\n}\n\n/* Improved touch handling */\n.touch-manipulation {\n  touch-action: manipulation;\n}\n\n/* Prevent text selection on buttons */\nbutton,\n[role=\"button\"] {\n  user-select: none;\n  -webkit-user-select: none;\n}\n\n/* Improved scroll behavior */\n.overscroll-contain {\n  overscroll-behavior: contain;\n}\n\n/* Active state for touch devices */\n@media (hover: none) and (pointer: coarse) {\n  button:active,\n  [role=\"button\"]:active {\n    transform: scale(0.98);\n  }\n}\n\n/* Ensure inputs are large enough for touch */\ninput,\nselect,\ntextarea {\n  font-size: 16px; /* Prevents zoom on iOS */\n}\n\n/* Smooth scrolling for iOS */\n.scroll-smooth {\n  -webkit-overflow-scrolling: touch;\n}\n\n/* Hide scrollbars on mobile but keep functionality */\n@media (max-width: 640px) {\n  .hide-scrollbar {\n    -ms-overflow-style: none;\n    scrollbar-width: none;\n  }\n  .hide-scrollbar::-webkit-scrollbar {\n    display: none;\n  }\n}\n\n/* Animation keyframes */\n@keyframes slide-up {\n  from {\n    transform: translateY(100%);\n  }\n  to {\n    transform: translateY(0);\n  }\n}\n\n@keyframes slide-down {\n  from {\n    transform: translateY(0);\n  }\n  to {\n    transform: translateY(100%);\n  }\n}\n\n@keyframes fade-in {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n@keyframes fade-out {\n  from {\n    opacity: 1;\n  }\n  to {\n    opacity: 0;\n  }\n}\n\n@keyframes scale-in {\n  from {\n    opacity: 0;\n    transform: scale(0.95);\n  }\n  to {\n    opacity: 1;\n    transform: scale(1);\n  }\n}\n\n.animate-slide-up {\n  animation: slide-up 0.3s ease-out;\n}\n\n.animate-slide-down {\n  animation: slide-down 0.3s ease-out;\n}\n\n.animate-fade-in {\n  animation: fade-in 0.2s ease-out;\n}\n\n.animate-fade-out {\n  animation: fade-out 0.2s ease-out;\n}\n\n.animate-scale-in {\n  animation: scale-in 0.2s ease-out;\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1253,"cache_read_input_tokens":101948,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1253},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"d9bd1322-1c5d-42a1-ae28-2065a1603d5a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YJjjYKmE97CkdwTSiKcxqF","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/globals.css has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"8aa91534-6f21-409a-b842-841c5c6b23bd","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/globals.css","oldString":"body {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: var(--font-sans), system-ui, sans-serif;\n}","newString":"/* Prevent horizontal scroll */\nhtml,\nbody {\n  overflow-x: hidden;\n  overscroll-behavior-x: none;\n}\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: var(--font-sans), system-ui, sans-serif;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n/* Safe area padding for iOS */\n.safe-area-pb {\n  padding-bottom: env(safe-area-inset-bottom);\n}\n\n.safe-area-pt {\n  padding-top: env(safe-area-inset-top);\n}\n\n/* Touch-friendly targets */\n.touch-target {\n  min-height: 44px;\n  min-width: 44px;\n}\n\n/* Improved touch handling */\n.touch-manipulation {\n  touch-action: manipulation;\n}\n\n/* Prevent text selection on buttons */\nbutton,\n[role=\"button\"] {\n  user-select: none;\n  -webkit-user-select: none;\n}\n\n/* Improved scroll behavior */\n.overscroll-contain {\n  overscroll-behavior: contain;\n}\n\n/* Active state for touch devices */\n@media (hover: none) and (pointer: coarse) {\n  button:active,\n  [role=\"button\"]:active {\n    transform: scale(0.98);\n  }\n}\n\n/* Ensure inputs are large enough for touch */\ninput,\nselect,\ntextarea {\n  font-size: 16px; /* Prevents zoom on iOS */\n}\n\n/* Smooth scrolling for iOS */\n.scroll-smooth {\n  -webkit-overflow-scrolling: touch;\n}\n\n/* Hide scrollbars on mobile but keep functionality */\n@media (max-width: 640px) {\n  .hide-scrollbar {\n    -ms-overflow-style: none;\n    scrollbar-width: none;\n  }\n  .hide-scrollbar::-webkit-scrollbar {\n    display: none;\n  }\n}\n\n/* Animation keyframes */\n@keyframes slide-up {\n  from {\n    transform: translateY(100%);\n  }\n  to {\n    transform: translateY(0);\n  }\n}\n\n@keyframes slide-down {\n  from {\n    transform: translateY(0);\n  }\n  to {\n    transform: translateY(100%);\n  }\n}\n\n@keyframes fade-in {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n@keyframes fade-out {\n  from {\n    opacity: 1;\n  }\n  to {\n    opacity: 0;\n  }\n}\n\n@keyframes scale-in {\n  from {\n    opacity: 0;\n    transform: scale(0.95);\n  }\n  to {\n    opacity: 1;\n    transform: scale(1);\n  }\n}\n\n.animate-slide-up {\n  animation: slide-up 0.3s ease-out;\n}\n\n.animate-slide-down {\n  animation: slide-down 0.3s ease-out;\n}\n\n.animate-fade-in {\n  animation: fade-in 0.2s ease-out;\n}\n\n.animate-fade-out {\n  animation: fade-out 0.2s ease-out;\n}\n\n.animate-scale-in {\n  animation: scale-in 0.2s ease-out;\n}","originalFile":"@import \"tailwindcss\";\n\n:root {\n  /* Minimalist color palette - neutral tones */\n  --background: #fafafa;\n  --foreground: #18181b;\n\n  /* Subtle borders */\n  --border: #e4e4e7;\n  --border-muted: #f4f4f5;\n\n  /* Neutral grays */\n  --muted: #f4f4f5;\n  --muted-foreground: #71717a;\n\n  /* Primary - subtle blue-gray */\n  --primary: #3f3f46;\n  --primary-foreground: #fafafa;\n\n  /* Accent - warm neutral */\n  --accent: #f4f4f5;\n  --accent-foreground: #18181b;\n\n  /* Destructive */\n  --destructive: #ef4444;\n  --destructive-foreground: #fafafa;\n\n  /* Card */\n  --card: #ffffff;\n  --card-foreground: #18181b;\n\n  /* Input */\n  --input: #e4e4e7;\n  --ring: #a1a1aa;\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n  --color-border: var(--border);\n  --color-border-muted: var(--border-muted);\n  --color-muted: var(--muted);\n  --color-muted-foreground: var(--muted-foreground);\n  --color-primary: var(--primary);\n  --color-primary-foreground: var(--primary-foreground);\n  --color-accent: var(--accent);\n  --color-accent-foreground: var(--accent-foreground);\n  --color-destructive: var(--destructive);\n  --color-destructive-foreground: var(--destructive-foreground);\n  --color-card: var(--card);\n  --color-card-foreground: var(--card-foreground);\n  --color-input: var(--input);\n  --color-ring: var(--ring);\n  --font-sans: var(--font-geist-sans);\n  --font-mono: var(--font-geist-mono);\n}\n\n@media (prefers-color-scheme: dark) {\n  :root {\n    --background: #09090b;\n    --foreground: #fafafa;\n\n    --border: #27272a;\n    --border-muted: #18181b;\n\n    --muted: #27272a;\n    --muted-foreground: #a1a1aa;\n\n    --primary: #fafafa;\n    --primary-foreground: #18181b;\n\n    --accent: #27272a;\n    --accent-foreground: #fafafa;\n\n    --card: #09090b;\n    --card-foreground: #fafafa;\n\n    --input: #27272a;\n    --ring: #52525b;\n  }\n}\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: var(--font-sans), system-ui, sans-serif;\n}\n","structuredPatch":[{"oldStart":80,"oldLines":8,"newStart":80,"newLines":148,"lines":["   }"," }"," ","+/* Prevent horizontal scroll */","+html,"," body {","+  overflow-x: hidden;","+  overscroll-behavior-x: none;","+}","+","+body {","   background: var(--background);","   color: var(--foreground);","   font-family: var(--font-sans), system-ui, sans-serif;","+  -webkit-font-smoothing: antialiased;","+  -moz-osx-font-smoothing: grayscale;"," }","+","+/* Safe area padding for iOS */","+.safe-area-pb {","+  padding-bottom: env(safe-area-inset-bottom);","+}","+","+.safe-area-pt {","+  padding-top: env(safe-area-inset-top);","+}","+","+/* Touch-friendly targets */","+.touch-target {","+  min-height: 44px;","+  min-width: 44px;","+}","+","+/* Improved touch handling */","+.touch-manipulation {","+  touch-action: manipulation;","+}","+","+/* Prevent text selection on buttons */","+button,","+[role=\"button\"] {","+  user-select: none;","+  -webkit-user-select: none;","+}","+","+/* Improved scroll behavior */","+.overscroll-contain {","+  overscroll-behavior: contain;","+}","+","+/* Active state for touch devices */","+@media (hover: none) and (pointer: coarse) {","+  button:active,","+  [role=\"button\"]:active {","+    transform: scale(0.98);","+  }","+}","+","+/* Ensure inputs are large enough for touch */","+input,","+select,","+textarea {","+  font-size: 16px; /* Prevents zoom on iOS */","+}","+","+/* Smooth scrolling for iOS */","+.scroll-smooth {","+  -webkit-overflow-scrolling: touch;","+}","+","+/* Hide scrollbars on mobile but keep functionality */","+@media (max-width: 640px) {","+  .hide-scrollbar {","+    -ms-overflow-style: none;","+    scrollbar-width: none;","+  }","+  .hide-scrollbar::-webkit-scrollbar {","+    display: none;","+  }","+}","+","+/* Animation keyframes */","+@keyframes slide-up {","+  from {","+    transform: translateY(100%);","+  }","+  to {","+    transform: translateY(0);","+  }","+}","+","+@keyframes slide-down {","+  from {","+    transform: translateY(0);","+  }","+  to {","+    transform: translateY(100%);","+  }","+}","+","+@keyframes fade-in {","+  from {","+    opacity: 0;","+  }","+  to {","+    opacity: 1;","+  }","+}","+","+@keyframes fade-out {","+  from {","+    opacity: 1;","+  }","+  to {","+    opacity: 0;","+  }","+}","+","+@keyframes scale-in {","+  from {","+    opacity: 0;","+    transform: scale(0.95);","+  }","+  to {","+    opacity: 1;","+    transform: scale(1);","+  }","+}","+","+.animate-slide-up {","+  animation: slide-up 0.3s ease-out;","+}","+","+.animate-slide-down {","+  animation: slide-down 0.3s ease-out;","+}","+","+.animate-fade-in {","+  animation: fade-in 0.2s ease-out;","+}","+","+.animate-fade-out {","+  animation: fade-out 0.2s ease-out;","+}","+","+.animate-scale-in {","+  animation: scale-in 0.2s ease-out;","+}"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_015HE8WU3urNSgqo8weuwezn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EXvPKAmSaiprkKpYWoCxG2","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"in_progress","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1063,"cache_read_input_tokens":103201,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1063},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"bd6fc738-597c-4ff4-a393-f4156c6ed877"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EXvPKAmSaiprkKpYWoCxG2","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"482ef123-44d2-487a-8b06-cb846dccc208","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"in_progress","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"pending","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"in_progress","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CzXJx1vfURsfQHsBLpgcvo","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the agenda page to use the new components."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":104264,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"d63690bc-4312-45f0-bcb7-4930a695451b"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CzXJx1vfURsfQHsBLpgcvo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017p9XfArmwXCi2bQVcFozL2","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"","new_string":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":104264,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"ac3b61c7-385d-466f-8f4f-93c76924a7f1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017p9XfArmwXCi2bQVcFozL2","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"0ca5c4c1-109e-4eb3-aea1-b582c34c4fc9","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"","newString":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-12 w-full bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <div key={i} className=\"h-16 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <div className=\"text-center py-12\">\n            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n              Sem disponibilidade\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              {isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"}\n            </p>\n          </div>\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <button\n        onClick={() => openCreateSheet()}\n        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n        aria-label=\"Novo agendamento\"\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n        </svg>\n      </button>\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":7,"oldLines":6,"newStart":7,"newLines":15,"lines":[" import { zodResolver } from \"@hookform/resolvers/zod\""," import { z } from \"zod\""," import { toast } from \"sonner\"","+import {","+  BottomNavigation,","+  FAB,","+  BottomSheet,","+  SkeletonAgenda,","+  ErrorState,","+  EmptyState,","+  SwipeContainer,","+} from \"@/shared/components/ui\""," "," const timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/"," "]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UzQJxKgRfJ9dxE9Jpb3xdB","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the loading state in agenda page to use the skeleton components."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":441,"cache_read_input_tokens":104678,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":441},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"037aaaf5-d3ef-4915-b8a0-1da9e6466f4c"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UzQJxKgRfJ9dxE9Jpb3xdB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PciwCYytcDBE3LQyPQS3Aa","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-12 w-full bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <div key={i} className=\"h-16 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }","new_string":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":441,"cache_read_input_tokens":104678,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":441},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"99942e19-35a4-4e91-8c7b-5f626510f6fd"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PciwCYytcDBE3LQyPQS3Aa","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"97b3457b-8503-4617-8b15-3560930bfaac","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-12 w-full bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <div key={i} className=\"h-16 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }","newString":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-12 w-full bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <div key={i} className=\"h-16 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <div className=\"text-center py-12\">\n            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n              Sem disponibilidade\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              {isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"}\n            </p>\n          </div>\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <button\n        onClick={() => openCreateSheet()}\n        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n        aria-label=\"Novo agendamento\"\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n        </svg>\n      </button>\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":787,"oldLines":15,"newStart":787,"newLines":9,"lines":["     return (","       <main className=\"min-h-screen bg-background pb-20\">","         <div className=\"max-w-4xl mx-auto px-4 py-8\">","-          <div className=\"animate-pulse space-y-6\">","-            <div className=\"h-12 w-full bg-muted rounded\" />","-            <div className=\"space-y-4\">","-              {[1, 2, 3, 4, 5].map((i) => (","-                <div key={i} className=\"h-16 bg-muted rounded\" />","-              ))}","-            </div>","-          </div>","+          <SkeletonAgenda />","         </div>","+        <BottomNavigation />","       </main>","     )","   }"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_016qaBJYBB6ojqXc2faaxwZa","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the empty state in agenda page."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":461,"cache_read_input_tokens":105119,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":461},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"57d9ed8f-4412-4e74-a96b-99108c6a1318"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_016qaBJYBB6ojqXc2faaxwZa","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MKgGLo36X8k1jDpaAa1VPV","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <div className=\"text-center py-12\">\n            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n              Sem disponibilidade\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              {isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"}\n            </p>\n          </div>\n        )}","new_string":"        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":461,"cache_read_input_tokens":105119,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":461},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"c90f0acc-f704-4df1-8b6f-64f8546f2777"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MKgGLo36X8k1jDpaAa1VPV","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"efdeffaa-fe3c-4e2c-8a55-f0a1085e17a8","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <div className=\"text-center py-12\">\n            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n              Sem disponibilidade\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              {isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"}\n            </p>\n          </div>\n        )}","newString":"        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <div className=\"text-center py-12\">\n            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">\n              Sem disponibilidade\n            </h3>\n            <p className=\"text-sm text-muted-foreground\">\n              {isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"}\n            </p>\n          </div>\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <button\n        onClick={() => openCreateSheet()}\n        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n        aria-label=\"Novo agendamento\"\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n        </svg>\n      </button>\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":892,"oldLines":21,"newStart":892,"newLines":19,"lines":[" ","         {/* No availability message */}","         {timeSlots.length === 0 && (","-          <div className=\"text-center py-12\">","-            <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-muted flex items-center justify-center\">","+          <EmptyState","+            title=\"Sem disponibilidade\"","+            message={","+              isAdmin && !selectedProfessionalId","+                ? \"Selecione um profissional para ver a agenda\"","+                : \"Nao ha horarios configurados para este dia\"","+            }","+            icon={","               <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">","                 <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />","               </svg>","-            </div>","-            <h3 className=\"text-lg font-medium text-foreground mb-2\">","-              Sem disponibilidade","-            </h3>","-            <p className=\"text-sm text-muted-foreground\">","-              {isAdmin && !selectedProfessionalId","-                ? \"Selecione um profissional para ver a agenda\"","-                : \"Nao ha horarios configurados para este dia\"}","-            </p>","-          </div>","+            }","+          />","         )}"," ","         {/* Timeline */}"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ANivY9AZrm2xWgJwhdQRb1","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the FAB and bottom navigation in agenda page."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":695,"cache_read_input_tokens":105580,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":695},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4d2af40b-9fdb-46d2-81f0-de567e826b70"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ANivY9AZrm2xWgJwhdQRb1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019StJBgRMD1p77LTrqLQB8R","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"      {/* FAB - Floating Action Button */}\n      <button\n        onClick={() => openCreateSheet()}\n        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n        aria-label=\"Novo agendamento\"\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n        </svg>\n      </button>","new_string":"      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":695,"cache_read_input_tokens":105580,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":695},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"19ced670-c64b-4ff3-9e4f-95c5f5d90c4a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019StJBgRMD1p77LTrqLQB8R","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9ff70177-ff3d-435f-9088-5c059b408f4a","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"      {/* FAB - Floating Action Button */}\n      <button\n        onClick={() => openCreateSheet()}\n        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n        aria-label=\"Novo agendamento\"\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n        </svg>\n      </button>","newString":"      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <button\n        onClick={() => openCreateSheet()}\n        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"\n        aria-label=\"Novo agendamento\"\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n        </svg>\n      </button>\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":995,"oldLines":15,"newStart":995,"newLines":7,"lines":["       </div>"," ","       {/* FAB - Floating Action Button */}","-      <button","-        onClick={() => openCreateSheet()}","-        className=\"fixed right-4 bottom-24 w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-all z-30 flex items-center justify-center\"","-        aria-label=\"Novo agendamento\"","-      >","-        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">","-          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />","-        </svg>","-      </button>","+      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />"," ","       {/* Create Appointment Sheet */}","       {isCreateSheetOpen && ("]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017C25LMZ4GdgGVHyM2PAPen","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me replace the bottom navigation with the component."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":427,"cache_read_input_tokens":106275,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":427},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"cb17aa67-cc2f-46ea-85c1-cf2e3e63616f"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017C25LMZ4GdgGVHyM2PAPen","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RtopkTJYV19CYCLN6zLjvk","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>","new_string":"      {/* Bottom Navigation */}\n      <BottomNavigation />"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":427,"cache_read_input_tokens":106275,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":427},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"30e9fa02-5502-42dc-b66b-c914a37c2e89"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RtopkTJYV19CYCLN6zLjvk","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4cd809ce-5263-45dd-8ae4-3d804fdfad0b","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>","newString":"      {/* Bottom Navigation */}\n      <BottomNavigation />","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"flex items-center justify-around h-16\">\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-primary\"\n              onClick={() => router.push(\"/agenda\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <span className=\"text-xs font-medium\">Agenda</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/patients\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n              </svg>\n              <span className=\"text-xs\">Pacientes</span>\n            </button>\n\n            <button\n              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => router.push(\"/settings/availability\")}\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n              </svg>\n              <span className=\"text-xs\">Configuracoes</span>\n            </button>\n          </div>\n        </div>\n      </nav>\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":1576,"oldLines":43,"newStart":1576,"newLines":8,"lines":["       )}"," ","       {/* Bottom Navigation */}","-      <nav className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40\">","-        <div className=\"max-w-4xl mx-auto px-4\">","-          <div className=\"flex items-center justify-around h-16\">","-            <button","-              className=\"flex flex-col items-center justify-center gap-1 text-primary\"","-              onClick={() => router.push(\"/agenda\")}","-            >","-              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">","-                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />","-              </svg>","-              <span className=\"text-xs font-medium\">Agenda</span>","-            </button>","+      <BottomNavigation />"," ","-            <button","-              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"","-              onClick={() => router.push(\"/patients\")}","-            >","-              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">","-                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />","-              </svg>","-              <span className=\"text-xs\">Pacientes</span>","-            </button>","-","-            <button","-              className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-foreground transition-colors\"","-              onClick={() => router.push(\"/settings/availability\")}","-            >","-              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">","-                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />","-                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />","-              </svg>","-              <span className=\"text-xs\">Configuracoes</span>","-            </button>","-          </div>","-        </div>","-      </nav>","-","       {/* Animation Styles */}","       <style jsx>{`","         @keyframes slide-up {"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XeCxQar3KeKe4sq63n5PmP","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me remove the style jsx at the end since we've moved animations to globals.css."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1509,"cache_read_input_tokens":106702,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1509},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a531f8ec-3c4b-4054-89b3-6a9b8c5c12ba"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XeCxQar3KeKe4sq63n5PmP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ViyhA948XG3RLWgsVpmLWY","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>","new_string":"    </main>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1509,"cache_read_input_tokens":106702,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1509},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"07d06d56-6d2f-47fc-9607-7d568dd15109"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ViyhA948XG3RLWgsVpmLWY","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"bac869eb-dbbd-4ae4-b763-aad7f19fe137","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>","newString":"    </main>","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n        @keyframes scale-in {\n          from {\n            opacity: 0;\n            transform: scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n        .animate-scale-in {\n          animation: scale-in 0.2s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":1578,"oldLines":33,"newStart":1578,"newLines":6,"lines":["       {/* Bottom Navigation */}","       <BottomNavigation />"," ","-      {/* Animation Styles */}","-      <style jsx>{`","-        @keyframes slide-up {","-          from {","-            transform: translateY(100%);","-          }","-          to {","-            transform: translateY(0);","-          }","-        }","-        .animate-slide-up {","-          animation: slide-up 0.3s ease-out;","-        }","-        @keyframes scale-in {","-          from {","-            opacity: 0;","-            transform: scale(0.95);","-          }","-          to {","-            opacity: 1;","-            transform: scale(1);","-          }","-        }","-        .animate-scale-in {","-          animation: scale-in 0.2s ease-out;","-        }","-      `}</style>","     </main>","   )"," }"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WUbWBhyFLmnySyfYG9SuY4","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me use the SwipeContainer component to wrap the timeline content."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":377,"cache_read_input_tokens":108211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":377},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"6c972452-b51f-497d-898a-5e7955a404fb"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WUbWBhyFLmnySyfYG9SuY4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JSqsTzvu2e3n9qNyg2phP2","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >","new_string":"      {/* Timeline Content */}\n      <SwipeContainer\n        onSwipeLeft={goToNextDay}\n        onSwipeRight={goToPreviousDay}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":377,"cache_read_input_tokens":108211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":377},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"21f8b941-d237-474d-a62d-c7696a76fced"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JSqsTzvu2e3n9qNyg2phP2","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2cfebf57-b24c-4701-afdb-bd4775cf40cb","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >","newString":"      {/* Timeline Content */}\n      <SwipeContainer\n        onSwipeLeft={goToNextDay}\n        onSwipeRight={goToPreviousDay}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <div\n        ref={containerRef}\n        onTouchStart={handleTouchStart}\n        onTouchMove={handleTouchMove}\n        onTouchEnd={handleTouchEnd}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":878,"oldLines":11,"newStart":878,"newLines":9,"lines":["       </header>"," ","       {/* Timeline Content */}","-      <div","-        ref={containerRef}","-        onTouchStart={handleTouchStart}","-        onTouchMove={handleTouchMove}","-        onTouchEnd={handleTouchEnd}","+      <SwipeContainer","+        onSwipeLeft={goToNextDay}","+        onSwipeRight={goToPreviousDay}","         className=\"max-w-4xl mx-auto px-4 py-4\"","       >","         {/* Day navigation hint */}"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TKBPisV7XcJGobKsAsGWsE","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to close the SwipeContainer properly."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":326,"cache_read_input_tokens":108588,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":326},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"8541b533-748b-46c7-88bd-b438accd348d"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TKBPisV7XcJGobKsAsGWsE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Bp7xhg1X1nKgMH9QKh1wAi","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","offset":980,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":326,"cache_read_input_tokens":108588,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":326},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"912b1e1b-5850-401e-bdd9-1f0dc4e89688"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Bp7xhg1X1nKgMH9QKh1wAi","type":"tool_result","content":"   980→                    onClick={() => openCreateSheet(slot.time)}\n   981→                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n   982→                  >\n   983→                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   984→                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n   985→                    </svg>\n   986→                    <span className=\"text-sm\">Disponivel</span>\n   987→                  </button>\n   988→                )}\n   989→              </div>\n   990→            ))}\n   991→          </div>\n   992→        )}\n   993→      </div>\n   994→\n   995→      {/* FAB - Floating Action Button */}\n   996→      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n   997→\n   998→      {/* Create Appointment Sheet */}\n   999→      {isCreateSheetOpen && (\n  1000→        <>\n  1001→          {/* Backdrop */}\n  1002→          <div\n  1003→            className=\"fixed inset-0 bg-black/50 z-40\"\n  1004→            onClick={closeCreateSheet}\n  1005→          />\n  1006→\n  1007→          {/* Sheet */}\n  1008→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n  1009→            {/* Handle */}\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"dc401cc9-240d-4c3c-b848-6e9fa336e82e","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","content":"                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}","numLines":30,"startLine":980,"totalLines":1582}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01T8qbupVvreYfBejiZ4Q8YD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012ynuzZEqUdMKG5Z3maxRnR","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}","new_string":"          </div>\n        )}\n      </SwipeContainer>\n\n      {/* FAB - Floating Action Button */}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":700,"cache_read_input_tokens":108914,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":700},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2593bcd0-5db8-49ab-bbf5-8b88b2a90dd1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012ynuzZEqUdMKG5Z3maxRnR","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2a7ad526-7240-470b-814b-273d943c2dc6","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}","newString":"          </div>\n        )}\n      </SwipeContainer>\n\n      {/* FAB - Floating Action Button */}","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <SwipeContainer\n        onSwipeLeft={goToNextDay}\n        onSwipeRight={goToPreviousDay}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":990,"oldLines":7,"newStart":990,"newLines":7,"lines":["             ))}","           </div>","         )}","-      </div>","+      </SwipeContainer>"," ","       {/* FAB - Floating Action Button */}","       <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KsugM1FDgs1nkDzYuHVL5U","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to remove the unused refs and handlers for touch gestures since we're using the SwipeContainer now."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":219,"cache_read_input_tokens":109614,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":219},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"31a333d3-e4e7-4277-a676-3631119fc821"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KsugM1FDgs1nkDzYuHVL5U","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014U1hGFAxsz4XB28xmqEoeK","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)","new_string":""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":219,"cache_read_input_tokens":109614,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":219},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"d616a28d-8c16-4ba5-9689-df343ff391e2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014U1hGFAxsz4XB28xmqEoeK","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a39375ef-64a9-4484-9a74-def520c32f1d","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)","newString":"","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n  // Touch gesture handling\n  const touchStartX = useRef<number | null>(null)\n  const touchEndX = useRef<number | null>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <SwipeContainer\n        onSwipeLeft={goToNextDay}\n        onSwipeRight={goToPreviousDay}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </SwipeContainer>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":190,"oldLines":10,"newStart":190,"newLines":6,"lines":["   const [showDatePicker, setShowDatePicker] = useState(false)","   const [appointmentDuration, setAppointmentDuration] = useState(50)"," ","-  // Touch gesture handling","-  const touchStartX = useRef<number | null>(null)","-  const touchEndX = useRef<number | null>(null)","-  const containerRef = useRef<HTMLDivElement>(null)"," ","   // Appointment creation state","   const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KpfiACvQ6zdFb1JusTrrPS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HAXXu97bEuGEP6uPWA8L5a","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {","new_string":"  function goToPreviousDay() {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":245,"cache_read_input_tokens":109833,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":245},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"46f6cb66-8e9c-4ec6-9ed7-cbe5c1674c9e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HAXXu97bEuGEP6uPWA8L5a","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"85f8278b-6ddf-4cd1-a790-0a73b0237037","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {","newString":"  function goToPreviousDay() {","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  // Touch gesture handlers\n  function handleTouchStart(e: React.TouchEvent) {\n    touchStartX.current = e.touches[0].clientX\n  }\n\n  function handleTouchMove(e: React.TouchEvent) {\n    touchEndX.current = e.touches[0].clientX\n  }\n\n  function handleTouchEnd() {\n    if (!touchStartX.current || !touchEndX.current) return\n\n    const diff = touchStartX.current - touchEndX.current\n    const threshold = 50 // Minimum swipe distance\n\n    if (Math.abs(diff) > threshold) {\n      if (diff > 0) {\n        // Swipe left - next day\n        goToNextDay()\n      } else {\n        // Swipe right - previous day\n        goToPreviousDay()\n      }\n    }\n\n    touchStartX.current = null\n    touchEndX.current = null\n  }\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <SwipeContainer\n        onSwipeLeft={goToNextDay}\n        onSwipeRight={goToPreviousDay}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </SwipeContainer>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":694,"oldLines":35,"newStart":694,"newLines":6,"lines":["     setTimeSlots(slots)","   }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])"," ","-  // Touch gesture handlers","-  function handleTouchStart(e: React.TouchEvent) {","-    touchStartX.current = e.touches[0].clientX","-  }","-","-  function handleTouchMove(e: React.TouchEvent) {","-    touchEndX.current = e.touches[0].clientX","-  }","-","-  function handleTouchEnd() {","-    if (!touchStartX.current || !touchEndX.current) return","-","-    const diff = touchStartX.current - touchEndX.current","-    const threshold = 50 // Minimum swipe distance","-","-    if (Math.abs(diff) > threshold) {","-      if (diff > 0) {","-        // Swipe left - next day","-        goToNextDay()","-      } else {","-        // Swipe right - previous day","-        goToPreviousDay()","-      }","-    }","-","-    touchStartX.current = null","-    touchEndX.current = null","-  }","-","   function goToPreviousDay() {","     setSelectedDate((prev) => {","       const newDate = new Date(prev)"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CDZY6G3ZSwK6LK3SbsDdr3","type":"message","role":"assistant","content":[{"type":"text","text":"Now let's also update the patients page with the reusable components."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":677,"cache_read_input_tokens":110078,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":677},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"56ee91ce-33ba-4c9e-9104-516ad3a3d438"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CDZY6G3ZSwK6LK3SbsDdr3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EDeou7Na6YdMvATZR7jRLE","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","old_string":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"","new_string":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":677,"cache_read_input_tokens":110078,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":677},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"23e1d7ac-7099-4d66-ba09-54fd883ad139"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EDeou7Na6YdMvATZR7jRLE","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/patients/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7232f941-6ebd-4d4c-ab04-edad670d2019","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","oldString":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"","newString":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\n\n// WhatsApp format validation\nconst phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n\nconst patientSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n  phone: z\n    .string()\n    .min(1, \"Telefone é obrigatório\")\n    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n  consentWhatsApp: z.boolean(),\n  consentEmail: z.boolean(),\n})\n\ntype PatientFormData = z.infer<typeof patientSchema>\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface Patient {\n  id: string\n  name: string\n  email: string | null\n  phone: string\n  birthDate: string | null\n  notes: string | null\n  isActive: boolean\n  lastVisitAt: string | null\n  consentWhatsApp: boolean\n  consentWhatsAppAt: string | null\n  consentEmail: boolean\n  consentEmailAt: string | null\n  createdAt: string\n  appointments?: Appointment[]\n}\n\nfunction formatPhone(phone: string): string {\n  // Format: (11) 99999-9999\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"-\"\n  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Não compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800\",\n  CONFIRMADO: \"bg-green-100 text-green-800\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n  FINALIZADO: \"bg-gray-100 text-gray-800\",\n}\n\nexport default function PatientsPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [search, setSearch] = useState(\"\")\n  const [filterActive, setFilterActive] = useState<string>(\"all\")\n  const [isSheetOpen, setIsSheetOpen] = useState(false)\n  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n  const [isSaving, setIsSaving] = useState(false)\n  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    formState: { errors },\n  } = useForm<PatientFormData>({\n    resolver: zodResolver(patientSchema),\n    defaultValues: {\n      consentWhatsApp: false,\n      consentEmail: false,\n    },\n  })\n\n  const fetchPatients = useCallback(async () => {\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set(\"search\", search)\n      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch patients\")\n      }\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      toast.error(\"Erro ao carregar pacientes\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [search, filterActive, router])\n\n  const fetchPatientDetails = useCallback(async (patientId: string) => {\n    setIsLoadingDetails(true)\n    try {\n      const response = await fetch(`/api/patients/${patientId}`)\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch patient details\")\n      }\n      const data = await response.json()\n      setViewingPatient(data.patient)\n    } catch {\n      toast.error(\"Erro ao carregar detalhes do paciente\")\n    } finally {\n      setIsLoadingDetails(false)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchPatients()\n    }\n  }, [status, router, fetchPatients])\n\n  function openCreateSheet() {\n    setEditingPatient(null)\n    setViewingPatient(null)\n    reset({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      notes: \"\",\n      consentWhatsApp: false,\n      consentEmail: false,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openEditSheet(patient: Patient) {\n    setEditingPatient(patient)\n    setViewingPatient(null)\n    reset({\n      name: patient.name,\n      phone: patient.phone,\n      email: patient.email ?? \"\",\n      notes: patient.notes ?? \"\",\n      consentWhatsApp: patient.consentWhatsApp,\n      consentEmail: patient.consentEmail,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openViewSheet(patient: Patient) {\n    setEditingPatient(null)\n    fetchPatientDetails(patient.id)\n    setIsSheetOpen(true)\n  }\n\n  function closeSheet() {\n    setIsSheetOpen(false)\n    setEditingPatient(null)\n    setViewingPatient(null)\n  }\n\n  async function onSubmit(data: PatientFormData) {\n    setIsSaving(true)\n    try {\n      const url = editingPatient\n        ? `/api/patients/${editingPatient.id}`\n        : \"/api/patients\"\n      const method = editingPatient ? \"PATCH\" : \"POST\"\n\n      const payload: Record<string, unknown> = {\n        name: data.name,\n        phone: data.phone.replace(/\\D/g, \"\"),\n        email: data.email || null,\n        notes: data.notes || null,\n        consentWhatsApp: data.consentWhatsApp,\n        consentEmail: data.consentEmail,\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save patient\")\n      }\n\n      toast.success(\n        editingPatient\n          ? \"Paciente atualizado com sucesso\"\n          : \"Paciente criado com sucesso\"\n      )\n      closeSheet()\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function handleDeactivate(patient: Patient) {\n    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n      return\n    }\n\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to deactivate patient\")\n      }\n\n      toast.success(\"Paciente desativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n    }\n  }\n\n  async function handleReactivate(patient: Patient) {\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isActive: true }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to reactivate patient\")\n      }\n\n      toast.success(\"Paciente reativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n    }\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"flex gap-4\">\n              <div className=\"h-12 flex-1 bg-muted rounded\" />\n              <div className=\"h-12 w-32 bg-muted rounded\" />\n            </div>\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n          {isAdmin && (\n            <button\n              onClick={openCreateSheet}\n              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n            >\n              + Novo Paciente\n            </button>\n          )}\n        </div>\n\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1\">\n            <input\n              type=\"text\"\n              placeholder=\"Buscar por nome, email ou telefone...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            />\n          </div>\n          <select\n            value={filterActive}\n            onChange={(e) => setFilterActive(e.target.value)}\n            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n          >\n            <option value=\"all\">Todos</option>\n            <option value=\"true\">Ativos</option>\n            <option value=\"false\">Inativos</option>\n          </select>\n        </div>\n\n        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              {search || filterActive !== \"all\"\n                ? \"Nenhum paciente encontrado\"\n                : \"Nenhum paciente cadastrado\"}\n            </div>\n          ) : (\n            patients.map((patient) => (\n              <div\n                key={patient.id}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !patient.isActive ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                  <div\n                    className=\"flex-1 min-w-0 cursor-pointer\"\n                    onClick={() => openViewSheet(patient)}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <h3 className=\"font-medium text-foreground truncate\">\n                        {patient.name}\n                      </h3>\n                      {!patient.isActive && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n                          Inativo\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatPhone(patient.phone)}\n                    </p>\n                    {patient.email && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {patient.email}\n                      </p>\n                    )}\n                    <div className=\"flex gap-3 mt-2\">\n                      {patient.consentWhatsApp && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n                          WhatsApp\n                        </span>\n                      )}\n                      {patient.consentEmail && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n                          Email\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  {isAdmin && (\n                    <div className=\"flex gap-2\">\n                      <button\n                        onClick={() => openEditSheet(patient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                      {patient.isActive ? (\n                        <button\n                          onClick={() => handleDeactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Desativar\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => handleReactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Reativar\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>\n                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n                        </div>\n                      </div>\n\n                      {/* Notes */}\n                      {viewingPatient.notes && (\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n                        </div>\n                      )}\n\n                      {/* Consent Info */}\n                      <div>\n                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">WhatsApp</span>\n                            {viewingPatient.consentWhatsAppAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">Email</span>\n                            {viewingPatient.consentEmailAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentEmailAt)})\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Appointment History */}\n                      <div>\n                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n                          Historico de Consultas\n                        </h3>\n                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {viewingPatient.appointments.map((appointment) => (\n                              <div\n                                key={appointment.id}\n                                className=\"bg-muted/50 rounded-lg p-4\"\n                              >\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <span className=\"font-medium\">\n                                    {formatDateTime(appointment.scheduledAt)}\n                                  </span>\n                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n                                    {statusLabels[appointment.status] || appointment.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.professionalProfile.user.name}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                                </p>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-muted-foreground text-sm\">\n                            Nenhuma consulta registrada\n                          </p>\n                        )}\n                      </div>\n\n                      <div className=\"pt-4\">\n                        <button\n                          type=\"button\"\n                          onClick={closeSheet}\n                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Fechar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Create/Edit Mode */}\n              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n                <>\n                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n                  </h2>\n\n                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div>\n                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Nome *\n                      </label>\n                      <input\n                        id=\"name\"\n                        type=\"text\"\n                        {...register(\"name\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.name && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Telefone (WhatsApp) *\n                      </label>\n                      <input\n                        id=\"phone\"\n                        type=\"tel\"\n                        {...register(\"phone\")}\n                        placeholder=\"11999999999\"\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.phone && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Formato: DDD + numero (ex: 11999999999)\n                      </p>\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Email\n                      </label>\n                      <input\n                        id=\"email\"\n                        type=\"email\"\n                        {...register(\"email\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.email && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Observacoes administrativas\n                      </label>\n                      <textarea\n                        id=\"notes\"\n                        rows={3}\n                        {...register(\"notes\")}\n                        placeholder=\"Observacoes internas sobre o paciente...\"\n                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                      />\n                      {errors.notes && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                      )}\n                    </div>\n\n                    {/* LGPD Consent Section */}\n                    <div className=\"border border-border rounded-lg p-4\">\n                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n                        Consentimentos LGPD\n                      </h3>\n                      <div className=\"space-y-4\">\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentWhatsApp\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber mensagens via WhatsApp\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentEmail\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber comunicacoes por email\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                      <button\n                        type=\"submit\"\n                        disabled={isSaving}\n                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                      >\n                        {isSaving\n                          ? \"Salvando...\"\n                          : editingPatient\n                          ? \"Salvar alteracoes\"\n                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":7,"oldLines":6,"newStart":7,"newLines":13,"lines":[" import { zodResolver } from \"@hookform/resolvers/zod\""," import { z } from \"zod\""," import { toast } from \"sonner\"","+import {","+  BottomNavigation,","+  FAB,","+  BottomSheet,","+  SkeletonPage,","+  EmptyState,","+} from \"@/shared/components/ui\""," "," // WhatsApp format validation"," const phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Htba6Jh8ekRNySDeNWWfBq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018p9Co3Khc3maPV668HJJpu","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","old_string":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"flex gap-4\">\n              <div className=\"h-12 flex-1 bg-muted rounded\" />\n              <div className=\"h-12 w-32 bg-muted rounded\" />\n            </div>\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }","new_string":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonPage />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":425,"cache_read_input_tokens":110755,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":425},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4f239505-f19a-421f-bc61-fa4ecce61594"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018p9Co3Khc3maPV668HJJpu","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/patients/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"bc93605d-c415-438b-b57b-bfbb4c08322b","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","oldString":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"flex gap-4\">\n              <div className=\"h-12 flex-1 bg-muted rounded\" />\n              <div className=\"h-12 w-32 bg-muted rounded\" />\n            </div>\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }","newString":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonPage />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"\n\n// WhatsApp format validation\nconst phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n\nconst patientSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n  phone: z\n    .string()\n    .min(1, \"Telefone é obrigatório\")\n    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n  consentWhatsApp: z.boolean(),\n  consentEmail: z.boolean(),\n})\n\ntype PatientFormData = z.infer<typeof patientSchema>\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface Patient {\n  id: string\n  name: string\n  email: string | null\n  phone: string\n  birthDate: string | null\n  notes: string | null\n  isActive: boolean\n  lastVisitAt: string | null\n  consentWhatsApp: boolean\n  consentWhatsAppAt: string | null\n  consentEmail: boolean\n  consentEmailAt: string | null\n  createdAt: string\n  appointments?: Appointment[]\n}\n\nfunction formatPhone(phone: string): string {\n  // Format: (11) 99999-9999\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"-\"\n  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Não compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800\",\n  CONFIRMADO: \"bg-green-100 text-green-800\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n  FINALIZADO: \"bg-gray-100 text-gray-800\",\n}\n\nexport default function PatientsPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [search, setSearch] = useState(\"\")\n  const [filterActive, setFilterActive] = useState<string>(\"all\")\n  const [isSheetOpen, setIsSheetOpen] = useState(false)\n  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n  const [isSaving, setIsSaving] = useState(false)\n  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    formState: { errors },\n  } = useForm<PatientFormData>({\n    resolver: zodResolver(patientSchema),\n    defaultValues: {\n      consentWhatsApp: false,\n      consentEmail: false,\n    },\n  })\n\n  const fetchPatients = useCallback(async () => {\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set(\"search\", search)\n      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch patients\")\n      }\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      toast.error(\"Erro ao carregar pacientes\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [search, filterActive, router])\n\n  const fetchPatientDetails = useCallback(async (patientId: string) => {\n    setIsLoadingDetails(true)\n    try {\n      const response = await fetch(`/api/patients/${patientId}`)\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch patient details\")\n      }\n      const data = await response.json()\n      setViewingPatient(data.patient)\n    } catch {\n      toast.error(\"Erro ao carregar detalhes do paciente\")\n    } finally {\n      setIsLoadingDetails(false)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchPatients()\n    }\n  }, [status, router, fetchPatients])\n\n  function openCreateSheet() {\n    setEditingPatient(null)\n    setViewingPatient(null)\n    reset({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      notes: \"\",\n      consentWhatsApp: false,\n      consentEmail: false,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openEditSheet(patient: Patient) {\n    setEditingPatient(patient)\n    setViewingPatient(null)\n    reset({\n      name: patient.name,\n      phone: patient.phone,\n      email: patient.email ?? \"\",\n      notes: patient.notes ?? \"\",\n      consentWhatsApp: patient.consentWhatsApp,\n      consentEmail: patient.consentEmail,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openViewSheet(patient: Patient) {\n    setEditingPatient(null)\n    fetchPatientDetails(patient.id)\n    setIsSheetOpen(true)\n  }\n\n  function closeSheet() {\n    setIsSheetOpen(false)\n    setEditingPatient(null)\n    setViewingPatient(null)\n  }\n\n  async function onSubmit(data: PatientFormData) {\n    setIsSaving(true)\n    try {\n      const url = editingPatient\n        ? `/api/patients/${editingPatient.id}`\n        : \"/api/patients\"\n      const method = editingPatient ? \"PATCH\" : \"POST\"\n\n      const payload: Record<string, unknown> = {\n        name: data.name,\n        phone: data.phone.replace(/\\D/g, \"\"),\n        email: data.email || null,\n        notes: data.notes || null,\n        consentWhatsApp: data.consentWhatsApp,\n        consentEmail: data.consentEmail,\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save patient\")\n      }\n\n      toast.success(\n        editingPatient\n          ? \"Paciente atualizado com sucesso\"\n          : \"Paciente criado com sucesso\"\n      )\n      closeSheet()\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function handleDeactivate(patient: Patient) {\n    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n      return\n    }\n\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to deactivate patient\")\n      }\n\n      toast.success(\"Paciente desativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n    }\n  }\n\n  async function handleReactivate(patient: Patient) {\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isActive: true }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to reactivate patient\")\n      }\n\n      toast.success(\"Paciente reativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n    }\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"flex gap-4\">\n              <div className=\"h-12 flex-1 bg-muted rounded\" />\n              <div className=\"h-12 w-32 bg-muted rounded\" />\n            </div>\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n          {isAdmin && (\n            <button\n              onClick={openCreateSheet}\n              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n            >\n              + Novo Paciente\n            </button>\n          )}\n        </div>\n\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1\">\n            <input\n              type=\"text\"\n              placeholder=\"Buscar por nome, email ou telefone...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            />\n          </div>\n          <select\n            value={filterActive}\n            onChange={(e) => setFilterActive(e.target.value)}\n            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n          >\n            <option value=\"all\">Todos</option>\n            <option value=\"true\">Ativos</option>\n            <option value=\"false\">Inativos</option>\n          </select>\n        </div>\n\n        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              {search || filterActive !== \"all\"\n                ? \"Nenhum paciente encontrado\"\n                : \"Nenhum paciente cadastrado\"}\n            </div>\n          ) : (\n            patients.map((patient) => (\n              <div\n                key={patient.id}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !patient.isActive ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                  <div\n                    className=\"flex-1 min-w-0 cursor-pointer\"\n                    onClick={() => openViewSheet(patient)}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <h3 className=\"font-medium text-foreground truncate\">\n                        {patient.name}\n                      </h3>\n                      {!patient.isActive && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n                          Inativo\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatPhone(patient.phone)}\n                    </p>\n                    {patient.email && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {patient.email}\n                      </p>\n                    )}\n                    <div className=\"flex gap-3 mt-2\">\n                      {patient.consentWhatsApp && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n                          WhatsApp\n                        </span>\n                      )}\n                      {patient.consentEmail && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n                          Email\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  {isAdmin && (\n                    <div className=\"flex gap-2\">\n                      <button\n                        onClick={() => openEditSheet(patient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                      {patient.isActive ? (\n                        <button\n                          onClick={() => handleDeactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Desativar\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => handleReactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Reativar\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>\n                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n                        </div>\n                      </div>\n\n                      {/* Notes */}\n                      {viewingPatient.notes && (\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n                        </div>\n                      )}\n\n                      {/* Consent Info */}\n                      <div>\n                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">WhatsApp</span>\n                            {viewingPatient.consentWhatsAppAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">Email</span>\n                            {viewingPatient.consentEmailAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentEmailAt)})\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Appointment History */}\n                      <div>\n                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n                          Historico de Consultas\n                        </h3>\n                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {viewingPatient.appointments.map((appointment) => (\n                              <div\n                                key={appointment.id}\n                                className=\"bg-muted/50 rounded-lg p-4\"\n                              >\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <span className=\"font-medium\">\n                                    {formatDateTime(appointment.scheduledAt)}\n                                  </span>\n                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n                                    {statusLabels[appointment.status] || appointment.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.professionalProfile.user.name}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                                </p>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-muted-foreground text-sm\">\n                            Nenhuma consulta registrada\n                          </p>\n                        )}\n                      </div>\n\n                      <div className=\"pt-4\">\n                        <button\n                          type=\"button\"\n                          onClick={closeSheet}\n                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Fechar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Create/Edit Mode */}\n              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n                <>\n                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n                  </h2>\n\n                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div>\n                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Nome *\n                      </label>\n                      <input\n                        id=\"name\"\n                        type=\"text\"\n                        {...register(\"name\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.name && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Telefone (WhatsApp) *\n                      </label>\n                      <input\n                        id=\"phone\"\n                        type=\"tel\"\n                        {...register(\"phone\")}\n                        placeholder=\"11999999999\"\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.phone && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Formato: DDD + numero (ex: 11999999999)\n                      </p>\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Email\n                      </label>\n                      <input\n                        id=\"email\"\n                        type=\"email\"\n                        {...register(\"email\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.email && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Observacoes administrativas\n                      </label>\n                      <textarea\n                        id=\"notes\"\n                        rows={3}\n                        {...register(\"notes\")}\n                        placeholder=\"Observacoes internas sobre o paciente...\"\n                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                      />\n                      {errors.notes && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                      )}\n                    </div>\n\n                    {/* LGPD Consent Section */}\n                    <div className=\"border border-border rounded-lg p-4\">\n                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n                        Consentimentos LGPD\n                      </h3>\n                      <div className=\"space-y-4\">\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentWhatsApp\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber mensagens via WhatsApp\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentEmail\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber comunicacoes por email\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                      <button\n                        type=\"submit\"\n                        disabled={isSaving}\n                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                      >\n                        {isSaving\n                          ? \"Salvando...\"\n                          : editingPatient\n                          ? \"Salvar alteracoes\"\n                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":314,"oldLines":21,"newStart":314,"newLines":11,"lines":[" ","   if (status === \"loading\" || isLoading) {","     return (","-      <main className=\"min-h-screen bg-background\">","+      <main className=\"min-h-screen bg-background pb-20\">","         <div className=\"max-w-4xl mx-auto px-4 py-8\">","-          <div className=\"animate-pulse space-y-6\">","-            <div className=\"h-8 w-48 bg-muted rounded\" />","-            <div className=\"flex gap-4\">","-              <div className=\"h-12 flex-1 bg-muted rounded\" />","-              <div className=\"h-12 w-32 bg-muted rounded\" />","-            </div>","-            <div className=\"space-y-4\">","-              {[1, 2, 3].map((i) => (","-                <div key={i} className=\"h-20 bg-muted rounded\" />","-              ))}","-            </div>","-          </div>","+          <SkeletonPage />","         </div>","+        <BottomNavigation />","       </main>","     )","   }"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WMFGRUAcyWb2EsAUcPixgC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XcSzhLKVDWitUBy1BHj7Cz","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","old_string":"  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">","new_string":"  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":493,"cache_read_input_tokens":111180,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":493},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"820cade0-d603-4ab6-9d76-84b808f811c5"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XcSzhLKVDWitUBy1BHj7Cz","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/patients/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a747840b-b831-4640-93df-9d96efb02ae5","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","oldString":"  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">","newString":"  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"\n\n// WhatsApp format validation\nconst phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n\nconst patientSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n  phone: z\n    .string()\n    .min(1, \"Telefone é obrigatório\")\n    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n  consentWhatsApp: z.boolean(),\n  consentEmail: z.boolean(),\n})\n\ntype PatientFormData = z.infer<typeof patientSchema>\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface Patient {\n  id: string\n  name: string\n  email: string | null\n  phone: string\n  birthDate: string | null\n  notes: string | null\n  isActive: boolean\n  lastVisitAt: string | null\n  consentWhatsApp: boolean\n  consentWhatsAppAt: string | null\n  consentEmail: boolean\n  consentEmailAt: string | null\n  createdAt: string\n  appointments?: Appointment[]\n}\n\nfunction formatPhone(phone: string): string {\n  // Format: (11) 99999-9999\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"-\"\n  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Não compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800\",\n  CONFIRMADO: \"bg-green-100 text-green-800\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n  FINALIZADO: \"bg-gray-100 text-gray-800\",\n}\n\nexport default function PatientsPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [search, setSearch] = useState(\"\")\n  const [filterActive, setFilterActive] = useState<string>(\"all\")\n  const [isSheetOpen, setIsSheetOpen] = useState(false)\n  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n  const [isSaving, setIsSaving] = useState(false)\n  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    formState: { errors },\n  } = useForm<PatientFormData>({\n    resolver: zodResolver(patientSchema),\n    defaultValues: {\n      consentWhatsApp: false,\n      consentEmail: false,\n    },\n  })\n\n  const fetchPatients = useCallback(async () => {\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set(\"search\", search)\n      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch patients\")\n      }\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      toast.error(\"Erro ao carregar pacientes\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [search, filterActive, router])\n\n  const fetchPatientDetails = useCallback(async (patientId: string) => {\n    setIsLoadingDetails(true)\n    try {\n      const response = await fetch(`/api/patients/${patientId}`)\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch patient details\")\n      }\n      const data = await response.json()\n      setViewingPatient(data.patient)\n    } catch {\n      toast.error(\"Erro ao carregar detalhes do paciente\")\n    } finally {\n      setIsLoadingDetails(false)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchPatients()\n    }\n  }, [status, router, fetchPatients])\n\n  function openCreateSheet() {\n    setEditingPatient(null)\n    setViewingPatient(null)\n    reset({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      notes: \"\",\n      consentWhatsApp: false,\n      consentEmail: false,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openEditSheet(patient: Patient) {\n    setEditingPatient(patient)\n    setViewingPatient(null)\n    reset({\n      name: patient.name,\n      phone: patient.phone,\n      email: patient.email ?? \"\",\n      notes: patient.notes ?? \"\",\n      consentWhatsApp: patient.consentWhatsApp,\n      consentEmail: patient.consentEmail,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openViewSheet(patient: Patient) {\n    setEditingPatient(null)\n    fetchPatientDetails(patient.id)\n    setIsSheetOpen(true)\n  }\n\n  function closeSheet() {\n    setIsSheetOpen(false)\n    setEditingPatient(null)\n    setViewingPatient(null)\n  }\n\n  async function onSubmit(data: PatientFormData) {\n    setIsSaving(true)\n    try {\n      const url = editingPatient\n        ? `/api/patients/${editingPatient.id}`\n        : \"/api/patients\"\n      const method = editingPatient ? \"PATCH\" : \"POST\"\n\n      const payload: Record<string, unknown> = {\n        name: data.name,\n        phone: data.phone.replace(/\\D/g, \"\"),\n        email: data.email || null,\n        notes: data.notes || null,\n        consentWhatsApp: data.consentWhatsApp,\n        consentEmail: data.consentEmail,\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save patient\")\n      }\n\n      toast.success(\n        editingPatient\n          ? \"Paciente atualizado com sucesso\"\n          : \"Paciente criado com sucesso\"\n      )\n      closeSheet()\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function handleDeactivate(patient: Patient) {\n    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n      return\n    }\n\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to deactivate patient\")\n      }\n\n      toast.success(\"Paciente desativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n    }\n  }\n\n  async function handleReactivate(patient: Patient) {\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isActive: true }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to reactivate patient\")\n      }\n\n      toast.success(\"Paciente reativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n    }\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonPage />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n          {isAdmin && (\n            <button\n              onClick={openCreateSheet}\n              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n            >\n              + Novo Paciente\n            </button>\n          )}\n        </div>\n\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1\">\n            <input\n              type=\"text\"\n              placeholder=\"Buscar por nome, email ou telefone...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            />\n          </div>\n          <select\n            value={filterActive}\n            onChange={(e) => setFilterActive(e.target.value)}\n            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n          >\n            <option value=\"all\">Todos</option>\n            <option value=\"true\">Ativos</option>\n            <option value=\"false\">Inativos</option>\n          </select>\n        </div>\n\n        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              {search || filterActive !== \"all\"\n                ? \"Nenhum paciente encontrado\"\n                : \"Nenhum paciente cadastrado\"}\n            </div>\n          ) : (\n            patients.map((patient) => (\n              <div\n                key={patient.id}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !patient.isActive ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                  <div\n                    className=\"flex-1 min-w-0 cursor-pointer\"\n                    onClick={() => openViewSheet(patient)}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <h3 className=\"font-medium text-foreground truncate\">\n                        {patient.name}\n                      </h3>\n                      {!patient.isActive && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n                          Inativo\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatPhone(patient.phone)}\n                    </p>\n                    {patient.email && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {patient.email}\n                      </p>\n                    )}\n                    <div className=\"flex gap-3 mt-2\">\n                      {patient.consentWhatsApp && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n                          WhatsApp\n                        </span>\n                      )}\n                      {patient.consentEmail && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n                          Email\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  {isAdmin && (\n                    <div className=\"flex gap-2\">\n                      <button\n                        onClick={() => openEditSheet(patient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                      {patient.isActive ? (\n                        <button\n                          onClick={() => handleDeactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Desativar\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => handleReactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Reativar\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>\n                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n                        </div>\n                      </div>\n\n                      {/* Notes */}\n                      {viewingPatient.notes && (\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n                        </div>\n                      )}\n\n                      {/* Consent Info */}\n                      <div>\n                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">WhatsApp</span>\n                            {viewingPatient.consentWhatsAppAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">Email</span>\n                            {viewingPatient.consentEmailAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentEmailAt)})\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Appointment History */}\n                      <div>\n                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n                          Historico de Consultas\n                        </h3>\n                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {viewingPatient.appointments.map((appointment) => (\n                              <div\n                                key={appointment.id}\n                                className=\"bg-muted/50 rounded-lg p-4\"\n                              >\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <span className=\"font-medium\">\n                                    {formatDateTime(appointment.scheduledAt)}\n                                  </span>\n                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n                                    {statusLabels[appointment.status] || appointment.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.professionalProfile.user.name}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                                </p>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-muted-foreground text-sm\">\n                            Nenhuma consulta registrada\n                          </p>\n                        )}\n                      </div>\n\n                      <div className=\"pt-4\">\n                        <button\n                          type=\"button\"\n                          onClick={closeSheet}\n                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Fechar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Create/Edit Mode */}\n              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n                <>\n                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n                  </h2>\n\n                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div>\n                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Nome *\n                      </label>\n                      <input\n                        id=\"name\"\n                        type=\"text\"\n                        {...register(\"name\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.name && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Telefone (WhatsApp) *\n                      </label>\n                      <input\n                        id=\"phone\"\n                        type=\"tel\"\n                        {...register(\"phone\")}\n                        placeholder=\"11999999999\"\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.phone && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Formato: DDD + numero (ex: 11999999999)\n                      </p>\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Email\n                      </label>\n                      <input\n                        id=\"email\"\n                        type=\"email\"\n                        {...register(\"email\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.email && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Observacoes administrativas\n                      </label>\n                      <textarea\n                        id=\"notes\"\n                        rows={3}\n                        {...register(\"notes\")}\n                        placeholder=\"Observacoes internas sobre o paciente...\"\n                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                      />\n                      {errors.notes && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                      )}\n                    </div>\n\n                    {/* LGPD Consent Section */}\n                    <div className=\"border border-border rounded-lg p-4\">\n                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n                        Consentimentos LGPD\n                      </h3>\n                      <div className=\"space-y-4\">\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentWhatsApp\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber mensagens via WhatsApp\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentEmail\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber comunicacoes por email\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                      <button\n                        type=\"submit\"\n                        disabled={isSaving}\n                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                      >\n                        {isSaving\n                          ? \"Salvando...\"\n                          : editingPatient\n                          ? \"Salvar alteracoes\"\n                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":324,"oldLines":7,"newStart":324,"newLines":7,"lines":["   }"," ","   return (","-    <main className=\"min-h-screen bg-background\">","+    <main className=\"min-h-screen bg-background pb-20\">","       <div className=\"max-w-4xl mx-auto px-4 py-8\">","         <div className=\"mb-6\">","           <button"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Gk7tUJ89xcHMCnQH2TBUYZ","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the empty state and add bottom navigation to patients page."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":252,"cache_read_input_tokens":111673,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":252},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"701e8737-d120-4dfc-8a5f-cd77c6e48ffc"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Gk7tUJ89xcHMCnQH2TBUYZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LdNGieb7uVp17hkcxGZtsc","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","old_string":"        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              {search || filterActive !== \"all\"\n                ? \"Nenhum paciente encontrado\"\n                : \"Nenhum paciente cadastrado\"}\n            </div>\n          ) : (","new_string":"        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <EmptyState\n              title={search || filterActive !== \"all\" ? \"Nenhum paciente encontrado\" : \"Nenhum paciente cadastrado\"}\n              message={search || filterActive !== \"all\" ? \"Tente ajustar os filtros de busca\" : \"Adicione seu primeiro paciente para comecar\"}\n              action={isAdmin && !search && filterActive === \"all\" ? { label: \"Adicionar paciente\", onClick: openCreateSheet } : undefined}\n              icon={\n                <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n                </svg>\n              }\n            />\n          ) : ("}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":252,"cache_read_input_tokens":111673,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":252},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e0e90436-dfb3-487f-953d-dc3e1f03ac51"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LdNGieb7uVp17hkcxGZtsc","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/patients/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"9ca1076b-b4c9-449c-b607-568380482311","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","oldString":"        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              {search || filterActive !== \"all\"\n                ? \"Nenhum paciente encontrado\"\n                : \"Nenhum paciente cadastrado\"}\n            </div>\n          ) : (","newString":"        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <EmptyState\n              title={search || filterActive !== \"all\" ? \"Nenhum paciente encontrado\" : \"Nenhum paciente cadastrado\"}\n              message={search || filterActive !== \"all\" ? \"Tente ajustar os filtros de busca\" : \"Adicione seu primeiro paciente para comecar\"}\n              action={isAdmin && !search && filterActive === \"all\" ? { label: \"Adicionar paciente\", onClick: openCreateSheet } : undefined}\n              icon={\n                <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n                </svg>\n              }\n            />\n          ) : (","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"\n\n// WhatsApp format validation\nconst phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n\nconst patientSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n  phone: z\n    .string()\n    .min(1, \"Telefone é obrigatório\")\n    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n  consentWhatsApp: z.boolean(),\n  consentEmail: z.boolean(),\n})\n\ntype PatientFormData = z.infer<typeof patientSchema>\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface Patient {\n  id: string\n  name: string\n  email: string | null\n  phone: string\n  birthDate: string | null\n  notes: string | null\n  isActive: boolean\n  lastVisitAt: string | null\n  consentWhatsApp: boolean\n  consentWhatsAppAt: string | null\n  consentEmail: boolean\n  consentEmailAt: string | null\n  createdAt: string\n  appointments?: Appointment[]\n}\n\nfunction formatPhone(phone: string): string {\n  // Format: (11) 99999-9999\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"-\"\n  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Não compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800\",\n  CONFIRMADO: \"bg-green-100 text-green-800\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n  FINALIZADO: \"bg-gray-100 text-gray-800\",\n}\n\nexport default function PatientsPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [search, setSearch] = useState(\"\")\n  const [filterActive, setFilterActive] = useState<string>(\"all\")\n  const [isSheetOpen, setIsSheetOpen] = useState(false)\n  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n  const [isSaving, setIsSaving] = useState(false)\n  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    formState: { errors },\n  } = useForm<PatientFormData>({\n    resolver: zodResolver(patientSchema),\n    defaultValues: {\n      consentWhatsApp: false,\n      consentEmail: false,\n    },\n  })\n\n  const fetchPatients = useCallback(async () => {\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set(\"search\", search)\n      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch patients\")\n      }\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      toast.error(\"Erro ao carregar pacientes\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [search, filterActive, router])\n\n  const fetchPatientDetails = useCallback(async (patientId: string) => {\n    setIsLoadingDetails(true)\n    try {\n      const response = await fetch(`/api/patients/${patientId}`)\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch patient details\")\n      }\n      const data = await response.json()\n      setViewingPatient(data.patient)\n    } catch {\n      toast.error(\"Erro ao carregar detalhes do paciente\")\n    } finally {\n      setIsLoadingDetails(false)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchPatients()\n    }\n  }, [status, router, fetchPatients])\n\n  function openCreateSheet() {\n    setEditingPatient(null)\n    setViewingPatient(null)\n    reset({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      notes: \"\",\n      consentWhatsApp: false,\n      consentEmail: false,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openEditSheet(patient: Patient) {\n    setEditingPatient(patient)\n    setViewingPatient(null)\n    reset({\n      name: patient.name,\n      phone: patient.phone,\n      email: patient.email ?? \"\",\n      notes: patient.notes ?? \"\",\n      consentWhatsApp: patient.consentWhatsApp,\n      consentEmail: patient.consentEmail,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openViewSheet(patient: Patient) {\n    setEditingPatient(null)\n    fetchPatientDetails(patient.id)\n    setIsSheetOpen(true)\n  }\n\n  function closeSheet() {\n    setIsSheetOpen(false)\n    setEditingPatient(null)\n    setViewingPatient(null)\n  }\n\n  async function onSubmit(data: PatientFormData) {\n    setIsSaving(true)\n    try {\n      const url = editingPatient\n        ? `/api/patients/${editingPatient.id}`\n        : \"/api/patients\"\n      const method = editingPatient ? \"PATCH\" : \"POST\"\n\n      const payload: Record<string, unknown> = {\n        name: data.name,\n        phone: data.phone.replace(/\\D/g, \"\"),\n        email: data.email || null,\n        notes: data.notes || null,\n        consentWhatsApp: data.consentWhatsApp,\n        consentEmail: data.consentEmail,\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save patient\")\n      }\n\n      toast.success(\n        editingPatient\n          ? \"Paciente atualizado com sucesso\"\n          : \"Paciente criado com sucesso\"\n      )\n      closeSheet()\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function handleDeactivate(patient: Patient) {\n    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n      return\n    }\n\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to deactivate patient\")\n      }\n\n      toast.success(\"Paciente desativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n    }\n  }\n\n  async function handleReactivate(patient: Patient) {\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isActive: true }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to reactivate patient\")\n      }\n\n      toast.success(\"Paciente reativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n    }\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonPage />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n          {isAdmin && (\n            <button\n              onClick={openCreateSheet}\n              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n            >\n              + Novo Paciente\n            </button>\n          )}\n        </div>\n\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1\">\n            <input\n              type=\"text\"\n              placeholder=\"Buscar por nome, email ou telefone...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            />\n          </div>\n          <select\n            value={filterActive}\n            onChange={(e) => setFilterActive(e.target.value)}\n            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n          >\n            <option value=\"all\">Todos</option>\n            <option value=\"true\">Ativos</option>\n            <option value=\"false\">Inativos</option>\n          </select>\n        </div>\n\n        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              {search || filterActive !== \"all\"\n                ? \"Nenhum paciente encontrado\"\n                : \"Nenhum paciente cadastrado\"}\n            </div>\n          ) : (\n            patients.map((patient) => (\n              <div\n                key={patient.id}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !patient.isActive ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                  <div\n                    className=\"flex-1 min-w-0 cursor-pointer\"\n                    onClick={() => openViewSheet(patient)}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <h3 className=\"font-medium text-foreground truncate\">\n                        {patient.name}\n                      </h3>\n                      {!patient.isActive && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n                          Inativo\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatPhone(patient.phone)}\n                    </p>\n                    {patient.email && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {patient.email}\n                      </p>\n                    )}\n                    <div className=\"flex gap-3 mt-2\">\n                      {patient.consentWhatsApp && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n                          WhatsApp\n                        </span>\n                      )}\n                      {patient.consentEmail && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n                          Email\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  {isAdmin && (\n                    <div className=\"flex gap-2\">\n                      <button\n                        onClick={() => openEditSheet(patient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                      {patient.isActive ? (\n                        <button\n                          onClick={() => handleDeactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Desativar\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => handleReactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Reativar\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>\n                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n                        </div>\n                      </div>\n\n                      {/* Notes */}\n                      {viewingPatient.notes && (\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n                        </div>\n                      )}\n\n                      {/* Consent Info */}\n                      <div>\n                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">WhatsApp</span>\n                            {viewingPatient.consentWhatsAppAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">Email</span>\n                            {viewingPatient.consentEmailAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentEmailAt)})\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Appointment History */}\n                      <div>\n                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n                          Historico de Consultas\n                        </h3>\n                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {viewingPatient.appointments.map((appointment) => (\n                              <div\n                                key={appointment.id}\n                                className=\"bg-muted/50 rounded-lg p-4\"\n                              >\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <span className=\"font-medium\">\n                                    {formatDateTime(appointment.scheduledAt)}\n                                  </span>\n                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n                                    {statusLabels[appointment.status] || appointment.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.professionalProfile.user.name}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                                </p>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-muted-foreground text-sm\">\n                            Nenhuma consulta registrada\n                          </p>\n                        )}\n                      </div>\n\n                      <div className=\"pt-4\">\n                        <button\n                          type=\"button\"\n                          onClick={closeSheet}\n                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Fechar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Create/Edit Mode */}\n              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n                <>\n                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n                  </h2>\n\n                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div>\n                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Nome *\n                      </label>\n                      <input\n                        id=\"name\"\n                        type=\"text\"\n                        {...register(\"name\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.name && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Telefone (WhatsApp) *\n                      </label>\n                      <input\n                        id=\"phone\"\n                        type=\"tel\"\n                        {...register(\"phone\")}\n                        placeholder=\"11999999999\"\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.phone && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Formato: DDD + numero (ex: 11999999999)\n                      </p>\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Email\n                      </label>\n                      <input\n                        id=\"email\"\n                        type=\"email\"\n                        {...register(\"email\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.email && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Observacoes administrativas\n                      </label>\n                      <textarea\n                        id=\"notes\"\n                        rows={3}\n                        {...register(\"notes\")}\n                        placeholder=\"Observacoes internas sobre o paciente...\"\n                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                      />\n                      {errors.notes && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                      )}\n                    </div>\n\n                    {/* LGPD Consent Section */}\n                    <div className=\"border border-border rounded-lg p-4\">\n                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n                        Consentimentos LGPD\n                      </h3>\n                      <div className=\"space-y-4\">\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentWhatsApp\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber mensagens via WhatsApp\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentEmail\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber comunicacoes por email\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                      <button\n                        type=\"submit\"\n                        disabled={isSaving}\n                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                      >\n                        {isSaving\n                          ? \"Salvando...\"\n                          : editingPatient\n                          ? \"Salvar alteracoes\"\n                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":372,"oldLines":11,"newStart":372,"newLines":16,"lines":["         {/* Patients List */}","         <div className=\"space-y-4\">","           {patients.length === 0 ? (","-            <div className=\"text-center py-12 text-muted-foreground\">","-              {search || filterActive !== \"all\"","-                ? \"Nenhum paciente encontrado\"","-                : \"Nenhum paciente cadastrado\"}","-            </div>","+            <EmptyState","+              title={search || filterActive !== \"all\" ? \"Nenhum paciente encontrado\" : \"Nenhum paciente cadastrado\"}","+              message={search || filterActive !== \"all\" ? \"Tente ajustar os filtros de busca\" : \"Adicione seu primeiro paciente para comecar\"}","+              action={isAdmin && !search && filterActive === \"all\" ? { label: \"Adicionar paciente\", onClick: openCreateSheet } : undefined}","+              icon={","+                <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">","+                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />","+                </svg>","+              }","+            />","           ) : (","             patients.map((patient) => (","               <div"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KwMQNAQtCnftRnyYPaKit7","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the bottom navigation and FAB to the patients page, and replace the style jsx."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":613,"cache_read_input_tokens":111925,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":613},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2c7e3143-46c3-4a3c-8fe3-97733ca9774f"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KwMQNAQtCnftRnyYPaKit7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011vD7zhe9uFvughBYm2yjNd","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","offset":450,"limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":613,"cache_read_input_tokens":111925,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":613},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"8c3fbc97-8971-4061-9b89-5169d86ef3e1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011vD7zhe9uFvughBYm2yjNd","type":"tool_result","content":"   450→                        </button>\n   451→                      )}\n   452→                    </div>\n   453→                  )}\n   454→                </div>\n   455→              </div>\n   456→            ))\n   457→          )}\n   458→        </div>\n   459→      </div>\n   460→\n   461→      {/* Bottom Sheet */}\n   462→      {isSheetOpen && (\n   463→        <>\n   464→          {/* Backdrop */}\n   465→          <div\n   466→            className=\"fixed inset-0 bg-black/50 z-40\"\n   467→            onClick={closeSheet}\n   468→          />\n   469→          {/* Sheet */}\n   470→          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n   471→            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n   472→              {/* Handle */}\n   473→              <div className=\"flex justify-center mb-4\">\n   474→                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n   475→              </div>\n   476→\n   477→              {/* View Mode */}\n   478→              {viewingPatient && !editingPatient && (\n   479→                <>\n   480→                  <div className=\"flex items-center justify-between mb-6\">\n   481→                    <h2 className=\"text-xl font-semibold text-foreground\">\n   482→                      {viewingPatient.name}\n   483→                    </h2>\n   484→                    {isAdmin && (\n   485→                      <button\n   486→                        onClick={() => openEditSheet(viewingPatient)}\n   487→                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   488→                      >\n   489→                        Editar\n   490→                      </button>\n   491→                    )}\n   492→                  </div>\n   493→\n   494→                  {isLoadingDetails ? (\n   495→                    <div className=\"animate-pulse space-y-4\">\n   496→                      <div className=\"h-6 w-32 bg-muted rounded\" />\n   497→                      <div className=\"h-4 w-48 bg-muted rounded\" />\n   498→                      <div className=\"h-4 w-40 bg-muted rounded\" />\n   499→                    </div>\n   500→                  ) : (\n   501→                    <div className=\"space-y-6\">\n   502→                      {/* Contact Info */}\n   503→                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n   504→                        <div>\n   505→                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n   506→                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n   507→                        </div>\n   508→                        <div>\n   509→                          <label className=\"text-sm text-muted-foreground\">Email</label>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"42ff1c2b-3b7e-466a-8063-2a1fd00193ec","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","content":"                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>","numLines":60,"startLine":450,"totalLines":755}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_013t4KjAVYoS1yrGFeGWcu9J","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01A9uM7ZPr1joVYQdEQDmHZm","name":"Read","input":{"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","offset":720,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1103,"cache_read_input_tokens":112538,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1103},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"bcb7dc6e-0070-4b4c-8d12-02a00a4d2961"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01A9uM7ZPr1joVYQdEQDmHZm","type":"tool_result","content":"   720→                          : \"Criar paciente\"}\n   721→                      </button>\n   722→                      <button\n   723→                        type=\"button\"\n   724→                        onClick={closeSheet}\n   725→                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n   726→                      >\n   727→                        Cancelar\n   728→                      </button>\n   729→                    </div>\n   730→                  </form>\n   731→                </>\n   732→              )}\n   733→            </div>\n   734→          </div>\n   735→        </>\n   736→      )}\n   737→\n   738→      {/* Animation Styles */}\n   739→      <style jsx>{`\n   740→        @keyframes slide-up {\n   741→          from {\n   742→            transform: translateY(100%);\n   743→          }\n   744→          to {\n   745→            transform: translateY(0);\n   746→          }\n   747→        }\n   748→        .animate-slide-up {\n   749→          animation: slide-up 0.3s ease-out;\n   750→        }\n   751→      `}</style>\n   752→    </main>\n   753→  )\n   754→}\n   755→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"5e59d25e-3500-4bc3-9a13-16d6114ba5c4","tool_use_result":{"type":"text","file":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","content":"                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","numLines":36,"startLine":720,"totalLines":755}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_011y2paXWjhaBXTguc8NWLR1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MozXLFeMG68qDJ7JQ38UYZ","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","old_string":"      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}","new_string":"      {/* FAB for adding patients */}\n      {isAdmin && (\n        <FAB onClick={openCreateSheet} label=\"Novo paciente\" />\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":584,"cache_read_input_tokens":113641,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":584},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"c036f09b-c8b2-43d9-a5c6-b1604b246ee6"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MozXLFeMG68qDJ7JQ38UYZ","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/patients/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"fbe9f506-0bb8-46e9-a04a-dcd24e3bcd40","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","oldString":"      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}","newString":"      {/* FAB for adding patients */}\n      {isAdmin && (\n        <FAB onClick={openCreateSheet} label=\"Novo paciente\" />\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"\n\n// WhatsApp format validation\nconst phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n\nconst patientSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n  phone: z\n    .string()\n    .min(1, \"Telefone é obrigatório\")\n    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n  consentWhatsApp: z.boolean(),\n  consentEmail: z.boolean(),\n})\n\ntype PatientFormData = z.infer<typeof patientSchema>\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface Patient {\n  id: string\n  name: string\n  email: string | null\n  phone: string\n  birthDate: string | null\n  notes: string | null\n  isActive: boolean\n  lastVisitAt: string | null\n  consentWhatsApp: boolean\n  consentWhatsAppAt: string | null\n  consentEmail: boolean\n  consentEmailAt: string | null\n  createdAt: string\n  appointments?: Appointment[]\n}\n\nfunction formatPhone(phone: string): string {\n  // Format: (11) 99999-9999\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"-\"\n  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Não compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800\",\n  CONFIRMADO: \"bg-green-100 text-green-800\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n  FINALIZADO: \"bg-gray-100 text-gray-800\",\n}\n\nexport default function PatientsPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [search, setSearch] = useState(\"\")\n  const [filterActive, setFilterActive] = useState<string>(\"all\")\n  const [isSheetOpen, setIsSheetOpen] = useState(false)\n  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n  const [isSaving, setIsSaving] = useState(false)\n  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    formState: { errors },\n  } = useForm<PatientFormData>({\n    resolver: zodResolver(patientSchema),\n    defaultValues: {\n      consentWhatsApp: false,\n      consentEmail: false,\n    },\n  })\n\n  const fetchPatients = useCallback(async () => {\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set(\"search\", search)\n      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch patients\")\n      }\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      toast.error(\"Erro ao carregar pacientes\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [search, filterActive, router])\n\n  const fetchPatientDetails = useCallback(async (patientId: string) => {\n    setIsLoadingDetails(true)\n    try {\n      const response = await fetch(`/api/patients/${patientId}`)\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch patient details\")\n      }\n      const data = await response.json()\n      setViewingPatient(data.patient)\n    } catch {\n      toast.error(\"Erro ao carregar detalhes do paciente\")\n    } finally {\n      setIsLoadingDetails(false)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchPatients()\n    }\n  }, [status, router, fetchPatients])\n\n  function openCreateSheet() {\n    setEditingPatient(null)\n    setViewingPatient(null)\n    reset({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      notes: \"\",\n      consentWhatsApp: false,\n      consentEmail: false,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openEditSheet(patient: Patient) {\n    setEditingPatient(patient)\n    setViewingPatient(null)\n    reset({\n      name: patient.name,\n      phone: patient.phone,\n      email: patient.email ?? \"\",\n      notes: patient.notes ?? \"\",\n      consentWhatsApp: patient.consentWhatsApp,\n      consentEmail: patient.consentEmail,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openViewSheet(patient: Patient) {\n    setEditingPatient(null)\n    fetchPatientDetails(patient.id)\n    setIsSheetOpen(true)\n  }\n\n  function closeSheet() {\n    setIsSheetOpen(false)\n    setEditingPatient(null)\n    setViewingPatient(null)\n  }\n\n  async function onSubmit(data: PatientFormData) {\n    setIsSaving(true)\n    try {\n      const url = editingPatient\n        ? `/api/patients/${editingPatient.id}`\n        : \"/api/patients\"\n      const method = editingPatient ? \"PATCH\" : \"POST\"\n\n      const payload: Record<string, unknown> = {\n        name: data.name,\n        phone: data.phone.replace(/\\D/g, \"\"),\n        email: data.email || null,\n        notes: data.notes || null,\n        consentWhatsApp: data.consentWhatsApp,\n        consentEmail: data.consentEmail,\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save patient\")\n      }\n\n      toast.success(\n        editingPatient\n          ? \"Paciente atualizado com sucesso\"\n          : \"Paciente criado com sucesso\"\n      )\n      closeSheet()\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function handleDeactivate(patient: Patient) {\n    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n      return\n    }\n\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to deactivate patient\")\n      }\n\n      toast.success(\"Paciente desativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n    }\n  }\n\n  async function handleReactivate(patient: Patient) {\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isActive: true }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to reactivate patient\")\n      }\n\n      toast.success(\"Paciente reativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n    }\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonPage />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n          {isAdmin && (\n            <button\n              onClick={openCreateSheet}\n              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n            >\n              + Novo Paciente\n            </button>\n          )}\n        </div>\n\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1\">\n            <input\n              type=\"text\"\n              placeholder=\"Buscar por nome, email ou telefone...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            />\n          </div>\n          <select\n            value={filterActive}\n            onChange={(e) => setFilterActive(e.target.value)}\n            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n          >\n            <option value=\"all\">Todos</option>\n            <option value=\"true\">Ativos</option>\n            <option value=\"false\">Inativos</option>\n          </select>\n        </div>\n\n        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <EmptyState\n              title={search || filterActive !== \"all\" ? \"Nenhum paciente encontrado\" : \"Nenhum paciente cadastrado\"}\n              message={search || filterActive !== \"all\" ? \"Tente ajustar os filtros de busca\" : \"Adicione seu primeiro paciente para comecar\"}\n              action={isAdmin && !search && filterActive === \"all\" ? { label: \"Adicionar paciente\", onClick: openCreateSheet } : undefined}\n              icon={\n                <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n                </svg>\n              }\n            />\n          ) : (\n            patients.map((patient) => (\n              <div\n                key={patient.id}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !patient.isActive ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                  <div\n                    className=\"flex-1 min-w-0 cursor-pointer\"\n                    onClick={() => openViewSheet(patient)}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <h3 className=\"font-medium text-foreground truncate\">\n                        {patient.name}\n                      </h3>\n                      {!patient.isActive && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n                          Inativo\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatPhone(patient.phone)}\n                    </p>\n                    {patient.email && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {patient.email}\n                      </p>\n                    )}\n                    <div className=\"flex gap-3 mt-2\">\n                      {patient.consentWhatsApp && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n                          WhatsApp\n                        </span>\n                      )}\n                      {patient.consentEmail && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n                          Email\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  {isAdmin && (\n                    <div className=\"flex gap-2\">\n                      <button\n                        onClick={() => openEditSheet(patient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                      {patient.isActive ? (\n                        <button\n                          onClick={() => handleDeactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Desativar\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => handleReactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Reativar\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>\n                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n                        </div>\n                      </div>\n\n                      {/* Notes */}\n                      {viewingPatient.notes && (\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n                        </div>\n                      )}\n\n                      {/* Consent Info */}\n                      <div>\n                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">WhatsApp</span>\n                            {viewingPatient.consentWhatsAppAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">Email</span>\n                            {viewingPatient.consentEmailAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentEmailAt)})\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Appointment History */}\n                      <div>\n                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n                          Historico de Consultas\n                        </h3>\n                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {viewingPatient.appointments.map((appointment) => (\n                              <div\n                                key={appointment.id}\n                                className=\"bg-muted/50 rounded-lg p-4\"\n                              >\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <span className=\"font-medium\">\n                                    {formatDateTime(appointment.scheduledAt)}\n                                  </span>\n                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n                                    {statusLabels[appointment.status] || appointment.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.professionalProfile.user.name}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                                </p>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-muted-foreground text-sm\">\n                            Nenhuma consulta registrada\n                          </p>\n                        )}\n                      </div>\n\n                      <div className=\"pt-4\">\n                        <button\n                          type=\"button\"\n                          onClick={closeSheet}\n                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Fechar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Create/Edit Mode */}\n              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n                <>\n                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n                  </h2>\n\n                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div>\n                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Nome *\n                      </label>\n                      <input\n                        id=\"name\"\n                        type=\"text\"\n                        {...register(\"name\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.name && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Telefone (WhatsApp) *\n                      </label>\n                      <input\n                        id=\"phone\"\n                        type=\"tel\"\n                        {...register(\"phone\")}\n                        placeholder=\"11999999999\"\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.phone && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Formato: DDD + numero (ex: 11999999999)\n                      </p>\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Email\n                      </label>\n                      <input\n                        id=\"email\"\n                        type=\"email\"\n                        {...register(\"email\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.email && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Observacoes administrativas\n                      </label>\n                      <textarea\n                        id=\"notes\"\n                        rows={3}\n                        {...register(\"notes\")}\n                        placeholder=\"Observacoes internas sobre o paciente...\"\n                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                      />\n                      {errors.notes && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                      )}\n                    </div>\n\n                    {/* LGPD Consent Section */}\n                    <div className=\"border border-border rounded-lg p-4\">\n                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n                        Consentimentos LGPD\n                      </h3>\n                      <div className=\"space-y-4\">\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentWhatsApp\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber mensagens via WhatsApp\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentEmail\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber comunicacoes por email\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                      <button\n                        type=\"submit\"\n                        disabled={isSaving}\n                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                      >\n                        {isSaving\n                          ? \"Salvando...\"\n                          : editingPatient\n                          ? \"Salvar alteracoes\"\n                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Animation Styles */}\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":735,"oldLines":20,"newStart":735,"newLines":13,"lines":["         </>","       )}"," ","-      {/* Animation Styles */}","-      <style jsx>{`","-        @keyframes slide-up {","-          from {","-            transform: translateY(100%);","-          }","-          to {","-            transform: translateY(0);","-          }","-        }","-        .animate-slide-up {","-          animation: slide-up 0.3s ease-out;","-        }","-      `}</style>","+      {/* FAB for adding patients */}","+      {isAdmin && (","+        <FAB onClick={openCreateSheet} label=\"Novo paciente\" />","+      )}","+","+      {/* Bottom Navigation */}","+      <BottomNavigation />","     </main>","   )"," }"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014xDNN9L61yerpCxxQXKRUX","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the settings/availability page."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":600,"cache_read_input_tokens":114225,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":600},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f7f08355-49ec-4f7c-908c-4fc60194e15b"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014xDNN9L61yerpCxxQXKRUX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01C3bqKioYGjWKHt4krY1Mn3","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"","new_string":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":600,"cache_read_input_tokens":114225,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":600},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"118d6c2c-c3fc-467b-9f3a-fc96b75ad1e2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01C3bqKioYGjWKHt4krY1Mn3","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f7a0dc59-579e-4f44-969c-5a8d40b83b7e","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"","newString":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"animate-pulse space-y-6\">\n          <div className=\"h-8 w-48 bg-muted rounded\" />\n          <div className=\"space-y-4\">\n            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n              <div key={i} className=\"h-20 bg-muted rounded\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":4,"oldLines":6,"newStart":4,"newLines":7,"lines":[" import { useRouter, useSearchParams } from \"next/navigation\""," import { useSession } from \"next-auth/react\""," import { toast } from \"sonner\"","+import { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\""," "," const DAYS_OF_WEEK = [","   { value: 0, label: \"Domingo\", short: \"Dom\" },"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TNAUvrS3f2rfbjcHLgULRz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TfraNmpVw7BWV5jaVP578U","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"function LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"animate-pulse space-y-6\">\n          <div className=\"h-8 w-48 bg-muted rounded\" />\n          <div className=\"space-y-4\">\n            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n              <div key={i} className=\"h-20 bg-muted rounded\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    </main>\n  )\n}","new_string":"function LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":114825,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7cbb755c-47e8-4253-8be4-6ac51f300bc2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TfraNmpVw7BWV5jaVP578U","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"bb5af97a-357f-405a-8aca-d4856ef451fa","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"function LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"animate-pulse space-y-6\">\n          <div className=\"h-8 w-48 bg-muted rounded\" />\n          <div className=\"space-y-4\">\n            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n              <div key={i} className=\"h-20 bg-muted rounded\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    </main>\n  )\n}","newString":"function LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"animate-pulse space-y-6\">\n          <div className=\"h-8 w-48 bg-muted rounded\" />\n          <div className=\"space-y-4\">\n            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n              <div key={i} className=\"h-20 bg-muted rounded\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":44,"oldLines":17,"newStart":44,"newLines":11,"lines":[" "," function LoadingState() {","   return (","-    <main className=\"min-h-screen bg-background\">","+    <main className=\"min-h-screen bg-background pb-20\">","       <div className=\"max-w-4xl mx-auto px-4 py-8\">","-        <div className=\"animate-pulse space-y-6\">","-          <div className=\"h-8 w-48 bg-muted rounded\" />","-          <div className=\"space-y-4\">","-            {[1, 2, 3, 4, 5, 6, 7].map((i) => (","-              <div key={i} className=\"h-20 bg-muted rounded\" />","-            ))}","-          </div>","-        </div>","+        <SkeletonPage />","       </div>","+      <BottomNavigation />","     </main>","   )"," }"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_011UctLqQA7cdi8VBacaHVs1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018kr7aFAdCZdFdbyRkFP1tS","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }","new_string":"  if (status === \"loading\" || isLoading) {\n    return <LoadingState />\n  }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":431,"cache_read_input_tokens":115159,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":431},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2baa7055-88df-43cd-b730-0e0b34dec960"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018kr7aFAdCZdFdbyRkFP1tS","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"cfe12577-aa06-476a-8441-bf162a7cfeb0","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }","newString":"  if (status === \"loading\" || isLoading) {\n    return <LoadingState />\n  }","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <div className=\"animate-pulse space-y-6\">\n            <div className=\"h-8 w-48 bg-muted rounded\" />\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n                <div key={i} className=\"h-20 bg-muted rounded\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":464,"oldLines":20,"newStart":464,"newLines":7,"lines":["   }"," ","   if (status === \"loading\" || isLoading) {","-    return (","-      <main className=\"min-h-screen bg-background\">","-        <div className=\"max-w-4xl mx-auto px-4 py-8\">","-          <div className=\"animate-pulse space-y-6\">","-            <div className=\"h-8 w-48 bg-muted rounded\" />","-            <div className=\"space-y-4\">","-              {[1, 2, 3, 4, 5, 6, 7].map((i) => (","-                <div key={i} className=\"h-20 bg-muted rounded\" />","-              ))}","-            </div>","-          </div>","-        </div>","-      </main>","-    )","+    return <LoadingState />","   }"," ","   return ("]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A2FqvufQAkBpftFkywdR8Q","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the main content area and add bottom navigation."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":383,"cache_read_input_tokens":115590,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":383},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"2ccf9e57-45d9-4faf-b9cf-d35e7215e699"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A2FqvufQAkBpftFkywdR8Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U2G4xxPvuoNAU8Tto5XmqE","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>","new_string":"  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"min-h-[44px] min-w-[44px] flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors touch-manipulation\"\n          >\n            &larr; Voltar\n          </button>\n        </div>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":383,"cache_read_input_tokens":115590,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":383},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e2144474-56cf-4ffa-acab-0ae2de0c4cad"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U2G4xxPvuoNAU8Tto5XmqE","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"73deaf1c-6f0e-47ed-b406-edad3f64943c","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>","newString":"  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"min-h-[44px] min-w-[44px] flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors touch-manipulation\"\n          >\n            &larr; Voltar\n          </button>\n        </div>","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return <LoadingState />\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":468,"oldLines":12,"newStart":468,"newLines":12,"lines":["   }"," ","   return (","-    <main className=\"min-h-screen bg-background\">","+    <main className=\"min-h-screen bg-background pb-20\">","       <div className=\"max-w-4xl mx-auto px-4 py-8\">","         <div className=\"mb-6\">","           <button","             onClick={() => router.back()}","-            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"","+            className=\"min-h-[44px] min-w-[44px] flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors touch-manipulation\"","           >","             &larr; Voltar","           </button>"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YRpHnsbVet6uggqaqfBAB9","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add bottom navigation and remove the style jsx at the end."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":431,"cache_read_input_tokens":115973,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":431},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"ce04cc1f-b53b-4ca1-b48a-576ced9e244c"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YRpHnsbVet6uggqaqfBAB9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Jjc6vvY57pcyyBoxh7kjRw","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}","new_string":"      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":431,"cache_read_input_tokens":115973,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":431},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"949fc292-1d69-44f7-bb3b-d3ed6e4e66e0"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Jjc6vvY57pcyyBoxh7kjRw","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"462db709-abb5-4e95-8ed3-aeaa0d99a1f3","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}","newString":"      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return <LoadingState />\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"min-h-[44px] min-w-[44px] flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors touch-manipulation\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      <style jsx>{`\n        @keyframes slide-up {\n          from {\n            transform: translateY(100%);\n          }\n          to {\n            transform: translateY(0);\n          }\n        }\n        .animate-slide-up {\n          animation: slide-up 0.3s ease-out;\n        }\n      `}</style>\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":1019,"oldLines":19,"newStart":1019,"newLines":8,"lines":["         </>","       )}"," ","-      <style jsx>{`","-        @keyframes slide-up {","-          from {","-            transform: translateY(100%);","-          }","-          to {","-            transform: translateY(0);","-          }","-        }","-        .animate-slide-up {","-          animation: slide-up 0.3s ease-out;","-        }","-      `}</style>","+      {/* Bottom Navigation */}","+      <BottomNavigation />","     </main>","   )"," }"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01W13Qezw7161urqHfn85YLo","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update some touch targets to ensure they are at least 44px. Let me update the toggle buttons and time block buttons."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":308,"cache_read_input_tokens":116404,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":308},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"47b25ca2-1e3b-4611-bbea-c3a300b9294d"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01W13Qezw7161urqHfn85YLo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VaMeNM5SeagtreCC2tJZ5X","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>","new_string":"                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-14 h-8 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1.5 w-5 h-5 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-8\" : \"left-1\"\n                        }`}\n                      />\n                    </button>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":308,"cache_read_input_tokens":116404,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":308},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f887b33b-d42f-456d-b392-a771b47d7a7e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VaMeNM5SeagtreCC2tJZ5X","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7abd5d02-b773-400d-b570-85a81693a75f","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>","newString":"                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-14 h-8 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1.5 w-5 h-5 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-8\" : \"left-1\"\n                        }`}\n                      />\n                    </button>","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return <LoadingState />\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"min-h-[44px] min-w-[44px] flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors touch-manipulation\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-7\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":537,"oldLines":14,"newStart":537,"newLines":14,"lines":["                     <button","                       type=\"button\"","                       onClick={() => toggleDayActive(day.value)}","-                      className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${","+                      className={`relative w-14 h-8 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${","                         allActive ? \"bg-primary\" : \"bg-muted\"","                       }`}","                       aria-label={`Toggle ${day.label}`}","                     >","                       <span","-                        className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${","-                          allActive ? \"left-7\" : \"left-1\"","+                        className={`absolute top-1.5 w-5 h-5 rounded-full bg-white transition-transform ${","+                          allActive ? \"left-8\" : \"left-1\"","                         }`}","                       />","                     </button>"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HdtkdKGnfKoxauUU8QVFX3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018P6zgxUDCF9dT7mqEsdAKS","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>","new_string":"                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`min-h-[44px] px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":846,"cache_read_input_tokens":116712,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":846},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"5b78c28d-3bb4-4698-9530-c0ee5edb5ca1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018P6zgxUDCF9dT7mqEsdAKS","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"eed0e701-a5d4-416b-b703-67f463b65bb7","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>","newString":"                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`min-h-[44px] px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return <LoadingState />\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"min-h-[44px] min-w-[44px] flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors touch-manipulation\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-14 h-8 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1.5 w-5 h-5 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-8\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":561,"oldLines":7,"newStart":561,"newLines":7,"lines":["                         key={rule.id || `${day.value}-${index}`}","                         type=\"button\"","                         onClick={() => openBlockEditor(day.value, index)}","-                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${","+                        className={`min-h-[44px] px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${","                           rule.isActive","                             ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"","                             : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\""]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0166vD4oxu88Bj4gEZf71DSA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019wvjLFarvFhjd9HrJZhkh5","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","old_string":"                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>","new_string":"                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"min-h-[44px] px-4 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation\"\n                    >\n                      + Adicionar\n                    </button>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":584,"cache_read_input_tokens":117558,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":584},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"ba4b9ace-8f4d-4d92-b883-e7310acb27c4"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019wvjLFarvFhjd9HrJZhkh5","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"ae6929c2-2701-4309-a46d-1d2e08696b75","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/settings/availability/page.tsx","oldString":"                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>","newString":"                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"min-h-[44px] px-4 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation\"\n                    >\n                      + Adicionar\n                    </button>","originalFile":"\"use client\"\n\nimport { Suspense, useCallback, useEffect, useState } from \"react\"\nimport { useRouter, useSearchParams } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { toast } from \"sonner\"\nimport { BottomNavigation, SkeletonPage } from \"@/shared/components/ui\"\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Domingo\", short: \"Dom\" },\n  { value: 1, label: \"Segunda\", short: \"Seg\" },\n  { value: 2, label: \"Terça\", short: \"Ter\" },\n  { value: 3, label: \"Quarta\", short: \"Qua\" },\n  { value: 4, label: \"Quinta\", short: \"Qui\" },\n  { value: 5, label: \"Sexta\", short: \"Sex\" },\n  { value: 6, label: \"Sábado\", short: \"Sáb\" },\n]\n\ninterface TimeBlock {\n  id?: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n  createdAt: string\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n  } | null\n}\n\nfunction LoadingState() {\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <SkeletonPage />\n      </div>\n      <BottomNavigation />\n    </main>\n  )\n}\n\nexport default function AvailabilitySettingsPage() {\n  return (\n    <Suspense fallback={<LoadingState />}>\n      <AvailabilitySettingsContent />\n    </Suspense>\n  )\n}\n\nfunction AvailabilitySettingsContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { data: session, status } = useSession()\n\n  const [isLoading, setIsLoading] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [rules, setRules] = useState<TimeBlock[]>([])\n  const [editingBlock, setEditingBlock] = useState<{\n    dayOfWeek: number\n    index: number | null\n    block: TimeBlock\n  } | null>(null)\n\n  // Exceptions state\n  const [exceptions, setExceptions] = useState<AvailabilityException[]>([])\n  const [editingException, setEditingException] = useState<{\n    id?: string\n    date: string\n    isAvailable: boolean\n    startTime: string | null\n    endTime: string | null\n    reason: string | null\n    isFullDay: boolean\n  } | null>(null)\n  const [isDeletingException, setIsDeletingException] = useState<string | null>(null)\n\n  // ADMIN-only: professional selection\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string | null>(null)\n  const professionalIdParam = searchParams.get(\"professionalId\")\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals?isActive=true\")\n      if (response.ok) {\n        const data = await response.json()\n        setProfessionals(data.professionals)\n      }\n    } catch {\n      // Ignore errors for professional list\n    }\n  }, [isAdmin])\n\n  const fetchExceptions = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (response.ok) {\n        const data = await response.json()\n        setExceptions(data.exceptions || [])\n      }\n    } catch {\n      // Silently fail for exceptions\n    }\n  }, [])\n\n  const fetchAvailability = useCallback(async (profileId?: string | null) => {\n    try {\n      const params = new URLSearchParams()\n      if (profileId) {\n        params.set(\"professionalProfileId\", profileId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n\n      // Also fetch exceptions\n      await fetchExceptions(profileId)\n    } catch {\n      toast.error(\"Erro ao carregar disponibilidade\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [router, fetchExceptions])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchProfessionals()\n\n      // If ADMIN with professionalId param, use that\n      if (isAdmin && professionalIdParam) {\n        setSelectedProfessionalId(professionalIdParam)\n        // Find the professional profile ID\n        const prof = professionals.find((p) => p.id === professionalIdParam)\n        if (prof?.professionalProfile?.id) {\n          fetchAvailability(prof.professionalProfile.id)\n        } else {\n          // Fetch all professionals first, then get availability\n          fetch(\"/api/professionals?isActive=true\")\n            .then((res) => res.json())\n            .then((data) => {\n              const foundProf = data.professionals?.find(\n                (p: Professional) => p.id === professionalIdParam\n              )\n              if (foundProf?.professionalProfile?.id) {\n                fetchAvailability(foundProf.professionalProfile.id)\n              } else {\n                setIsLoading(false)\n              }\n            })\n            .catch(() => setIsLoading(false))\n        }\n      } else {\n        fetchAvailability()\n      }\n    }\n  }, [status, router, fetchProfessionals, fetchAvailability, isAdmin, professionalIdParam, professionals])\n\n  async function handleProfessionalChange(professionalId: string) {\n    setSelectedProfessionalId(professionalId)\n    setIsLoading(true)\n\n    const prof = professionals.find((p) => p.id === professionalId)\n    if (prof?.professionalProfile?.id) {\n      await fetchAvailability(prof.professionalProfile.id)\n    } else {\n      setRules([])\n      setIsLoading(false)\n    }\n  }\n\n  async function saveAvailability() {\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          rules,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save availability\")\n      }\n\n      const data = await response.json()\n      setRules(data.rules || [])\n      toast.success(\"Disponibilidade salva com sucesso\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar disponibilidade\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  function getRulesForDay(dayOfWeek: number): TimeBlock[] {\n    return rules.filter((r) => r.dayOfWeek === dayOfWeek)\n  }\n\n  function toggleDayActive(dayOfWeek: number) {\n    const dayRules = getRulesForDay(dayOfWeek)\n\n    if (dayRules.length === 0) {\n      // Add default time block for this day\n      setRules([\n        ...rules,\n        {\n          dayOfWeek,\n          startTime: \"08:00\",\n          endTime: \"18:00\",\n          isActive: true,\n        },\n      ])\n    } else {\n      // Toggle isActive for all blocks on this day\n      const allActive = dayRules.every((r) => r.isActive)\n      setRules(\n        rules.map((r) =>\n          r.dayOfWeek === dayOfWeek ? { ...r, isActive: !allActive } : r\n        )\n      )\n    }\n  }\n\n  function openBlockEditor(dayOfWeek: number, index: number | null = null) {\n    const dayRules = getRulesForDay(dayOfWeek)\n    const block =\n      index !== null\n        ? dayRules[index]\n        : { dayOfWeek, startTime: \"08:00\", endTime: \"18:00\", isActive: true }\n\n    setEditingBlock({ dayOfWeek, index, block })\n  }\n\n  function closeBlockEditor() {\n    setEditingBlock(null)\n  }\n\n  function saveBlock() {\n    if (!editingBlock) return\n\n    const { dayOfWeek, index, block } = editingBlock\n\n    // Validate times\n    if (block.startTime >= block.endTime) {\n      toast.error(\"O horário de início deve ser anterior ao horário de término\")\n      return\n    }\n\n    if (index !== null) {\n      // Update existing block\n      let blockIndex = 0\n      setRules(\n        rules.map((r) => {\n          if (r.dayOfWeek === dayOfWeek) {\n            if (blockIndex === index) {\n              blockIndex++\n              return { ...block }\n            }\n            blockIndex++\n          }\n          return r\n        })\n      )\n    } else {\n      // Add new block\n      setRules([...rules, { ...block }])\n    }\n\n    closeBlockEditor()\n  }\n\n  function deleteBlock() {\n    if (!editingBlock || editingBlock.index === null) return\n\n    const { dayOfWeek, index } = editingBlock\n    let blockIndex = 0\n\n    setRules(\n      rules.filter((r) => {\n        if (r.dayOfWeek === dayOfWeek) {\n          if (blockIndex === index) {\n            blockIndex++\n            return false\n          }\n          blockIndex++\n        }\n        return true\n      })\n    )\n\n    closeBlockEditor()\n  }\n\n  function removeAllBlocksForDay(dayOfWeek: number) {\n    setRules(rules.filter((r) => r.dayOfWeek !== dayOfWeek))\n  }\n\n  // Exception handlers\n  function openExceptionEditor(exception?: AvailabilityException) {\n    if (exception) {\n      setEditingException({\n        id: exception.id,\n        date: exception.date.split(\"T\")[0],\n        isAvailable: exception.isAvailable,\n        startTime: exception.startTime,\n        endTime: exception.endTime,\n        reason: exception.reason,\n        isFullDay: !exception.startTime && !exception.endTime,\n      })\n    } else {\n      // New exception - default to block (unavailable)\n      const tomorrow = new Date()\n      tomorrow.setDate(tomorrow.getDate() + 1)\n      setEditingException({\n        date: tomorrow.toISOString().split(\"T\")[0],\n        isAvailable: false,\n        startTime: null,\n        endTime: null,\n        reason: null,\n        isFullDay: true,\n      })\n    }\n  }\n\n  function closeExceptionEditor() {\n    setEditingException(null)\n  }\n\n  async function saveException() {\n    if (!editingException) return\n\n    const { date, isAvailable, startTime, endTime, reason, isFullDay } = editingException\n\n    // Validate time range if not full day\n    if (!isFullDay) {\n      if (!startTime || !endTime) {\n        toast.error(\"Selecione os horários de início e término\")\n        return\n      }\n      if (startTime >= endTime) {\n        toast.error(\"O horário de início deve ser anterior ao horário de término\")\n        return\n      }\n    }\n\n    setIsSaving(true)\n\n    try {\n      let professionalProfileId: string | undefined\n\n      if (isAdmin && selectedProfessionalId) {\n        const prof = professionals.find((p) => p.id === selectedProfessionalId)\n        professionalProfileId = prof?.professionalProfile?.id\n      }\n\n      const response = await fetch(\"/api/availability/exceptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          professionalProfileId,\n          date,\n          isAvailable,\n          startTime: isFullDay ? null : startTime,\n          endTime: isFullDay ? null : endTime,\n          reason: reason || null,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao salvar exceção\")\n      }\n\n      const data = await response.json()\n      setExceptions([...exceptions, data.exception])\n      toast.success(isAvailable ? \"Disponibilidade extra adicionada\" : \"Bloqueio adicionado\")\n      closeExceptionEditor()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar exceção\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function deleteException(id: string) {\n    setIsDeletingException(id)\n\n    try {\n      const response = await fetch(`/api/availability/exceptions/${id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Erro ao excluir exceção\")\n      }\n\n      setExceptions(exceptions.filter((e) => e.id !== id))\n      toast.success(\"Exceção removida\")\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao excluir exceção\")\n    } finally {\n      setIsDeletingException(null)\n    }\n  }\n\n  function formatExceptionDate(dateStr: string): string {\n    const date = new Date(dateStr + \"T00:00:00\")\n    return date.toLocaleDateString(\"pt-BR\", {\n      weekday: \"short\",\n      day: \"2-digit\",\n      month: \"short\",\n      year: \"numeric\",\n    })\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return <LoadingState />\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"min-h-[44px] min-w-[44px] flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors touch-manipulation\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">\n            Disponibilidade Semanal\n          </h1>\n          <button\n            onClick={saveAvailability}\n            disabled={isSaving}\n            className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n          >\n            {isSaving ? \"Salvando...\" : \"Salvar\"}\n          </button>\n        </div>\n\n        {/* ADMIN: Professional selector */}\n        {isAdmin && professionals.length > 0 && (\n          <div className=\"mb-6\">\n            <label\n              htmlFor=\"professional\"\n              className=\"block text-sm font-medium text-foreground mb-2\"\n            >\n              Profissional\n            </label>\n            <select\n              id=\"professional\"\n              value={selectedProfessionalId || \"\"}\n              onChange={(e) => handleProfessionalChange(e.target.value)}\n              className=\"w-full sm:w-auto min-w-[250px] h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Selecione um profissional</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.id}>\n                  {prof.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Weekly Grid */}\n        <div className=\"space-y-4\">\n          {DAYS_OF_WEEK.map((day) => {\n            const dayRules = getRulesForDay(day.value)\n            const hasRules = dayRules.length > 0\n            const allActive = hasRules && dayRules.every((r) => r.isActive)\n\n            return (\n              <div\n                key={day.value}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !allActive && hasRules ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n                  {/* Day toggle */}\n                  <div className=\"flex items-center gap-3 sm:w-32\">\n                    <button\n                      type=\"button\"\n                      onClick={() => toggleDayActive(day.value)}\n                      className={`relative w-14 h-8 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${\n                        allActive ? \"bg-primary\" : \"bg-muted\"\n                      }`}\n                      aria-label={`Toggle ${day.label}`}\n                    >\n                      <span\n                        className={`absolute top-1.5 w-5 h-5 rounded-full bg-white transition-transform ${\n                          allActive ? \"left-8\" : \"left-1\"\n                        }`}\n                      />\n                    </button>\n                    <span className=\"font-medium text-foreground\">\n                      <span className=\"hidden sm:inline\">{day.label}</span>\n                      <span className=\"sm:hidden\">{day.short}</span>\n                    </span>\n                  </div>\n\n                  {/* Time blocks */}\n                  <div className=\"flex-1 flex flex-wrap gap-2\">\n                    {dayRules.map((rule, index) => (\n                      <button\n                        key={rule.id || `${day.value}-${index}`}\n                        type=\"button\"\n                        onClick={() => openBlockEditor(day.value, index)}\n                        className={`min-h-[44px] px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation ${\n                          rule.isActive\n                            ? \"bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20\"\n                            : \"bg-muted text-muted-foreground border border-border hover:bg-muted/80\"\n                        }`}\n                      >\n                        {rule.startTime} - {rule.endTime}\n                      </button>\n                    ))}\n\n                    {/* Add time block button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => openBlockEditor(day.value)}\n                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"\n                    >\n                      + Adicionar\n                    </button>\n                  </div>\n\n                  {/* Remove all */}\n                  {hasRules && (\n                    <button\n                      type=\"button\"\n                      onClick={() => removeAllBlocksForDay(day.value)}\n                      className=\"text-sm text-destructive hover:underline focus:outline-none\"\n                    >\n                      Limpar\n                    </button>\n                  )}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mt-6\">\n          Configure os horários em que você está disponível para atendimentos.\n          Você pode adicionar múltiplos blocos de horário por dia.\n        </p>\n\n        {/* Exceptions Section */}\n        <div className=\"mt-10\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n            <h2 className=\"text-xl font-semibold text-foreground\">\n              Bloqueios e Exceções\n            </h2>\n            <button\n              type=\"button\"\n              onClick={() => openExceptionEditor()}\n              className=\"h-10 px-4 rounded-md border border-primary text-primary font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n            >\n              + Adicionar Exceção\n            </button>\n          </div>\n\n          {exceptions.length === 0 ? (\n            <div className=\"bg-card border border-border rounded-lg p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                Nenhuma exceção configurada. Adicione bloqueios para férias, feriados ou horários extras de atendimento.\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {exceptions\n                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                .map((exception) => (\n                  <div\n                    key={exception.id}\n                    className={`bg-card border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center gap-4 ${\n                      exception.isAvailable\n                        ? \"border-green-500/30 bg-green-500/5\"\n                        : \"border-red-500/30 bg-red-500/5\"\n                    }`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span\n                          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${\n                            exception.isAvailable\n                              ? \"bg-green-500/20 text-green-700 dark:text-green-400\"\n                              : \"bg-red-500/20 text-red-700 dark:text-red-400\"\n                          }`}\n                        >\n                          {exception.isAvailable ? \"Disponível\" : \"Bloqueado\"}\n                        </span>\n                        {exception.startTime && exception.endTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            {exception.startTime} - {exception.endTime}\n                          </span>\n                        )}\n                        {!exception.startTime && (\n                          <span className=\"text-sm text-muted-foreground\">\n                            Dia inteiro\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"font-medium text-foreground\">\n                        {formatExceptionDate(exception.date)}\n                      </p>\n                      {exception.reason && (\n                        <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {exception.reason}\n                        </p>\n                      )}\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => deleteException(exception.id)}\n                      disabled={isDeletingException === exception.id}\n                      className=\"shrink-0 px-3 py-1.5 text-sm text-destructive hover:bg-destructive hover:text-destructive-foreground rounded-md transition-colors disabled:opacity-50\"\n                    >\n                      {isDeletingException === exception.id ? \"Excluindo...\" : \"Excluir\"}\n                    </button>\n                  </div>\n                ))}\n            </div>\n          )}\n\n          <p className=\"text-sm text-muted-foreground mt-4\">\n            Use bloqueios para marcar dias de férias ou indisponibilidade.\n            Use exceções de disponibilidade para atender fora do horário normal.\n          </p>\n        </div>\n      </div>\n\n      {/* Time Block Editor Modal */}\n      {editingBlock && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeBlockEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingBlock.index !== null\n                  ? \"Editar Horário\"\n                  : \"Novo Horário\"}\n                {\" - \"}\n                {DAYS_OF_WEEK[editingBlock.dayOfWeek].label}\n              </h2>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label\n                      htmlFor=\"startTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Início\n                    </label>\n                    <input\n                      id=\"startTime\"\n                      type=\"time\"\n                      value={editingBlock.block.startTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            startTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                  <div>\n                    <label\n                      htmlFor=\"endTime\"\n                      className=\"block text-sm font-medium text-foreground mb-2\"\n                    >\n                      Término\n                    </label>\n                    <input\n                      id=\"endTime\"\n                      type=\"time\"\n                      value={editingBlock.block.endTime}\n                      onChange={(e) =>\n                        setEditingBlock({\n                          ...editingBlock,\n                          block: {\n                            ...editingBlock.block,\n                            endTime: e.target.value,\n                          },\n                        })\n                      }\n                      className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingBlock({\n                        ...editingBlock,\n                        block: {\n                          ...editingBlock.block,\n                          isActive: !editingBlock.block.isActive,\n                        },\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingBlock.block.isActive ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingBlock.block.isActive ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">\n                    {editingBlock.block.isActive ? \"Ativo\" : \"Inativo\"}\n                  </span>\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveBlock}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n                  >\n                    Salvar\n                  </button>\n                  {editingBlock.index !== null && (\n                    <button\n                      type=\"button\"\n                      onClick={deleteBlock}\n                      className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-destructive text-destructive font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                    >\n                      Excluir\n                    </button>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={closeBlockEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Exception Editor Modal */}\n      {editingException && (\n        <>\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeExceptionEditor}\n          />\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-md mx-auto px-4 py-6\">\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                {editingException.id ? \"Editar Exceção\" : \"Nova Exceção\"}\n              </h2>\n\n              <div className=\"space-y-6\">\n                {/* Exception Type */}\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-3\">\n                    Tipo\n                  </label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: false,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        !editingException.isAvailable\n                          ? \"border-red-500 bg-red-500/10 text-red-700 dark:text-red-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Bloqueio\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        setEditingException({\n                          ...editingException,\n                          isAvailable: true,\n                        })\n                      }\n                      className={`px-4 py-3 rounded-md border text-sm font-medium transition-colors ${\n                        editingException.isAvailable\n                          ? \"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400\"\n                          : \"border-border text-muted-foreground hover:border-foreground\"\n                      }`}\n                    >\n                      Disponibilidade Extra\n                    </button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {editingException.isAvailable\n                      ? \"Adiciona disponibilidade fora do horário normal\"\n                      : \"Bloqueia a agenda para este período\"}\n                  </p>\n                </div>\n\n                {/* Date */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionDate\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Data\n                  </label>\n                  <input\n                    id=\"exceptionDate\"\n                    type=\"date\"\n                    value={editingException.date}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        date: e.target.value,\n                      })\n                    }\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                {/* Full Day Toggle */}\n                <div className=\"flex items-center gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setEditingException({\n                        ...editingException,\n                        isFullDay: !editingException.isFullDay,\n                        startTime: !editingException.isFullDay ? null : \"08:00\",\n                        endTime: !editingException.isFullDay ? null : \"18:00\",\n                      })\n                    }\n                    className={`relative w-12 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background ${\n                      editingException.isFullDay ? \"bg-primary\" : \"bg-muted\"\n                    }`}\n                  >\n                    <span\n                      className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\n                        editingException.isFullDay ? \"left-7\" : \"left-1\"\n                      }`}\n                    />\n                  </button>\n                  <span className=\"text-sm text-foreground\">Dia inteiro</span>\n                </div>\n\n                {/* Time Range (only if not full day) */}\n                {!editingException.isFullDay && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label\n                        htmlFor=\"exceptionStartTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Início\n                      </label>\n                      <input\n                        id=\"exceptionStartTime\"\n                        type=\"time\"\n                        value={editingException.startTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            startTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label\n                        htmlFor=\"exceptionEndTime\"\n                        className=\"block text-sm font-medium text-foreground mb-2\"\n                      >\n                        Término\n                      </label>\n                      <input\n                        id=\"exceptionEndTime\"\n                        type=\"time\"\n                        value={editingException.endTime || \"\"}\n                        onChange={(e) =>\n                          setEditingException({\n                            ...editingException,\n                            endTime: e.target.value,\n                          })\n                        }\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Reason */}\n                <div>\n                  <label\n                    htmlFor=\"exceptionReason\"\n                    className=\"block text-sm font-medium text-foreground mb-2\"\n                  >\n                    Motivo (opcional)\n                  </label>\n                  <input\n                    id=\"exceptionReason\"\n                    type=\"text\"\n                    value={editingException.reason || \"\"}\n                    onChange={(e) =>\n                      setEditingException({\n                        ...editingException,\n                        reason: e.target.value,\n                      })\n                    }\n                    placeholder=\"Ex: Férias, Feriado, Compromisso pessoal\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={saveException}\n                    disabled={isSaving}\n                    className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity disabled:opacity-50\"\n                  >\n                    {isSaving ? \"Salvando...\" : \"Salvar\"}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={closeExceptionEditor}\n                    className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Cancelar\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":575,"oldLines":7,"newStart":575,"newLines":7,"lines":["                     <button","                       type=\"button\"","                       onClick={() => openBlockEditor(day.value)}","-                      className=\"px-3 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background\"","+                      className=\"min-h-[44px] px-4 py-2 rounded-md text-sm font-medium border border-dashed border-border text-muted-foreground hover:border-primary hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background touch-manipulation\"","                     >","                       + Adicionar","                     </button>"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01K54RiteGRAAfDSj7iwxz4v","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me run TypeScript to check for any errors."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":452,"cache_read_input_tokens":118142,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":452},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"42c838c0-3bc5-4fdb-8235-b066824a178b"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01K54RiteGRAAfDSj7iwxz4v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PVyrzJPDTNyZ8Lpsv1s2LE","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"completed","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"in_progress","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":452,"cache_read_input_tokens":118142,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":452},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e9f5793a-a796-47ac-ab8d-df12807703aa"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PVyrzJPDTNyZ8Lpsv1s2LE","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"cd31e74b-0039-4ecc-bb4b-77c33e778eb4","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"in_progress","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"pending","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"completed","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"in_progress","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_012Qfwia9Eqq7TyniJ2bFHEJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0184sUmTa9q7oTrGxYWaREdU","name":"Bash","input":{"command":"npx tsc --noEmit 2>&1 | head -60","description":"Type check the project"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":427,"cache_read_input_tokens":118594,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":427},"output_tokens":26,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"da5845d7-3187-411f-a4c9-b17d6123939c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0184sUmTa9q7oTrGxYWaREdU","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"d59c7859-b66d-4b54-a049-39ec86c13bb1","tool_use_result":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0136DALDxJ3ce8Sk5diF53i6","type":"message","role":"assistant","content":[{"type":"text","text":"TypeScript passes. Let me run the linter next."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":114,"cache_read_input_tokens":119021,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":114},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"a094d665-aeaa-4269-a8ee-5f95b2f53aa1"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0136DALDxJ3ce8Sk5diF53i6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NZ6h3VkuXfziwnHQVviTpX","name":"Bash","input":{"command":"npx next lint 2>&1 | head -50","description":"Run Next.js linter"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":114,"cache_read_input_tokens":119021,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":114},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"3fac19c7-acee-447a-8816-b5d8b0907665"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NZ6h3VkuXfziwnHQVviTpX","type":"tool_result","content":"Invalid project directory provided, no such directory: /mnt/d/personal/clinica/src/lint","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"73c14c2b-79ab-4ec5-9152-34587d8543d7","tool_use_result":{"stdout":"Invalid project directory provided, no such directory: /mnt/d/personal/clinica/src/lint","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X1Jk2RczPLPWHWmdqSLj5j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XxAjgaM49KsJKdHqCkCSP3","name":"Bash","input":{"command":"npx next lint 2>&1 | head -50","description":"Run Next.js linter from project root"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":134,"cache_read_input_tokens":119135,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":134},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"d541e34d-120a-4a07-a0e9-0d4335c479f1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XxAjgaM49KsJKdHqCkCSP3","type":"tool_result","content":"Invalid project directory provided, no such directory: /mnt/d/personal/clinica/src/lint","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"61732a43-f9bc-47f4-8076-38c64ba9359d","tool_use_result":{"stdout":"Invalid project directory provided, no such directory: /mnt/d/personal/clinica/src/lint","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QLbW3m8VBp9wE1N9UAkAqp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013wmzX63oP9idCZVqWMPQUa","name":"Bash","input":{"command":"npx next lint 2>&1 | head -50","description":"Run Next.js linter from project root"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":124,"cache_read_input_tokens":119269,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":124},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"80b54e49-640f-4bce-9259-a1149fb1bb64"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013wmzX63oP9idCZVqWMPQUa","type":"tool_result","content":"Invalid project directory provided, no such directory: /mnt/d/personal/clinica/src/lint","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"28482f8a-51be-4b71-bcc6-78468f674024","tool_use_result":{"stdout":"Invalid project directory provided, no such directory: /mnt/d/personal/clinica/src/lint","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_011zbNB6ejULeVhRTDqHpMXF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Jy1We9Yv5QuTWdjVMSw5wa","name":"Bash","input":{"command":"npx --yes eslint src --ext .ts,.tsx 2>&1 | head -50","description":"Run eslint on source files"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":124,"cache_read_input_tokens":119393,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":124},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"40e7fa3e-6b63-4dba-9514-90362680d9e3"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Jy1We9Yv5QuTWdjVMSw5wa","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx\n  13:3  warning  'BottomSheet' is defined but never used  @typescript-eslint/no-unused-vars\n  15:3  warning  'ErrorState' is defined but never used   @typescript-eslint/no-unused-vars\n\n/mnt/d/personal/clinica/src/src/app/patients/page.tsx\n  13:3  warning  'BottomSheet' is defined but never used  @typescript-eslint/no-unused-vars\n\n/mnt/d/personal/clinica/src/src/lib/notifications/providers/whatsapp-mock.ts\n  14:5  warning  '_subject' is defined but never used  @typescript-eslint/no-unused-vars\n\n✖ 4 problems (0 errors, 4 warnings)","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"278eb1e9-f5ba-4e9b-a980-aa03d29910f8","tool_use_result":{"stdout":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx\n  13:3  warning  'BottomSheet' is defined but never used  @typescript-eslint/no-unused-vars\n  15:3  warning  'ErrorState' is defined but never used   @typescript-eslint/no-unused-vars\n\n/mnt/d/personal/clinica/src/src/app/patients/page.tsx\n  13:3  warning  'BottomSheet' is defined but never used  @typescript-eslint/no-unused-vars\n\n/mnt/d/personal/clinica/src/src/lib/notifications/providers/whatsapp-mock.ts\n  14:5  warning  '_subject' is defined but never used  @typescript-eslint/no-unused-vars\n\n✖ 4 problems (0 errors, 4 warnings)","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EPiMLiqds1J9xqqw3Yxe7U","type":"message","role":"assistant","content":[{"type":"text","text":"Let me fix the unused imports."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":316,"cache_read_input_tokens":119517,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":316},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"31bba952-5fab-440b-9f3c-dc5924ea4ea5"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EPiMLiqds1J9xqqw3Yxe7U","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HTpd2G3cdy2f14WyMXqnmi","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","old_string":"import {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"","new_string":"import {\n  BottomNavigation,\n  FAB,\n  SkeletonAgenda,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":316,"cache_read_input_tokens":119517,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":316},"output_tokens":5,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"abc210fe-39c6-4371-aa14-61f060484955"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HTpd2G3cdy2f14WyMXqnmi","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/agenda/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4705c8e5-3914-4cef-b28a-1426e07ef24f","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/agenda/page.tsx","oldString":"import {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"","newString":"import {\n  BottomNavigation,\n  FAB,\n  SkeletonAgenda,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState, useRef } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonAgenda,\n  ErrorState,\n  EmptyState,\n  SwipeContainer,\n} from \"@/shared/components/ui\"\n\nconst timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/\n\nconst appointmentSchema = z.object({\n  patientId: z.string().min(1, \"Selecione um paciente\"),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n})\n\nconst editAppointmentSchema = z.object({\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Data inválida\"),\n  startTime: z.string().regex(timeRegex, \"Horário inválido (HH:mm)\"),\n  duration: z.number().int().min(15).max(480).optional(),\n  modality: z.enum([\"ONLINE\", \"PRESENCIAL\"]),\n  notes: z.string().max(2000).optional().nullable(),\n  price: z.union([z.number().min(0), z.string(), z.null()]).optional().nullable(),\n})\n\ntype AppointmentFormData = z.infer<typeof appointmentSchema>\ntype EditAppointmentFormData = z.infer<typeof editAppointmentSchema>\n\ninterface Patient {\n  id: string\n  name: string\n  phone: string\n  email: string | null\n}\n\ninterface Professional {\n  id: string\n  name: string\n  professionalProfile: {\n    id: string\n    specialty: string | null\n    appointmentDuration: number\n  } | null\n}\n\ninterface AvailabilityRule {\n  id: string\n  dayOfWeek: number\n  startTime: string\n  endTime: string\n  isActive: boolean\n}\n\ninterface AvailabilityException {\n  id: string\n  date: string\n  isAvailable: boolean\n  startTime: string | null\n  endTime: string | null\n  reason: string | null\n}\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  price: string | null\n  cancellationReason: string | null\n  cancelledAt: string | null\n  patient: {\n    id: string\n    name: string\n    email: string | null\n    phone: string\n    consentWhatsApp?: boolean\n    consentEmail?: boolean\n  }\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface TimeSlot {\n  time: string\n  isAvailable: boolean\n  appointment: Appointment | null\n  isBlocked: boolean\n  blockReason?: string\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Nao compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800 border-blue-200\",\n  CONFIRMADO: \"bg-green-100 text-green-800 border-green-200\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800 border-red-200\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800 border-red-200\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\n  FINALIZADO: \"bg-gray-100 text-gray-800 border-gray-200\",\n}\n\nconst statusBorderColors: Record<string, string> = {\n  AGENDADO: \"border-l-blue-500\",\n  CONFIRMADO: \"border-l-green-500\",\n  CANCELADO_PACIENTE: \"border-l-red-500\",\n  CANCELADO_PROFISSIONAL: \"border-l-red-500\",\n  NAO_COMPARECEU: \"border-l-yellow-500\",\n  FINALIZADO: \"border-l-gray-500\",\n}\n\nfunction formatTime(time: string): string {\n  return time.slice(0, 5)\n}\n\nfunction formatDateHeader(date: Date): string {\n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  const dateOnly = new Date(date)\n  dateOnly.setHours(0, 0, 0, 0)\n\n  const diffDays = Math.round((dateOnly.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))\n\n  const dayName = date.toLocaleDateString(\"pt-BR\", { weekday: \"long\" })\n  const formattedDate = date.toLocaleDateString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  })\n\n  if (diffDays === 0) return `Hoje, ${formattedDate}`\n  if (diffDays === 1) return `Amanha, ${formattedDate}`\n  if (diffDays === -1) return `Ontem, ${formattedDate}`\n\n  return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${formattedDate}`\n}\n\nfunction formatPhone(phone: string): string {\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction toDateString(date: Date): string {\n  return date.toISOString().split(\"T\")[0]\n}\n\nexport default function AgendaPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [selectedDate, setSelectedDate] = useState(() => new Date())\n  const [appointments, setAppointments] = useState<Appointment[]>([])\n  const [availabilityRules, setAvailabilityRules] = useState<AvailabilityRule[]>([])\n  const [availabilityExceptions, setAvailabilityExceptions] = useState<AvailabilityException[]>([])\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([])\n  const [professionals, setProfessionals] = useState<Professional[]>([])\n  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>(\"\")\n  const [showDatePicker, setShowDatePicker] = useState(false)\n  const [appointmentDuration, setAppointmentDuration] = useState(50)\n\n\n  // Appointment creation state\n  const [isCreateSheetOpen, setIsCreateSheetOpen] = useState(false)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [patientSearch, setPatientSearch] = useState(\"\")\n  const [isSearchingPatients, setIsSearchingPatients] = useState(false)\n  const [isSavingAppointment, setIsSavingAppointment] = useState(false)\n  const [selectedPatient, setSelectedPatient] = useState<Patient | null>(null)\n  const [showPatientDropdown, setShowPatientDropdown] = useState(false)\n  const patientSearchRef = useRef<HTMLInputElement>(null)\n\n  // Appointment edit/detail state\n  const [isEditSheetOpen, setIsEditSheetOpen] = useState(false)\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null)\n  const [isUpdatingAppointment, setIsUpdatingAppointment] = useState(false)\n\n  // Cancel appointment state\n  const [isCancelDialogOpen, setIsCancelDialogOpen] = useState(false)\n  const [cancelReason, setCancelReason] = useState(\"\")\n  const [notifyPatient, setNotifyPatient] = useState(true)\n  const [isCancellingAppointment, setIsCancellingAppointment] = useState(false)\n\n  // Status update state\n  const [isUpdatingStatus, setIsUpdatingStatus] = useState(false)\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    resolver: zodResolver(appointmentSchema),\n    defaultValues: {\n      modality: \"PRESENCIAL\",\n    },\n  })\n\n  const {\n    register: registerEdit,\n    handleSubmit: handleSubmitEdit,\n    reset: resetEdit,\n    formState: { errors: editErrors },\n  } = useForm<EditAppointmentFormData>({\n    resolver: zodResolver(editAppointmentSchema),\n  })\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n  const currentProfessionalProfileId = session?.user?.professionalProfileId\n\n  // Get the professionalProfileId to use for API calls\n  const activeProfessionalProfileId = isAdmin && selectedProfessionalId\n    ? selectedProfessionalId\n    : currentProfessionalProfileId\n\n  const fetchProfessionals = useCallback(async () => {\n    if (!isAdmin) return\n\n    try {\n      const response = await fetch(\"/api/professionals\")\n      if (!response.ok) return\n      const data = await response.json()\n      setProfessionals(data.professionals)\n    } catch {\n      // Silently fail - professionals dropdown is optional\n    }\n  }, [isAdmin])\n\n  const fetchAppointments = useCallback(async () => {\n    if (!activeProfessionalProfileId && !isAdmin) return\n\n    try {\n      const params = new URLSearchParams({\n        date: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/appointments?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/login\")\n          return\n        }\n        throw new Error(\"Failed to fetch appointments\")\n      }\n      const data = await response.json()\n      setAppointments(data.appointments)\n    } catch {\n      toast.error(\"Erro ao carregar agenda\")\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId, router])\n\n  const fetchAvailability = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams()\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityRules(data.rules)\n\n      // Also fetch the appointment duration from the professional's profile\n      if (data.rules.length > 0) {\n        // Try to get appointment duration from professionals list\n        const prof = professionals.find(p => p.professionalProfile?.id === activeProfessionalProfileId)\n        if (prof?.professionalProfile?.appointmentDuration) {\n          setAppointmentDuration(prof.professionalProfile.appointmentDuration)\n        }\n      }\n    } catch {\n      // Silently fail - availability is optional\n    }\n  }, [activeProfessionalProfileId, isAdmin, selectedProfessionalId, professionals])\n\n  const fetchAvailabilityExceptions = useCallback(async () => {\n    if (!activeProfessionalProfileId) return\n\n    try {\n      const params = new URLSearchParams({\n        startDate: toDateString(selectedDate),\n        endDate: toDateString(selectedDate),\n      })\n\n      if (isAdmin && selectedProfessionalId) {\n        params.set(\"professionalProfileId\", selectedProfessionalId)\n      }\n\n      const response = await fetch(`/api/availability/exceptions?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setAvailabilityExceptions(data.exceptions)\n    } catch {\n      // Silently fail - exceptions are optional\n    }\n  }, [selectedDate, activeProfessionalProfileId, isAdmin, selectedProfessionalId])\n\n  const searchPatients = useCallback(async (query: string) => {\n    if (query.length < 2) {\n      setPatients([])\n      return\n    }\n\n    setIsSearchingPatients(true)\n    try {\n      const params = new URLSearchParams({\n        search: query,\n        isActive: \"true\",\n      })\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) return\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      // Silently fail\n    } finally {\n      setIsSearchingPatients(false)\n    }\n  }, [])\n\n  // Debounced patient search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (patientSearch) {\n        searchPatients(patientSearch)\n      }\n    }, 300)\n\n    return () => clearTimeout(timer)\n  }, [patientSearch, searchPatients])\n\n  function openCreateSheet(slotTime?: string) {\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n    reset({\n      patientId: \"\",\n      date: toDateString(selectedDate),\n      startTime: slotTime || \"\",\n      modality: \"PRESENCIAL\",\n      notes: \"\",\n    })\n    setIsCreateSheetOpen(true)\n  }\n\n  function closeCreateSheet() {\n    setIsCreateSheetOpen(false)\n    setSelectedPatient(null)\n    setPatientSearch(\"\")\n    setPatients([])\n  }\n\n  function selectPatient(patient: Patient) {\n    setSelectedPatient(patient)\n    setValue(\"patientId\", patient.id)\n    setPatientSearch(patient.name)\n    setShowPatientDropdown(false)\n    setPatients([])\n  }\n\n  function openEditSheet(appointment: Appointment) {\n    setSelectedAppointment(appointment)\n    const scheduledDate = new Date(appointment.scheduledAt)\n    const endDate = new Date(appointment.endAt)\n    const durationMinutes = Math.round((endDate.getTime() - scheduledDate.getTime()) / 60000)\n\n    resetEdit({\n      date: toDateString(scheduledDate),\n      startTime: `${scheduledDate.getHours().toString().padStart(2, \"0\")}:${scheduledDate.getMinutes().toString().padStart(2, \"0\")}`,\n      duration: durationMinutes,\n      modality: appointment.modality as \"ONLINE\" | \"PRESENCIAL\",\n      notes: appointment.notes || \"\",\n      price: appointment.price ? parseFloat(appointment.price) : null,\n    })\n    setIsEditSheetOpen(true)\n  }\n\n  function closeEditSheet() {\n    setIsEditSheetOpen(false)\n    setSelectedAppointment(null)\n  }\n\n  async function onSubmitEdit(data: EditAppointmentFormData) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingAppointment(true)\n\n    try {\n      // Calculate scheduledAt and endAt from date, startTime, and duration\n      const [hours, minutes] = data.startTime.split(\":\").map(Number)\n      const scheduledAt = new Date(data.date + \"T12:00:00\")\n      scheduledAt.setHours(hours, minutes, 0, 0)\n\n      const durationMinutes = data.duration || appointmentDuration\n      const endAt = new Date(scheduledAt.getTime() + durationMinutes * 60000)\n\n      const body: Record<string, unknown> = {\n        scheduledAt: scheduledAt.toISOString(),\n        endAt: endAt.toISOString(),\n        modality: data.modality,\n        notes: data.notes || null,\n        price: data.price !== undefined && data.price !== \"\" ? Number(data.price) : null,\n      }\n\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento atualizado com sucesso\")\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar agendamento\")\n    } finally {\n      setIsUpdatingAppointment(false)\n    }\n  }\n\n  function openCancelDialog() {\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n    setIsCancelDialogOpen(true)\n  }\n\n  function closeCancelDialog() {\n    setIsCancelDialogOpen(false)\n    setCancelReason(\"\")\n    setNotifyPatient(true)\n  }\n\n  async function handleCancelAppointment() {\n    if (!selectedAppointment) return\n\n    if (!cancelReason.trim()) {\n      toast.error(\"Informe o motivo do cancelamento\")\n      return\n    }\n\n    setIsCancellingAppointment(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/cancel`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          reason: cancelReason.trim(),\n          notifyPatient,\n        }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao cancelar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento cancelado com sucesso\")\n      if (result.notificationCreated) {\n        toast.success(\"Notificacao enviada ao paciente\")\n      }\n      closeCancelDialog()\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao cancelar agendamento\")\n    } finally {\n      setIsCancellingAppointment(false)\n    }\n  }\n\n  // Check if appointment can be cancelled\n  function canCancelAppointment(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Check if patient has notification consent\n  function hasNotificationConsent(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return !!(appointment.patient.consentWhatsApp || appointment.patient.consentEmail)\n  }\n\n  // Check if appointment can be marked as finalized or no-show\n  function canMarkStatus(appointment: Appointment | null): boolean {\n    if (!appointment) return false\n    return [\"AGENDADO\", \"CONFIRMADO\"].includes(appointment.status)\n  }\n\n  // Update appointment status\n  async function handleUpdateStatus(newStatus: string, successMessage: string) {\n    if (!selectedAppointment) return\n\n    setIsUpdatingStatus(true)\n\n    try {\n      const response = await fetch(`/api/appointments/${selectedAppointment.id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao atualizar status\")\n        return\n      }\n\n      toast.success(successMessage)\n      closeEditSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao atualizar status\")\n    } finally {\n      setIsUpdatingStatus(false)\n    }\n  }\n\n  async function handleFinalizarAppointment() {\n    await handleUpdateStatus(\"FINALIZADO\", \"Consulta finalizada com sucesso\")\n  }\n\n  async function handleNaoCompareceuAppointment() {\n    await handleUpdateStatus(\"NAO_COMPARECEU\", \"Paciente marcado como não compareceu\")\n  }\n\n  async function onSubmitAppointment(data: AppointmentFormData) {\n    setIsSavingAppointment(true)\n\n    try {\n      const body: Record<string, unknown> = {\n        patientId: data.patientId,\n        date: data.date,\n        startTime: data.startTime,\n        modality: data.modality,\n        notes: data.notes || null,\n      }\n\n      // If admin and has selected a professional, include it\n      if (isAdmin && selectedProfessionalId) {\n        body.professionalProfileId = selectedProfessionalId\n      }\n\n      // Include duration if different from default\n      if (data.duration) {\n        body.duration = data.duration\n      }\n\n      const response = await fetch(\"/api/appointments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        toast.error(result.error || \"Erro ao criar agendamento\")\n        return\n      }\n\n      toast.success(\"Agendamento criado com sucesso\")\n      closeCreateSheet()\n      fetchAppointments()\n    } catch {\n      toast.error(\"Erro ao criar agendamento\")\n    } finally {\n      setIsSavingAppointment(false)\n    }\n  }\n\n  // Generate time slots based on availability\n  const generateTimeSlots = useCallback(() => {\n    const dayOfWeek = selectedDate.getDay()\n    const dateStr = toDateString(selectedDate)\n\n    // Get active rules for this day of week\n    const dayRules = availabilityRules.filter(\n      (rule) => rule.dayOfWeek === dayOfWeek && rule.isActive\n    )\n\n    // Check for full-day exception (block)\n    const fullDayException = availabilityExceptions.find(\n      (ex) => toDateString(new Date(ex.date)) === dateStr && !ex.startTime && !ex.isAvailable\n    )\n\n    if (fullDayException) {\n      setTimeSlots([])\n      return\n    }\n\n    // If no availability rules for this day, show empty\n    if (dayRules.length === 0) {\n      setTimeSlots([])\n      return\n    }\n\n    // Generate slots based on availability rules\n    const slots: TimeSlot[] = []\n    const slotDuration = appointmentDuration\n\n    for (const rule of dayRules) {\n      const [startHour, startMin] = rule.startTime.split(\":\").map(Number)\n      const [endHour, endMin] = rule.endTime.split(\":\").map(Number)\n\n      let currentMinutes = startHour * 60 + startMin\n      const endMinutes = endHour * 60 + endMin\n\n      while (currentMinutes + slotDuration <= endMinutes) {\n        const hour = Math.floor(currentMinutes / 60)\n        const min = currentMinutes % 60\n        const timeStr = `${hour.toString().padStart(2, \"0\")}:${min.toString().padStart(2, \"0\")}`\n\n        // Check for time-specific exception\n        const exception = availabilityExceptions.find((ex) => {\n          if (toDateString(new Date(ex.date)) !== dateStr) return false\n          if (!ex.startTime || !ex.endTime) return false\n          return timeStr >= ex.startTime && timeStr < ex.endTime && !ex.isAvailable\n        })\n\n        // Find matching appointment\n        const appointment = appointments.find((apt) => {\n          const aptTime = new Date(apt.scheduledAt)\n          const aptHour = aptTime.getHours()\n          const aptMin = aptTime.getMinutes()\n          return aptHour === hour && aptMin === min\n        })\n\n        slots.push({\n          time: timeStr,\n          isAvailable: !exception && !appointment,\n          appointment: appointment || null,\n          isBlocked: !!exception,\n          blockReason: exception?.reason || undefined,\n        })\n\n        currentMinutes += slotDuration\n      }\n    }\n\n    // Sort slots by time\n    slots.sort((a, b) => a.time.localeCompare(b.time))\n    setTimeSlots(slots)\n  }, [selectedDate, availabilityRules, availabilityExceptions, appointments, appointmentDuration])\n\n  function goToPreviousDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() - 1)\n      return newDate\n    })\n  }\n\n  function goToNextDay() {\n    setSelectedDate((prev) => {\n      const newDate = new Date(prev)\n      newDate.setDate(newDate.getDate() + 1)\n      return newDate\n    })\n  }\n\n  function goToToday() {\n    setSelectedDate(new Date())\n    setShowDatePicker(false)\n  }\n\n  // Initial load\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      setIsLoading(false)\n      fetchProfessionals()\n    }\n  }, [status, router, fetchProfessionals])\n\n  // Fetch data when date or professional changes\n  useEffect(() => {\n    if (status === \"authenticated\" && (activeProfessionalProfileId || isAdmin)) {\n      fetchAppointments()\n      fetchAvailability()\n      fetchAvailabilityExceptions()\n    }\n  }, [\n    status,\n    selectedDate,\n    activeProfessionalProfileId,\n    isAdmin,\n    fetchAppointments,\n    fetchAvailability,\n    fetchAvailabilityExceptions,\n  ])\n\n  // Generate slots when data changes\n  useEffect(() => {\n    generateTimeSlots()\n  }, [generateTimeSlots])\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonAgenda />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <header className=\"sticky top-0 bg-background/95 backdrop-blur border-b border-border z-30\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          {/* Date Header - Tappable */}\n          <button\n            onClick={() => setShowDatePicker(!showDatePicker)}\n            className=\"w-full text-left mb-3\"\n          >\n            <h1 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n              {formatDateHeader(selectedDate)}\n              <svg\n                className={`w-5 h-5 transition-transform ${showDatePicker ? \"rotate-180\" : \"\"}`}\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n              </svg>\n            </h1>\n          </button>\n\n          {/* Professional Filter - ADMIN only */}\n          {isAdmin && professionals.length > 0 && (\n            <select\n              value={selectedProfessionalId}\n              onChange={(e) => setSelectedProfessionalId(e.target.value)}\n              className=\"w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            >\n              <option value=\"\">Todos os profissionais</option>\n              {professionals.map((prof) => (\n                <option key={prof.id} value={prof.professionalProfile?.id || \"\"}>\n                  {prof.name}\n                  {prof.professionalProfile?.specialty && ` - ${prof.professionalProfile.specialty}`}\n                </option>\n              ))}\n            </select>\n          )}\n        </div>\n\n        {/* Date Picker Dropdown */}\n        {showDatePicker && (\n          <div className=\"border-t border-border bg-card\">\n            <div className=\"max-w-4xl mx-auto px-4 py-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <button\n                  onClick={goToPreviousDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <button\n                  onClick={goToToday}\n                  className=\"h-10 px-4 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition-colors\"\n                >\n                  Hoje\n                </button>\n                <button\n                  onClick={goToNextDay}\n                  className=\"h-10 w-10 rounded-md border border-input bg-background flex items-center justify-center hover:bg-muted transition-colors\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </button>\n              </div>\n              <input\n                type=\"date\"\n                value={toDateString(selectedDate)}\n                onChange={(e) => {\n                  setSelectedDate(new Date(e.target.value + \"T12:00:00\"))\n                  setShowDatePicker(false)\n                }}\n                className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n              />\n            </div>\n          </div>\n        )}\n      </header>\n\n      {/* Timeline Content */}\n      <SwipeContainer\n        onSwipeLeft={goToNextDay}\n        onSwipeRight={goToPreviousDay}\n        className=\"max-w-4xl mx-auto px-4 py-4\"\n      >\n        {/* Day navigation hint */}\n        <p className=\"text-xs text-muted-foreground text-center mb-4\">\n          Deslize para esquerda ou direita para mudar o dia\n        </p>\n\n        {/* No availability message */}\n        {timeSlots.length === 0 && (\n          <EmptyState\n            title=\"Sem disponibilidade\"\n            message={\n              isAdmin && !selectedProfessionalId\n                ? \"Selecione um profissional para ver a agenda\"\n                : \"Nao ha horarios configurados para este dia\"\n            }\n            icon={\n              <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            }\n          />\n        )}\n\n        {/* Timeline */}\n        {timeSlots.length > 0 && (\n          <div className=\"space-y-2\">\n            {timeSlots.map((slot) => (\n              <div\n                key={slot.time}\n                className={`flex items-stretch gap-3 min-h-[4rem] ${\n                  slot.isBlocked ? \"opacity-50\" : \"\"\n                }`}\n              >\n                {/* Time Column */}\n                <div className=\"w-14 flex-shrink-0 text-sm text-muted-foreground pt-2\">\n                  {formatTime(slot.time)}\n                </div>\n\n                {/* Slot Content */}\n                {slot.appointment ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => openEditSheet(slot.appointment!)}\n                    className={`flex-1 bg-card border border-border rounded-lg p-3 border-l-4 text-left hover:bg-muted/50 transition-colors cursor-pointer ${\n                      statusBorderColors[slot.appointment.status] || \"border-l-gray-400\"\n                    } ${\n                      (slot.appointment.status === \"CANCELADO_PROFISSIONAL\" || slot.appointment.status === \"CANCELADO_PACIENTE\") ? \"opacity-50\" : \"\"\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"min-w-0 flex-1\">\n                        <h4 className=\"font-medium text-foreground truncate\">\n                          {slot.appointment.patient.name}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {formatPhone(slot.appointment.patient.phone)}\n                        </p>\n                        {isAdmin && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {slot.appointment.professionalProfile.user.name}\n                          </p>\n                        )}\n                      </div>\n                      <span\n                        className={`flex-shrink-0 text-xs px-2 py-1 rounded-full border ${\n                          statusColors[slot.appointment.status] || \"bg-gray-100 text-gray-800\"\n                        }`}\n                      >\n                        {statusLabels[slot.appointment.status] || slot.appointment.status}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mt-2\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {slot.appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                      </span>\n                      {slot.appointment.notes && (\n                        <span className=\"text-xs text-muted-foreground truncate\">\n                          • {slot.appointment.notes}\n                        </span>\n                      )}\n                    </div>\n                  </button>\n                ) : slot.isBlocked ? (\n                  <div className=\"flex-1 bg-muted/50 border border-dashed border-border rounded-lg p-3 flex items-center\">\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      <span className=\"text-sm\">\n                        {slot.blockReason || \"Bloqueado\"}\n                      </span>\n                    </div>\n                  </div>\n                ) : (\n                  <button\n                    onClick={() => openCreateSheet(slot.time)}\n                    className=\"flex-1 border border-dashed border-border rounded-lg p-3 flex items-center justify-center text-muted-foreground hover:bg-muted/50 hover:border-primary/50 hover:text-primary transition-colors cursor-pointer\"\n                  >\n                    <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    <span className=\"text-sm\">Disponivel</span>\n                  </button>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </SwipeContainer>\n\n      {/* FAB - Floating Action Button */}\n      <FAB onClick={() => openCreateSheet()} label=\"Novo agendamento\" />\n\n      {/* Create Appointment Sheet */}\n      {isCreateSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeCreateSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Novo Agendamento</h2>\n            </div>\n\n            <form onSubmit={handleSubmit(onSubmitAppointment)} className=\"p-4 space-y-6\">\n              {/* Patient Selection */}\n              <div className=\"relative\">\n                <label htmlFor=\"patientSearch\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Paciente *\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={patientSearchRef}\n                    id=\"patientSearch\"\n                    type=\"text\"\n                    value={patientSearch}\n                    onChange={(e) => {\n                      setPatientSearch(e.target.value)\n                      setShowPatientDropdown(true)\n                      if (selectedPatient && e.target.value !== selectedPatient.name) {\n                        setSelectedPatient(null)\n                        setValue(\"patientId\", \"\")\n                      }\n                    }}\n                    onFocus={() => setShowPatientDropdown(true)}\n                    placeholder=\"Digite o nome do paciente...\"\n                    className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                  />\n                  {isSearchingPatients && (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      <svg className=\"w-5 h-5 animate-spin text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n                      </svg>\n                    </div>\n                  )}\n                </div>\n                <input type=\"hidden\" {...register(\"patientId\")} />\n\n                {/* Patient Dropdown */}\n                {showPatientDropdown && patients.length > 0 && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                    {patients.map((patient) => (\n                      <button\n                        key={patient.id}\n                        type=\"button\"\n                        onClick={() => selectPatient(patient)}\n                        className=\"w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center justify-between\"\n                      >\n                        <div>\n                          <p className=\"font-medium text-foreground\">{patient.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{formatPhone(patient.phone)}</p>\n                        </div>\n                        {selectedPatient?.id === patient.id && (\n                          <svg className=\"w-5 h-5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                            <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                          </svg>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                )}\n\n                {/* No results */}\n                {showPatientDropdown && patientSearch.length >= 2 && patients.length === 0 && !isSearchingPatients && (\n                  <div className=\"absolute z-10 w-full mt-1 bg-card border border-border rounded-md shadow-lg p-4 text-center text-muted-foreground\">\n                    Nenhum paciente encontrado\n                  </div>\n                )}\n\n                {errors.patientId && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.patientId.message}</p>\n                )}\n\n                {selectedPatient && (\n                  <div className=\"mt-2 p-3 bg-muted/50 rounded-md\">\n                    <p className=\"text-sm font-medium text-foreground\">{selectedPatient.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatPhone(selectedPatient.phone)}</p>\n                    {selectedPatient.email && (\n                      <p className=\"text-xs text-muted-foreground\">{selectedPatient.email}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Date */}\n              <div>\n                <label htmlFor=\"date\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"date\"\n                  type=\"date\"\n                  {...register(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"startTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"startTime\"\n                  type=\"time\"\n                  {...register(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {errors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"duration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"duration\"\n                  type=\"number\"\n                  {...register(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Se nao informado, usa a duracao padrao do profissional ({appointmentDuration} min)\n                </p>\n                {errors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...register(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {errors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  rows={3}\n                  {...register(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {errors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                <button\n                  type=\"submit\"\n                  disabled={isSavingAppointment || !selectedPatient}\n                  className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                >\n                  {isSavingAppointment ? \"Salvando...\" : \"Criar Agendamento\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={closeCreateSheet}\n                  className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                >\n                  Cancelar\n                </button>\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Edit Appointment Sheet */}\n      {isEditSheetOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeEditSheet}\n          />\n\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background rounded-t-2xl shadow-xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            {/* Handle */}\n            <div className=\"sticky top-0 bg-background pt-3 pb-2 px-4 border-b border-border\">\n              <div className=\"w-10 h-1 bg-muted rounded-full mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold text-foreground\">Editar Agendamento</h2>\n            </div>\n\n            {/* Patient Info (read-only) */}\n            <div className=\"px-4 py-4 bg-muted/30 border-b border-border\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Paciente</p>\n                  <p className=\"font-medium text-foreground\">{selectedAppointment.patient.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">{formatPhone(selectedAppointment.patient.phone)}</p>\n                  {selectedAppointment.patient.email && (\n                    <p className=\"text-sm text-muted-foreground\">{selectedAppointment.patient.email}</p>\n                  )}\n                </div>\n                <span className={`px-3 py-1 rounded-full text-xs font-medium border ${statusColors[selectedAppointment.status] || \"bg-gray-100 text-gray-800 border-gray-200\"}`}>\n                  {statusLabels[selectedAppointment.status] || selectedAppointment.status}\n                </span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 italic\">\n                Para alterar o paciente, cancele este agendamento e crie um novo.\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmitEdit(onSubmitEdit)} className=\"p-4 space-y-6\">\n              {/* Date */}\n              <div>\n                <label htmlFor=\"editDate\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Data *\n                </label>\n                <input\n                  id=\"editDate\"\n                  type=\"date\"\n                  {...registerEdit(\"date\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.date && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.date.message}</p>\n                )}\n              </div>\n\n              {/* Start Time */}\n              <div>\n                <label htmlFor=\"editStartTime\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Horario *\n                </label>\n                <input\n                  id=\"editStartTime\"\n                  type=\"time\"\n                  {...registerEdit(\"startTime\")}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.startTime && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.startTime.message}</p>\n                )}\n              </div>\n\n              {/* Duration */}\n              <div>\n                <label htmlFor=\"editDuration\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Duracao (minutos)\n                </label>\n                <input\n                  id=\"editDuration\"\n                  type=\"number\"\n                  {...registerEdit(\"duration\", { valueAsNumber: true })}\n                  placeholder={`Padrao: ${appointmentDuration} minutos`}\n                  min={15}\n                  max={480}\n                  step={5}\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.duration && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.duration.message}</p>\n                )}\n              </div>\n\n              {/* Modality */}\n              <div>\n                <label className=\"block text-sm font-medium text-foreground mb-2\">\n                  Modalidade *\n                </label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"PRESENCIAL\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Presencial</span>\n                    </div>\n                  </label>\n                  <label className=\"relative flex items-center justify-center cursor-pointer\">\n                    <input\n                      type=\"radio\"\n                      value=\"ONLINE\"\n                      {...registerEdit(\"modality\")}\n                      className=\"sr-only peer\"\n                    />\n                    <div className=\"w-full h-12 flex items-center justify-center gap-2 rounded-md border border-input bg-background text-foreground peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary peer-focus:ring-2 peer-focus:ring-ring transition-colors\">\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Online</span>\n                    </div>\n                  </label>\n                </div>\n                {editErrors.modality && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.modality.message}</p>\n                )}\n              </div>\n\n              {/* Price */}\n              <div>\n                <label htmlFor=\"editPrice\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Valor (R$)\n                </label>\n                <input\n                  id=\"editPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  {...registerEdit(\"price\", { valueAsNumber: true })}\n                  placeholder=\"Ex: 150.00\"\n                  className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                />\n                {editErrors.price && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.price.message}</p>\n                )}\n              </div>\n\n              {/* Notes */}\n              <div>\n                <label htmlFor=\"editNotes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Observacoes\n                </label>\n                <textarea\n                  id=\"editNotes\"\n                  rows={3}\n                  {...registerEdit(\"notes\")}\n                  placeholder=\"Observacoes sobre a consulta...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n                {editErrors.notes && (\n                  <p className=\"text-sm text-destructive mt-1\">{editErrors.notes.message}</p>\n                )}\n              </div>\n\n              {/* Cancellation Info (for cancelled appointments) */}\n              {(selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" || selectedAppointment.status === \"CANCELADO_PACIENTE\") && (\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-md\">\n                  <p className=\"text-sm font-medium text-red-800 mb-1\">\n                    {selectedAppointment.status === \"CANCELADO_PROFISSIONAL\" ? \"Cancelado pelo profissional\" : \"Cancelado pelo paciente\"}\n                  </p>\n                  {selectedAppointment.cancellationReason && (\n                    <p className=\"text-sm text-red-700\">\n                      Motivo: {selectedAppointment.cancellationReason}\n                    </p>\n                  )}\n                  {selectedAppointment.cancelledAt && (\n                    <p className=\"text-xs text-red-600 mt-1\">\n                      Em: {new Date(selectedAppointment.cancelledAt).toLocaleString(\"pt-BR\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {/* Quick Actions (for active appointments) */}\n              {canMarkStatus(selectedAppointment) && (\n                <div className=\"border-t border-border pt-6\">\n                  <p className=\"text-sm font-medium text-foreground mb-3\">Acoes Rapidas</p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      type=\"button\"\n                      onClick={handleFinalizarAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-gray-100 text-gray-800 font-medium border border-gray-200 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Finalizar\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handleNaoCompareceuAppointment}\n                      disabled={isUpdatingStatus || isUpdatingAppointment}\n                      className=\"h-12 rounded-md bg-yellow-100 text-yellow-800 font-medium border border-yellow-200 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\" />\n                      </svg>\n                      {isUpdatingStatus ? \"...\" : \"Nao compareceu\"}\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex flex-col sm:flex-row gap-3 pt-4 pb-8\">\n                {canCancelAppointment(selectedAppointment) ? (\n                  <>\n                    <button\n                      type=\"submit\"\n                      disabled={isUpdatingAppointment || isUpdatingStatus}\n                      className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                    >\n                      {isUpdatingAppointment ? \"Salvando...\" : \"Salvar Alteracoes\"}\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={openCancelDialog}\n                      disabled={isUpdatingStatus}\n                      className=\"flex-1 sm:flex-initial h-12 rounded-md border border-red-300 bg-red-50 text-red-700 font-medium hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                    >\n                      Cancelar Agendamento\n                    </button>\n                  </>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={closeEditSheet}\n                    className=\"flex-1 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                  >\n                    Fechar\n                  </button>\n                )}\n              </div>\n            </form>\n          </div>\n        </>\n      )}\n\n      {/* Cancel Confirmation Dialog */}\n      {isCancelDialogOpen && selectedAppointment && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/70 z-[60]\"\n            onClick={closeCancelDialog}\n          />\n\n          {/* Dialog */}\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center p-4\">\n            <div className=\"bg-background rounded-lg shadow-xl max-w-md w-full p-6 animate-scale-in\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Cancelar Agendamento\n                </h3>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Voce esta prestes a cancelar o agendamento de <strong>{selectedAppointment.patient.name}</strong>.\n                Esta acao nao pode ser desfeita.\n              </p>\n\n              {/* Cancellation Reason */}\n              <div className=\"mb-4\">\n                <label htmlFor=\"cancelReason\" className=\"block text-sm font-medium text-foreground mb-2\">\n                  Motivo do cancelamento *\n                </label>\n                <textarea\n                  id=\"cancelReason\"\n                  rows={3}\n                  value={cancelReason}\n                  onChange={(e) => setCancelReason(e.target.value)}\n                  placeholder=\"Informe o motivo do cancelamento...\"\n                  className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                />\n              </div>\n\n              {/* Notify Patient Option */}\n              {hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6\">\n                  <label className=\"flex items-center gap-3 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={notifyPatient}\n                      onChange={(e) => setNotifyPatient(e.target.checked)}\n                      className=\"w-5 h-5 rounded border-input text-primary focus:ring-primary\"\n                    />\n                    <span className=\"text-sm text-foreground\">\n                      Notificar paciente sobre o cancelamento\n                    </span>\n                  </label>\n                  <p className=\"text-xs text-muted-foreground mt-1 ml-8\">\n                    O paciente sera notificado via {selectedAppointment.patient.consentWhatsApp && selectedAppointment.patient.consentEmail ? \"WhatsApp e email\" : selectedAppointment.patient.consentWhatsApp ? \"WhatsApp\" : \"email\"}\n                  </p>\n                </div>\n              )}\n\n              {!hasNotificationConsent(selectedAppointment) && (\n                <div className=\"mb-6 p-3 bg-muted/50 rounded-md\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    O paciente nao possui consentimento para receber notificacoes.\n                  </p>\n                </div>\n              )}\n\n              {/* Dialog Actions */}\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={closeCancelDialog}\n                  disabled={isCancellingAppointment}\n                  className=\"flex-1 h-11 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 transition-colors\"\n                >\n                  Voltar\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelAppointment}\n                  disabled={isCancellingAppointment || !cancelReason.trim()}\n                  className=\"flex-1 h-11 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n                >\n                  {isCancellingAppointment ? \"Cancelando...\" : \"Confirmar Cancelamento\"}\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":10,"oldLines":9,"newStart":10,"newLines":7,"lines":[" import {","   BottomNavigation,","   FAB,","-  BottomSheet,","   SkeletonAgenda,","-  ErrorState,","   EmptyState,","   SwipeContainer,"," } from \"@/shared/components/ui\""]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KHJnGjngwgQb5LDr3BK1Ny","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BqJXGi4DETSE3g8ncXpHhP","name":"Edit","input":{"replace_all":false,"file_path":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","old_string":"import {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"","new_string":"import {\n  BottomNavigation,\n  FAB,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":283,"cache_read_input_tokens":119833,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":283},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"7e349cc4-da75-42fd-8481-f58aede36406"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BqJXGi4DETSE3g8ncXpHhP","type":"tool_result","content":"The file /mnt/d/personal/clinica/src/src/app/patients/page.tsx has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"446e3add-f3c9-493c-8435-bfe93136d217","tool_use_result":{"filePath":"/mnt/d/personal/clinica/src/src/app/patients/page.tsx","oldString":"import {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"","newString":"import {\n  BottomNavigation,\n  FAB,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"","originalFile":"\"use client\"\n\nimport { useCallback, useEffect, useState } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useSession } from \"next-auth/react\"\nimport { useForm } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport { z } from \"zod\"\nimport { toast } from \"sonner\"\nimport {\n  BottomNavigation,\n  FAB,\n  BottomSheet,\n  SkeletonPage,\n  EmptyState,\n} from \"@/shared/components/ui\"\n\n// WhatsApp format validation\nconst phoneRegex = /^(\\+?55)?(\\d{2})(\\d{8,9})$/\n\nconst patientSchema = z.object({\n  name: z.string().min(2, \"Nome deve ter pelo menos 2 caracteres\").max(200),\n  phone: z\n    .string()\n    .min(1, \"Telefone é obrigatório\")\n    .regex(phoneRegex, \"Telefone inválido. Use formato: 11999999999\"),\n  email: z.string().email(\"Email inválido\").optional().or(z.literal(\"\")),\n  notes: z.string().max(2000).optional().or(z.literal(\"\")),\n  consentWhatsApp: z.boolean(),\n  consentEmail: z.boolean(),\n})\n\ntype PatientFormData = z.infer<typeof patientSchema>\n\ninterface Appointment {\n  id: string\n  scheduledAt: string\n  endAt: string\n  status: string\n  modality: string\n  notes: string | null\n  professionalProfile: {\n    id: string\n    user: {\n      name: string\n    }\n  }\n}\n\ninterface Patient {\n  id: string\n  name: string\n  email: string | null\n  phone: string\n  birthDate: string | null\n  notes: string | null\n  isActive: boolean\n  lastVisitAt: string | null\n  consentWhatsApp: boolean\n  consentWhatsAppAt: string | null\n  consentEmail: boolean\n  consentEmailAt: string | null\n  createdAt: string\n  appointments?: Appointment[]\n}\n\nfunction formatPhone(phone: string): string {\n  // Format: (11) 99999-9999\n  const digits = phone.replace(/\\D/g, \"\")\n  if (digits.length === 11) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`\n  }\n  if (digits.length === 10) {\n    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`\n  }\n  return phone\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"-\"\n  return new Date(dateString).toLocaleDateString(\"pt-BR\")\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"pt-BR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n\nconst statusLabels: Record<string, string> = {\n  AGENDADO: \"Agendado\",\n  CONFIRMADO: \"Confirmado\",\n  CANCELADO_PACIENTE: \"Cancelado (Paciente)\",\n  CANCELADO_PROFISSIONAL: \"Cancelado (Profissional)\",\n  NAO_COMPARECEU: \"Não compareceu\",\n  FINALIZADO: \"Finalizado\",\n}\n\nconst statusColors: Record<string, string> = {\n  AGENDADO: \"bg-blue-100 text-blue-800\",\n  CONFIRMADO: \"bg-green-100 text-green-800\",\n  CANCELADO_PACIENTE: \"bg-red-100 text-red-800\",\n  CANCELADO_PROFISSIONAL: \"bg-red-100 text-red-800\",\n  NAO_COMPARECEU: \"bg-yellow-100 text-yellow-800\",\n  FINALIZADO: \"bg-gray-100 text-gray-800\",\n}\n\nexport default function PatientsPage() {\n  const router = useRouter()\n  const { data: session, status } = useSession()\n  const [isLoading, setIsLoading] = useState(true)\n  const [patients, setPatients] = useState<Patient[]>([])\n  const [search, setSearch] = useState(\"\")\n  const [filterActive, setFilterActive] = useState<string>(\"all\")\n  const [isSheetOpen, setIsSheetOpen] = useState(false)\n  const [editingPatient, setEditingPatient] = useState<Patient | null>(null)\n  const [viewingPatient, setViewingPatient] = useState<Patient | null>(null)\n  const [isSaving, setIsSaving] = useState(false)\n  const [isLoadingDetails, setIsLoadingDetails] = useState(false)\n\n  const isAdmin = session?.user?.role === \"ADMIN\"\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    formState: { errors },\n  } = useForm<PatientFormData>({\n    resolver: zodResolver(patientSchema),\n    defaultValues: {\n      consentWhatsApp: false,\n      consentEmail: false,\n    },\n  })\n\n  const fetchPatients = useCallback(async () => {\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set(\"search\", search)\n      if (filterActive !== \"all\") params.set(\"isActive\", filterActive)\n\n      const response = await fetch(`/api/patients?${params.toString()}`)\n      if (!response.ok) {\n        if (response.status === 403) {\n          toast.error(\"Acesso negado\")\n          router.push(\"/\")\n          return\n        }\n        throw new Error(\"Failed to fetch patients\")\n      }\n      const data = await response.json()\n      setPatients(data.patients)\n    } catch {\n      toast.error(\"Erro ao carregar pacientes\")\n    } finally {\n      setIsLoading(false)\n    }\n  }, [search, filterActive, router])\n\n  const fetchPatientDetails = useCallback(async (patientId: string) => {\n    setIsLoadingDetails(true)\n    try {\n      const response = await fetch(`/api/patients/${patientId}`)\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch patient details\")\n      }\n      const data = await response.json()\n      setViewingPatient(data.patient)\n    } catch {\n      toast.error(\"Erro ao carregar detalhes do paciente\")\n    } finally {\n      setIsLoadingDetails(false)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (status === \"unauthenticated\") {\n      router.push(\"/login\")\n      return\n    }\n\n    if (status === \"authenticated\") {\n      fetchPatients()\n    }\n  }, [status, router, fetchPatients])\n\n  function openCreateSheet() {\n    setEditingPatient(null)\n    setViewingPatient(null)\n    reset({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      notes: \"\",\n      consentWhatsApp: false,\n      consentEmail: false,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openEditSheet(patient: Patient) {\n    setEditingPatient(patient)\n    setViewingPatient(null)\n    reset({\n      name: patient.name,\n      phone: patient.phone,\n      email: patient.email ?? \"\",\n      notes: patient.notes ?? \"\",\n      consentWhatsApp: patient.consentWhatsApp,\n      consentEmail: patient.consentEmail,\n    })\n    setIsSheetOpen(true)\n  }\n\n  function openViewSheet(patient: Patient) {\n    setEditingPatient(null)\n    fetchPatientDetails(patient.id)\n    setIsSheetOpen(true)\n  }\n\n  function closeSheet() {\n    setIsSheetOpen(false)\n    setEditingPatient(null)\n    setViewingPatient(null)\n  }\n\n  async function onSubmit(data: PatientFormData) {\n    setIsSaving(true)\n    try {\n      const url = editingPatient\n        ? `/api/patients/${editingPatient.id}`\n        : \"/api/patients\"\n      const method = editingPatient ? \"PATCH\" : \"POST\"\n\n      const payload: Record<string, unknown> = {\n        name: data.name,\n        phone: data.phone.replace(/\\D/g, \"\"),\n        email: data.email || null,\n        notes: data.notes || null,\n        consentWhatsApp: data.consentWhatsApp,\n        consentEmail: data.consentEmail,\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to save patient\")\n      }\n\n      toast.success(\n        editingPatient\n          ? \"Paciente atualizado com sucesso\"\n          : \"Paciente criado com sucesso\"\n      )\n      closeSheet()\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao salvar paciente\")\n    } finally {\n      setIsSaving(false)\n    }\n  }\n\n  async function handleDeactivate(patient: Patient) {\n    if (!confirm(`Deseja realmente desativar ${patient.name}?`)) {\n      return\n    }\n\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"DELETE\",\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to deactivate patient\")\n      }\n\n      toast.success(\"Paciente desativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao desativar paciente\")\n    }\n  }\n\n  async function handleReactivate(patient: Patient) {\n    try {\n      const response = await fetch(`/api/patients/${patient.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isActive: true }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || \"Failed to reactivate patient\")\n      }\n\n      toast.success(\"Paciente reativado com sucesso\")\n      fetchPatients()\n    } catch (error) {\n      toast.error(error instanceof Error ? error.message : \"Erro ao reativar paciente\")\n    }\n  }\n\n  if (status === \"loading\" || isLoading) {\n    return (\n      <main className=\"min-h-screen bg-background pb-20\">\n        <div className=\"max-w-4xl mx-auto px-4 py-8\">\n          <SkeletonPage />\n        </div>\n        <BottomNavigation />\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen bg-background pb-20\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <button\n            onClick={() => router.back()}\n            className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            &larr; Voltar\n          </button>\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <h1 className=\"text-2xl font-semibold text-foreground\">Pacientes</h1>\n          {isAdmin && (\n            <button\n              onClick={openCreateSheet}\n              className=\"h-10 px-4 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-opacity\"\n            >\n              + Novo Paciente\n            </button>\n          )}\n        </div>\n\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1\">\n            <input\n              type=\"text\"\n              placeholder=\"Buscar por nome, email ou telefone...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n            />\n          </div>\n          <select\n            value={filterActive}\n            onChange={(e) => setFilterActive(e.target.value)}\n            className=\"h-12 px-4 rounded-md border border-input bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n          >\n            <option value=\"all\">Todos</option>\n            <option value=\"true\">Ativos</option>\n            <option value=\"false\">Inativos</option>\n          </select>\n        </div>\n\n        {/* Patients List */}\n        <div className=\"space-y-4\">\n          {patients.length === 0 ? (\n            <EmptyState\n              title={search || filterActive !== \"all\" ? \"Nenhum paciente encontrado\" : \"Nenhum paciente cadastrado\"}\n              message={search || filterActive !== \"all\" ? \"Tente ajustar os filtros de busca\" : \"Adicione seu primeiro paciente para comecar\"}\n              action={isAdmin && !search && filterActive === \"all\" ? { label: \"Adicionar paciente\", onClick: openCreateSheet } : undefined}\n              icon={\n                <svg className=\"w-8 h-8 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n                </svg>\n              }\n            />\n          ) : (\n            patients.map((patient) => (\n              <div\n                key={patient.id}\n                className={`bg-card border border-border rounded-lg p-4 sm:p-6 ${\n                  !patient.isActive ? \"opacity-60\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                  <div\n                    className=\"flex-1 min-w-0 cursor-pointer\"\n                    onClick={() => openViewSheet(patient)}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <h3 className=\"font-medium text-foreground truncate\">\n                        {patient.name}\n                      </h3>\n                      {!patient.isActive && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground\">\n                          Inativo\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {formatPhone(patient.phone)}\n                    </p>\n                    {patient.email && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {patient.email}\n                      </p>\n                    )}\n                    <div className=\"flex gap-3 mt-2\">\n                      {patient.consentWhatsApp && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800\">\n                          WhatsApp\n                        </span>\n                      )}\n                      {patient.consentEmail && (\n                        <span className=\"text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800\">\n                          Email\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  {isAdmin && (\n                    <div className=\"flex gap-2\">\n                      <button\n                        onClick={() => openEditSheet(patient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                      {patient.isActive ? (\n                        <button\n                          onClick={() => handleDeactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-destructive text-destructive text-sm font-medium hover:bg-destructive hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Desativar\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => handleReactivate(patient)}\n                          className=\"h-9 px-3 rounded-md border border-primary text-primary text-sm font-medium hover:bg-primary hover:text-primary-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Reativar\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* Bottom Sheet */}\n      {isSheetOpen && (\n        <>\n          {/* Backdrop */}\n          <div\n            className=\"fixed inset-0 bg-black/50 z-40\"\n            onClick={closeSheet}\n          />\n          {/* Sheet */}\n          <div className=\"fixed inset-x-0 bottom-0 z-50 bg-background border-t border-border rounded-t-2xl max-h-[90vh] overflow-y-auto animate-slide-up\">\n            <div className=\"max-w-2xl mx-auto px-4 py-6\">\n              {/* Handle */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-12 h-1.5 rounded-full bg-muted\" />\n              </div>\n\n              {/* View Mode */}\n              {viewingPatient && !editingPatient && (\n                <>\n                  <div className=\"flex items-center justify-between mb-6\">\n                    <h2 className=\"text-xl font-semibold text-foreground\">\n                      {viewingPatient.name}\n                    </h2>\n                    {isAdmin && (\n                      <button\n                        onClick={() => openEditSheet(viewingPatient)}\n                        className=\"h-9 px-3 rounded-md border border-input bg-background text-foreground text-sm font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Editar\n                      </button>\n                    )}\n                  </div>\n\n                  {isLoadingDetails ? (\n                    <div className=\"animate-pulse space-y-4\">\n                      <div className=\"h-6 w-32 bg-muted rounded\" />\n                      <div className=\"h-4 w-48 bg-muted rounded\" />\n                      <div className=\"h-4 w-40 bg-muted rounded\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-6\">\n                      {/* Contact Info */}\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Telefone</label>\n                          <p className=\"text-foreground\">{formatPhone(viewingPatient.phone)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Email</label>\n                          <p className=\"text-foreground\">{viewingPatient.email || \"-\"}</p>\n                        </div>\n                      </div>\n\n                      {/* Notes */}\n                      {viewingPatient.notes && (\n                        <div>\n                          <label className=\"text-sm text-muted-foreground\">Observacoes</label>\n                          <p className=\"text-foreground whitespace-pre-wrap\">{viewingPatient.notes}</p>\n                        </div>\n                      )}\n\n                      {/* Consent Info */}\n                      <div>\n                        <label className=\"text-sm text-muted-foreground mb-2 block\">Consentimentos LGPD</label>\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentWhatsApp ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">WhatsApp</span>\n                            {viewingPatient.consentWhatsAppAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentWhatsAppAt)})\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`w-3 h-3 rounded-full ${viewingPatient.consentEmail ? 'bg-green-500' : 'bg-gray-300'}`} />\n                            <span className=\"text-sm\">Email</span>\n                            {viewingPatient.consentEmailAt && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({formatDate(viewingPatient.consentEmailAt)})\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Appointment History */}\n                      <div>\n                        <h3 className=\"text-lg font-medium text-foreground mb-4\">\n                          Historico de Consultas\n                        </h3>\n                        {viewingPatient.appointments && viewingPatient.appointments.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {viewingPatient.appointments.map((appointment) => (\n                              <div\n                                key={appointment.id}\n                                className=\"bg-muted/50 rounded-lg p-4\"\n                              >\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <span className=\"font-medium\">\n                                    {formatDateTime(appointment.scheduledAt)}\n                                  </span>\n                                  <span className={`text-xs px-2 py-1 rounded-full ${statusColors[appointment.status] || 'bg-gray-100 text-gray-800'}`}>\n                                    {statusLabels[appointment.status] || appointment.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.professionalProfile.user.name}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {appointment.modality === \"ONLINE\" ? \"Online\" : \"Presencial\"}\n                                </p>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <p className=\"text-muted-foreground text-sm\">\n                            Nenhuma consulta registrada\n                          </p>\n                        )}\n                      </div>\n\n                      <div className=\"pt-4\">\n                        <button\n                          type=\"button\"\n                          onClick={closeSheet}\n                          className=\"w-full h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                        >\n                          Fechar\n                        </button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Create/Edit Mode */}\n              {(editingPatient || (!viewingPatient && !isLoadingDetails)) && isAdmin && (\n                <>\n                  <h2 className=\"text-xl font-semibold text-foreground mb-6\">\n                    {editingPatient ? \"Editar Paciente\" : \"Novo Paciente\"}\n                  </h2>\n\n                  <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div>\n                      <label htmlFor=\"name\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Nome *\n                      </label>\n                      <input\n                        id=\"name\"\n                        type=\"text\"\n                        {...register(\"name\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.name && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"phone\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Telefone (WhatsApp) *\n                      </label>\n                      <input\n                        id=\"phone\"\n                        type=\"tel\"\n                        {...register(\"phone\")}\n                        placeholder=\"11999999999\"\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.phone && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.phone.message}</p>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Formato: DDD + numero (ex: 11999999999)\n                      </p>\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"email\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Email\n                      </label>\n                      <input\n                        id=\"email\"\n                        type=\"email\"\n                        {...register(\"email\")}\n                        className=\"w-full h-12 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors\"\n                      />\n                      {errors.email && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <label htmlFor=\"notes\" className=\"block text-sm font-medium text-foreground mb-2\">\n                        Observacoes administrativas\n                      </label>\n                      <textarea\n                        id=\"notes\"\n                        rows={3}\n                        {...register(\"notes\")}\n                        placeholder=\"Observacoes internas sobre o paciente...\"\n                        className=\"w-full px-4 py-3 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent transition-colors resize-none\"\n                      />\n                      {errors.notes && (\n                        <p className=\"text-sm text-destructive mt-1\">{errors.notes.message}</p>\n                      )}\n                    </div>\n\n                    {/* LGPD Consent Section */}\n                    <div className=\"border border-border rounded-lg p-4\">\n                      <h3 className=\"text-sm font-medium text-foreground mb-4\">\n                        Consentimentos LGPD\n                      </h3>\n                      <div className=\"space-y-4\">\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentWhatsApp\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber mensagens via WhatsApp\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n\n                        <label className=\"flex items-start gap-3 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            {...register(\"consentEmail\")}\n                            className=\"mt-1 h-4 w-4 rounded border-input text-primary focus:ring-ring\"\n                          />\n                          <div>\n                            <span className=\"text-sm text-foreground\">\n                              Autorizo receber comunicacoes por email\n                            </span>\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Lembretes de consulta, confirmacoes e comunicacoes da clinica\n                            </p>\n                          </div>\n                        </label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n                      <button\n                        type=\"submit\"\n                        disabled={isSaving}\n                        className=\"flex-1 h-12 rounded-md bg-primary text-primary-foreground font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed transition-opacity\"\n                      >\n                        {isSaving\n                          ? \"Salvando...\"\n                          : editingPatient\n                          ? \"Salvar alteracoes\"\n                          : \"Criar paciente\"}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={closeSheet}\n                        className=\"flex-1 sm:flex-initial sm:w-32 h-12 rounded-md border border-input bg-background text-foreground font-medium hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background transition-colors\"\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                  </form>\n                </>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* FAB for adding patients */}\n      {isAdmin && (\n        <FAB onClick={openCreateSheet} label=\"Novo paciente\" />\n      )}\n\n      {/* Bottom Navigation */}\n      <BottomNavigation />\n    </main>\n  )\n}\n","structuredPatch":[{"oldStart":10,"oldLines":7,"newStart":10,"newLines":6,"lines":[" import {","   BottomNavigation,","   FAB,","-  BottomSheet,","   SkeletonPage,","   EmptyState,"," } from \"@/shared/components/ui\""]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DeZtzHi1khxQzvQ8LT3Vht","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WAaKm2GsU1ZyZSCAph8djN","name":"Bash","input":{"command":"npx --yes eslint src --ext .ts,.tsx 2>&1 | head -30","description":"Re-run eslint"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":256,"cache_read_input_tokens":120116,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":256},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"cfc5f62a-30d9-4bd7-ba50-f80d877f5ec1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WAaKm2GsU1ZyZSCAph8djN","type":"tool_result","content":"/mnt/d/personal/clinica/src/src/lib/notifications/providers/whatsapp-mock.ts\n  14:5  warning  '_subject' is defined but never used  @typescript-eslint/no-unused-vars\n\n✖ 1 problem (0 errors, 1 warning)","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b2b59859-3987-47a8-a1e3-7dba1ae7e173","tool_use_result":{"stdout":"/mnt/d/personal/clinica/src/src/lib/notifications/providers/whatsapp-mock.ts\n  14:5  warning  '_subject' is defined but never used  @typescript-eslint/no-unused-vars\n\n✖ 1 problem (0 errors, 1 warning)","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PqGP5Yudko7u8gAY1PVsp8","type":"message","role":"assistant","content":[{"type":"text","text":"The remaining warning is in a different file not related to this PR. Let me try running a build to make sure everything compiles."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":441,"cache_read_input_tokens":120372,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":441},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"e05347be-4aec-48d7-9de8-e17de43740b1"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PqGP5Yudko7u8gAY1PVsp8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Hn4AWTuneRAbSZ3gcMK3nR","name":"Bash","input":{"command":"npx next build 2>&1 | tail -30","description":"Run Next.js build","timeout":180000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":441,"cache_read_input_tokens":120372,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":441},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"29a5a1c0-6767-4583-8e9b-2643c4921ba8"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Hn4AWTuneRAbSZ3gcMK3nR","type":"tool_result","content":"├ ƒ /api/appointments/[id]/notifications\n├ ƒ /api/appointments/[id]/status\n├ ƒ /api/appointments/cancel\n├ ƒ /api/appointments/confirm\n├ ƒ /api/auth/[...nextauth]\n├ ƒ /api/availability\n├ ƒ /api/availability/exceptions\n├ ƒ /api/availability/exceptions/[id]\n├ ƒ /api/me\n├ ƒ /api/patients\n├ ƒ /api/patients/[id]\n├ ƒ /api/professionals\n├ ƒ /api/professionals/[id]\n├ ƒ /api/profile\n├ ƒ /api/public/appointments/cancel\n├ ƒ /api/public/appointments/confirm\n├ ƒ /api/public/appointments/lookup\n├ ○ /cancel\n├ ○ /confirm\n├ ○ /login\n├ ○ /patients\n├ ○ /profile\n└ ○ /settings/availability\n\n\nƒ Proxy (Middleware)\n\n○  (Static)   prerendered as static content\nƒ  (Dynamic)  server-rendered on demand","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"18d0c546-9ff0-4697-92b7-5885b494ee7c","tool_use_result":{"stdout":"├ ƒ /api/appointments/[id]/notifications\n├ ƒ /api/appointments/[id]/status\n├ ƒ /api/appointments/cancel\n├ ƒ /api/appointments/confirm\n├ ƒ /api/auth/[...nextauth]\n├ ƒ /api/availability\n├ ƒ /api/availability/exceptions\n├ ƒ /api/availability/exceptions/[id]\n├ ƒ /api/me\n├ ƒ /api/patients\n├ ƒ /api/patients/[id]\n├ ƒ /api/professionals\n├ ƒ /api/professionals/[id]\n├ ƒ /api/profile\n├ ƒ /api/public/appointments/cancel\n├ ƒ /api/public/appointments/confirm\n├ ƒ /api/public/appointments/lookup\n├ ○ /cancel\n├ ○ /confirm\n├ ○ /login\n├ ○ /patients\n├ ○ /profile\n└ ○ /settings/availability\n\n\nƒ Proxy (Middleware)\n\n○  (Static)   prerendered as static content\nƒ  (Dynamic)  server-rendered on demand","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Nu9whBgjeNvoKwQgq7qRaL","type":"message","role":"assistant","content":[{"type":"text","text":"The build passes. Now let me create the commit."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":466,"cache_read_input_tokens":120813,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":466},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"f7d4c232-4444-40c2-86f9-1d9ce602af43"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Nu9whBgjeNvoKwQgq7qRaL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014CJx2qYnerTsEEPWPG7do7","name":"Bash","input":{"command":"git status","description":"Check git status"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":466,"cache_read_input_tokens":120813,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":466},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"5c0b66d5-fa2c-4ed6-887a-667fdd86f47a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014CJx2qYnerTsEEPWPG7do7","type":"tool_result","content":"On branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .ralph-tui/session-meta.json\n\tmodified:   .ralph-tui/session.json\n\tmodified:   README.md\n\tmodified:   docker-compose.yml\n\tmodified:   prisma/seed.ts\n\tmodified:   src/app/agenda/page.tsx\n\tmodified:   src/app/globals.css\n\tmodified:   src/app/patients/page.tsx\n\tmodified:   src/app/settings/availability/page.tsx\n\tmodified:   tasks/prd.json\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\t.ralph-tui/iterations/99fc4b79_2026-01-29_08-47-51_US-029.log\n\tsrc/shared/components/ui/\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"13d4e7c2-17f1-459a-bbc0-98a0f8e1815c","tool_use_result":{"stdout":"On branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .ralph-tui/session-meta.json\n\tmodified:   .ralph-tui/session.json\n\tmodified:   README.md\n\tmodified:   docker-compose.yml\n\tmodified:   prisma/seed.ts\n\tmodified:   src/app/agenda/page.tsx\n\tmodified:   src/app/globals.css\n\tmodified:   src/app/patients/page.tsx\n\tmodified:   src/app/settings/availability/page.tsx\n\tmodified:   tasks/prd.json\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\t.ralph-tui/iterations/99fc4b79_2026-01-29_08-47-51_US-029.log\n\tsrc/shared/components/ui/\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_014uWJZBtyQScBcXCic5un6N","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012qie79entbhe1QThCLHU3i","name":"Bash","input":{"command":"git diff src/app/globals.css | head -100","description":"Check globals.css changes"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":360,"cache_read_input_tokens":121279,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":360},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"40856d5a-5544-4f1b-bc26-9b219e825652"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012qie79entbhe1QThCLHU3i","type":"tool_result","content":"diff --git a/src/app/globals.css b/src/app/globals.css\nindex 860f8ef..27ed856 100644\n--- a/src/app/globals.css\n+++ b/src/app/globals.css\n@@ -80,8 +80,148 @@\n   }\n }\n \n+/* Prevent horizontal scroll */\n+html,\n+body {\n+  overflow-x: hidden;\n+  overscroll-behavior-x: none;\n+}\n+\n body {\n   background: var(--background);\n   color: var(--foreground);\n   font-family: var(--font-sans), system-ui, sans-serif;\n+  -webkit-font-smoothing: antialiased;\n+  -moz-osx-font-smoothing: grayscale;\n+}\n+\n+/* Safe area padding for iOS */\n+.safe-area-pb {\n+  padding-bottom: env(safe-area-inset-bottom);\n+}\n+\n+.safe-area-pt {\n+  padding-top: env(safe-area-inset-top);\n+}\n+\n+/* Touch-friendly targets */\n+.touch-target {\n+  min-height: 44px;\n+  min-width: 44px;\n+}\n+\n+/* Improved touch handling */\n+.touch-manipulation {\n+  touch-action: manipulation;\n+}\n+\n+/* Prevent text selection on buttons */\n+button,\n+[role=\"button\"] {\n+  user-select: none;\n+  -webkit-user-select: none;\n+}\n+\n+/* Improved scroll behavior */\n+.overscroll-contain {\n+  overscroll-behavior: contain;\n+}\n+\n+/* Active state for touch devices */\n+@media (hover: none) and (pointer: coarse) {\n+  button:active,\n+  [role=\"button\"]:active {\n+    transform: scale(0.98);\n+  }\n+}\n+\n+/* Ensure inputs are large enough for touch */\n+input,\n+select,\n+textarea {\n+  font-size: 16px; /* Prevents zoom on iOS */\n+}\n+\n+/* Smooth scrolling for iOS */\n+.scroll-smooth {\n+  -webkit-overflow-scrolling: touch;\n+}\n+\n+/* Hide scrollbars on mobile but keep functionality */\n+@media (max-width: 640px) {\n+  .hide-scrollbar {\n+    -ms-overflow-style: none;\n+    scrollbar-width: none;\n+  }\n+  .hide-scrollbar::-webkit-scrollbar {\n+    display: none;\n+  }\n+}\n+\n+/* Animation keyframes */\n+@keyframes slide-up {\n+  from {\n+    transform: translateY(100%);\n+  }\n+  to {\n+    transform: translateY(0);\n+  }\n+}\n+\n+@keyframes slide-down {\n+  from {\n+    transform: translateY(0);\n+  }","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"c1a1735e-3df4-43a1-abbe-cdc3ab2f1364","tool_use_result":{"stdout":"diff --git a/src/app/globals.css b/src/app/globals.css\nindex 860f8ef..27ed856 100644\n--- a/src/app/globals.css\n+++ b/src/app/globals.css\n@@ -80,8 +80,148 @@\n   }\n }\n \n+/* Prevent horizontal scroll */\n+html,\n+body {\n+  overflow-x: hidden;\n+  overscroll-behavior-x: none;\n+}\n+\n body {\n   background: var(--background);\n   color: var(--foreground);\n   font-family: var(--font-sans), system-ui, sans-serif;\n+  -webkit-font-smoothing: antialiased;\n+  -moz-osx-font-smoothing: grayscale;\n+}\n+\n+/* Safe area padding for iOS */\n+.safe-area-pb {\n+  padding-bottom: env(safe-area-inset-bottom);\n+}\n+\n+.safe-area-pt {\n+  padding-top: env(safe-area-inset-top);\n+}\n+\n+/* Touch-friendly targets */\n+.touch-target {\n+  min-height: 44px;\n+  min-width: 44px;\n+}\n+\n+/* Improved touch handling */\n+.touch-manipulation {\n+  touch-action: manipulation;\n+}\n+\n+/* Prevent text selection on buttons */\n+button,\n+[role=\"button\"] {\n+  user-select: none;\n+  -webkit-user-select: none;\n+}\n+\n+/* Improved scroll behavior */\n+.overscroll-contain {\n+  overscroll-behavior: contain;\n+}\n+\n+/* Active state for touch devices */\n+@media (hover: none) and (pointer: coarse) {\n+  button:active,\n+  [role=\"button\"]:active {\n+    transform: scale(0.98);\n+  }\n+}\n+\n+/* Ensure inputs are large enough for touch */\n+input,\n+select,\n+textarea {\n+  font-size: 16px; /* Prevents zoom on iOS */\n+}\n+\n+/* Smooth scrolling for iOS */\n+.scroll-smooth {\n+  -webkit-overflow-scrolling: touch;\n+}\n+\n+/* Hide scrollbars on mobile but keep functionality */\n+@media (max-width: 640px) {\n+  .hide-scrollbar {\n+    -ms-overflow-style: none;\n+    scrollbar-width: none;\n+  }\n+  .hide-scrollbar::-webkit-scrollbar {\n+    display: none;\n+  }\n+}\n+\n+/* Animation keyframes */\n+@keyframes slide-up {\n+  from {\n+    transform: translateY(100%);\n+  }\n+  to {\n+    transform: translateY(0);\n+  }\n+}\n+\n+@keyframes slide-down {\n+  from {\n+    transform: translateY(0);\n+  }","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0175W6p5zkS38NX6ou5rEji9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015hEbeyPCq1rHV6tFvSdccg","name":"Bash","input":{"command":"git add src/app/globals.css src/app/agenda/page.tsx src/app/patients/page.tsx src/app/settings/availability/page.tsx src/shared/components/ui/","description":"Stage files for commit"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":856,"cache_read_input_tokens":121639,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":856},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"4a907212-e2df-4bc1-a8ae-f3352748849a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015hEbeyPCq1rHV6tFvSdccg","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"22f8cc70-50d6-4e99-96f5-2e45fcb3369c","tool_use_result":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DnMgCnzrNbmWsT98VFjiLp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LrQTgALRNWHYcFg58SuyEt","name":"Bash","input":{"command":"git diff --cached --stat","description":"Show staged changes"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":143,"cache_read_input_tokens":122495,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":143},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"90e7471f-e0ae-4178-84d2-c1de9f7aa97e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LrQTgALRNWHYcFg58SuyEt","type":"tool_result","content":" src/app/agenda/page.tsx                        | 156 ++++----------------\n src/app/globals.css                            | 140 ++++++++++++++++++\n src/app/patients/page.tsx                      |  60 ++++----\n src/app/settings/availability/page.tsx         |  57 ++------\n src/shared/components/ui/bottom-navigation.tsx |  85 +++++++++++\n src/shared/components/ui/bottom-sheet.tsx      | 189 +++++++++++++++++++++++++\n src/shared/components/ui/error-state.tsx       | 144 +++++++++++++++++++\n src/shared/components/ui/fab.tsx               |  31 ++++\n src/shared/components/ui/index.ts              |  15 ++\n src/shared/components/ui/skeleton.tsx          | 114 +++++++++++++++\n src/shared/components/ui/swipe-container.tsx   |  75 ++++++++++\n 11 files changed, 859 insertions(+), 207 deletions(-)","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b9245b2a-e4db-4891-95d2-0adfa11c59de","tool_use_result":{"stdout":" src/app/agenda/page.tsx                        | 156 ++++----------------\n src/app/globals.css                            | 140 ++++++++++++++++++\n src/app/patients/page.tsx                      |  60 ++++----\n src/app/settings/availability/page.tsx         |  57 ++------\n src/shared/components/ui/bottom-navigation.tsx |  85 +++++++++++\n src/shared/components/ui/bottom-sheet.tsx      | 189 +++++++++++++++++++++++++\n src/shared/components/ui/error-state.tsx       | 144 +++++++++++++++++++\n src/shared/components/ui/fab.tsx               |  31 ++++\n src/shared/components/ui/index.ts              |  15 ++\n src/shared/components/ui/skeleton.tsx          | 114 +++++++++++++++\n src/shared/components/ui/swipe-container.tsx   |  75 ++++++++++\n 11 files changed, 859 insertions(+), 207 deletions(-)","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_016SmHmgFqXhNrgVkuLpJm6f","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0127EesemJeyf5C7DhBpZRH2","name":"Bash","input":{"command":"git log --oneline -5","description":"Check recent commits for style"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":356,"cache_read_input_tokens":122638,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":356},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b3bd477b-8134-4381-843d-79602b1469dd"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0127EesemJeyf5C7DhBpZRH2","type":"tool_result","content":"e83ad19 feat: US-029 - Seed de dados para desenvolvimento\n347f2f7 feat: US-029 - Seed de dados para desenvolvimento\na4139f3 feat: US-028 - Configurações da clínica\n038d972 feat: US-028 - Configurações da clínica\nee3a40b feat: US-027 - Sistema de auditoria completo","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"09e422fe-8f29-44c0-967c-2d3b5761645f","tool_use_result":{"stdout":"e83ad19 feat: US-029 - Seed de dados para desenvolvimento\n347f2f7 feat: US-029 - Seed de dados para desenvolvimento\na4139f3 feat: US-028 - Configurações da clínica\n038d972 feat: US-028 - Configurações da clínica\nee3a40b feat: US-027 - Sistema de auditoria completo","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_015hDYsq4sRrQKJXYws3Fb71","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JfHxS473TjXeYceMrGHRt2","name":"Bash","input":{"command":"git commit -m \"$(cat <<'EOF'\nfeat: US-030 - Responsividade e UX mobile final\n\n- Add reusable UI components (BottomNavigation, FAB, BottomSheet, Skeleton, ErrorState, SwipeContainer)\n- Implement bottom navigation with 44px+ touch targets\n- Add FAB positioned correctly above bottom nav\n- Create skeleton loading screens for all pages\n- Add horizontal scroll prevention globally\n- Improve swipe gestures with dedicated SwipeContainer\n- Add iOS safe area support\n- Prevent input zoom on iOS (16px minimum font)\n- Add touch-manipulation for better touch response\n- Consolidate animations in globals.css\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>\nEOF\n)\"","description":"Create commit"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":189,"cache_read_input_tokens":122994,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":189},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"01a2ba06-2cd6-4c15-b745-867e134f44e8"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JfHxS473TjXeYceMrGHRt2","type":"tool_result","content":"[main 15c0bf8] feat: US-030 - Responsividade e UX mobile final\n Committer: root <root@Saltlake.localdomain>\nYour name and email address were configured automatically based\non your username and hostname. Please check that they are accurate.\nYou can suppress this message by setting them explicitly:\n\n    git config --global user.name \"Your Name\"\n    git config --global user.email you@example.com\n\nAfter doing this, you may fix the identity used for this commit with:\n\n    git commit --amend --reset-author\n\n 11 files changed, 859 insertions(+), 207 deletions(-)\n create mode 100644 src/shared/components/ui/bottom-navigation.tsx\n create mode 100644 src/shared/components/ui/bottom-sheet.tsx\n create mode 100644 src/shared/components/ui/error-state.tsx\n create mode 100644 src/shared/components/ui/fab.tsx\n create mode 100644 src/shared/components/ui/index.ts\n create mode 100644 src/shared/components/ui/skeleton.tsx\n create mode 100644 src/shared/components/ui/swipe-container.tsx","is_error":false}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b37557cc-78d4-4144-9b43-dcbf1bc8221a","tool_use_result":{"stdout":"[main 15c0bf8] feat: US-030 - Responsividade e UX mobile final\n Committer: root <root@Saltlake.localdomain>\nYour name and email address were configured automatically based\non your username and hostname. Please check that they are accurate.\nYou can suppress this message by setting them explicitly:\n\n    git config --global user.name \"Your Name\"\n    git config --global user.email you@example.com\n\nAfter doing this, you may fix the identity used for this commit with:\n\n    git commit --amend --reset-author\n\n 11 files changed, 859 insertions(+), 207 deletions(-)\n create mode 100644 src/shared/components/ui/bottom-navigation.tsx\n create mode 100644 src/shared/components/ui/bottom-sheet.tsx\n create mode 100644 src/shared/components/ui/error-state.tsx\n create mode 100644 src/shared/components/ui/fab.tsx\n create mode 100644 src/shared/components/ui/index.ts\n create mode 100644 src/shared/components/ui/skeleton.tsx\n create mode 100644 src/shared/components/ui/swipe-container.tsx","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tdzdi8pfdXxVRxtvG25deY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01M1nKsESB3HGdHGndpQVccU","name":"TodoWrite","input":{"todos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"completed","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"completed","activeForm":"Running quality checks"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":561,"cache_read_input_tokens":123183,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":561},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"65c2b2a7-16ac-4ff6-92ca-fd402148c553"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01M1nKsESB3HGdHGndpQVccU","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"6ee329af-45f9-410c-aa07-c1bb2476815f","tool_use_result":{"oldTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"completed","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"in_progress","activeForm":"Running quality checks"}],"newTodos":[{"content":"Audit and fix all touch targets to ensure ≥ 44px","status":"completed","activeForm":"Auditing touch targets for 44px minimum"},{"content":"Create reusable BottomNavigation component","status":"completed","activeForm":"Creating BottomNavigation component"},{"content":"Create reusable FAB component with correct positioning","status":"completed","activeForm":"Creating FAB component"},{"content":"Create BottomSheet component for quick actions","status":"completed","activeForm":"Creating BottomSheet component"},{"content":"Create Skeleton loading component system","status":"completed","activeForm":"Creating Skeleton components"},{"content":"Create ErrorState component with retry actions","status":"completed","activeForm":"Creating ErrorState component"},{"content":"Improve swipe gestures on agenda","status":"completed","activeForm":"Improving swipe gestures"},{"content":"Add horizontal scroll prevention to all pages","status":"completed","activeForm":"Adding horizontal scroll prevention"},{"content":"Integrate components across all pages","status":"completed","activeForm":"Integrating components across pages"},{"content":"Run quality checks and commit","status":"completed","activeForm":"Running quality checks"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NchSmsomNfPpfAUi7fhurX","type":"message","role":"assistant","content":[{"type":"text","text":"I have successfully implemented **US-030 - Responsividade e UX mobile final**. Here's a summary of what was done:\n\n## Summary\n\n### New Reusable UI Components Created (`src/shared/components/ui/`)\n\n1. **BottomNavigation** - Fixed bottom navigation bar with 3 items (Agenda, Pacientes, Config) with 44px+ touch targets\n2. **FAB** - Floating Action Button positioned correctly (bottom-right, above nav)\n3. **BottomSheet** - Reusable bottom sheet component with swipe-to-close gesture\n4. **Skeleton Components** - Skeleton loading screens (SkeletonAgenda, SkeletonPage, SkeletonList, etc.)\n5. **ErrorState/EmptyState** - Error and empty state components with retry actions\n6. **SwipeContainer** - Touch gesture handler for horizontal swipe navigation\n\n### Global CSS Improvements (`globals.css`)\n\n- Horizontal scroll prevention (`overflow-x: hidden`)\n- iOS safe area support (`.safe-area-pb`, `.safe-area-pt`)\n- Touch-friendly targets (`.touch-target`, `.touch-manipulation`)\n- Prevent input zoom on iOS (16px minimum font-size)\n- Button touch feedback for mobile devices\n- Consolidated animation keyframes (slide-up, fade-in, scale-in)\n\n### Page Updates\n\n- **Agenda page**: Uses BottomNavigation, FAB, SwipeContainer, SkeletonAgenda, EmptyState\n- **Patients page**: Uses BottomNavigation, FAB, SkeletonPage, EmptyState\n- **Settings page**: Uses BottomNavigation, SkeletonPage, improved touch targets\n\n### Acceptance Criteria Met\n\n- [x] All touch targets ≥ 44px\n- [x] Bottom navigation implemented (Agenda, Pacientes, Config)\n- [x] FAB positioned correctly (bottom right, above nav)\n- [x] Bottom sheets for quick actions\n- [x] Swipe gestures working on agenda\n- [x] Loading states with skeleton screens\n- [x] Error states with retry actions\n- [x] No horizontal scroll on any page\n\n<promise>COMPLETE</promise>"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":412,"cache_read_input_tokens":123744,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":412},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","uuid":"b61f97fc-9fc1-4f37-b8a2-3e402c8dcad1"}
{"type":"result","subtype":"success","is_error":false,"duration_ms":666107,"duration_api_ms":520387,"num_turns":73,"result":"I have successfully implemented **US-030 - Responsividade e UX mobile final**. Here's a summary of what was done:\n\n## Summary\n\n### New Reusable UI Components Created (`src/shared/components/ui/`)\n\n1. **BottomNavigation** - Fixed bottom navigation bar with 3 items (Agenda, Pacientes, Config) with 44px+ touch targets\n2. **FAB** - Floating Action Button positioned correctly (bottom-right, above nav)\n3. **BottomSheet** - Reusable bottom sheet component with swipe-to-close gesture\n4. **Skeleton Components** - Skeleton loading screens (SkeletonAgenda, SkeletonPage, SkeletonList, etc.)\n5. **ErrorState/EmptyState** - Error and empty state components with retry actions\n6. **SwipeContainer** - Touch gesture handler for horizontal swipe navigation\n\n### Global CSS Improvements (`globals.css`)\n\n- Horizontal scroll prevention (`overflow-x: hidden`)\n- iOS safe area support (`.safe-area-pb`, `.safe-area-pt`)\n- Touch-friendly targets (`.touch-target`, `.touch-manipulation`)\n- Prevent input zoom on iOS (16px minimum font-size)\n- Button touch feedback for mobile devices\n- Consolidated animation keyframes (slide-up, fade-in, scale-in)\n\n### Page Updates\n\n- **Agenda page**: Uses BottomNavigation, FAB, SwipeContainer, SkeletonAgenda, EmptyState\n- **Patients page**: Uses BottomNavigation, FAB, SkeletonPage, EmptyState\n- **Settings page**: Uses BottomNavigation, SkeletonPage, improved touch targets\n\n### Acceptance Criteria Met\n\n- [x] All touch targets ≥ 44px\n- [x] Bottom navigation implemented (Agenda, Pacientes, Config)\n- [x] FAB positioned correctly (bottom right, above nav)\n- [x] Bottom sheets for quick actions\n- [x] Swipe gestures working on agenda\n- [x] Loading states with skeleton screens\n- [x] Error states with retry actions\n- [x] No horizontal scroll on any page\n\n<promise>COMPLETE</promise>","session_id":"450a69ab-cd7f-4725-ad89-8b0246468634","total_cost_usd":5.0000987,"usage":{"input_tokens":116,"cache_creation_input_tokens":98453,"cache_read_input_tokens":6956395,"output_tokens":25995,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":98453,"ephemeral_5m_input_tokens":0}},"modelUsage":{"claude-opus-4-5-20251101":{"inputTokens":116,"outputTokens":25995,"cacheReadInputTokens":6956395,"cacheCreationInputTokens":98453,"webSearchRequests":0,"costUSD":4.74398375,"contextWindow":200000,"maxOutputTokens":64000},"claude-haiku-4-5-20251001":{"inputTokens":31898,"outputTokens":7334,"cacheReadInputTokens":590382,"cacheCreationInputTokens":102807,"webSearchRequests":0,"costUSD":0.2561149500000001,"contextWindow":200000,"maxOutputTokens":64000}},"permission_denials":[],"uuid":"c974db1c-114e-4df6-9ed0-fef99ee4124a"}

--- SUBAGENT TRACE ---
{
  "events": [
    {
      "id": "subagent_1769687554969_hfzbekw",
      "type": "spawn",
      "timestamp": "2026-01-29T11:52:34.969Z",
      "agentType": "Explore",
      "description": "Explore codebase structure",
      "prompt": "Explore this codebase to understand:\n1. The overall project structure (is it React, Vue, Next.js, etc.)\n2. Current component organization\n3. Existing navigation patterns\n4. Current mobile/responsive implementations\n5. CSS/styling approach (Tailwind, CSS modules, styled-components, etc.)\n6. Any existing bottom navigation or FAB components\n7. Current loading/error state patterns\n\nFocus on finding:\n- Main layout components\n- Navigation components\n- Any mobile-specific code\n- UI component library being used (if any)"
    },
    {
      "id": "subagent_1769687554969_hfzbekw",
      "type": "complete",
      "timestamp": "2026-01-29T12:03:34.520Z",
      "agentType": "Explore",
      "description": "Explore codebase structure",
      "exitStatus": "success",
      "durationMs": 659551
    }
  ],
  "hierarchy": [
    {
      "state": {
        "id": "subagent_1769687554969_hfzbekw",
        "agentType": "Explore",
        "description": "Explore codebase structure",
        "status": "completed",
        "childIds": [],
        "spawnedAt": "2026-01-29T11:52:34.969Z",
        "prompt": "Explore this codebase to understand:\n1. The overall project structure (is it React, Vue, Next.js, etc.)\n2. Current component organization\n3. Existing navigation patterns\n4. Current mobile/responsive implementations\n5. CSS/styling approach (Tailwind, CSS modules, styled-components, etc.)\n6. Any existing bottom navigation or FAB components\n7. Current loading/error state patterns\n\nFocus on finding:\n- Main layout components\n- Navigation components\n- Any mobile-specific code\n- UI component library being used (if any)",
        "endedAt": "2026-01-29T12:03:34.520Z",
        "durationMs": 659551
      },
      "children": []
    }
  ],
  "stats": {
    "totalSubagents": 1,
    "byType": {
      "Explore": 1
    },
    "totalDurationMs": 659551,
    "failureCount": 0,
    "maxDepth": 1
  }
}